<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>iRequest</title>
  <link rel="icon" href="/static/assets/iRlogo.png" type="image/x-icon">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Signup shared styles -->
  <link rel="stylesheet" href="/static/assets/css/signup.css">

</head>
<body>

<div class="container signup-container d-flex align-items-center justify-content-center min-vh-100">
  <div class="card signup-card">
    <div class="card-body">
      <h3 class="signup-title">Staff Signup Form</h3>
          <form id="staffSignupForm">
            
            <!-- Department -->
            <div class="mb-3">
              <label class="form-label">Department</label>
              <select class="form-select" name="department" required>
                <option selected disabled>Choose Department...</option>
                <option>Admin</option>
                <option>Computer Laboratory</option>
                <option>Guidance Office</option>
                <option>Student Affairs</option>
                <option>Library</option>
                <option>Dean of CoEd</option>
                <option>Dean of HM</option>
                <option>Dean of CS</option>
                <option>Accounting</option>
                <option>Property Custodian</option>
                <option>Registrar</option>
              </select>
            </div>

            <!-- Name -->
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" name="first_name" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Middle Name</label>
                <input type="text" class="form-control" id="staff_middle_name" name="middle_name">
                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" id="staff_no_middlename">
                  <label class="form-check-label" for="staff_no_middlename">No Middle Name</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" name="last_name" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Suffix</label>
                <select class="form-select" name="suffix">
                  <option selected disabled>Choose...</option>
                  <option>Jr.</option>
                  <option>Sr.</option>
                  <option>I</option>
                  <option>II</option>
                  <option>III</option>
                  <option>IV</option>
                  <option>V</option>
                  <option>None</option>
                </select>
              </div>
            </div>

            <!-- Email -->
            <div class="mt-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" required>
            </div>

            <!-- Password -->
            <div class="row g-2 mt-3">
              <div class="col-md-6">
                <label class="form-label">Password</label>
                <div class="position-relative">
                  <input type="password" class="form-control" id="staff_password" name="password" required style="padding-right: 42px;">
                  <i id="toggleStaffPwd" class="fa-solid fa-eye position-absolute" style="right:12px; top:50%; transform: translateY(-50%); cursor:pointer; user-select:none;"></i>
                </div>
                <div id="staff_pwd_strength" class="mt-1" style="font-size:13px;">Strength: <span id="staff_pwd_strength_label">Weak</span></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Confirm Password</label>
                <div class="position-relative">
                  <input type="password" class="form-control" id="staff_confirm_password" name="confirm_password" required style="padding-right: 42px;">
                  <i id="toggleStaffConfirmPwd" class="fa-solid fa-eye position-absolute" style="right:12px; top:50%; transform: translateY(-50%); cursor:pointer; user-select:none;"></i>
                </div>
              </div>
            </div>

            <!-- Mobile -->
            <div class="mt-3">
              <label class="form-label">Mobile No.</label>
              <input type="text" id="mobile" name="mobile" class="form-control" placeholder="09XXXXXXXXX" required>
              <div id="mobileError">Invalid mobile number. Format: 09XXXXXXXXX</div>
            </div>

            <!-- Gender -->
            <div class="mt-3">
              <label class="form-label">Gender</label><br>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="gender" value="Male" required>
                <label class="form-check-label">Male</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="gender" value="Female" required>
                <label class="form-check-label">Female</label>
              </div>
            </div>

            <!-- Address -->
            <div class="mt-3">
              <label class="form-label">Address</label>
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label">Province</label>
                  <select class="form-select" id="staff_province" name="province" required>
                    <option selected disabled>Loading provinces...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Municipality/City</label>
                  <select class="form-select" id="staff_municipality" name="municipality" required disabled>
                    <option selected disabled>Choose province first</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Barangay</label>
                  <select class="form-select" id="staff_barangay" name="barangay" required disabled>
                    <option selected disabled>Choose city/municipality first</option>
                  </select>
                </div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-md-8">
                  <label class="form-label">Street</label>
                  <input type="text" class="form-control" id="staff_street" name="street" placeholder="Street / Subdivision / Purok" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Block/Lot/Unit</label>
                  <input type="text" class="form-control" id="staff_block" name="block" placeholder="e.g., Blk 1 Lot 2">
                </div>
              </div>
              <input type="hidden" id="staff_full_address" name="address">
            </div>

            <!-- Terms -->
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" id="terms" disabled>
              <label class="form-check-label" for="terms">
                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms of Service</a>
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="privacy" disabled>
              <label class="form-check-label" for="privacy">
                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Data Privacy Policy</a>
              </label>
            </div>

            <!-- Submit -->
            <div class="d-grid mt-4">
              <button type="submit" class="btn btn-primary">Sign Up</button>
            </div>

            <!-- Already have account -->
            <div class="login-link">
              Already have an account? <a href="login.html">Login</a>
            </div>

          </form>
    </div>
  </div>
</div>

<!-- Terms Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-primary text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-file-contract me-3 fs-4"></i>
          <h5 class="modal-title mb-0 fw-bold">Terms of Service</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-dark" style="max-height: 60vh; overflow-y: auto;">
        <div class="mb-4">
          <h6 class="text-primary fw-bold mb-3">
            <i class="fas fa-info-circle me-2"></i>Overview
          </h6>
          <p class="mb-3">These Terms of Service ("Terms") govern your use of the iRequest Online Document Request Form platform operated by Norzagaray College. By accessing or using our service, you agree to be bound by these Terms.</p>
        </div>

        <div class="mb-4">
          <h6 class="text-primary fw-bold mb-3">
            <i class="fas fa-user-check me-2"></i>Acceptable Use
          </h6>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Use the platform only for requesting, processing, and managing official documents of Norzagaray College</li>
            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Provide accurate and truthful information in all requests</li>
            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Maintain the confidentiality of your account credentials</li>
            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Comply with all applicable laws and regulations</li>
          </ul>
        </div>

        <div class="mb-4">
          <h6 class="text-primary fw-bold mb-3">
            <i class="fas fa-ban me-2"></i>Prohibited Activities
          </h6>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>Submitting false or misleading information</li>
            <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>Attempting to gain unauthorized access to the system</li>
            <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>Using the platform for any illegal or unauthorized purpose</li>
            <li class="mb-2"><i class="fas fa-times text-danger me-2"></i>Interfering with the proper functioning of the service</li>
          </ul>
        </div>

        <div class="mb-4">
          <h6 class="text-primary fw-bold mb-3">
            <i class="fas fa-shield-alt me-2"></i>Account Responsibility
          </h6>
          <p class="mb-2">You are responsible for:</p>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-key me-2 text-warning"></i>Maintaining the security of your account</li>
            <li class="mb-2"><i class="fas fa-key me-2 text-warning"></i>All activities that occur under your account</li>
            <li class="mb-2"><i class="fas fa-key me-2 text-warning"></i>Notifying us immediately of any unauthorized use</li>
          </ul>
        </div>

        <div class="mb-4">
          <h6 class="text-primary fw-bold mb-3">
            <i class="fas fa-gavel me-2"></i>Limitation of Liability
          </h6>
          <p class="mb-0">Norzagaray College shall not be liable for any indirect, incidental, special, consequential, or punitive damages resulting from your use of the iRequest platform.</p>
        </div>

        <div class="alert alert-info border-0 bg-light">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Note:</strong> These terms may be updated periodically. Continued use of the service constitutes acceptance of any changes.
      </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-primary px-4 py-2" id="acceptTerms" data-bs-dismiss="modal">
          <i class="fas fa-check me-2"></i>I Understand and Accept
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Privacy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content rounded-4 shadow-lg">
      <div class="modal-header bg-success text-white border-0">
        <div class="d-flex align-items-center">
          <i class="fas fa-shield-alt me-3 fs-4"></i>
          <h5 class="modal-title mb-0 fw-bold">Data Privacy Policy</h5>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-dark" style="max-height: 60vh; overflow-y: auto;">
        <div class="mb-4">
          <h6 class="text-success fw-bold mb-3">
            <i class="fas fa-info-circle me-2"></i>Introduction
          </h6>
          <p class="mb-3">Norzagaray College is committed to protecting your privacy and personal data. This Data Privacy Policy explains how we collect, use, store, and protect your information when you use the iRequest platform, in compliance with the Data Privacy Act of 2012 (Republic Act No. 10173).</p>
        </div>

        <div class="mb-4">
          <h6 class="text-success fw-bold mb-3">
            <i class="fas fa-database me-2"></i>Information We Collect
          </h6>
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted fw-semibold mb-2">Personal Information:</h6>
              <ul class="list-unstyled small">
                <li class="mb-1"><i class="fas fa-user me-2 text-primary"></i>Full name</li>
                <li class="mb-1"><i class="fas fa-id-card me-2 text-primary"></i>Employee ID</li>
                <li class="mb-1"><i class="fas fa-envelope me-2 text-primary"></i>Email address</li>
                <li class="mb-1"><i class="fas fa-phone me-2 text-primary"></i>Contact number</li>
                <li class="mb-1"><i class="fas fa-map-marker-alt me-2 text-primary"></i>Address</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted fw-semibold mb-2">Professional Information:</h6>
              <ul class="list-unstyled small">
                <li class="mb-1"><i class="fas fa-briefcase me-2 text-primary"></i>Department/Office</li>
                <li class="mb-1"><i class="fas fa-user-tie me-2 text-primary"></i>Position/Title</li>
                <li class="mb-1"><i class="fas fa-file-alt me-2 text-primary"></i>Document requests</li>
                <li class="mb-1"><i class="fas fa-history me-2 text-primary"></i>Transaction history</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <h6 class="text-success fw-bold mb-3">
            <i class="fas fa-cogs me-2"></i>How We Use Your Information
          </h6>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Verify your identity and employment status</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Process and fulfill your document requests</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Communicate with you about your requests and account status</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Maintain records for administrative and audit purposes</li>
            <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i>Improve our services and user experience</li>
          </ul>
        </div>

        <div class="mb-4">
          <h6 class="text-success fw-bold mb-3">
            <i class="fas fa-lock me-2"></i>Data Protection Measures
          </h6>
          <div class="row">
            <div class="col-md-6">
              <div class="card border-0 bg-light h-100">
                <div class="card-body p-3">
                  <h6 class="card-title text-success"><i class="fas fa-shield-alt me-2"></i>Technical Safeguards</h6>
                  <ul class="list-unstyled small mb-0">
                    <li class="mb-1">• SSL encryption for data transmission</li>
                    <li class="mb-1">• Secure database storage</li>
                    <li class="mb-1">• Regular security updates</li>
                    <li class="mb-1">• Access controls and authentication</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-0 bg-light h-100">
                <div class="card-body p-3">
                  <h6 class="card-title text-success"><i class="fas fa-users me-2"></i>Administrative Safeguards</h6>
                  <ul class="list-unstyled small mb-0">
                    <li class="mb-1">• Staff training on data privacy</li>
                    <li class="mb-1">• Limited access to personal data</li>
                    <li class="mb-1">• Regular privacy audits</li>
                    <li class="mb-1">• Incident response procedures</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <h6 class="text-success fw-bold mb-3">
            <i class="fas fa-share-alt me-2"></i>Data Sharing and Disclosure
          </h6>
          <p class="mb-2">We do not sell, trade, or rent your personal information to third parties. We may share your information only in the following circumstances:</p>
          <ul class="list-unstyled">
            <li class="mb-2"><i class="fas fa-gavel me-2 text-warning"></i>When required by law or legal process</li>
            <li class="mb-2"><i class="fas fa-university me-2 text-warning"></i>With authorized college personnel for legitimate purposes</li>
            <li class="mb-2"><i class="fas fa-handshake me-2 text-warning"></i>With your explicit consent</li>
          </ul>
        </div>

        <div class="mb-4">
          <h6 class="text-success fw-bold mb-3">
            <i class="fas fa-user-cog me-2"></i>Your Rights
          </h6>
          <p class="mb-2">Under the Data Privacy Act, you have the right to:</p>
          <div class="row">
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="mb-2"><i class="fas fa-eye me-2 text-info"></i>Access your personal data</li>
                <li class="mb-2"><i class="fas fa-edit me-2 text-info"></i>Correct inaccurate information</li>
                <li class="mb-2"><i class="fas fa-ban me-2 text-info"></i>Object to processing</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="mb-2"><i class="fas fa-trash me-2 text-info"></i>Request data deletion</li>
                <li class="mb-2"><i class="fas fa-download me-2 text-info"></i>Data portability</li>
                <li class="mb-2"><i class="fas fa-exclamation-triangle me-2 text-info"></i>File complaints</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="alert alert-success border-0 bg-light">
          <i class="fas fa-info-circle me-2"></i>
          <strong>Contact Information:</strong> For privacy concerns or data requests, contact our Data Protection Officer at <strong>dpo@norzagaraycollege.edu.ph</strong> or visit the Registrar's Office.
        </div>

        <div class="alert alert-warning border-0 bg-light">
          <i class="fas fa-calendar-alt me-2"></i>
          <strong>Last Updated:</strong> This policy was last updated on <strong>January 2024</strong> and may be revised to reflect changes in our practices or applicable laws.
      </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button type="button" class="btn btn-success px-4 py-2" id="acceptPrivacy" data-bs-dismiss="modal">
          <i class="fas fa-shield-alt me-2"></i>I Understand and Accept
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const mobileInput = document.getElementById('mobile');
  const mobileError = document.getElementById('mobileError');

  mobileInput.addEventListener('input', function () {
    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11);
    const pattern = /^09\d{9}$/;
    if (!pattern.test(this.value) && this.value.length > 0) {
      mobileError.style.display = 'block';
    } else {
      mobileError.style.display = 'none';
    }
  });

  // Disable checking until OK is clicked
  const termsCheckbox = document.getElementById('terms');
  const privacyCheckbox = document.getElementById('privacy');
  document.getElementById('acceptTerms').addEventListener('click', () => {
    termsCheckbox.disabled = false;
    termsCheckbox.checked = true;
  });
  document.getElementById('acceptPrivacy').addEventListener('click', () => {
    privacyCheckbox.disabled = false;
    privacyCheckbox.checked = true;
  });
  // Show/Hide password toggles
  function wireToggle(inputId, toggleId){
    var input = document.getElementById(inputId);
    var toggle = document.getElementById(toggleId);
    if(!input || !toggle) return;
    toggle.addEventListener('click', function(){
      var isPwd = input.getAttribute('type') === 'password';
      input.setAttribute('type', isPwd ? 'text' : 'password');
      toggle.className = isPwd ? 'fa-solid fa-eye position-absolute' : 'fa-solid fa-eye-slash position-absolute';
    });
  }
  wireToggle('staff_password','toggleStaffPwd');
  wireToggle('staff_confirm_password','toggleStaffConfirmPwd');

  // Middle name checkbox behavior
  (function(){
    var cb = document.getElementById('staff_no_middlename');
    var input = document.getElementById('staff_middle_name');
    if(cb && input){
      cb.addEventListener('change', function(){
        if(this.checked){
          input.value = '';
          input.disabled = true;
        } else {
          input.disabled = false;
        }
      });
    }
  })();

  // Password strength with missing requirements message
  (function(){
    var pwd = document.getElementById('staff_password');
    var label = document.getElementById('staff_pwd_strength_label');
    function calcStrength(pass){
      var hasLen = pass.length >= 8;
      var hasUpper = /[A-Z]/.test(pass);
      var hasLower = /[a-z]/.test(pass);
      var hasDigit = /\d/.test(pass);
      var hasSpecial = /[@#$%&*!]/.test(pass);
      var score = [hasLen, hasUpper, hasLower, hasDigit, hasSpecial].filter(Boolean).length;
      if(score <= 2) return 'Weak';
      if(score === 3 || score === 4) return 'Medium';
      return 'Strong';
    }

    function update(){
      if(!pwd || !label) return;
      var pass = pwd.value;
      var strength = calcStrength(pass);
      var missing = [];
      if(pass.length < 8) missing.push('minimum length 8');
      if(!/[A-Z]/.test(pass)) missing.push('uppercase');
      if(!/[a-z]/.test(pass)) missing.push('lowercase');
      if(!/\d/.test(pass)) missing.push('number');
      if(!/[@#$%&*!]/.test(pass)) missing.push('special character');
      label.textContent = missing.length ? (strength + ' — missing: ' + missing.join(', ')) : strength;
      label.style.color = strength === 'Strong' ? '#00e676' : (strength === 'Medium' ? '#ffdd57' : '#ff6b6b');
    }
    if(pwd){ pwd.addEventListener('input', update); update(); }
  })();

  // Form submission with SweetAlert
  document.getElementById('staffSignupForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Show loading
    Swal.fire({
      title: 'Processing...',
      text: 'Please wait while we process your registration',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    // Password requirements and match check
    var pwd = document.getElementById('staff_password').value;
    var cpwd = document.getElementById('staff_confirm_password').value;
    var ok = pwd.length >= 8 && /[A-Z]/.test(pwd) && /[a-z]/.test(pwd) && /\d/.test(pwd) && /[@#$%&*!]/.test(pwd);
    if(!ok){
      Swal.fire({ icon:'error', title:'Weak password', text:'Please meet all password requirements.' });
      return;
    }
    if(pwd !== cpwd){
      Swal.fire({ icon:'error', title:'Passwords do not match', text:'Please make sure both passwords match.' });
      return;
    }

    // Prepare dynamic address
    try {
      (function(){
        var PSGC_BASE = 'https://psgc.gitlab.io/api';
        var provSel = document.getElementById('staff_province');
        var muniSel = document.getElementById('staff_municipality');
        var brgySel = document.getElementById('staff_barangay');

        async function loadProvinces(){
          try{
            provSel.innerHTML = '<option selected disabled>Loading provinces...</option>';
            var controller = new AbortController();
            var timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            var res = await fetch(PSGC_BASE + '/provinces', {
              signal: controller.signal,
              mode: 'cors'
            }).catch(() => null);
            clearTimeout(timeoutId);
            if (!res || !res.ok) {
              throw new Error('Failed to fetch');
            }
            var provinces = await res.json();
            provinces.sort(function(a,b){ return a.name.localeCompare(b.name); });
            provSel.innerHTML = '<option selected disabled>Choose...</option>' + provinces.map(function(p){
              return '<option data-code="'+p.code+'">'+p.name+'</option>';
            }).join('');
            provSel.disabled = false;
          }catch(err){
            provSel.innerHTML = '<option selected disabled>Manual entry (API unavailable)</option>';
            provSel.disabled = false;
          }
          muniSel.innerHTML = '<option selected disabled>Choose province first</option>';
          muniSel.disabled = true;
          brgySel.innerHTML = '<option selected disabled>Choose city/municipality first</option>';
          brgySel.disabled = true;
        }

        async function loadMunicipalities(provinceCode){
          muniSel.innerHTML = '<option selected disabled>Loading cities/municipalities...</option>';
          muniSel.disabled = true;
          brgySel.innerHTML = '<option selected disabled>Choose city/municipality first</option>';
          brgySel.disabled = true;
          try{
            var controller = new AbortController();
            var timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            var res = await fetch(PSGC_BASE + '/provinces/' + provinceCode + '/cities-municipalities', {
              signal: controller.signal,
              mode: 'cors'
            }).catch(() => null);
            clearTimeout(timeoutId);
            if (!res || !res.ok) {
              throw new Error('Failed to fetch');
            }
            var cities = await res.json();
            cities.sort(function(a,b){ return a.name.localeCompare(b.name); });
            muniSel.innerHTML = '<option selected disabled>Choose...</option>' + cities.map(function(c){
              return '<option data-code="'+c.code+'">'+c.name+'</option>';
            }).join('');
            muniSel.disabled = false;
          }catch(err){
            muniSel.innerHTML = '<option selected disabled>Manual entry (API unavailable)</option>';
            muniSel.disabled = false;
          }
        }

        async function loadBarangays(cityCode){
          brgySel.innerHTML = '<option selected disabled>Loading barangays...</option>';
          brgySel.disabled = true;
          try{
            var controller = new AbortController();
            var timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            var res = await fetch(PSGC_BASE + '/cities-municipalities/' + cityCode + '/barangays', {
              signal: controller.signal,
              mode: 'cors'
            }).catch(() => null);
            clearTimeout(timeoutId);
            if (!res || !res.ok) {
              throw new Error('Failed to fetch');
            }
            var brgys = await res.json();
            brgys.sort(function(a,b){ return a.name.localeCompare(b.name); });
            brgySel.innerHTML = '<option selected disabled>Choose...</option>' + brgys.map(function(b){
              return '<option data-code="'+b.code+'">'+b.name+'</option>';
            }).join('');
            brgySel.disabled = false;
          }catch(err){
            brgySel.innerHTML = '<option selected disabled>Manual entry (API unavailable)</option>';
            brgySel.disabled = false;
          }
        }

        // initial load (ensure PSGC lists present before submit)
        if(!provSel._loaded){ loadProvinces(); provSel._loaded = true; }
        if(provSel && !provSel._wired){
          provSel.addEventListener('change', function(){
            var opt = this.options[this.selectedIndex];
            var code = opt && opt.getAttribute('data-code');
            if(code) loadMunicipalities(code);
          });
          provSel._wired = true;
        }
        if(muniSel && !muniSel._wired){
          muniSel.addEventListener('change', function(){
            var opt = this.options[this.selectedIndex];
            var code = opt && opt.getAttribute('data-code');
            if(code) loadBarangays(code);
          });
          muniSel._wired = true;
        }

        // build full address now
        var block = (document.getElementById('staff_block')||{}).value || '';
        var street = (document.getElementById('staff_street')||{}).value || '';
        var barangayOpt = brgySel && brgySel.options[brgySel.selectedIndex];
        var muniOpt = muniSel && muniSel.options[muniSel.selectedIndex];
        var provOpt = provSel && provSel.options[provSel.selectedIndex];
        var barangay = barangayOpt ? barangayOpt.text : '';
        var municipality = muniOpt ? muniOpt.text : '';
        var province = provOpt ? provOpt.text : '';
        var parts = [];
        if(block.trim()) parts.push(block.trim());
        if(street.trim()) parts.push(street.trim());
        if(barangay) parts.push('Brgy. ' + barangay);
        if(municipality && province) parts.push(municipality + ', ' + province);
        else if(municipality) parts.push(municipality);
        else if(province) parts.push(province);
        var full = parts.join(', ');
        var hidden = document.getElementById('staff_full_address');
        if(hidden) hidden.value = full;
      })();

      const formData = new FormData(this);
      const response = await fetch('/staff/signup', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (result.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Registration Successful!',
          text: result.message,
          confirmButtonText: 'OK'
        }).then(() => {
          // Redirect to login page
          window.location.href = 'login.html';
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Registration Failed',
          text: result.message,
          confirmButtonText: 'Try Again'
        });
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'An unexpected error occurred. Please try again.',
        confirmButtonText: 'OK'
      });
    }
  });

  // Load PSGC data on page load so address works even before submit
  (function initAddressSelectors(){
    var PSGC_BASE = 'https://psgc.gitlab.io/api';
    var provSel = document.getElementById('staff_province');
    var muniSel = document.getElementById('staff_municipality');
    var brgySel = document.getElementById('staff_barangay');
    if(!provSel) return;
    async function loadProvinces(){
      try{
        provSel.innerHTML = '<option selected disabled>Loading provinces...</option>';
        var controller = new AbortController();
        var timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        var res = await fetch(PSGC_BASE + '/provinces', {
          signal: controller.signal,
          mode: 'cors'
        }).catch(() => null);
        clearTimeout(timeoutId);
        if (!res || !res.ok) {
          throw new Error('Failed to fetch');
        }
        var provinces = await res.json();
        provinces.sort(function(a,b){ return a.name.localeCompare(b.name); });
        provSel.innerHTML = '<option selected disabled>Choose...</option>' + provinces.map(function(p){
          return '<option data-code="'+p.code+'">'+p.name+'</option>';
        }).join('');
        provSel.disabled = false;
      }catch(err){
        provSel.innerHTML = '<option selected disabled>Manual entry (API unavailable)</option>';
        provSel.disabled = false;
      }
      muniSel.innerHTML = '<option selected disabled>Choose province first</option>';
      muniSel.disabled = true;
      brgySel.innerHTML = '<option selected disabled>Choose city/municipality first</option>';
      brgySel.disabled = true;
    }
    async function loadMunicipalities(provinceCode){
      muniSel.innerHTML = '<option selected disabled>Loading cities/municipalities...</option>';
      muniSel.disabled = true;
      brgySel.innerHTML = '<option selected disabled>Choose city/municipality first</option>';
      brgySel.disabled = true;
      try{
        var controller = new AbortController();
        var timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        var res = await fetch(PSGC_BASE + '/provinces/' + provinceCode + '/cities-municipalities', {
          signal: controller.signal,
          mode: 'cors'
        }).catch(() => null);
        clearTimeout(timeoutId);
        if (!res || !res.ok) {
          throw new Error('Failed to fetch');
        }
        var cities = await res.json();
        cities.sort(function(a,b){ return a.name.localeCompare(b.name); });
        muniSel.innerHTML = '<option selected disabled>Choose...</option>' + cities.map(function(c){
          return '<option data-code="'+c.code+'">'+c.name+'</option>';
        }).join('');
        muniSel.disabled = false;
      }catch(err){
        muniSel.innerHTML = '<option selected disabled>Manual entry (API unavailable)</option>';
        muniSel.disabled = false;
      }
    }
    async function loadBarangays(cityCode){
      brgySel.innerHTML = '<option selected disabled>Loading barangays...</option>';
      brgySel.disabled = true;
      try{
        var controller = new AbortController();
        var timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        var res = await fetch(PSGC_BASE + '/cities-municipalities/' + cityCode + '/barangays', {
          signal: controller.signal,
          mode: 'cors'
        }).catch(() => null);
        clearTimeout(timeoutId);
        if (!res || !res.ok) {
          throw new Error('Failed to fetch');
        }
        var brgys = await res.json();
        brgys.sort(function(a,b){ return a.name.localeCompare(b.name); });
        brgySel.innerHTML = '<option selected disabled>Choose...</option>' + brgys.map(function(b){
          return '<option data-code="'+b.code+'">'+b.name+'</option>';
        }).join('');
        brgySel.disabled = false;
      }catch(err){
        brgySel.innerHTML = '<option selected disabled>Manual entry (API unavailable)</option>';
        brgySel.disabled = false;
      }
    }
    loadProvinces();
    if(!provSel._wired){
      provSel.addEventListener('change', function(){
        var opt = this.options[this.selectedIndex];
        var code = opt && opt.getAttribute('data-code');
        if(code) loadMunicipalities(code);
      });
      provSel._wired = true;
    }
    if(!muniSel._wired){
      muniSel.addEventListener('change', function(){
        var opt = this.options[this.selectedIndex];
        var code = opt && opt.getAttribute('data-code');
        if(code) loadBarangays(code);
      });
      muniSel._wired = true;
    }
  })();
</script>
</body>
</html>
