<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iRequest</title>
  <link rel="icon" href="/static/assets/iRlogo.png" type="image/x-icon">
  <!-- Cache busting for receipt fix - 20250125 -->

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Professional SweetAlert Styling -->
  <link rel="stylesheet" href="/static/assets/css/sweetalert-professional.css">
  <!-- SweetAlert Utilities -->
  <script src="/static/assets/js/sweetalert-utils.js"></script>
  <!-- Loading Utilities -->
  <script src="/static/assets/js/loading-utils.js"></script>
  <!-- Receipt Modal Styles -->
  <link rel="stylesheet" href="/static/assets/css/receipt-modal.css">
  <!-- Receipt Modal Utilities -->
  <script src="/static/assets/js/receipt-modal.js?v=20250125"></script>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* Import Modern Design System */
    /* ===== ROOT VARIABLES ===== */
    :root {
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      --primary-300: #93c5fd;
      --primary-400: #60a5fa;
      --primary-500: #3b82f6;
      --primary-600: #2563eb;
      --primary-700: #1d4ed8;
      --primary-800: #1e40af;
      --primary-900: #1e3a8a;

      --secondary-50: #f8fafc;
      --secondary-100: #f1f5f9;
      --secondary-200: #e2e8f0;
      --secondary-300: #cbd5e1;
      --secondary-400: #94a3b8;
      --secondary-500: #64748b;
      --secondary-600: #475569;
      --secondary-700: #334155;
      --secondary-800: #1e293b;
      --secondary-900: #0f172a;

      --success-50: #f0fdf4;
      --success-100: #dcfce7;
      --success-200: #bbf7d0;
      --success-500: #22c55e;
      --success-600: #16a34a;
      --success-700: #15803d;

      --warning-50: #fffbeb;
      --warning-100: #fef3c7;
      --warning-200: #fde68a;
      --warning-500: #f59e0b;
      --warning-600: #d97706;
      --warning-700: #b45309;

      --error-50: #fef2f2;
      --error-100: #fee2e2;
      --error-200: #fecaca;
      --error-500: #ef4444;
      --error-600: #dc2626;
      --error-700: #b91c1c;

      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;

      /* Custom Button Styles */
      --move-pending-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --move-pending-hover: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      --move-pending-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;

      --bg-primary: #ffffff;
      --bg-secondary: var(--gray-50);
      --surface: var(--bg-primary);

      --font-family-primary: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;

      --font-normal: 400;
      --font-medium: 500;
      --font-semibold: 600;
      --font-bold: 700;

      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;

      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --radius-full: 9999px;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      --transition-fast: 150ms ease-in-out;
      --transition-normal: 200ms ease-in-out;
      --transition-slow: 300ms ease-in-out;
    }

    /* Base Styles */
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0;
    }
    
    body {
      font-family: var(--font-family-primary);
      background: linear-gradient(135deg, var(--bg-secondary) 0%, #e2e8f0 100%);
      color: var(--gray-800);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Layout - Accounting Dashboard Style */
    .container-fluid { 
      padding: 0; 
      margin: 0;
      min-height: 100vh;
      display: flex;
    }
    .row { 
      margin: 0; 
      flex: 1;
    }
    
    /* Skip Link for Accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 6px;
      background: var(--primary-600);
      color: white;
      padding: 8px;
      text-decoration: none;
      border-radius: 4px;
      z-index: 1000;
    }
    
    .skip-link:focus {
      top: 6px;
    }
    
    /* Sidebar Overlay for Mobile */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1040;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-normal);
    }
    
    .sidebar-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    /* Sidebar Styles - Accounting Dashboard Style */
    .sidebar {
      width: 72px;
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 1030;
      transition: width var(--transition-normal);
      overflow: hidden;
      flex-shrink: 0;
    }
    
    /* Expanded sidebar */
    .sidebar.expanded {
      width: 280px;
    }
    
    /* Hamburger button inside sidebar */
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: var(--space-4) var(--space-3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      min-height: 70px;
      width: 100%;
      position: relative;
    }
    
    .sidebar-hamburger {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      font-size: var(--text-xl);
      cursor: pointer;
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 10;
    }
    
    .sidebar-hamburger:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
      transform: scale(1.1);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar-hamburger:active {
      transform: scale(0.95);
    }
    
    .sidebar-title {
      margin-left: var(--space-3);
      font-weight: var(--font-bold);
      font-size: var(--text-xl);
      opacity: 1;
      transform: translateX(0);
      transition: all var(--transition-normal);
      white-space: nowrap;
    }
    
    .sidebar.expanded .sidebar-title {
      opacity: 1;
      transform: translateX(0);
    }
    
    /* Hide title cleanly when collapsed to prevent layout shift */
    .sidebar:not(.expanded) .sidebar-title {
      display: none;
    }
    
    /* Mobile view - always show sidebar title */
    @media (max-width: 768px) {
      .sidebar-title {
        opacity: 1 !important;
        transform: translateX(0) !important;
      }
    }
    
    /* Responsive Design - Tablet and Desktop */
    @media (min-width: 769px) {
      .sidebar {
        width: 72px;
        position: fixed;
        height: 100vh;
        transform: translateX(0);
        transition: width var(--transition-normal);
      }
      
      .sidebar.expanded {
        width: 280px;
      }
      
      .main-content {
        margin-left: 72px;
        transition: margin-left var(--transition-normal);
      }
      
      .main-content.sidebar-expanded {
        margin-left: 280px;
      }
      
      .mobile-menu-toggle {
        display: none !important;
      }
      
      .sidebar-overlay {
        display: none !important;
      }
    }
    
    /* Tablet specific adjustments */
    @media (min-width: 769px) and (max-width: 1024px) {
      .sidebar.expanded {
        width: 260px;
      }
      
      .main-content.sidebar-expanded {
        margin-left: 260px;
      }
    }
    
    /* Mobile - Full overlay sidebar */
    @media (max-width: 768px) {
      .sidebar {
        width: 280px;
        position: fixed;
        height: 100vh;
        transform: translateX(-100%);
        transition: transform var(--transition-normal);
        z-index: 1050;
        box-shadow: var(--shadow-xl);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
      }
      
      .mobile-menu-toggle {
        display: block !important;
      }
    }
    
    /* Navigation */
    .sidebar-nav {
      flex: 1;
      padding: var(--space-6) 0;
    }
    
    .sidebar .link-text { 
      opacity: 0;
      transform: translateX(-10px);
      transition: all var(--transition-normal);
      white-space: nowrap;
    }
    
    .sidebar.expanded .link-text { 
      opacity: 1;
      transform: translateX(0);
    }
    
    /* Mobile view - always show text */
    @media (max-width: 768px) {
      .sidebar .link-text {
        opacity: 1 !important;
        transform: translateX(0) !important;
      }
    }
    
    .sidebar a { 
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      margin: 0 var(--space-2) var(--space-1);
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-radius: var(--radius-lg);
      transition: all var(--transition-normal);
      cursor: pointer;
      min-height: 48px;
      font-size: var(--text-sm);
      position: relative;
    }
    
    /* Center icons and remove side padding when collapsed */
    .sidebar:not(.expanded) a {
      justify-content: center;
      padding: var(--space-3) 0;
    }
    
    /* Ensure text is hidden only when collapsed */
    .sidebar:not(.expanded) .link-text { display: none; }
    
    .sidebar.expanded a {
      justify-content: flex-start;
    }
    
    .sidebar a i {
      width: 20px;
      text-align: center;
      font-size: var(--text-lg);
      flex-shrink: 0;
    }
    
    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      transform: translateX(2px);
    }
    
    .sidebar a.active {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      font-weight: var(--font-semibold);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }
    
    /* Notification Badge for Nav Items */
    .nav-badge {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--error-500);
      color: white;
      font-size: 10px;
      font-weight: var(--font-bold);
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1;
    }
    
    .sidebar:not(.expanded) .nav-badge {
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    .sidebar.expanded .nav-badge {
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    .logout {
      margin-top: auto;
      padding: var(--space-4);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logout a {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      border-radius: var(--radius-lg);
      transition: all var(--transition-normal);
      cursor: pointer;
      min-height: 48px;
      font-size: var(--text-sm);
    }
    
    .logout a:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      transform: translateX(2px);
    }
    
    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--gray-700);
      font-size: var(--text-xl);
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      position: relative;
      z-index: var(--z-fixed);
    }
    
    .mobile-menu-toggle:hover {
      background: var(--gray-100);
      transform: scale(1.05);
    }
    
    /* Main Content - Accounting Dashboard Style */
    .main-content {
      flex: 1;
      margin-left: 72px;
      padding: var(--space-6);
      transition: margin-left var(--transition-normal);
      min-height: 100vh;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, #e2e8f0 100%);
      width: calc(100% - 72px);
      overflow-x: hidden;
    }
    
    /* When sidebar is expanded */
    .main-content.sidebar-expanded { 
      margin-left: 280px; 
      width: calc(100% - 280px);
    }
    
    /* Topbar - Accounting Dashboard Style */
    .topbar {
      background: var(--surface);
      padding: 0 var(--space-6);
      min-height: 68px;
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      position: sticky;
      top: 0;
      z-index: 100;
      margin-bottom: 0;
    }
    
    .topbar-title {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      margin: 0;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--gray-700);
      font-weight: var(--font-medium);
    }
    
    .user-info i {
      font-size: var(--text-lg);
      color: var(--primary-500);
    }
    
    /* Status Cards Grid - Student Dashboard Style */
    .status-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-6);
      margin-bottom: var(--space-8);
      position: relative;
      width: 100%;
      max-width: 100%;
    }

    /* Professional Sidebar */
    nav.sidebar {
      min-height: 100vh;
      background: linear-gradient(180deg, var(--primary-600) 0%, var(--primary-800) 100%);
      color: white;
      padding: var(--space-6);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }
    
    nav.sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }
    
    nav.sidebar h4 { 
      margin-bottom: var(--space-6); 
      font-weight: var(--font-bold);
      font-size: var(--text-xl);
      color: white;
      text-align: center;
      padding-bottom: var(--space-4);
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }
    
    nav.sidebar .nav-link {
      color: rgba(255,255,255,0.9);
      font-weight: var(--font-medium);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-2);
      transition: var(--transition-normal);
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    
    nav.sidebar .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: var(--transition-slow);
    }
    
    nav.sidebar .nav-link:hover { 
      background: rgba(255,255,255,0.1); 
      color: white;
      transform: translateX(4px);
      text-decoration: none;
    }
    
    nav.sidebar .nav-link:hover::before {
      left: 100%;
    }
    
    nav.sidebar .nav-link.active { 
      background: rgba(255,255,255,0.15); 
      color: white;
      font-weight: var(--font-semibold);
      box-shadow: var(--shadow-md);
    }

    /* Professional Topbar - Student Dashboard Style */
    .topbar { 
      background: var(--surface);
      padding: 0 var(--space-6);
      min-height: 68px;
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      position: sticky;
      top: 0;
      z-index: 100;
      margin-bottom: 0;
    }
    
    .topbar .username {
      font-weight: var(--font-semibold);
      font-size: var(--text-lg);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* Professional Dashboard Cards - Student Dashboard Style */
    .card-counter { 
      cursor: pointer; 
      border-radius: var(--radius-xl);
      transition: all var(--transition-normal);
      border: 1px solid var(--gray-200);
      background: var(--surface);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      min-height: 120px;
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
    }
    
    .card-counter::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
      transition: height var(--transition-normal);
    }
    
    .card-counter:hover { 
      transform: translateY(-4px); 
      box-shadow: var(--shadow-xl);
    }
    
    .card-counter:hover::before {
      height: 6px;
    }
    
    .card-counter .card-body {
      padding: 0;
      flex: 1;
    }
    
    .card-counter .card-body h3 { 
      font-weight: var(--font-bold); 
      margin: 0 0 var(--space-1) 0;
      font-size: var(--text-xl);
      color: var(--gray-800);
    }
    
    .card-counter .card-body p {
      color: var(--gray-600);
      font-size: var(--text-sm);
      margin: 0;
      font-weight: var(--font-medium);
    }
    
    /* Card Icons - Student Dashboard Style */
    .card-counter i {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-2xl);
      color: white;
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      flex-shrink: 0;
    }
    
    /* Icon Colors for different card types */
    .card-counter[data-type="pending"] i {
      background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
    }
    
    .card-counter[data-type="processing"] i {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    }
    
    .card-counter[data-type="completed"] i {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
    }
    
    .card-counter[data-type="released"] i {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
    }
    
    .card-counter[data-type="unclaimed"] i {
      background: linear-gradient(135deg, var(--gray-500), var(--gray-600));
    }
    
    .card-counter[data-type="approved"] i {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
    }
    
    .card-counter[data-type="rejected"] i {
      background: linear-gradient(135deg, var(--error-500), var(--error-600));
    }
    
    /* Status Badge - Student Dashboard Style */
    .card-counter .badge {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background: var(--error-500);
      color: white;
      font-size: var(--text-xs);
      font-weight: var(--font-bold);
      border-radius: var(--radius-full);
      min-width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      z-index: 2;
      border: 2px solid white;
    }
    
    /* Loading spinner for dashboard cards */
    .card-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }
    
    .spinner-border-sm {
      width: 1.5rem;
      height: 1.5rem;
      border-width: 0.2em;
    }
    
    .loading-text {
      margin-left: 10px;
      color: #6c757d;
      font-size: 0.9rem;
    }

    .card-counter.active[data-type="pending"] {
      border:2px solid #facc15; background: rgba(250,204,21,0.06);
    }
    .card-counter.active[data-type="approved"] {
      border:2px solid #198754; background: rgba(25,135,84,0.06);
    }
    .card-counter.active[data-type="rejected"] {
      border:2px solid #dc3545; background: rgba(220,53,69,0.06);
    }

    /* Professional Status Classes */
    .status-pending { 
      color: var(--warning-600); 
      font-weight: var(--font-semibold);
      background: var(--warning-50);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
    }
    
    .status-completed { 
      color: var(--success-600); 
      font-weight: var(--font-semibold);
      background: var(--success-50);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
    }
    
    .status-signed { 
      color: var(--success-600); 
      font-weight: var(--font-semibold);
      background: var(--success-50);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-rejected { 
      color: var(--error-600); 
      font-weight: var(--font-semibold);
      background: var(--error-50);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Professional Buttons */
    .btn-sign { 
      background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
      color: white; 
      border: none; 
      border-radius: var(--radius-lg); 
      padding: var(--space-2) var(--space-4); 
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      transition: var(--transition-normal);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-sign:hover { 
      background: linear-gradient(135deg, var(--success-600) 0%, var(--success-700) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .reason-dropdown { 
      border-radius: var(--radius-lg); 
      border: 1px solid var(--gray-300); 
      padding: var(--space-2) var(--space-3); 
      min-width: 160px;
      font-size: var(--text-sm);
      background: white;
      transition: var(--transition-normal);
    }
    
    .reason-dropdown:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }

    /* Professional Table */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: white; 
      border-radius: var(--radius-xl); 
      overflow: hidden; 
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
    }
    
    table thead { 
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      position: relative;
    }
    
    table thead::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    }
    
    table thead th { 
      padding: var(--space-4) var(--space-6); 
      text-align: left; 
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: white;
    }
    
    table tbody td { 
      padding: var(--space-4) var(--space-6); 
      border-bottom: 1px solid var(--gray-100); 
      vertical-align: middle;
      font-size: var(--text-sm);
      color: var(--gray-700);
    }
    
    table tbody tr {
      transition: var(--transition-fast);
    }
    
    table tbody tr:hover {
      background: var(--gray-50);
    }
    
    table tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Payment Status Column */
    .payment-status-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
      justify-content: center;
    }
    
    /* Clearance Status Column */
    .clearance-status-cell {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    
    /* Status Column */
    .status-cell {
      text-align: center;
      font-weight: 500;
    }
    
    /* Status badges */
    .status-pending {
      color: #ffc107;
      font-weight: 600;
    }
    
    .status-signed {
      color: #198754;
      font-weight: 600;
    }
    
    .status-rejected {
      color: #dc3545;
      font-weight: 600;
    }
    
    /* Button improvements */
    .btn-sm {
      font-size: 0.875rem;
      padding: 0.375rem 0.75rem;
    }
    
    /* Reason dropdown improvements */
    .reason-dropdown {
      font-size: 0.875rem;
      min-width: 140px;
    }
    
    /* Payment status improvements */
    .payment-status-cell small {
      font-size: 0.75rem;
      margin-top: 2px;
    }
    
    /* Professional Receipt Button */
    .view-receipt-btn {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      cursor: pointer;
      transition: var(--transition-normal);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }
    
    .view-receipt-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: var(--transition-slow);
    }
    
    .view-receipt-btn:hover {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      color: white;
      text-decoration: none;
    }
    
    .view-receipt-btn:hover::before {
      left: 100%;
    }
    
    .view-receipt-btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .view-receipt-btn i {
      font-size: 0.875rem;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    
    /* Mobile receipt button */
    .view-receipt-mobile {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      cursor: pointer;
      transition: var(--transition-normal);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }
    
    .view-receipt-mobile:hover {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      color: white;
      text-decoration: none;
    }
    
    /* No receipt text styling */
    .no-receipt-text {
      color: var(--gray-500);
      font-size: var(--text-sm);
      font-style: italic;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      background: var(--gray-100);
      border-radius: var(--radius-md);
      border: 1px solid var(--gray-200);
    }
    
    .no-receipt-text i {
      font-size: var(--text-xs);
      opacity: 0.7;
    }

    /* Professional Profile Styles - Accounting Dashboard Style */
    .profile-header {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      border-radius: var(--radius-2xl);
      padding: var(--space-8);
      margin-bottom: var(--space-8);
      color: white;
      display: flex;
      align-items: center;
      gap: var(--space-6);
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
    }

    .profile-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }

    .profile-avatar {
      position: relative;
      z-index: 1;
    }

    .avatar-circle {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      border: 4px solid rgba(255, 255, 255, 0.3);
      box-shadow: var(--shadow-lg);
    }

    .profile-status {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-top: var(--space-3);
      justify-content: center;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--success-500);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    .status-indicator.active {
      background: var(--success-500);
    }

    .status-text {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      color: rgba(255, 255, 255, 0.9);
    }

    .profile-info {
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .profile-name {
      font-size: var(--text-3xl);
      font-weight: var(--font-bold);
      margin: 0 0 var(--space-2) 0;
      color: white;
    }

    .profile-title {
      font-size: var(--text-lg);
      color: rgba(255, 255, 255, 0.8);
      margin: 0 0 var(--space-3) 0;
      font-weight: var(--font-medium);
    }

    .profile-email, .profile-joined {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      color: rgba(255, 255, 255, 0.9);
      margin: var(--space-1) 0;
      font-size: var(--text-sm);
    }

    .profile-email i, .profile-joined i {
      color: rgba(255, 255, 255, 0.7);
      width: 16px;
    }

    .profile-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: var(--space-6);
      margin-bottom: var(--space-8);
    }

    .profile-card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      transition: all var(--transition-normal);
    }

    .profile-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .profile-card .card-header {
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      padding: var(--space-6);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .card-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xl);
      color: white;
    }

    .card-icon.personal {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    }

    .card-icon.contact {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
    }

    .profile-card .card-header h3 {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      margin: 0;
    }

    .card-content {
      padding: var(--space-6);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-4);
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .info-item.full-width {
      grid-column: 1 / -1;
    }

    .info-item label {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .info-item span {
      font-size: var(--text-base);
      color: var(--gray-800);
      font-weight: var(--font-medium);
    }

    .profile-actions {
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      margin-bottom: var(--space-8);
    }

    .action-buttons {
      display: flex;
      gap: var(--space-4);
      justify-content: center;
    }

    .action-buttons .btn {
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-weight: var(--font-semibold);
      display: flex;
      align-items: center;
      gap: var(--space-2);
      transition: all var(--transition-normal);
    }

    .profile-notice {
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
      border: 1px solid var(--primary-200);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-8);
    }

    .notice-content {
      display: flex;
      align-items: flex-start;
      gap: var(--space-4);
    }

    .notice-content i {
      color: var(--primary-600);
      font-size: var(--text-xl);
      margin-top: var(--space-1);
    }

    .notice-content strong {
      color: var(--primary-800);
      font-weight: var(--font-bold);
      display: block;
      margin-bottom: var(--space-2);
    }

    .notice-content p {
      color: var(--primary-700);
      margin: 0;
      line-height: var(--line-height-relaxed);
    }

    .profile-error {
      text-align: center;
      padding: var(--space-12);
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
    }

    .error-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--error-100), var(--error-200));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto var(--space-6);
      font-size: 2rem;
      color: var(--error-500);
    }

    .profile-error h3 {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      margin-bottom: var(--space-4);
    }

    .profile-error p {
      color: var(--gray-600);
      margin-bottom: var(--space-6);
      line-height: var(--line-height-relaxed);
    }

    /* Responsive Profile Design */
    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        padding: var(--space-6);
      }

      .profile-cards-grid {
        grid-template-columns: 1fr;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }

    /* Search */
    #searchContainer { margin-bottom:14px; }

    /* Analytics Section */
    .analytics-section {
      margin-top: var(--space-6);
    }

    .analytics-section .card {
      border: none;
      border-radius: var(--radius-xl);
      overflow: hidden;
    }

    .analytics-section .card-header {
      border-bottom: none;
      padding: var(--space-4) var(--space-6);
      font-weight: var(--font-semibold);
    }

    .analytics-section .card-body {
      padding: var(--space-6);
      min-height: 200px;
    }

    .analytics-section canvas {
      max-height: 300px;
    }

    /* Modal canvas */
    .modal-content canvas { border:1px solid #ddd; border-radius:6px; cursor:crosshair; }

    /* Enhanced Modal Styles */
    .bg-gradient-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #0a58ca 100%);
    }
    
    .modal-xl {
      max-width: 1200px;
    }
    
    .modal-content {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .modal-header {
      padding: 1.5rem;
    }
    
    .modal-body {
      background: #fafbfc;
    }
    
    .modal-footer {
      padding: 1rem 1.5rem;
    }
    
    /* Status Badges */
    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-badge.approved {
      background: rgba(25, 135, 84, 0.1);
      color: #198754;
      border: 1px solid rgba(25, 135, 84, 0.2);
    }
    
    .status-badge.pending {
      background: rgba(250, 204, 21, 0.1);
      color: #facc15;
      border: 1px solid rgba(250, 204, 21, 0.2);
    }
    
    .status-badge.rejected {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.2);
    }

    /* Status Badge Chips (matching student dashboard) */
    .status-badge-chip { 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 4px 10px; 
      border-radius: 999px; 
      font-weight: 600; 
      font-size: 12px; 
      border: 1px solid transparent; 
    }
    
    .chip-pending { 
      background: rgba(250, 204, 21, 0.1); 
      color: #facc15; 
      border-color: rgba(250, 204, 21, 0.2); 
    }
    
    .chip-approved { 
      background: rgba(25, 135, 84, 0.1); 
      color: #198754; 
      border-color: rgba(25, 135, 84, 0.2); 
    }
    
    .chip-rejected { 
      background: rgba(220, 53, 69, 0.1); 
      color: #dc3545; 
      border-color: rgba(220, 53, 69, 0.2); 
    }
    
    /* Info Cards */
    .info-item {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      border-left: 4px solid var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 0.5rem;
    }
    
    .info-item .label {
      font-size: 0.75rem;
      color: #6c757d;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }
    
    .info-item .value {
      font-size: 0.95rem;
      color: #212529;
      font-weight: 500;
    }
    
    /* Enhanced Document Information Layout */
    #clViewInfo .col-md-4 {
      padding: 0 0.75rem;
    }
    
    #clViewInfo .info-item {
      background: #ffffff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }
    
    #clViewInfo .info-item:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-1px);
    }
    
    #clViewInfo .info-item .label {
      font-size: 0.7rem;
      color: #6c757d;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.8px;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    #clViewInfo .info-item .value {
      font-size: 1rem;
      color: #212529;
      font-weight: 600;
      line-height: 1.4;
    }
    
    #clViewInfo .info-item .value.fw-bold {
      font-weight: 700;
    }
    
    /* Table Enhancements */
    .table th {
      font-size: 0.8rem;
      padding: 1rem 0.75rem;
    }
    
    .table td {
      padding: 1rem 0.75rem;
      vertical-align: middle;
    }
    
    .table tbody tr:hover {
      background-color: rgba(13, 110, 253, 0.02);
    }
    
    /* Office Icons */
    .office-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.75rem;
      font-size: 0.875rem;
    }
    
    .office-icon.computer-lab { background: rgba(13, 110, 253, 0.1); color: #0d6efd; }
    .office-icon.guidance { background: rgba(25, 135, 84, 0.1); color: #198754; }
    .office-icon.student-affairs { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
    .office-icon.library { background: rgba(108, 117, 125, 0.1); color: #6c757d; }
    .office-icon.dean { background: rgba(220, 53, 69, 0.1); color: #dc3545; }
    .office-icon.accounting { background: rgba(111, 66, 193, 0.1); color: #6f42c1; }
    .office-icon.registrar { background: rgba(13, 202, 240, 0.1); color: #0dcaf0; }

    /* Auto-transfer badge styling */
    .badge.bg-success {
      background: linear-gradient(135deg, #198754 0%, #20c997 100%) !important;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3);
      animation: pulse-success 2s infinite;
    }
    
    @keyframes pulse-success {
      0% { box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3); }
      50% { box-shadow: 0 2px 8px rgba(25, 135, 84, 0.5); }
      100% { box-shadow: 0 2px 4px rgba(25, 135, 84, 0.3); }
    }

    /* small utilities */
    .mt-12 { margin-top:12px; }
    .mb-16 { margin-bottom:16px; }

    @media (max-width: 991px) {
      nav.sidebar { padding:14px; }
      .topbar { margin-left:0; }
    }
  </style>
</head>
<body>

  <!-- Skip Link for Accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" aria-hidden="true"></div>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar Navigation - Accounting Dashboard Style -->
      <div class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
        <div class="sidebar-header">
          <button class="sidebar-hamburger" id="sidebarToggle" aria-label="Toggle sidebar">
            <i class="fa-solid fa-bars"></i>
          </button>
          <span class="sidebar-title">Registrar Panel</span>
        </div>
        
        <div class="sidebar-nav">
          <a class="nav-link active" onclick="setActive(this); loadContent('dashboard')" 
             aria-current="page" tabindex="0">
            <i class="fa-solid fa-chart-simple" aria-hidden="true"></i> 
            <span class="link-text">Dashboard</span>
            <span class="nav-badge" id="dashboardBadge" style="display: none;">0</span>
          </a>

          <a class="nav-link" onclick="setActive(this); loadContent('analytics')" tabindex="0">
            <i class="fa-solid fa-chart-line" aria-hidden="true"></i> 
            <span class="link-text">Analytics</span>
          </a>

          <a class="nav-link" onclick="setActive(this); loadContent('clearance')" tabindex="0">
            <i class="fa-solid fa-file-signature" aria-hidden="true"></i> 
            <span class="link-text">Clearance</span>
            <span class="nav-badge" id="clearanceBadge" style="display: none;">0</span>
          </a>

          <a class="nav-link" onclick="setActive(this); loadContent('profile')" tabindex="0">
            <i class="fa-solid fa-id-badge" aria-hidden="true"></i> 
            <span class="link-text">Profile</span>
          </a>

          <a class="nav-link" onclick="setActive(this); loadContent('password')" tabindex="0">
            <i class="fa-solid fa-lock" aria-hidden="true"></i> 
            <span class="link-text">Change Password</span>
          </a>
        </div>
        
        <div class="logout">
          <a onclick="logout()" aria-label="Logout from system">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i> 
            <span class="link-text">Logout</span>
          </a>
        </div>
      </div>

      <!-- Main Content Area - Accounting Dashboard Style -->
      <main class="main-content" id="main-content" role="main">
        <!-- Topbar -->
        <header class="topbar" role="banner">
          <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle navigation menu" aria-expanded="false">
            <i class="fa-solid fa-bars"></i>
          </button>
          <h1 class="topbar-title">Registrar Dashboard</h1>
          <div class="user-info" role="complementary" aria-label="User information">
            <i class="fa-solid fa-circle-user" aria-hidden="true"></i> 
            <span id="registrarName">Registrar</span>
          </div>
        </header>

        <!-- Dynamic content mount -->
        <div id="mainContent" role="region" aria-label="Dashboard content"></div>
      </main>
    </div>
  </div>

  <!-- Dashboard Template (Pending / Processing / Released / Rejected / Unclaimed + search + counters) -->
  <template id="dashboardTemplate">
    <div id="dashboardContent">

      <!-- Status Cards - Student Dashboard Style -->
      <div class="status-cards">
        <div class="card-counter" data-type="pending" onclick="showTable('pending')">
          <i class="fa-solid fa-hourglass-half"></i>
          <div class="card-body">
            <h3 id="pendingCount">0</h3>
            <p>Pending Documents</p>
          </div>
        </div>

        <div class="card-counter" data-type="processing" onclick="showTable('processing')">
          <i class="fa-solid fa-gears"></i>
          <div class="card-body">
            <h3 id="processingCount">0</h3>
            <p>Processing Documents</p>
          </div>
        </div>

        <div class="card-counter" data-type="completed" onclick="showTable('completed')">
          <i class="fa-solid fa-check-double"></i>
          <div class="card-body">
            <h3 id="completedCount">0</h3>
            <p>Completed Documents</p>
          </div>
        </div>

        <div class="card-counter" data-type="released" onclick="showTable('released')">
          <i class="fa-solid fa-paper-plane"></i>
          <div class="card-body">
            <h3 id="releasedCount">0</h3>
            <p>Released Documents</p>
          </div>
        </div>

        <div class="card-counter" data-type="unclaimed" onclick="showTable('unclaimed')">
          <i class="fa-solid fa-box-archive"></i>
          <div class="card-body">
            <h3 id="unclaimedCount">0</h3>
            <p>Unclaimed Documents</p>
          </div>
        </div>
      </div>

      <!-- Search -->
      <div id="searchContainer" class="mb-3 d-none">
        <input id="searchInput" class="form-control" placeholder="Search student...">
      </div>

      <!-- Tables container -->
      <div id="tablesContainer">

        <!-- Pending -->
        <div id="pendingTable" class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white"><i class="fa-solid fa-clipboard-list"></i> Pending Documents</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-primary">
                <tr>
                  <th>Student Name</th>
                  <th>Document</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="pendingList">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Processing -->
        <div id="processingTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-info text-white"><i class="fa-solid fa-gears"></i> Processing Documents</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-info">
                <tr>
                  <th>Student Name</th>
                  <th>Document</th>
                  <th>Status</th>
                  <th>Pickup Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="processingList"></tbody>
            </table>
          </div>
        </div>

        <!-- Completed -->
        <div id="completedTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-success text-white"><i class="fa-solid fa-check-double"></i> Completed Documents</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-success">
                <tr>
                  <th>Student Name</th>
                  <th>Document</th>
                  <th>Status</th>
                  <th>Completed At</th>
                  <th>Pickup Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="completedList"></tbody>
            </table>
          </div>
        </div>

        <!-- Released -->
        <div id="releasedTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-success text-white"><i class="fa-solid fa-paper-plane"></i> Released Documents</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-success">
                <tr>
                  <th>Student Name</th>
                  <th>Document</th>
                  <th>Status</th>
                  <th>Released At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="releasedList"></tbody>
            </table>
          </div>
        </div>

        

        <!-- Unclaimed -->
        <div id="unclaimedTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-secondary text-white"><i class="fa-solid fa-box-archive"></i> Unclaimed Documents</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-secondary">
                <tr>
                  <th>Student Name</th>
                  <th>Document</th>
                  <th>Status</th>
                  <th>Released At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="unclaimedList"></tbody>
            </table>
          </div>
        </div>

      </div> <!-- /tablesContainer -->

    </div> <!-- /dashboardContent -->
  </template>

  <!-- Clearance Template (Pending / Approved / Rejected) -->
  <template id="clearanceTemplate">
    <div id="clearanceContent">
      <div class="row mb-4">
        <div class="col-md-4 mb-16">
          <div class="card text-center shadow-sm card-counter" data-type="pending" onclick="showClearanceTable('pending')">
            <div class="card-body">
              <h5><i class="fa-solid fa-hourglass-half text-warning"></i> Pending Clearances</h5>
              <h3 id="clPendingCount">0</h3>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-16">
          <div class="card text-center shadow-sm card-counter" data-type="approved" onclick="showClearanceTable('approved')">
            <div class="card-body">
              <h5><i class="fa-solid fa-check text-success"></i> Approved Clearances</h5>
              <h3 id="clApprovedCount">0</h3>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-16">
          <div class="card text-center shadow-sm card-counter" data-type="rejected" onclick="showClearanceTable('rejected')">
            <div class="card-body">
              <h5><i class="fa-solid fa-xmark text-danger"></i> Rejected Clearances</h5>
              <h3 id="clRejectedCount">0</h3>
            </div>
          </div>
        </div>
      </div>

      <div id="searchContainerClearance" class="mb-3 d-none">
        <input id="searchInputClearance" class="form-control" placeholder="Search student...">
      </div>

      <div id="clearanceTablesContainer">
        <div id="clPendingTable" class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white"><i class="fa-solid fa-clipboard-list"></i> Pending Clearances</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-primary">
                <tr>
                  <th>Student Name</th>
                  <th>Payment Status</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="clPendingList"></tbody>
            </table>
          </div>
        </div>

        <div id="clApprovedTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-success text-white"><i class="fa-solid fa-check"></i> Approved Clearances</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-success">
                <tr>
                  <th>Student Name</th>
                  <th>Payment Status</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="clApprovedList"></tbody>
            </table>
          </div>
        </div>

        <div id="clRejectedTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-danger text-white"><i class="fa-solid fa-xmark"></i> Rejected Clearances</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-danger">
                <tr>
                  <th>Student Name</th>
                  <th>Payment Status</th>
                  <th>Status</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody id="clRejectedList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Analytics Template -->
  <template id="analyticsTemplate">
    <div id="analyticsContent">
      <div class="analytics-section mb-5">
        <div class="row">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Document Requests by Month and Type</h5>
              </div>
              <div class="card-body">
                <canvas id="analyticsChart" height="80"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- File Upload Modal for releasing processed document(s) -->
  <div class="modal fade" id="clSignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Upload Files to Release</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="onClModalClose()"></button>
        </div>
    <div class="modal-body text-center">
      <div class="mb-4">
        <label class="form-label d-block">Upload Files to Release (optional, multiple)</label>
        <input id="releaseFiles" type="file" class="form-control" multiple />
        <small class="text-muted">Select multiple files to upload for the student to download</small>
      </div>
      <div class="mt-3">
        <button class="btn btn-success btn-lg px-4" onclick="clSaveFiles()">
          <i class="fa-solid fa-check"></i> Save Files
        </button>
      </div>
    </div>
      </div>
    </div>
  </div>

  <!-- Approval Modal for Registrar Clearance (no upload) -->
  <div class="modal fade" id="clApproveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-check-circle text-success"></i> Clearance Approval</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="onClModalClose()"></button>
        </div>
        <div class="modal-body text-center">
          <div class="alert alert-info mb-4">
            <i class="fa-solid fa-info-circle"></i>
            <strong>Approval Process Information:</strong><br>
            By approving this clearance, you are confirming that the student has met all requirements for your department. This action will:
            <ul class="text-start mt-2 mb-0">
              <li>Mark the clearance as approved in your department</li>
              <li>Update the student's clearance status</li>
              <li>Allow the clearance to proceed to the next stage</li>
            </ul>
          </div>
          <p class="mb-4"><strong>Are you sure you want to approve this student's clearance?</strong></p>
          <div class="mt-3">
            <button class="btn btn-success btn-lg px-4" onclick="approveClearanceFromModal()">
              <i class="fa-solid fa-check"></i> Approve Clearance
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Professional Clearance Modal -->
  <div class="modal fade" id="clViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content professional-modal">
        <div class="modal-header professional-header">
          <div class="d-flex align-items-center">
            <div class="header-icon-container">
              <div class="header-icon-bg">
                <i class="fa-solid fa-file-shield"></i>
              </div>
              <div class="header-content">
                <h4 class="modal-title">Clearance Details</h4>
                <p class="modal-subtitle">Student Clearance Information & Status</p>
              </div>
            </div>
          </div>
          <button type="button" class="btn-close professional-close" data-bs-dismiss="modal" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body professional-body">
          <!-- Student Information Card -->
          <div class="info-card professional-card">
            <div class="card-header-professional">
              <div class="header-accent-line"></div>
              <div class="d-flex align-items-center">
                <div class="card-icon-container">
                  <i class="fa-solid fa-user-graduate"></i>
                </div>
                <h6 class="card-title-professional">Student Information</h6>
              </div>
            </div>
            <div class="card-body-professional">
              <div id="clViewStudentInfo" class="student-info-grid">
                <!-- Student info will be populated here -->
              </div>
            </div>
          </div>

          <!-- Document Information Card -->
          <div class="info-card professional-card">
            <div class="card-header-professional">
              <div class="header-accent-line"></div>
              <div class="d-flex align-items-center">
                <div class="card-icon-container">
                  <i class="fa-solid fa-file-lines"></i>
                </div>
                <h6 class="card-title-professional">Document Information</h6>
              </div>
            </div>
            <div class="card-body-professional">
              <div id="clViewInfo" class="info-grid-professional">
                <!-- Content will be populated here -->
              </div>
            </div>
          </div>


          <!-- Office Clearance Status Card -->
          <div class="info-card professional-card">
            <div class="card-header-professional">
              <div class="header-accent-line"></div>
              <div class="d-flex align-items-center">
                <div class="card-icon-container">
                  <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <h6 class="card-title-professional">Office Clearance Status</h6>
              </div>
            </div>
            <div class="card-body-professional">
              <div class="table-container-professional">
                <table class="professional-table">
                  <thead>
                    <tr>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-building"></i>
                          <span>Office</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-check-circle"></i>
                          <span>Status</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-signature"></i>
                          <span>Approved By</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-clock"></i>
                          <span>Updated</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-comment"></i>
                          <span>Reason</span>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="clViewSignatories">
                    <!-- Content will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer professional-footer">
          <button type="button" class="btn-professional btn-secondary-professional" data-bs-dismiss="modal">
            <i class="fa-solid fa-times"></i>
            <span>Close</span>
          </button>
          <button type="button" class="btn-professional btn-primary-professional" onclick="printClearanceDetails(document.getElementById('clViewInfo').innerHTML)">
            <i class="fa-solid fa-print"></i>
            <span>Print</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Professional Modal Styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    .professional-modal {
      border: none;
      border-radius: 20px;
      box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      overflow: hidden;
    }

    /* Professional Header Styles */
    .professional-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: none;
      border-radius: 20px 20px 0 0;
      padding: 32px;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .professional-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }

    .header-icon-container {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
      z-index: 1;
    }

    .header-icon-bg {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
      position: relative;
    }

    .header-icon-bg::before {
      content: '';
      position: absolute;
      inset: 2px;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      border-radius: 16px;
      pointer-events: none;
    }

    .header-icon-bg i {
      font-size: 28px;
      color: white;
      position: relative;
      z-index: 1;
    }

    .header-content h4 {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin: 0;
      line-height: 1.2;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .modal-subtitle {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
      margin: 8px 0 0 0;
      font-weight: 400;
    }

    .professional-close {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      color: white;
      position: relative;
      z-index: 1;
    }

    .professional-close:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .professional-close i {
      font-size: 16px;
    }

    /* Professional Body Styles */
    .professional-body {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 40px;
      border-radius: 0;
    }

    /* Professional Card Styles */
    .professional-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      margin-bottom: 32px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(226, 232, 240, 0.5);
    }

    .professional-card:hover {
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
      transform: translateY(-4px);
    }

    .card-header-professional {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      padding: 24px 32px;
      border-bottom: 1px solid #e2e8f0;
      position: relative;
    }

    .header-accent-line {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
    }

    .card-icon-container {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .card-icon-container i {
      font-size: 18px;
      color: white;
    }

    .card-title-professional {
      font-size: 22px;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
      display: flex;
      align-items: center;
    }

    .card-body-professional {
      padding: 32px;
    }

    /* Professional Grid Styles */
    .info-grid-professional {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 32px;
    }

    .student-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .info-item-professional {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .info-item-professional:hover {
      background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
      border-color: #3b82f6;
      transform: translateY(-2px);
    }

    .info-label-professional {
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-label-professional i {
      font-size: 16px;
      color: #3b82f6;
    }

    .info-value-professional {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      line-height: 1.4;
    }

    /* Progress Overview Styles */
    .progress-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
    }

    .progress-item {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .progress-item:hover {
      background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
      border-color: #3b82f6;
      transform: translateY(-4px);
    }

    .progress-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 20px;
      color: white;
    }

    .progress-icon.completed {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .progress-icon.pending {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .progress-icon.rejected {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .progress-label {
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 8px;
    }

    .progress-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
    }

    /* Professional Table Styles */
    .table-container-professional {
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .professional-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }

    .professional-table thead {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .professional-table th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      color: white;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: none;
      white-space: nowrap;
    }

    .professional-table th:nth-child(1) { width: 25%; } /* Office */
    .professional-table th:nth-child(2) { width: 15%; } /* Status */
    .professional-table th:nth-child(3) { width: 20%; } /* Approved By */
    .professional-table th:nth-child(4) { width: 20%; } /* Updated */
    .professional-table th:nth-child(5) { width: 20%; } /* Reason */

    .th-content {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .th-content i {
      font-size: 14px;
      color: #60a5fa;
    }

    .professional-table td {
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
      font-size: 13px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.4;
    }

    .professional-table td.text-muted {
      font-size: 12px;
      color: #64748b;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .professional-table td small {
      font-size: 11px;
      color: #64748b;
    }

    .professional-table tbody tr {
      transition: all 0.2s ease;
    }

    .professional-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    /* Ensure all content is visible */
    .professional-table td:nth-child(1) { 
      min-width: 120px; 
      max-width: 200px;
    }
    .professional-table td:nth-child(2) { 
      min-width: 80px; 
      max-width: 120px;
    }
    .professional-table td:nth-child(3) { 
      min-width: 100px; 
      max-width: 150px;
    }
    .professional-table td:nth-child(4) { 
      min-width: 100px; 
      max-width: 150px;
    }
    .professional-table td:nth-child(5) { 
      min-width: 100px; 
      max-width: 200px;
    }

    .office-cell-professional {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .office-icon-professional {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .office-cell-professional span {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .office-icon-computer { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8; }
    .office-icon-guidance { background: linear-gradient(135deg, #fce7f3, #fbcfe8); color: #be185d; }
    .office-icon-student { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
    .office-icon-library { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }
    .office-icon-dean { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #3730a3; }
    .office-icon-accounting { background: linear-gradient(135deg, #f3e8ff, #e9d5ff); color: #7c3aed; }
    .office-icon-registrar { background: linear-gradient(135deg, #f0fdf4, #dcfce7); color: #15803d; }

    .status-badge-professional {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      gap: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      max-width: 100%;
    }

    .status-approved-professional {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      color: #166534;
    }

    .status-pending-professional {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }

    .status-rejected-professional {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }

    /* Professional Footer Styles */
    .professional-footer {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: none;
      border-radius: 0 0 20px 20px;
      padding: 24px 32px;
      gap: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .btn-professional {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary-professional {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      color: #64748b;
      border: 1px solid #cbd5e1;
    }

    .btn-secondary-professional:hover {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      color: #475569;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .btn-primary-professional {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary-professional:hover {
      background: linear-gradient(135deg, #1d4ed8, #1e40af);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    /* Enhanced Move to Pending Documents Button - REMOVED (now using automatic transfer) */

    /* Responsive Design */
    @media (max-width: 768px) {
      .professional-modal {
        margin: 16px;
        border-radius: 16px;
      }
      
      .professional-header {
        padding: 24px;
      }
      
      .header-icon-bg {
        width: 56px;
        height: 56px;
      }
      
      .header-content h4 {
        font-size: 28px;
      }
      
      .professional-body {
        padding: 24px;
      }
      
      .card-body-professional {
        padding: 24px;
      }
      
      .info-grid-professional {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .professional-table th,
      .professional-table td {
        padding: 16px;
      }
    }
  </style>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ============================================================
       Sidebar active & dynamic page loads (profile / password)
       ============================================================ */
    function setActive(elem) {
      document.querySelectorAll('#sidebarMenu .nav-link').forEach(l => l.classList.remove('active'));
      if(elem) elem.classList.add('active');
    }

    /* ============================================================
       Registrar Actions (move between states)
       ============================================================ */
    let currentRow = null;
    let clCurrentRow = null;

    // Helpers to normalize API fields
    function getCourseDisplay(student) {
      return (
        student.course ||
        student.course_name ||
        student.program ||
        student.course_code ||
        student.course_abbr ||
        ''
      );
    }

    function getYearLevelDisplay(student) {
      return (
        student.year_level_name ||
        student.year_level ||
        student.year ||
        student.level ||
        ''
      );
    }

    /* ============================================================
       SweetAlert Functions
       ============================================================ */
    function logout() {
      Swal.fire({
        title: 'Logout',
        text: 'Are you sure you want to logout?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Logout',
        cancelButtonText: 'Cancel'
      }).then(async (result) => {
        if (!result.isConfirmed) return;
        try {
          await fetch('/api/logout', { method: 'POST' });
        } catch (_) {}
        Swal.fire({
          title: 'Logged Out',
          text: 'You have been successfully logged out.',
          icon: 'success',
          confirmButtonText: 'OK'
        }).then(() => { window.location.href = 'login.html'; });
      });
    }

    // Move a pending item to processing
    async function moveToProcessing(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      if (!requestId) {
        Swal.fire('Error', 'Request ID not found', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/registrar/mark-processing', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            request_id: Number(requestId)
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const processingList = document.getElementById('processingList');
          if (processingList) {
            const newRow = document.createElement('tr');
            newRow.dataset.requestId = requestId;
            newRow.dataset.studentId = row.dataset.studentId;
            newRow.innerHTML = `
              <td>${row.cells[0].textContent}</td>
              <td>${row.cells[1].textContent}</td>
              <td class="status-pending">Processing</td>
              <td class="pickup-date-display">
                <span class="text-muted">Not set</span>
              </td>
              <td>
                <button class="btn btn-info btn-sm me-2" onclick="setPickupDate(this)"><i class='fa-solid fa-calendar'></i> Set Pickup Date</button>
                <button class="btn btn-success btn-sm" onclick="markAsCompleted(this)"><i class='fa-solid fa-upload'></i> Upload File</button>
              </td>
            `;
            processingList.appendChild(newRow);
          }
          row.remove();
          updateCounters();
          showTable('processing');
          
          // Show success message based on clearance status
          if (data.clearance_status === 'approved') {
            Swal.fire({
              icon: 'success',
              title: ' All Clearances Approved',
              text: data.message || 'Document is now in processing.',
              timer: 3000,
              showConfirmButton: false
            });
          } else {
            Swal.fire({
              icon: 'success',
              title: 'Document Processing Started',
              text: data.message || 'Document has been moved to processing status.',
              timer: 2000,
              showConfirmButton: false
            });
          }
        } else {
          // Show error message based on clearance status
          let icon = 'error';
          let title = 'Cannot Process Document';
          
          if (data.clearance_status === 'pending') {
            icon = 'warning';
            title = ' Clearances Still Pending';
          } else if (data.clearance_status === 'rejected') {
            icon = 'error';
            title = ' Clearances Rejected';
          } else if (data.clearance_status === 'incomplete') {
            icon = 'warning';
            title = ' Incomplete Clearances';
          }
          
          Swal.fire({
            icon: icon,
            title: title,
            text: data.message || 'Failed to start processing',
            confirmButtonText: 'OK'
          });
        }
      } catch (error) {
        console.error('Error moving to processing:', error);
        Swal.fire('Error', 'Network error occurred', 'error');
      }
    }

    // Move a processing item to completed
    async function moveToCompleted(row) {
      const requestId = row.dataset.requestId;
      const studentId = row.dataset.studentId;
      
      if (!requestId) {
        console.error('Request ID not found');
        return;
      }
      
      try {
        const completedList = document.getElementById('completedList');
        if (completedList) {
          const newRow = document.createElement('tr');
          newRow.dataset.requestId = requestId;
          newRow.dataset.studentId = studentId;
          
          // Get the pickup date from the processing row
          const pickupDateCell = row.querySelector('.pickup-date-display');
          const pickupDate = pickupDateCell ? pickupDateCell.innerHTML : '<span class="text-muted">Not set</span>';
          
          newRow.innerHTML = `
            <td>${row.cells[0].textContent}</td>
            <td>${row.cells[1].textContent}</td>
            <td class="text-success fw-semibold">Completed</td>
            <td>${new Date().toLocaleString()}</td>
            <td>${pickupDate.includes('Not set') ? '' : formatPickupDate(pickupDate.replace(/<[^>]*>/g, ''))}</td>
            <td>
              <button class="btn btn-outline-primary btn-sm me-2" onclick="openViewClearance(${requestId})"><i class="fa-solid fa-eye"></i> View Clearance</button>
              <button class="btn btn-primary btn-sm" onclick="moveToReleased(this)"><i class='fa-solid fa-paper-plane'></i> Released Documents</button>
              <button class="btn btn-secondary btn-sm ms-2" onclick="moveToUnclaimed(this)"><i class='fa-solid fa-box-archive'></i> Unclaimed Documents</button>
            </td>
          `;
          completedList.appendChild(newRow);
        }
        
        // Remove from processing list
        row.remove();
        updateCounters();
        showTable('completed');
        
      } catch (error) {
        console.error('Error moving to completed:', error);
      }
    }

    // Mark a processing item as released
    async function markReleased(btn) {
      const row = btn.closest('tr');
      const studentId = row.dataset.studentId;
      
      if (!studentId) {
        Swal.fire('Error', 'Student ID not found', 'error');
        return;
      }
      
      // Open file upload modal for registrar to upload files
      currentRow = row;
      const modalEl = document.getElementById('clSignModal');
      const bs = new bootstrap.Modal(modalEl);
      // Clear any previous file selection
      const fileInput = document.getElementById('releaseFiles');
      if (fileInput) fileInput.value = '';
      bs.show();
    }

    // Reject from a select dropdown (works for pending or processing rows)
    async function rejectFromSelect(select) {
      const reason = select.value;
      if(!reason) return;
      const row = select.closest('tr');
      const requestId = row.dataset.requestId;
      
      if (!requestId) {
        Swal.fire('Error', 'Request ID not found', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/registrar/document-requests/reject', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            request_id: Number(requestId),
            reason: reason
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const rejectedList = document.getElementById('rejectedList');
          if (rejectedList) {
            const newRow = document.createElement('tr');
            newRow.dataset.studentId = currentRow.dataset.studentId || '';
          newRow.setAttribute('role', 'row');
          newRow.innerHTML = `
              <td>${row.cells[0].textContent}</td>
              <td>${row.cells[1].textContent}</td>
              <td class="status-rejected">Rejected</td>
              <td>${reason}</td>
            `;
            rejectedList.appendChild(newRow);
          }
          row.remove();
          updateCounters();
          showTable('rejected');
          Swal.fire({ icon: 'warning', title: 'Document Rejected', text: reason });
        } else {
          Swal.fire('Error', data.message || 'Failed to reject document', 'error');
        }
      } catch (error) {
        console.error('Error rejecting document:', error);
        Swal.fire('Error', 'Network error occurred', 'error');
      }
    }


    // Mark released item as unclaimed
    async function markUnclaimed(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      if (requestId) {
        try { await fetch('/api/registrar/mark-unclaimed', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({request_id: Number(requestId)})}); } catch(_){ }
      }
      const unclaimedList = document.getElementById('unclaimedList');
      if (unclaimedList) {
        const newRow = document.createElement('tr');
        newRow.dataset.studentId = currentRow.dataset.studentId || '';
          newRow.setAttribute('role', 'row');
          newRow.innerHTML = `
          <td>${row.cells[0].textContent}</td>
          <td>${row.cells[1].textContent}</td>
          <td class="text-secondary fw-semibold">Unclaimed</td>
          <td>${row.cells[3].textContent}</td>
        `;
        unclaimedList.appendChild(newRow);
      }
      row.remove();
      updateCounters();
      showTable('unclaimed');
    }

    /* ============================================================
       Counters / showTable / search
       ============================================================ */
    function updateCounters() {
      // Update pending count
      const pendingCount = document.querySelectorAll('#pendingList tr').length;
      const pendingEl = document.getElementById('pendingCount');
      if (pendingEl) {
        pendingEl.innerHTML = `<h3>${pendingCount}</h3>`;
        pendingEl.className = '';
      }
      
      // Update processing count
      const processingCount = document.querySelectorAll('#processingList tr').length;
      const processingEl = document.getElementById('processingCount');
      if (processingEl) {
        processingEl.innerHTML = `<h3>${processingCount}</h3>`;
        processingEl.className = '';
      }
      
      // Update completed count
      const completedCount = document.querySelectorAll('#completedList tr').length;
      const completedEl = document.getElementById('completedCount');
      if (completedEl) {
        completedEl.innerHTML = `<h3>${completedCount}</h3>`;
        completedEl.className = '';
      }
      
      // Update released count
      const releasedCount = document.querySelectorAll('#releasedList tr').length;
      const releasedEl = document.getElementById('releasedCount');
      if (releasedEl) {
        releasedEl.innerHTML = `<h3>${releasedCount}</h3>`;
        releasedEl.className = '';
      }
      
      // Update unclaimed count
      const unclaimedCount = document.querySelectorAll('#unclaimedList tr').length;
      const unclaimedEl = document.getElementById('unclaimedCount');
      if (unclaimedEl) {
        unclaimedEl.innerHTML = `<h3>${unclaimedCount}</h3>`;
        unclaimedEl.className = '';
      }
      
      // Update nav badge for dashboard
      updateDashboardBadge(pendingCount);
    }
    
    /* ============================================================
       Update Navigation Badges
       ============================================================ */
    async function updateNavBadges() {
      try {
        // Fetch pending documents count for Dashboard badge
        const dashboardRes = await fetch('/api/registrar/document-requests?status=pending');
        if (dashboardRes.ok) {
          const dashboardData = await dashboardRes.json();
          const dashboardCount = dashboardData.ok && dashboardData.data ? dashboardData.data.length : 0;
          updateDashboardBadge(dashboardCount);
        }
        
        // Fetch pending clearances count for Clearance badge
        const clearanceRes = await fetch('/api/signatories/pending?office=Registrar');
        if (clearanceRes.ok) {
          const clearanceData = await clearanceRes.json();
          const clearanceCount = clearanceData.ok && clearanceData.data ? clearanceData.data.length : 0;
          updateClearanceBadge(clearanceCount);
        }
      } catch (error) {
        console.error('Error updating nav badges:', error);
      }
    }
    
    function updateDashboardBadge(count) {
      const dashboardBadge = document.getElementById('dashboardBadge');
      if (dashboardBadge) {
        if (count > 0) {
          dashboardBadge.textContent = count;
          dashboardBadge.style.display = 'flex';
        } else {
          dashboardBadge.style.display = 'none';
        }
      }
    }
    
    function updateClearanceBadge(count) {
      const clearanceBadge = document.getElementById('clearanceBadge');
      if (clearanceBadge) {
        if (count > 0) {
          clearanceBadge.textContent = count;
          clearanceBadge.style.display = 'flex';
        } else {
          clearanceBadge.style.display = 'none';
        }
      }
    }

    async function showTable(type, showFullScreenLoading = true) {
      // Show full-screen loading overlay only if requested
      if (showFullScreenLoading && window.buttonLoadingManager) {
        window.buttonLoadingManager.showFullScreenLoading('Loading Documents...');
      }
      
      try {
        // hide all - check if elements exist before manipulating
        const pendingTable = document.getElementById('pendingTable');
        const processingTable = document.getElementById('processingTable');
        const completedTable = document.getElementById('completedTable');
        const releasedTable = document.getElementById('releasedTable');
        const unclaimedTable = document.getElementById('unclaimedTable');
        
        if (pendingTable) pendingTable.classList.add('d-none');
        if (processingTable) processingTable.classList.add('d-none');
        if (completedTable) completedTable.classList.add('d-none');
        if (releasedTable) releasedTable.classList.add('d-none');
        if (unclaimedTable) unclaimedTable.classList.add('d-none');

        // show search
        const searchContainer = document.getElementById('searchContainer');
        if (searchContainer) searchContainer.classList.remove('d-none');

        // remove active
        document.querySelectorAll('.card-counter').forEach(c => c.classList.remove('active'));

        if(type === 'pending') {
          if (pendingTable) pendingTable.classList.remove('d-none');
          const pendingCounter = document.querySelector(".card-counter[data-type='pending']");
          if (pendingCounter) pendingCounter.classList.add('active');
          await loadPendingDocuments();
        } else if(type === 'processing') {
          if (processingTable) processingTable.classList.remove('d-none');
          const processingCounter = document.querySelector(".card-counter[data-type='processing']");
          if (processingCounter) processingCounter.classList.add('active');
          await loadProcessingDocuments();
        } else if(type === 'completed') {
          if (completedTable) completedTable.classList.remove('d-none');
          const completedCounter = document.querySelector(".card-counter[data-type='completed']");
          if (completedCounter) completedCounter.classList.add('active');
          await loadCompletedDocuments();
        } else if(type === 'released') {
          if (releasedTable) releasedTable.classList.remove('d-none');
          const releasedCounter = document.querySelector(".card-counter[data-type='released']");
          if (releasedCounter) releasedCounter.classList.add('active');
          await loadReleasedDocuments();
        } else if(type === 'unclaimed') {
          if (unclaimedTable) unclaimedTable.classList.remove('d-none');
          const unclaimedCounter = document.querySelector(".card-counter[data-type='unclaimed']");
          if (unclaimedCounter) unclaimedCounter.classList.add('active');
          await loadUnclaimedDocuments();
        }
      } finally {
        // Hide full-screen loading overlay only if it was shown
        if (showFullScreenLoading && window.buttonLoadingManager) {
          window.buttonLoadingManager.hideFullScreenLoading();
        }
      }
    }

    // Format pickup date to readable words with time
    function formatPickupDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const now = new Date();
        // Normalize times for day comparison
        const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startOfThatDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const diffDays = Math.round((startOfThatDay - startOfToday) / (1000 * 60 * 60 * 24));
        const timePart = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        if (diffDays < 0) return 'Overdue';
        if (diffDays === 0) return `Today, ${timePart}`;
        if (diffDays === 1) return `Tomorrow, ${timePart}`;
        if (diffDays <= 7) return `In ${diffDays} days, ${timePart}`;
        const datePart = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        return `${datePart}, ${timePart}`;
      } catch (error) {
        return dateString;
      }
    }

    // search input behavior (delegated)
    document.addEventListener('keyup', function(e) {
      if(e.target && e.target.id === 'searchInput') {
        const q = e.target.value.toLowerCase();
        const tbody = document.querySelector('#tablesContainer .card:not(.d-none) tbody');
        if(!tbody) return;
        Array.from(tbody.children).forEach(r => {
          r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      }
    });

    // Clearance: delegated search
    document.addEventListener('keyup', function(e) {
      if(e.target && e.target.id === 'searchInputClearance') {
        const q = e.target.value.toLowerCase();
        const tbody = document.querySelector('#clearanceTablesContainer .card:not(.d-none) tbody');
        if(!tbody) return;
        Array.from(tbody.children).forEach(r => {
          r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      }
    });

    /* ============================================================
       Status determination function (same as Student Dashboard)
       ============================================================ */
    function getEffectiveStatus(req){
      const raw = (req.status || '').toString().trim().toLowerCase();
      const signatories = Array.isArray(req.signatories) ? req.signatories : [];
      const requestType = req.request_type || 'clearance';
      
      // Handle consolidated requests (clearance + document combined)
      if (requestType === 'consolidated') {
        if (raw === 'completed') return 'completed';
        if (raw === 'processing') return 'processing';
        if (raw === 'rejected') return 'rejected';
        if (raw === 'released') return 'released';
        return 'pending';
      }
      
      // Handle document requests (post-auto-transfer)
      if (requestType === 'document') {
        if (raw === 'completed') return 'completed';
        if (raw === 'released') return 'released';
        if (raw === 'processing') return 'processing';
        if (raw === 'rejected') return 'rejected';
        if (raw === 'unclaimed') return 'released';
        return 'pending';
      }
      
      // Handle standalone document requests (no signatories) - legacy support
      if (signatories.length === 0) {
        if (raw === 'completed') return 'completed';
        if (raw === 'released') return 'released';
        if (raw === 'processing') return 'processing';
        if (raw === 'rejected') return 'rejected';
        return 'pending';
      }
      
      // Handle clearance requests (with signatories)
      const hasAnyRejected = signatories.some(function(s){ return (s.status || '').toString().toLowerCase() === 'rejected'; });
      const allApproved = signatories.length > 0 && signatories.every(function(s){ return (s.status || '').toString().toLowerCase() === 'approved'; });

      // If any office rejected, whole request is Rejected
      if (hasAnyRejected) {
        return 'rejected';
      }

      // If not all signatories have approved yet, remain Pending
      if (!allApproved) {
        return 'pending';
      }

      // All signatories approved  rely on Registrar fulfillment status
      if (raw === 'processing') return 'processing';
      if (raw === 'rejected') return 'rejected';
      if (raw === 'completed') return 'completed';
      if (raw === 'released') return 'released';

      // Default when Registrar has not started
      return 'pending';
    }

    /* ============================================================
       Load Registrar documents by status
       ============================================================ */
    async function loadPendingDocuments() {
      try {
        // Use the dedicated document-requests endpoint to avoid backend schema mismatches
        const response = await fetch('/api/registrar/document-requests?status=pending');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        const tbody = document.getElementById('pendingList');
        if (!tbody) {
          console.warn('pendingList element not found');
          return;
        }
        tbody.innerHTML = '';
        
        if (data.ok && data.data) {
          data.data.forEach(doc => {
            const tr = document.createElement('tr');
            tr.dataset.requestId = doc.request_id || doc.id || '';
            tr.dataset.studentId = doc.student_id || doc.id || '';
            tr.dataset.requestType = doc.request_type || 'clearance';
            
            // Add auto-transfer indicator for document requests
            let autoTransferBadge = '';
            let clearanceStatusBadge = '';
            
            if (doc.request_type === 'document' && doc.auto_transferred_at) {
              const transferTime = new Date(doc.auto_transferred_at).toLocaleString();
              autoTransferBadge = `
                <div class="mt-1">
                  <span class="badge bg-success" title="Auto-transferred at ${transferTime}">
                    <i class="fa-solid fa-robot me-1"></i>Auto-transferred
                  </span>
                </div>
              `;
            }
            
            // Add clearance status indicator for documents from clearance requests
            if (doc.clearance_request_id || doc.clearance_status) {
              let statusClass = 'bg-secondary';
              let statusText = 'Clearance Status Unknown';
              let statusIcon = 'fa-question';
              
              if (doc.clearance_status === 'approved' || doc.clearance_status === 'no_clearance_required') {
                statusClass = 'bg-success';
                statusText = doc.clearance_status === 'no_clearance_required' ? 'No Clearance Required' : 'All Clearances Approved';
                statusIcon = 'fa-check';
              } else if (doc.clearance_status === 'pending') {
                statusClass = 'bg-warning';
                statusText = 'Clearances Pending';
                statusIcon = 'fa-clock';
              } else if (doc.clearance_status === 'rejected') {
                statusClass = 'bg-danger';
                statusText = 'Clearances Rejected';
                statusIcon = 'fa-times';
              }
              
              clearanceStatusBadge = `
                <div class="mt-1">
                  <span class="badge ${statusClass}" title="${statusText}">
                    <i class="fa-solid ${statusIcon} me-1"></i>${statusText}
                  </span>
                </div>
              `;
            }
            
            // Determine document type based on documents field
            let documentType = '';
            // For clearance_requests, prioritize documents/document field over document_type
            // For document_requests, document_type is the primary field
            if (doc.request_type === 'clearance') {
              // First check document field (set by backend from documents column)
              if (doc.document && doc.document !== doc.document_type) {
                documentType = doc.document;
              }
              // Then check documents array (for clearance_requests)
              else if (doc.documents) {
                // Check if documents is already an array (from backend parsing)
                if (Array.isArray(doc.documents) && doc.documents.length > 0) {
                  documentType = doc.documents.join(', ');
                }
                // Otherwise try to parse as JSON string
                else if (typeof doc.documents === 'string') {
                  try {
                    const documents = JSON.parse(doc.documents);
                    if (Array.isArray(documents) && documents.length > 0) {
                      documentType = documents.join(', ');
                    } else {
                      // If not array after parsing, use as is
                      documentType = doc.documents;
                    }
                  } catch (e) {
                    // If JSON parse fails, use as string
                    documentType = doc.documents;
                  }
                }
              }
              // Fallback to document_type only if documents/document not available
              else if (doc.document_type) {
                documentType = doc.document_type;
              }
            } else {
              // For document_requests, use document_type first
              if (doc.document_type) {
                documentType = doc.document_type;
              } 
              // Then check document field (set by backend)
              else if (doc.document) {
                documentType = doc.document;
              }
            }

            // Determine clearance status
            let clearanceStatusText = 'No Clearance';
            let clearanceStatusClass = 'bg-secondary';
            let clearanceStatusIcon = 'fa-question';
            
            if (doc.clearance_request_id) {
              if (doc.clearance_status === 'Approved') {
                clearanceStatusText = 'All Clearances Approved';
                clearanceStatusClass = 'bg-success';
                clearanceStatusIcon = 'fa-check';
              } else if (doc.clearance_status === 'Pending') {
                clearanceStatusText = 'Clearances Pending';
                clearanceStatusClass = 'bg-warning';
                clearanceStatusIcon = 'fa-clock';
              } else if (doc.clearance_status === 'Rejected') {
                clearanceStatusText = 'Clearances Rejected';
                clearanceStatusClass = 'bg-danger';
                clearanceStatusIcon = 'fa-times';
              } else {
                clearanceStatusText = 'Clearance Status Unknown';
                clearanceStatusClass = 'bg-secondary';
                clearanceStatusIcon = 'fa-question';
              }
            }

            // Determine the status to display
            let statusText = 'Pending';
            let statusClass = 'status-pending';
            
            // If this is a document request from a clearance (has clearance_request_id), show "Completed"
            if (doc.request_type === 'document' && doc.clearance_request_id) {
              statusText = 'Completed';
              statusClass = 'status-completed';
            }

            tr.innerHTML = `
              <td>
                ${doc.student_name || (doc.first_name + ' ' + doc.last_name)}
                ${autoTransferBadge}
              </td>
              <td>${documentType}</td>
              <td class="${statusClass}">${statusText}</td>
              <td>
                ${doc.clearance_request_id ? 
                  `<button class="btn btn-outline-primary btn-sm me-2" onclick="openViewClearance(${doc.clearance_request_id})"><i class="fa-solid fa-eye"></i> View Clearance</button>` : 
                  ''
                }
                ${(doc.clearance_request_id && doc.clearance_status && doc.clearance_status !== 'Approved') ? 
                  `<button class="btn btn-secondary btn-sm" disabled title="Cannot process - clearances not fully approved"><i class='fa-solid fa-lock'></i> Start Processing</button>` :
                  `<button class="btn btn-primary btn-sm" onclick="moveToProcessing(this)"><i class='fa-solid fa-play'></i> Start Processing</button>`
                }
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        updateCounters();
      } catch (error) {
        console.error('Error loading pending documents:', error);
        addSampleData();
      }
    }

    async function loadProcessingDocuments() {
      try {
        const response = await fetch('/api/registrar/document-requests?status=processing');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        const tbody = document.getElementById('processingList');
        if (!tbody) {
          console.warn('processingList element not found');
          return;
        }
        tbody.innerHTML = '';
        
        if (data.ok && data.data) {
        data.data.forEach(doc => {
          const tr = document.createElement('tr');
          tr.dataset.requestId = doc.request_id || doc.id || '';
          tr.dataset.studentId = doc.student_id || doc.id || '';
            
            // Determine document type based on documents field
            let documentType = '';
            if (doc.documents) {
              try {
                const documents = JSON.parse(doc.documents);
                if (Array.isArray(documents) && documents.length > 0) {
                  documentType = documents.join(', ');
                }
              } catch (e) {
                documentType = doc.documents || '';
              }
            } else if (doc.document_type) {
              // Fallback to document_type if documents is empty
              documentType = doc.document_type;
            } else {
              documentType = '';
            }

            // Determine clearance status
            let clearanceStatusText = 'No Clearance';
            let clearanceStatusClass = 'bg-secondary';
            let clearanceStatusIcon = 'fa-question';
            
            if (doc.clearance_request_id) {
              if (doc.clearance_status === 'Approved') {
                clearanceStatusText = 'All Clearances Approved';
                clearanceStatusClass = 'bg-success';
                clearanceStatusIcon = 'fa-check';
              } else if (doc.clearance_status === 'Pending') {
                clearanceStatusText = 'Clearances Pending';
                clearanceStatusClass = 'bg-warning';
                clearanceStatusIcon = 'fa-clock';
              } else if (doc.clearance_status === 'Rejected') {
                clearanceStatusText = 'Clearances Rejected';
                clearanceStatusClass = 'bg-danger';
                clearanceStatusIcon = 'fa-times';
              } else {
                clearanceStatusText = 'Clearance Status Unknown';
                clearanceStatusClass = 'bg-secondary';
                clearanceStatusIcon = 'fa-question';
              }
            }
            
            tr.innerHTML = `
              <td>${doc.student_name || (doc.first_name + ' ' + doc.last_name)}</td>
              <td>${documentType}</td>
              <td class="status-processing">Processing</td>
              <td class="pickup-date-display">
                ${doc.pickup_date ? 
                  `<span class="text-success"><i class="fa-solid fa-calendar-check"></i> ${formatPickupDate(doc.pickup_date)}</span>` : 
                  '<span class="text-muted">Not set</span>'
                }
              </td>
              <td>
                ${doc.clearance_request_id ? 
                  `<button class="btn btn-outline-primary btn-sm me-2" onclick="openViewClearance(${doc.clearance_request_id})"><i class="fa-solid fa-eye"></i> View Clearance</button>` : 
                  ''
                }
                <button class="btn btn-info btn-sm me-2" onclick="setPickupDate(this)"><i class='fa-solid fa-calendar'></i> Set Pickup Date</button>
                <button class="btn btn-success btn-sm" onclick="markAsCompleted(this)"><i class='fa-solid fa-upload'></i> Upload File</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        updateCounters();
      } catch (error) {
        console.error('Error loading processing documents:', error);
      }
    }

    async function setPickupDate(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      if (!requestId) {
        Swal.fire('Error', 'Request ID not found', 'error');
        return;
      }
      
      // Show date & time picker modal
      const { value: pickupDate } = await Swal.fire({
        title: 'Set Pickup Date',
        html: `
          <div class="mb-3">
            <label for="pickup-date" class="form-label">Pickup Date</label>
            <input type="date" class="form-control" id="pickup-date" required>
          </div>
          <div class="mb-1">
            <label for="pickup-time" class="form-label">Pickup Time</label>
            <input type="time" class="form-control" id="pickup-time" required>
          </div>
          <div class="form-text">Select the date and time when the student can pick up their documents.</div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Set Pickup Date',
        cancelButtonText: 'Cancel',
        focusConfirm: false,
        didOpen: () => {
          const d = document.getElementById('pickup-date');
          const t = document.getElementById('pickup-time');
          try {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const min = String(now.getMinutes()).padStart(2, '0');
            if (d && !d.value) d.value = `${yyyy}-${mm}-${dd}`;
            if (t && !t.value) t.value = `${hh}:${min}`;
          } catch (_) { /* noop */ }
        },
        preConfirm: () => {
          const d = document.getElementById('pickup-date');
          const t = document.getElementById('pickup-time');
          if (!d || !d.value) {
            Swal.showValidationMessage('Please select a date');
            return false;
          }
          if (!t || !t.value) {
            Swal.showValidationMessage('Please select a time');
            return false;
          }
          // Combine into ISO-like string so back-end can parse consistently
          const combined = `${d.value}T${t.value}`;
          return combined;
        }
      });
      
      if (pickupDate) {
        try {
          const response = await fetch('/api/registrar/set-pickup-date', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              request_id: Number(requestId),
              pickup_date: pickupDate
            })
          });
          
          const data = await response.json();
          
          if (data.ok) {
            Swal.fire({
              icon: 'success',
              title: 'Pickup Date Set!',
              text: `Pickup date has been set to ${formatPickupDate(pickupDate)}`,
              timer: 3000,
              showConfirmButton: false
            });
            
            // Update the pickup date display in the table
            const pickupDateCell = row.querySelector('.pickup-date-display');
            if (pickupDateCell) {
              pickupDateCell.innerHTML = `<span class="text-success"><i class="fa-solid fa-calendar-check"></i> ${formatPickupDate(pickupDate)}</span>`;
            }
            
            // Update the button to show it's been set
            const setDateBtn = row.querySelector('button[onclick="setPickupDate(this)"]');
            if (setDateBtn) {
              setDateBtn.innerHTML = '<i class="fa-solid fa-calendar-check"></i> Update Pickup Date';
              setDateBtn.classList.remove('btn-info');
              setDateBtn.classList.add('btn-outline-success');
            }
          } else {
            Swal.fire('Error', data.message || 'Failed to set pickup date', 'error');
          }
        } catch (error) {
          console.error('Error setting pickup date:', error);
          Swal.fire('Error', 'Failed to set pickup date', 'error');
        }
      }
    }

    async function loadCompletedDocuments() {
      try {
        const response = await fetch('/api/registrar/document-requests?status=completed');
        const data = await response.json();
        const tbody = document.getElementById('completedList');
        if (!tbody) {
          console.warn('completedList element not found');
          return;
        }
        tbody.innerHTML = '';
        
        if (data.ok && data.data) {
          data.data.forEach(doc => {
            const tr = document.createElement('tr');
            tr.dataset.requestId = doc.request_id || doc.id || '';
            tr.dataset.studentId = doc.student_id || doc.id || '';
            tr.dataset.requestType = doc.request_type || 'clearance';
            
            // Determine document type based on documents field
            let documentType = '';
            if (doc.documents) {
              try {
                const documents = JSON.parse(doc.documents);
                if (Array.isArray(documents) && documents.length > 0) {
                  documentType = documents.join(', ');
                }
              } catch (e) {
                documentType = doc.documents || '';
              }
            } else if (doc.document_type) {
              // Fallback to document_type if documents is empty
              documentType = doc.document_type;
            } else {
              documentType = '';
            }

            tr.innerHTML = `
              <td>${doc.student_name || (doc.first_name + ' ' + doc.last_name)}</td>
              <td>${documentType}</td>
              <td class="text-success fw-semibold">Completed</td>
              <td>${doc.completed_at || new Date().toLocaleString()}</td>
              <td>${doc.pickup_date ? formatPickupDate(doc.pickup_date) : ''}</td>
              <td>
                ${doc.clearance_request_id ? 
                  `<button class="btn btn-outline-primary btn-sm me-2" onclick="openViewClearance(${doc.clearance_request_id})"><i class="fa-solid fa-eye"></i> View Clearance</button>` : 
                  ''
                }
                <button class="btn btn-primary btn-sm" onclick="moveToReleased(this)"><i class='fa-solid fa-paper-plane'></i> Released Documents</button>
                <button class="btn btn-secondary btn-sm ms-2" onclick="moveToUnclaimed(this)"><i class='fa-solid fa-box-archive'></i> Unclaimed Documents</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        updateCounters();
      } catch (error) {
        console.error('Error loading completed documents:', error);
      }
    }

    async function moveToReleased(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      try {
        const response = await fetch('/api/registrar/mark-released', {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({request_id: Number(requestId)})
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const list = document.getElementById('releasedList');
          if (list){
            const newRow = document.createElement('tr');
            newRow.dataset.requestId = requestId;
            newRow.dataset.studentId = row.dataset.studentId;
            newRow.innerHTML = `
              <td>${row.cells[0].textContent}</td>
              <td>${row.cells[1].textContent}</td>
              <td class="text-success fw-semibold">Released</td>
              <td>${new Date().toLocaleString()}</td>
              <td>
                <button class="btn btn-secondary btn-sm" onclick="markUnclaimed(this)"><i class='fa-solid fa-box-archive'></i> Mark Unclaimed</button>
              </td>
            `;
            list.appendChild(newRow);
          }
          row.remove();
          updateCounters();
          showTable('released');
          
          Swal.fire({
            icon: 'success',
            title: 'Document Released!',
            text: 'Document has been moved to released status.',
            timer: 3000,
            showConfirmButton: false
          });
        } else {
          Swal.fire('Error', data.message || 'Failed to release document', 'error');
        }
      } catch (error) {
        console.error('Error releasing document:', error);
        Swal.fire('Error', 'Failed to release document', 'error');
      }
    }

    async function releaseClearanceDocument(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      if (!requestId) {
        Swal.fire('Error', 'Request ID not found', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/registrar/release-document', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            request_id: Number(requestId)
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Document Released!',
            text: 'Document has been released and student has been notified.',
            timer: 3000,
            showConfirmButton: false
          });
          
          // Move to released table
          const list = document.getElementById('releasedList');
          if (list){
            const newRow = document.createElement('tr');
            newRow.dataset.requestId = requestId;
            newRow.dataset.studentId = row.dataset.studentId;
            newRow.innerHTML = `
              <td>${row.cells[0].textContent}</td>
              <td>${row.cells[1].textContent}</td>
              <td class="text-success fw-semibold">Released</td>
              <td>${new Date().toLocaleString()}</td>
              <td>
                <button class="btn btn-secondary btn-sm" onclick="markUnclaimed(this)"><i class='fa-solid fa-box-archive'></i> Mark Unclaimed</button>
              </td>
            `;
            list.appendChild(newRow);
          }
          row.remove();
          updateCounters();
          showTable('released');
        } else {
          Swal.fire('Error', data.message || 'Failed to release document', 'error');
        }
      } catch (error) {
        console.error('Error releasing clearance document:', error);
        Swal.fire('Error', 'Failed to release document', 'error');
      }
    }

    async function moveToUnclaimed(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      try {
        const response = await fetch('/api/registrar/mark-unclaimed', {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({request_id: Number(requestId)})
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const list = document.getElementById('unclaimedList');
          if (list){
            const newRow = document.createElement('tr');
            newRow.dataset.requestId = requestId;
            newRow.dataset.studentId = row.dataset.studentId;
            newRow.innerHTML = `
              <td>${row.cells[0].textContent}</td>
              <td>${row.cells[1].textContent}</td>
              <td class="text-secondary fw-semibold">Unclaimed</td>
              <td>${new Date().toLocaleString()}</td>
              <td>
                <button class="btn btn-primary btn-sm" onclick="markReleased(this)"><i class='fa-solid fa-paper-plane'></i> Mark Released</button>
              </td>
            `;
            list.appendChild(newRow);
          }
          row.remove();
          updateCounters();
          showTable('unclaimed');
          
          Swal.fire({
            icon: 'success',
            title: 'Document Marked as Unclaimed!',
            text: 'Document has been moved to unclaimed status.',
            timer: 3000,
            showConfirmButton: false
          });
        } else {
          Swal.fire('Error', data.message || 'Failed to mark document as unclaimed', 'error');
        }
      } catch (error) {
        console.error('Error marking document as unclaimed:', error);
        Swal.fire('Error', 'Failed to mark document as unclaimed', 'error');
      }
    }

    async function markReleased(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      try {
        const response = await fetch('/api/registrar/mark-released', {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({request_id: Number(requestId)})
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const list = document.getElementById('releasedList');
          if (list){
            const newRow = document.createElement('tr');
            newRow.dataset.requestId = requestId;
            newRow.dataset.studentId = row.dataset.studentId;
            newRow.innerHTML = `
              <td>${row.cells[0].textContent}</td>
              <td>${row.cells[1].textContent}</td>
              <td class="text-success fw-semibold">Released</td>
              <td>${new Date().toLocaleString()}</td>
              <td>
                <button class="btn btn-secondary btn-sm" onclick="markUnclaimed(this)"><i class='fa-solid fa-box-archive'></i> Mark Unclaimed</button>
              </td>
            `;
            list.appendChild(newRow);
          }
          row.remove();
          updateCounters();
          showTable('released');
          
          Swal.fire({
            icon: 'success',
            title: 'Document Released!',
            text: 'Document has been moved to released status.',
            timer: 3000,
            showConfirmButton: false
          });
        } else {
          Swal.fire('Error', data.message || 'Failed to release document', 'error');
        }
      } catch (error) {
        console.error('Error releasing document:', error);
        Swal.fire('Error', 'Failed to release document', 'error');
      }
    }

    async function markUnclaimed(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      try {
        const response = await fetch('/api/registrar/mark-unclaimed', {
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify({request_id: Number(requestId)})
        });
        
        const data = await response.json();
        
        if (data.ok) {
          const list = document.getElementById('unclaimedList');
          if (list){
            const newRow = document.createElement('tr');
            newRow.dataset.requestId = requestId;
            newRow.dataset.studentId = row.dataset.studentId;
            newRow.innerHTML = `
              <td>${row.cells[0].textContent}</td>
              <td>${row.cells[1].textContent}</td>
              <td class="text-secondary fw-semibold">Unclaimed</td>
              <td>${new Date().toLocaleString()}</td>
              <td>
                <button class="btn btn-primary btn-sm" onclick="markReleased(this)"><i class='fa-solid fa-paper-plane'></i> Mark Released</button>
              </td>
            `;
            list.appendChild(newRow);
          }
          row.remove();
          updateCounters();
          showTable('unclaimed');
          
          Swal.fire({
            icon: 'success',
            title: 'Document Marked as Unclaimed!',
            text: 'Document has been moved to unclaimed status.',
            timer: 3000,
            showConfirmButton: false
          });
        } else {
          Swal.fire('Error', data.message || 'Failed to mark document as unclaimed', 'error');
        }
      } catch (error) {
        console.error('Error marking document as unclaimed:', error);
        Swal.fire('Error', 'Failed to mark document as unclaimed', 'error');
      }
    }

    async function markAsCompleted(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      
      if (!requestId) {
        Swal.fire('Error', 'Request ID not found', 'error');
        return;
      }
      
      // Check if pickup date is set
      const pickupDateCell = row.querySelector('.pickup-date-display');
      const hasPickupDate = pickupDateCell && (
        pickupDateCell.textContent.includes('calendar-check') || 
        pickupDateCell.textContent.includes('Not set') === false ||
        pickupDateCell.querySelector('.text-success') !== null ||
        pickupDateCell.innerHTML.includes('text-success')
      );
      
      if (!hasPickupDate) {
        const { value: setPickupFirst } = await Swal.fire({
          title: 'Pickup Date Required',
          text: 'Please set a pickup date before uploading the file.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Set Pickup Date First',
          cancelButtonText: 'Cancel'
        });
        
        if (setPickupFirst) {
          await setPickupDate(btn);
        }
        return;
      }
      
      // Proceed with file upload
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.pdf,.doc,.docx,.jpg,.jpeg,.png';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('files[]', file);
        formData.append('request_id', requestId);
        
        try {
          const response = await fetch('/api/registrar/upload-document', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          if (data.ok) {
              Swal.fire({
                icon: 'success',
                title: 'File Uploaded!',
                text: 'Document has been uploaded and moved to completed status. You can now release it when ready.',
                timer: 3000,
                showConfirmButton: false
              });
            
            // Move to completed table
            moveToCompleted(row);
            updateCounters();
          } else {
            Swal.fire('Error', data.message || 'Failed to upload file', 'error');
          }
        } catch (error) {
          console.error('Error uploading file:', error);
          Swal.fire('Error', 'Failed to upload file', 'error');
        }
      };
      
      input.click();
    }


    async function loadReleasedDocuments() {
      try {
        const response = await fetch('/api/registrar/document-requests?status=released');
        const data = await response.json();
        
        const tbody = document.getElementById('releasedList');
        if (!tbody) {
          console.warn('releasedList element not found');
          return;
        }
        tbody.innerHTML = '';
        
        if (data.ok && data.data) {
          data.data.forEach(doc => {
            const tr = document.createElement('tr');
            tr.dataset.requestId = doc.request_id || doc.id || '';
            tr.dataset.studentId = doc.student_id || doc.id || '';
            
            // Determine document type based on documents field
            let documentType = '';
            if (doc.documents) {
              try {
                const documents = JSON.parse(doc.documents);
                if (Array.isArray(documents) && documents.length > 0) {
                  documentType = documents.join(', ');
                }
              } catch (e) {
                documentType = doc.documents || '';
              }
            } else if (doc.document_type) {
              // Fallback to document_type if documents is empty
              documentType = doc.document_type;
            } else {
              documentType = '';
            }

            // Determine clearance status
            let clearanceStatusText = 'No Clearance';
            let clearanceStatusClass = 'bg-secondary';
            let clearanceStatusIcon = 'fa-question';
            
            if (doc.clearance_request_id) {
              if (doc.clearance_status === 'Approved') {
                clearanceStatusText = 'All Clearances Approved';
                clearanceStatusClass = 'bg-success';
                clearanceStatusIcon = 'fa-check';
              } else if (doc.clearance_status === 'Pending') {
                clearanceStatusText = 'Clearances Pending';
                clearanceStatusClass = 'bg-warning';
                clearanceStatusIcon = 'fa-clock';
              } else if (doc.clearance_status === 'Rejected') {
                clearanceStatusText = 'Clearances Rejected';
                clearanceStatusClass = 'bg-danger';
                clearanceStatusIcon = 'fa-times';
              } else {
                clearanceStatusText = 'Clearance Status Unknown';
                clearanceStatusClass = 'bg-secondary';
                clearanceStatusIcon = 'fa-question';
              }
            }
            
            tr.innerHTML = `
              <td>${doc.student_name || (doc.first_name + ' ' + doc.last_name)}</td>
              <td>${documentType}</td>
              <td class="text-success fw-semibold">Released</td>
              <td>${doc.released_at || new Date().toLocaleString()}</td>
              <td>
                ${doc.clearance_request_id ? 
                  `<button class="btn btn-outline-primary btn-sm me-2" onclick="openViewClearance(${doc.clearance_request_id})"><i class="fa-solid fa-eye"></i> View Clearance</button>` : 
                  ''
                }
                <button class="btn btn-secondary btn-sm" onclick="markUnclaimed(this)"><i class='fa-solid fa-box-archive'></i> Mark Unclaimed</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          console.error('Error loading released documents:', data.message || 'Unknown error');
        }
        updateCounters();
      } catch (error) {
        console.error('Error loading released documents:', error);
        Swal.fire('Error', 'Failed to load released documents', 'error');
      }
    }

    async function loadRejectedDocuments() {
      try {
        const response = await fetch('/api/registrar/document-requests?status=rejected');
        const data = await response.json();
        
        const tbody = document.getElementById('rejectedList');
        tbody.innerHTML = '';
        
        if (data.ok && data.data) {
          data.data.forEach(doc => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${doc.student_name || (doc.first_name + ' ' + doc.last_name)}</td>
              <td>${doc.documents ? (Array.isArray(JSON.parse(doc.documents)) ? JSON.parse(doc.documents).join(', ') : doc.documents) : ''}</td>
              <td class="status-rejected">Rejected</td>
              <td>${doc.rejection_reason || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        updateCounters();
      } catch (error) {
        console.error('Error loading rejected documents:', error);
      }
    }

    async function loadUnclaimedDocuments() {
      try {
        const response = await fetch('/api/registrar/document-requests?status=unclaimed');
        const data = await response.json();
        
        const tbody = document.getElementById('unclaimedList');
        if (!tbody) {
          console.warn('unclaimedList element not found');
          return;
        }
        tbody.innerHTML = '';
        
        if (data.ok && data.data) {
          data.data.forEach(doc => {
            const tr = document.createElement('tr');
            tr.dataset.requestId = doc.request_id || doc.id || '';
            tr.dataset.studentId = doc.student_id || doc.id || '';
            
            // Determine document type based on documents field
            let documentType = '';
            if (doc.documents) {
              try {
                const documents = JSON.parse(doc.documents);
                if (Array.isArray(documents) && documents.length > 0) {
                  documentType = documents.join(', ');
                }
              } catch (e) {
                documentType = doc.documents || '';
              }
            } else if (doc.document_type) {
              // Fallback to document_type if documents is empty
              documentType = doc.document_type;
            } else {
              documentType = '';
            }

            // Determine clearance status
            let clearanceStatusText = 'No Clearance';
            let clearanceStatusClass = 'bg-secondary';
            let clearanceStatusIcon = 'fa-question';
            
            if (doc.clearance_request_id) {
              if (doc.clearance_status === 'Approved') {
                clearanceStatusText = 'All Clearances Approved';
                clearanceStatusClass = 'bg-success';
                clearanceStatusIcon = 'fa-check';
              } else if (doc.clearance_status === 'Pending') {
                clearanceStatusText = 'Clearances Pending';
                clearanceStatusClass = 'bg-warning';
                clearanceStatusIcon = 'fa-clock';
              } else if (doc.clearance_status === 'Rejected') {
                clearanceStatusText = 'Clearances Rejected';
                clearanceStatusClass = 'bg-danger';
                clearanceStatusIcon = 'fa-times';
              } else {
                clearanceStatusText = 'Clearance Status Unknown';
                clearanceStatusClass = 'bg-secondary';
                clearanceStatusIcon = 'fa-question';
              }
            }
            
            tr.innerHTML = `
              <td>${doc.student_name || (doc.first_name + ' ' + doc.last_name)}</td>
              <td>${documentType}</td>
              <td class="text-secondary fw-semibold">Unclaimed</td>
              <td>${doc.released_at || doc.updated_at || ''}</td>
              <td>
                ${doc.clearance_request_id ? 
                  `<button class="btn btn-outline-primary btn-sm me-2" onclick="openViewClearance(${doc.clearance_request_id})"><i class="fa-solid fa-eye"></i> View Clearance</button>` : 
                  ''
                }
                <button class="btn btn-primary btn-sm" onclick="markReleased(this)"><i class='fa-solid fa-paper-plane'></i> Mark Released</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          console.error('Error loading unclaimed documents:', data.message || 'Unknown error');
        }
        updateCounters();
      } catch (error) {
        console.error('Error loading unclaimed documents:', error);
        Swal.fire('Error', 'Failed to load unclaimed documents', 'error');
      }
    }

    /* ============================================================
       Load Analytics Data and Display Charts
       ============================================================ */
    let analyticsChart = null;

    async function loadAnalytics() {
      try {
        const response = await fetch('/api/registrar/analytics');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (!data.ok) {
          console.error('Error loading analytics:', data.message || 'Unknown error');
          return;
        }

        const analyticsData = data.data;
        
        // Destroy existing chart if it exists
        if (analyticsChart) {
          analyticsChart.destroy();
        }

        // Create grouped bar chart
        const ctx = document.getElementById('analyticsChart');
        if (!ctx) {
          console.warn('analyticsChart canvas not found');
          return;
        }

        // Months are on x-axis (bottom), percentage on y-axis (side)
        const months = analyticsData.months || [];
        const datasets = analyticsData.datasets || [];

        analyticsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: months, // Months at the bottom (x-axis)
            datasets: datasets // Document types as separate series
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  boxWidth: 12,
                  padding: 10,
                  font: {
                    size: 11
                  }
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    const label = context.dataset.label || '';
                    const value = context.parsed.y || 0;
                    return `${label}: ${value}%`;
                  }
                }
              },
              title: {
                display: false
              }
            },
            scales: {
              x: {
                stacked: false,
                title: {
                  display: true,
                  text: 'Months',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                },
                ticks: {
                  font: {
                    size: 10
                  }
                }
              },
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Percentage (%)',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                },
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  },
                  font: {
                    size: 10
                  },
                  stepSize: 10
                }
              }
            },
            interaction: {
              mode: 'index',
              intersect: false
            }
          }
        });

      } catch (error) {
        console.error('Error loading analytics:', error);
        // Don't show error alert for analytics as it's not critical
      }
    }

    // Add sample data for demo purposes
    function addSampleData() {
      const sampleDocs = [
       
      ];

      const tbody = document.getElementById('pendingList');
      if (!tbody) {
        console.warn('pendingList element not found in addSampleData');
        return;
      }
      tbody.innerHTML = '';
      
      sampleDocs.forEach(doc => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doc.student_name}</td>
          <td>${doc.documents ? (Array.isArray(JSON.parse(doc.documents)) ? JSON.parse(doc.documents).join(', ') : doc.documents) : ''}</td>
          <td class="status-pending">Pending</td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="moveToProcessing(this)"><i class='fa-solid fa-play'></i> Start Processing</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateCounters();
    }

    function loadContent(type) {
      const container = document.getElementById('mainContent');

      if(type === 'dashboard') {
        const template = document.getElementById('dashboardTemplate').content.cloneNode(true);
        container.innerHTML = '';
        container.appendChild(template);
        // Update topbar title
        const topbarTitle = document.querySelector('.topbar-title');
        if (topbarTitle) {
          topbarTitle.textContent = 'Registrar Dashboard';
        }
        // Small delay to ensure DOM is ready
        setTimeout(async () => {
          // Only load documents if the dashboard template is active
          if (document.getElementById('pendingList')) {
            // Load all document types to populate counters
            await Promise.all([
              loadPendingDocuments(),
              loadProcessingDocuments(),
              loadCompletedDocuments(),
              loadReleasedDocuments(),
              loadUnclaimedDocuments()
            ]);
            // Show pending table by default (without full-screen loading)
            showTable('pending', false);
            // Update nav badges after loading data
            updateNavBadges();
          }
        }, 10);
      }

      if(type === 'analytics') {
        const template = document.getElementById('analyticsTemplate').content.cloneNode(true);
        container.innerHTML = '';
        container.appendChild(template);
        // Update topbar title
        const topbarTitle = document.querySelector('.topbar-title');
        if (topbarTitle) {
          topbarTitle.textContent = 'Registrar Analytics';
        }
        // Small delay to ensure DOM is ready
        setTimeout(async () => {
          // Load analytics chart
          if (document.getElementById('analyticsChart')) {
            await loadAnalytics();
          }
        }, 10);
      }

      if(type === 'clearance') {
        const template = document.getElementById('clearanceTemplate').content.cloneNode(true);
        container.innerHTML = '';
        container.appendChild(template);
        // Small delay to ensure DOM is ready
        setTimeout(async () => {
          showClearanceTable('pending');
          // Load clearance data after template is loaded
          await Promise.all([
            loadRegistrarPendingClearances(),
            loadRegistrarApprovedClearances(),
            loadRegistrarRejectedClearances()
          ]);
          updateClearanceCounters();
          // Update nav badges after loading clearance data
          updateNavBadges();
          // init canvas listeners after DOM available
        }, 10);
      }

      if(type === 'profile') {
        loadRegistrarProfile();
      }

      if(type === 'password') {
        container.innerHTML = `
          <div class="card shadow-sm p-4">
            <h5><i class="fa-solid fa-lock"></i> Change Password</h5>
            <form id="passwordForm" class="mt-3">
              <div class="mb-3">
                <label class="form-label">Current Password</label>
                <input id="currentPassword" type="password" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">New Password</label>
                <input id="newPassword" type="password" class="form-control" required minlength="6" />
                <div class="form-text">Password must be at least 6 characters long</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Confirm New Password</label>
                <input id="confirmPassword" type="password" class="form-control" required />
              </div>
              <button class="btn btn-primary" type="submit">Update Password</button>
            </form>
          </div>
        `;
        
        // Add form submission handler
        setTimeout(() => {
          const form = document.getElementById('passwordForm');
          if(form) {
            form.addEventListener('submit', handlePasswordChange);
          }
        }, 100);
      }
    }

    // Handle password change
    async function handlePasswordChange(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Client-side validation
      if (!currentPassword || !newPassword || !confirmPassword) {
        Swal.fire('Error', 'All fields are required!', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        Swal.fire('Error', 'New Password and Confirm Password do not match!', 'error');
        return;
      }
      
      if (newPassword.length < 6) {
        Swal.fire('Error', 'New password must be at least 6 characters long!', 'error');
        return;
      }
      
      // Show loading
      Swal.fire({
        title: 'Updating Password...',
        text: 'Please wait while we update your password',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      try {
        const response = await fetch('/api/registrar/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Password Updated!',
            text: 'Your password has been successfully updated.',
            confirmButtonText: 'OK'
          }).then(() => {
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Password Update Failed',
            text: data.message || 'An error occurred while updating your password.',
            confirmButtonText: 'Try Again'
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Unable to connect to server. Please check your connection and try again.',
          confirmButtonText: 'OK'
        });
      }
    }

    // Load Registrar information from database
    async function loadRegistrarInfo() {
      try {
        const response = await fetch('/api/staff/me');
        const data = await response.json();
        
        if (data.ok && (data.staff_info || data.user)) {
          const registrar = data.staff_info || data.user;
          const name = registrar.full_name || [registrar.first_name, registrar.last_name].filter(Boolean).join(' ');
          const nameEl = document.getElementById('registrarName');
          if (nameEl) nameEl.textContent = name || 'Registrar';
          return registrar;
        }
      } catch (error) {
        console.error('Error loading registrar info:', error);
      }
      return null;
    }

    // Load Registrar profile with real data - Professional Design
    async function loadRegistrarProfile() {
      const container = document.getElementById('mainContent');
      
      try {
        const registrar = await loadRegistrarInfo();
        
        if (registrar) {
          // Format dates
          const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          };

          // Format full name
          const fullName = `${registrar.first_name || ''} ${registrar.middle_name || ''} ${registrar.last_name || ''} ${registrar.suffix || ''}`.replace(/\s+/g, ' ').trim();

          container.innerHTML = `
            <!-- Professional Profile Header -->
            <div class="profile-header">
              <div class="profile-avatar">
                <div class="avatar-circle">
                  <i class="fa-solid fa-user-tie"></i>
                </div>
                <div class="profile-status">
                  <span class="status-indicator active"></span>
                  <span class="status-text">Active</span>
                </div>
              </div>
              <div class="profile-info">
                <h2 class="profile-name">${fullName}</h2>
                ${registrar.department || registrar.office ? `
                <p class="profile-title">${registrar.department || registrar.office || 'Registrar'}</p>
                ` : ''}
                ${registrar.email ? `
                <p class="profile-email">
                  <i class="fa-solid fa-envelope"></i>
                  ${registrar.email}
                </p>
                ` : ''}
                ${registrar.created_at ? `
                <p class="profile-joined">
                  <i class="fa-solid fa-calendar"></i>
                  Member since ${formatDate(registrar.created_at)}
                </p>
                ` : ''}
              </div>
            </div>

            <!-- Professional Profile Cards -->
            <div class="profile-cards-grid">
              <!-- Personal Information Card -->
              <div class="profile-card">
                <div class="card-header">
                  <div class="card-icon personal">
                    <i class="fa-solid fa-user"></i>
                  </div>
                  <h3>Personal Information</h3>
                </div>
                <div class="card-content">
                  <div class="info-grid">
                    ${registrar.first_name ? `
                    <div class="info-item">
                      <label>First Name</label>
                      <span>${registrar.first_name}</span>
                    </div>
                    ` : ''}
                    ${registrar.last_name ? `
                    <div class="info-item">
                      <label>Last Name</label>
                      <span>${registrar.last_name}</span>
                    </div>
                    ` : ''}
                    ${registrar.middle_name ? `
                    <div class="info-item">
                      <label>Middle Name</label>
                      <span>${registrar.middle_name}</span>
                    </div>
                    ` : ''}
                    ${registrar.suffix ? `
                    <div class="info-item">
                      <label>Suffix</label>
                      <span>${registrar.suffix}</span>
                    </div>
                    ` : ''}
                    ${registrar.gender ? `
                    <div class="info-item">
                      <label>Gender</label>
                      <span>${registrar.gender}</span>
                    </div>
                    ` : ''}
                    ${registrar.department || registrar.office ? `
                    <div class="info-item">
                      <label>Department</label>
                      <span>${registrar.department || registrar.office || 'Registrar'}</span>
                    </div>
                    ` : ''}
                    ${registrar.address ? `
                    <div class="info-item full-width">
                      <label>Address</label>
                      <span>${registrar.address}</span>
                    </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              <!-- Contact Information Card -->
              <div class="profile-card">
                <div class="card-header">
                  <div class="card-icon contact">
                    <i class="fa-solid fa-phone"></i>
                  </div>
                  <h3>Contact Information</h3>
                </div>
                <div class="card-content">
                  <div class="info-grid">
                    ${registrar.email ? `
                    <div class="info-item full-width">
                      <label>Email Address</label>
                      <span>
                        <i class="fa-solid fa-envelope" style="margin-right: 8px; color: var(--primary-500);"></i>
                        ${registrar.email}
                      </span>
                    </div>
                    ` : ''}
                    ${registrar.contact_no ? `
                    <div class="info-item full-width">
                      <label>Contact Number</label>
                      <span>
                        <i class="fa-solid fa-phone" style="margin-right: 8px; color: var(--success-500);"></i>
                        ${registrar.contact_no}
                      </span>
                    </div>
                    ` : ''}
                    ${registrar.created_at ? `
                    <div class="info-item full-width">
                      <label>Member Since</label>
                      <span>
                        <i class="fa-solid fa-calendar" style="margin-right: 8px; color: var(--warning-500);"></i>
                        ${formatDate(registrar.created_at)}
                      </span>
                    </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Actions -->
            <div class="profile-actions">
              <div class="action-buttons">
                <button class="btn btn-primary" onclick="loadContent('password')">
                  <i class="fa-solid fa-key"></i> Change Password
                </button>
              </div>
            </div>

            <!-- Information Notice -->
            <div class="profile-notice">
              <div class="notice-content">
                <i class="fa-solid fa-info-circle"></i>
                <div>
                  <strong>Profile Information Notice:</strong>
                  <p>Your profile information is read-only and managed by the system administrator. To update your information, please contact your HR department or system administrator.</p>
                </div>
              </div>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="profile-error">
              <div class="error-icon">
                <i class="fa-solid fa-exclamation-triangle"></i>
              </div>
              <h3>Unable to Load Profile</h3>
              <p>We couldn't load your profile information. This might be due to a network issue or server problem.</p>
              <button class="btn btn-primary" onclick="loadRegistrarProfile()">
                <i class="fa-solid fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        container.innerHTML = `
          <div class="profile-error">
            <div class="error-icon">
              <i class="fa-solid fa-times-circle"></i>
            </div>
            <h3>Error Loading Profile</h3>
            <p>An error occurred while loading your profile information. Please refresh the page and try again.</p>
            <button class="btn btn-primary" onclick="loadRegistrarProfile()">
              <i class="fa-solid fa-refresh"></i> Retry
            </button>
          </div>
        `;
      } finally {
        // Hide loading after profile is loaded
        if (window.hideFullScreenLoading) {
          window.hideFullScreenLoading();
        }
      }
    }

    // Auto-transfer monitoring variables
    let autoTransferInterval = null;
    let lastTransferCheck = null;
    let processedTransfers = new Set();

    // Real-time auto-transfer monitoring
    function startAutoTransferMonitoring() {
      if (autoTransferInterval) {
        clearInterval(autoTransferInterval);
      }
      
      autoTransferInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/registrar/check-auto-transfers');
          const data = await response.json();
          
          if (data.ok && data.transfers && data.transfers.length > 0) {
            // Check for new transfers
            data.transfers.forEach(transfer => {
              const transferKey = `${transfer.clearance_request_id}_${transfer.document_request_id}`;
              
              if (!processedTransfers.has(transferKey)) {
                processedTransfers.add(transferKey);
                showAutoTransferNotification(transfer);
                
                // Refresh the pending documents table if we're on dashboard
                if (document.getElementById('pendingList')) {
                  loadPendingDocuments();
                  updateCounters();
                }
              }
            });
          }
        } catch (error) {
          console.warn('Auto-transfer monitoring error:', error);
        }
      }, 3000); // Check every 3 seconds
    }

    function stopAutoTransferMonitoring() {
      if (autoTransferInterval) {
        clearInterval(autoTransferInterval);
        autoTransferInterval = null;
      }
    }

    function showAutoTransferNotification(transfer) {
      const studentName = transfer.student_name || 'Student';
      const transferTime = new Date(transfer.transferred_at).toLocaleString();
      
      Swal.fire({
        icon: 'success',
        title: 'All Clearances Approved!',
        html: `
          <div style="text-align: left;">
            <p><strong>Student:</strong> ${studentName}</p>
            <p><strong>Status:</strong> Record moved to Pending Documents</p>
            <p><strong>Time:</strong> ${transferTime}</p>
            <p><strong>Reason:</strong> All office clearances approved</p>
          </div>
        `,
        confirmButtonText: 'View Pending Documents',
        confirmButtonColor: '#198754',
        showCancelButton: true,
        cancelButtonText: 'Close',
        timer: 8000,
        timerProgressBar: true,
        allowOutsideClick: false
      }).then((result) => {
        if (result.isConfirmed) {
          // Switch to dashboard and show pending documents
          loadContent('dashboard');
          setTimeout(() => {
            showTable('pending');
          }, 100);
        }
      });
    }

    // Sidebar toggle functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mainContent = document.querySelector('.main-content');
    const overlay = document.getElementById('sidebarOverlay');

    // Desktop sidebar toggle
    if (sidebarToggle) {
      sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('expanded');
        mainContent.classList.toggle('sidebar-expanded');
      });
    }

    // Mobile menu toggle
    if (mobileMenuToggle) {
      mobileMenuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
        document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
      });
    }

    // Close sidebar when clicking overlay
    if (overlay) {
      overlay.addEventListener('click', function() {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
      });
    }

    // Close sidebar on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        sidebar.classList.remove('open');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
      }
    });

    // On page load, show dashboard
    window.onload = function() {
      loadContent('dashboard');
      loadRegistrarInfo(); // Load registrar name in topbar
      const settings = document.getElementById('settingsMenu');
      if(settings) settings.classList.remove('show');

      const modalEl = document.getElementById('clSignModal');
      if (modalEl) {
        modalEl.addEventListener('hidden.bs.modal', function() { onClModalClose(); });
      }
      
      // Update nav badges on page load
      updateNavBadges();
      
      // Auto-fix disabled - use manual "Move to Pending Documents" button instead
      
      // Disable auto-transfer monitoring to avoid unnecessary requests
      // startAutoTransferMonitoring();
    };

    // Fix missing transfers function
    async function fixMissingTransfers() {
      try {
        const response = await fetch('/api/registrar/fix-missing-transfers', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        
        if (result.ok && result.fixed_count > 0) {
          console.log(`Fixed ${result.fixed_count} missing transfers`);
          // Refresh the pending documents if we're on the dashboard
          if (document.getElementById('pendingTable') && !document.getElementById('pendingTable').classList.contains('d-none')) {
            await loadPendingDocuments();
            updateCounters();
          }
        }
      } catch (error) {
        console.error('Error fixing missing transfers:', error);
      }
    }

    // Stop monitoring when page is unloaded
    window.addEventListener('beforeunload', function() {
      stopAutoTransferMonitoring();
    });

    /* ============================================================
       Clearance: Modal handlers
       ============================================================ */
    function onClModalClose(){ 
      if(clCurrentRow){ 
        const sel = clCurrentRow.querySelector('.reason-dropdown'); 
        if(sel && sel.dataset.disabledBeforeSign){ 
          sel.disabled=false; 
          delete sel.dataset.disabledBeforeSign; 
        } 
        clCurrentRow=null; 
      } 
      // Clear file input
      const fileInput = document.getElementById('releaseFiles');
      if (fileInput) fileInput.value = '';
    }
    // Open approval modal for clearance signing (no file upload)
    function openClApproveModal(btn){ 
      // Show brief loading for better UX
      if (window.buttonLoadingManager) {
        window.buttonLoadingManager.showFullScreenLoading('Opening Approval Modal...');
      }
      
      clCurrentRow = btn.closest('tr'); 
      const sel = clCurrentRow.querySelector('.reason-dropdown'); 
      if(sel){ 
        sel.dataset.disabledBeforeSign="1"; 
        sel.disabled=true; 
      } 
      const mEl=document.getElementById('clApproveModal'); 
      const bs=new bootstrap.Modal(mEl); 
      bs.show();
      
      // Hide loading after modal is shown
      setTimeout(() => {
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.hideFullScreenLoading();
        }
      }, 300);
    }
    // Keep clSignModal for document releasing only
    function openClSignModal(btn){ clCurrentRow = btn.closest('tr'); const sel = clCurrentRow.querySelector('.reason-dropdown'); if(sel){ sel.dataset.disabledBeforeSign="1"; sel.disabled=true; } const mEl=document.getElementById('clApproveModal'); const bs=new bootstrap.Modal(mEl); bs.show(); }
    async function clSaveFiles(){ 
      try { 
        // Show full-screen loading overlay
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.showFullScreenLoading('Processing Request...');
        }
        
        // Check if this is a document release (from processing) or clearance approval
        if (currentRow) {
          // This is a document release from processing
          const requestId = currentRow.dataset.requestId;
          const studentId = currentRow.dataset.studentId;
          
          if (!requestId) {
            Swal.fire('Error', 'Request ID not found', 'error');
            return;
          }
          
          // Build multipart with any uploaded files
          const formData = new FormData();
          formData.append('request_id', Number(requestId));
          const fileInput = document.getElementById('releaseFiles');
          if (fileInput && fileInput.files && fileInput.files.length){
            Array.from(fileInput.files).forEach(f => formData.append('files[]', f));
          }
          
          console.log('Sending request to complete document:', requestId);
          const response = await fetch('/api/registrar/document-requests/complete',{ method:'POST', body: formData });
          const result = await response.json();
          
          console.log('Response from server:', result);
          
          if (!result.ok) {
            Swal.fire({
              icon: 'error',
              title: 'Upload Failed',
              text: result.message || 'Failed to upload files and complete document request'
            });
            return;
          }
          
          // Move to completed documents (new stage)
          const completedList = document.getElementById('completedList');
          if (completedList) {
            const completedAt = new Date().toLocaleString();
            const newRow = document.createElement('tr');
            newRow.dataset.requestId = requestId;
            newRow.dataset.studentId = studentId;
            // Get pickup date from the processing row if available
            const pickupDateCell = currentRow.querySelector('.pickup-date-display');
            const pickupDate = pickupDateCell ? pickupDateCell.innerHTML : '<span class="text-muted">Not set</span>';
            
            newRow.innerHTML = `
              <td>${currentRow.cells[0].textContent}</td>
              <td>${currentRow.cells[1].textContent}</td>
              <td class="text-success fw-semibold">Completed</td>
              <td>${completedAt}</td>
              <td>${pickupDate.includes('Not set') ? '' : formatPickupDate(pickupDate.replace(/<[^>]*>/g, ''))}</td>
              <td>
                <button class="btn btn-primary btn-sm" onclick="moveToReleased(this)"><i class='fa-solid fa-paper-plane'></i> Released Documents</button>
                <button class="btn btn-secondary btn-sm ms-2" onclick="moveToUnclaimed(this)"><i class='fa-solid fa-box-archive'></i> Unclaimed Documents</button>
              </td>
            `;
            completedList.appendChild(newRow);
          }
          currentRow.remove();
          updateCounters();
          showTable('completed');
          
          let successMessage = 'Files uploaded. Document marked as Completed.';
          if (result.files && result.files.length > 0) {
            successMessage += ` ${result.files.length} file(s) uploaded successfully.`;
          }
          Swal.fire({icon:'success', title:'Completed!', text: successMessage});
        } else if (clCurrentRow) {
          await approveClearanceFromModal(true);
        } else {
          Swal.fire('Error', 'No document selected', 'error');
          return;
        }
      } catch(error) {
        console.error('Error in clSaveFiles:', error);
        Swal.fire({icon:'error', title:'Error', text:'Failed to save files.'});
      } finally {
        // Hide full-screen loading overlay
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.hideFullScreenLoading();
        }
      }
      
      // Close modal and cleanup
      const mEl=document.getElementById('clSignModal'); 
      const bs=bootstrap.Modal.getInstance(mEl); 
      if(bs) bs.hide();
      
      // Clear variables
      currentRow = null;
      clCurrentRow = null;
      
      // Clear file input
      const fileInput = document.getElementById('releaseFiles');
      if (fileInput) fileInput.value = ''; 
    }

    // Approve clearance from approval modal (shared by clSaveFiles when called during clearance flow)
    async function approveClearanceFromModal(fromClSave){ 
      try { 
        // Show full-screen loading overlay
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.showFullScreenLoading('Approving Clearance...');
        }
        
        if(!clCurrentRow) return; 
        const studentId = clCurrentRow.dataset.studentId; 
        const requestId = clCurrentRow.dataset.requestId;
        
        // Make the API call and check the response
        const response = await fetch('/api/registrar/release',{ 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify({ student_id: Number(studentId) }) 
        }); 
        
        // Parse the response
        const result = await response.json();
        
        // Check if the API call was successful
        if (!response.ok || !result.ok) {
          throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const approvedList = document.getElementById('clApprovedList'); 
        if (approvedList) { 
          const newRow = document.createElement('tr'); 
          newRow.dataset.requestId = clCurrentRow.dataset.requestId; 
          newRow.dataset.studentId = clCurrentRow.dataset.studentId; 
          newRow.innerHTML = `
            <td>${clCurrentRow.cells[0].textContent}</td>
            <td class="payment-status-cell">${clCurrentRow.cells[1].innerHTML}</td>
            <td class="status-cell status-signed">Approved</td>
            <td class="clearance-status-cell"></td>
          `; 
          approvedList.appendChild(newRow);
          
          // Use the new function to properly check all clearances
          resolveApprovedActionCell(newRow, Number(requestId), Number(studentId));
        } 
        
        clCurrentRow.remove(); 
        updateClearanceCounters(); 
        showClearanceTable('approved'); 
        Swal.fire({icon:'success', title:'Clearance Approved!', text:'Student clearance approved.'}); 
      } catch(error) { 
        console.error('Approval failed:', error);
        Swal.fire({
          icon:'error', 
          title:'Error', 
          text:`Failed to approve clearance. ${error.message || 'Please try again.'}`
        }); 
      } finally { 
        // Hide full-screen loading overlay
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.hideFullScreenLoading();
        }
        const mEl=document.getElementById('clApproveModal'); 
        const bs=bootstrap.Modal.getInstance(mEl); 
        if(bs) bs.hide(); 
        if(!fromClSave){ clCurrentRow=null; } 
      } 
    }

    /* ============================================================
       Clearance: Loaders and table switching
       ============================================================ */
    function updateClearanceCounters(){ 
      const pendingCount = document.querySelectorAll('#clPendingList tr').length;
      document.getElementById('clPendingCount').textContent = pendingCount; 
      document.getElementById('clApprovedCount').textContent = document.querySelectorAll('#clApprovedList tr').length; 
      document.getElementById('clRejectedCount').textContent = document.querySelectorAll('#clRejectedList tr').length; 
      
      // Update nav badge for clearance
      updateClearanceBadge(pendingCount);
    }
    async function showClearanceTable(type){ 
      // Show full-screen loading overlay
      if (window.buttonLoadingManager) {
        window.buttonLoadingManager.showFullScreenLoading('Loading Clearances...');
      }
      
      try {
        document.getElementById('clPendingTable').classList.add('d-none'); 
        document.getElementById('clApprovedTable').classList.add('d-none'); 
        document.getElementById('clRejectedTable').classList.add('d-none'); 
        document.getElementById('searchContainerClearance').classList.remove('d-none'); 
        document.querySelectorAll('#clearanceContent .card-counter').forEach(c => c.classList.remove('active')); 
        
        if(type==='pending'){ 
          document.getElementById('clPendingTable').classList.remove('d-none'); 
          document.querySelector("#clearanceContent .card-counter[data-type='pending']").classList.add('active'); 
          await loadRegistrarPendingClearances(); 
        } else if(type==='approved'){ 
          document.getElementById('clApprovedTable').classList.remove('d-none'); 
          document.querySelector("#clearanceContent .card-counter[data-type='approved']").classList.add('active'); 
          await loadRegistrarApprovedClearances(); 
        } else if(type==='rejected'){ 
          document.getElementById('clRejectedTable').classList.remove('d-none'); 
          document.querySelector("#clearanceContent .card-counter[data-type='rejected']").classList.add('active'); 
          await loadRegistrarRejectedClearances(); 
        }
      } finally {
        // Hide full-screen loading overlay
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.hideFullScreenLoading();
        }
      }
    }
    async function loadRegistrarPendingClearances(){ 
      try { 
        const res = await fetch('/api/signatories/pending?office=Registrar'); 
        const data = await res.json(); 
        const tbody = document.getElementById('clPendingList'); 
        if (!tbody) { 
          console.warn('clPendingList element not found'); 
          return; 
        } 
        tbody.innerHTML=''; 
        if(data.ok && data.data){ 
          data.data.forEach(item => { 
          // Build payment status HTML
          let paymentStatusHtml = '';
          // Show receipt button if there's any payment information or receipt data
          if ((item.payment_method && item.payment_amount) || item.payment_receipt || item.payment_details) {
            paymentStatusHtml = `
              <button class="btn btn-info btn-sm view-receipt-btn" onclick='viewReceiptRegistrar(${JSON.stringify(item)})'><i class="fas fa-receipt"></i> View Receipt</button>
            `;
          } else {
            paymentStatusHtml = '<span class="no-receipt-text"><i class="fas fa-receipt"></i> No receipt</span>';
          }
          
          const tr = document.createElement('tr'); 
          tr.dataset.studentId = item.student_id || item.id || ''; 
          tr.dataset.requestId = item.request_id || ''; 
          tr.innerHTML = `
          <td>${(item.first_name||'') + ' ' + (item.last_name||'')}</td>
          <td class="payment-status-cell">${paymentStatusHtml}</td>
          <td class="status-cell status-pending">Pending</td>
          <td class="clearance-status-cell">
            <button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${item.request_id})">View</button>
            <button class="btn-sign" onclick="openClApproveModal(this)">Sign</button>
            <select class="reason-dropdown" onchange="registrarRejectFromSelect(this)">
              <option value="">Reject Reason</option>
              <option>Incomplete Requirements</option>
              <option>Payment Issues</option>
              <option>Record Mismatch</option>
              <option>Other</option>
            </select>
          </td>
        `; tbody.appendChild(tr); 
        }); 
        }
        updateClearanceCounters(); 
      } catch(err){ 
        console.error('Error loading registrar pending:', err); 
      }
    }
    async function loadRegistrarApprovedClearances(){ 
      try { 
        const res = await fetch('/api/signatories/approved?office=Registrar'); 
        const data = await res.json(); 
        const tbody = document.getElementById('clApprovedList'); 
        if (!tbody) { 
          console.warn('clApprovedList element not found'); 
          return; 
        } 
        tbody.innerHTML=''; 
        if(data.ok && data.data){ 
          data.data.forEach(item => { 
          // Build payment status HTML
          let paymentStatusHtml = '';
          // Show receipt button if there's any payment information or receipt data
          if ((item.payment_method && item.payment_amount) || item.payment_receipt || item.payment_details) {
            paymentStatusHtml = `
              <button class="btn btn-info btn-sm view-receipt-btn" onclick='viewReceiptRegistrar(${JSON.stringify(item)})'><i class="fas fa-receipt"></i> View Receipt</button>
            `;
          } else {
            paymentStatusHtml = '<span class="no-receipt-text"><i class="fas fa-receipt"></i> No receipt</span>';
          }
          
          const tr = document.createElement('tr'); 
          tr.dataset.requestId = item.request_id || ''; 
          tr.dataset.studentId = item.student_id || item.id || ''; 
          tr.innerHTML = `
          <td>${(item.first_name||'') + ' ' + (item.last_name||'')}</td>
          <td class="payment-status-cell">${paymentStatusHtml}</td>
          <td class="status-cell status-signed">Approved</td>
          <td class="clearance-status-cell"></td>
        `; tbody.appendChild(tr);
        // Decide whether to show Move button or Already Pending badge
        resolveApprovedActionCell(tr, Number(tr.dataset.requestId), Number(tr.dataset.studentId));
        
        }); 
        }
        updateClearanceCounters(); 
      } catch(err){ 
        console.error('Error loading registrar approved:', err); 
      }
    }

    // Helper to fill action cell for Approved rows - show status instead of action buttons
    async function resolveApprovedActionCell(row, requestId, studentId){
      const cell = row.querySelector('.clearance-status-cell');
      if (!cell) return;
      
      try {
        // Check if already in pending documents for this specific clearance
        const pendingDocRes = await fetch(`/api/registrar/check-pending-doc-request?student_id=${encodeURIComponent(studentId)}&clearance_request_id=${encodeURIComponent(requestId)}`);
        const pendingDocData = await pendingDocRes.json();
        
        if (pendingDocData.ok && pendingDocData.in_pending){
          // Already in pending documents - show completed status
          cell.innerHTML = `<button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${requestId})">View Clearance</button><span class="badge bg-success ms-2"><i class="fa-solid fa-check me-1"></i>Completed</span>`;
          return;
        }
        
        // Check if all clearances are approved
        const clearanceStatusRes = await fetch(`/api/registrar/check-all-clearances-approved?request_id=${encodeURIComponent(requestId)}`);
        const clearanceStatusData = await clearanceStatusRes.json();
        
        if (clearanceStatusData.ok && clearanceStatusData.all_approved) {
          // All clearances approved - show approved status (auto-transferred to documents)
          cell.innerHTML = `
            <button class="btn btn-outline-primary btn-sm me-2" onclick="openViewClearance(${requestId})">View Clearance</button>
            <span class="badge bg-success ms-2"><i class="fa-solid fa-check me-1"></i>Approved</span>
          `;
        } else {
          // Not all clearances approved yet - show pending status (no button)
          const statusMessage = clearanceStatusData.message || "Clearance is still not approved";
          const statusClass = clearanceStatusData.rejected_count > 0 ? 'bg-danger' : 'bg-warning';
          const statusIcon = clearanceStatusData.rejected_count > 0 ? 'fa-times' : 'fa-clock';
          
          cell.innerHTML = `
            <button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${requestId})">View Clearance</button>
            <span class="badge ${statusClass} ms-2" title="${statusMessage}">
              <i class="fa-solid ${statusIcon} me-1"></i>Pending
            </span>
          `;
        }
      } catch (e){
        console.error('Error checking clearance status:', e);
        // Fallback to show completed status on error (since it's in approved list)
        cell.innerHTML = `<button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${requestId})">View Clearance</button><span class="badge bg-success ms-2"><i class="fa-solid fa-check me-1"></i>Completed</span>`;
      }
    }
    async function loadRegistrarRejectedClearances(){ 
      try { 
        const res = await fetch('/api/signatories/rejected?office=Registrar'); 
        const data = await res.json(); 
        const tbody = document.getElementById('clRejectedList'); 
        if (!tbody) { 
          console.warn('clRejectedList element not found'); 
          return; 
        } 
        tbody.innerHTML=''; 
        if(data.ok && data.data){ 
          data.data.forEach(item => { 
          // Build payment status HTML
          let paymentStatusHtml = '';
          // Show receipt button if there's any payment information or receipt data
          if ((item.payment_method && item.payment_amount) || item.payment_receipt || item.payment_details) {
            paymentStatusHtml = `
              <button class="btn btn-info btn-sm view-receipt-btn" onclick='viewReceiptRegistrar(${JSON.stringify(item)})'><i class="fas fa-receipt"></i> View Receipt</button>
            `;
          } else {
            paymentStatusHtml = '<span class="no-receipt-text"><i class="fas fa-receipt"></i> No receipt</span>';
          }
          
          const tr = document.createElement('tr'); 
          tr.innerHTML = `
          <td>${(item.first_name||'') + ' ' + (item.last_name||'')}</td>
          <td class="payment-status-cell">${paymentStatusHtml}</td>
          <td class="status-cell status-rejected">Rejected</td>
          <td>${item.rejection_reason || 'No reason provided'}</td>
        `; tbody.appendChild(tr); 
        }); 
        }
        updateClearanceCounters(); 
      } catch(err){ 
        console.error('Error loading registrar rejected:', err); 
      }
    }
    async function registrarRejectFromSelect(select){ 
      const reason = select.value; 
      if(!reason) return; 
      
      // Show full-screen loading overlay
      if (window.buttonLoadingManager) {
        window.buttonLoadingManager.showFullScreenLoading('Rejecting Clearance...');
      }
      
      const row = select.closest('tr'); 
      const requestId = row.dataset.requestId || ''; 
      try { 
        await fetch('/api/registrar/reject',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ request_id: Number(requestId), reason }) }); 
      } catch(_) {}
      const rejectedList = document.getElementById('clRejectedList'); 
      if (rejectedList) {
        const newRow = document.createElement('tr'); 
        newRow.dataset.studentId = currentRow.dataset.studentId || '';
          newRow.setAttribute('role', 'row');
          newRow.innerHTML = `
          <td>${row.cells[0].textContent}</td>
          <td class="payment-status-cell">${row.cells[1].innerHTML}</td>
          <td class="status-cell status-rejected">Rejected</td>
          <td>${reason}</td>
        `; 
        rejectedList.appendChild(newRow);
      }
      row.remove(); updateClearanceCounters(); showClearanceTable('rejected'); Swal.fire({icon:'warning', title:'Clearance Rejected', text:`Student clearance rejected: ${reason}`}); 
      
      // Hide full-screen loading overlay
      if (window.buttonLoadingManager) {
        window.buttonLoadingManager.hideFullScreenLoading();
      }
    }

    // Move approved clearance back to pending clearances
    async function moveToPendingClearances(btn) {
      const row = btn.closest('tr');
      const requestId = row.dataset.requestId;
      const studentId = row.dataset.studentId;
      
      if (!requestId) {
        Swal.fire('Error', 'Request ID not found', 'error');
        return;
      }
      
      // Show confirmation dialog
      const result = await Swal.fire({
        title: 'Move to Pending Clearances',
        text: 'Are you sure you want to move this approved clearance back to pending clearances?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Move to Pending',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#ffc107'
      });
      
      if (!result.isConfirmed) return;
      
      try {
        const response = await fetch('/api/registrar/move-to-pending', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            request_id: Number(requestId),
            student_id: Number(studentId)
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          // Move the row to pending clearances table
          const pendingList = document.getElementById('clPendingList');
          const newRow = document.createElement('tr');
          newRow.dataset.studentId = studentId;
          newRow.dataset.requestId = requestId;
          newRow.innerHTML = `
            <td>${row.cells[0].textContent}</td>
            <td class="payment-status-cell">${row.cells[1].innerHTML}</td>
            <td class="status-cell status-pending">Pending</td>
            <td class="clearance-status-cell">
              <button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${requestId})">View</button>
              <button class="btn-sign" onclick="openClSignModal(this)">Sign</button>
              <select class="reason-dropdown" onchange="registrarRejectFromSelect(this)">
                <option value="">Reject Reason</option>
                <option>Incomplete Requirements</option>
                <option>Payment Issues</option>
                <option>Record Mismatch</option>
                <option>Other</option>
              </select>
            </td>
          `;
          if (pendingList) {
            pendingList.appendChild(newRow);
          }
          row.remove();
          updateClearanceCounters();
          showClearanceTable('pending');
          
          Swal.fire({
            icon: 'success',
            title: 'Moved to Pending Clearances',
            text: 'Clearance has been moved back to pending clearances.',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          Swal.fire('Error', data.message || 'Failed to move to pending documents', 'error');
        }
      } catch (error) {
        console.error('Error moving to pending documents:', error);
        Swal.fire('Error', 'Network error occurred', 'error');
      }
    }

    // Move approved clearance to pending documents function - REMOVED (now using automatic transfer)


    async function openViewClearance(requestId){ 
      if(!requestId) return; 
      
      // Show full-screen loading overlay
      if (window.buttonLoadingManager) {
        window.buttonLoadingManager.showFullScreenLoading('Loading Clearance Details...');
      }
      
      try { 
        // Add timeout and better error handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
        
        const res = await fetch(`/api/clearance/request/${Number(requestId)}`, {
          signal: controller.signal,
          headers: {
            'Content-Type': 'application/json',
          }
        }); 
        
        clearTimeout(timeoutId);
        
        if (!res.ok) {
          if (res.status === 404) {
            throw new Error('Clearance request not found');
          } else if (res.status === 500) {
            throw new Error('Server error occurred. Please try again.');
          } else {
            throw new Error(`Request failed with status: ${res.status}`);
          }
        }
        
        const data = await res.json(); 
        if(!data.ok){ throw new Error(data.message||'Failed to load clearance details'); } 
        const req = data.request || {}; 
        const sigs = data.signatories || []; 
        const studentInfoEl = document.getElementById('clViewStudentInfo');
        const infoEl = document.getElementById('clViewInfo'); 
        const progressEl = document.getElementById('clViewProgress');
        const tbody = document.getElementById('clViewSignatories'); 
        
        // Populate Student Information
        if(studentInfoEl) {
          const studentName = req.student_name || '';
          const course = req.course || '';
          const yearLevel = req.year_level || '';
          
          studentInfoEl.innerHTML = `
            <div class="info-item-professional">
              <div class="info-label-professional">
                <i class="fa-solid fa-user"></i>
                Student Name
              </div>
              <div class="info-value-professional">${studentName}</div>
            </div>
            <div class="info-item-professional">
              <div class="info-label-professional">
                <i class="fa-solid fa-graduation-cap"></i>
                Course
              </div>
              <div class="info-value-professional">${course}</div>
            </div>
            <div class="info-item-professional">
              <div class="info-label-professional">
                <i class="fa-solid fa-layer-group"></i>
                Year Level
              </div>
              <div class="info-value-professional">${yearLevel}</div>
            </div>
          `;
        }
        
        // Populate Document Information
        if(infoEl) { 
          const documents = (req.documents||[]).join(', ') || (req.document_type||'');
          const purposes = (req.purpose||[]).join(', ') || '';
          
          // Build payment information
          let paymentInfo = '';
          let paymentStatusHtml = '';
          if (req.payment_method) {
            const paymentStatus = req.payment_verified ? 'Paid' : 'Pending';
            const paymentStatusClass = req.payment_verified ? 'status-approved-professional' : 'status-pending-professional';
            const paymentMethod = req.payment_method === 'gcash' ? 'GCash' : 'Cash';
            const paymentAmount = req.payment_amount ? '' + req.payment_amount : '50.00';
            
            paymentInfo = `${paymentMethod} (${paymentAmount})`;
            paymentStatusHtml = `<span class="status-badge-professional ${paymentStatusClass}">${paymentStatus}</span>`;
          } else {
            paymentInfo = '';
            paymentStatusHtml = '<span class="status-badge-professional status-pending-professional">Pending</span>';
          }
          
          // Get overall status
          const overallStatus = req.clearance_status || 'Pending';
          const statusClass = overallStatus.toLowerCase() === 'completed' ? 'status-approved-professional' : 
                            overallStatus.toLowerCase() === 'approved' ? 'status-approved-professional' : 'status-pending-professional';
          
          infoEl.innerHTML = `
            <div class="info-item-professional">
              <div class="info-label-professional">
                <i class="fa-solid fa-file-lines"></i>
                Document Type
              </div>
              <div class="info-value-professional">${documents}</div>
            </div>
            <div class="info-item-professional">
              <div class="info-label-professional">
                <i class="fa-solid fa-bullseye"></i>
                Purpose
              </div>
              <div class="info-value-professional">${purposes}</div>
            </div>
            <div class="info-item-professional">
              <div class="info-label-professional">
                <i class="fa-solid fa-chart-line"></i>
                Overall Status
              </div>
              <div class="info-value-professional">
                <span class="status-badge-professional ${statusClass}">
                  <i class="fa-solid fa-check-circle"></i>${overallStatus}
                </span>
              </div>
            </div>
          `; 
        }
        
        // Populate Progress Overview
        if(progressEl && Array.isArray(sigs)) {
          const totalOffices = sigs.length;
          const approvedCount = sigs.filter(s => s.status === 'approved').length;
          const pendingCount = sigs.filter(s => s.status === 'pending').length;
          const rejectedCount = sigs.filter(s => s.status === 'rejected').length;
          const completionPercentage = totalOffices > 0 ? Math.round((approvedCount / totalOffices) * 100) : 0;
          
          progressEl.innerHTML = `
            <div class="progress-item">
              <div class="progress-icon completed">
                <i class="fa-solid fa-check"></i>
              </div>
              <div class="progress-label">Approved</div>
              <div class="progress-value">${approvedCount}</div>
            </div>
            <div class="progress-item">
              <div class="progress-icon pending">
                <i class="fa-solid fa-clock"></i>
              </div>
              <div class="progress-label">Pending</div>
              <div class="progress-value">${pendingCount}</div>
            </div>
            <div class="progress-item">
              <div class="progress-icon rejected">
                <i class="fa-solid fa-times"></i>
              </div>
              <div class="progress-label">Rejected</div>
              <div class="progress-value">${rejectedCount}</div>
            </div>
            <div class="progress-item">
              <div class="progress-icon completed">
                <i class="fa-solid fa-percentage"></i>
              </div>
              <div class="progress-label">Completion</div>
              <div class="progress-value">${completionPercentage}%</div>
            </div>
          `;
        }
        
        if(tbody){ 
          tbody.innerHTML=''; 
          sigs.forEach(s => { 
            const statusLower = (s.status||'').toLowerCase();
            const statusIcon = statusLower === 'approved' ? 'fa-check-circle' : (statusLower === 'pending' ? 'fa-clock' : 'fa-times-circle');
            const statusClass = statusLower === 'approved' ? 'status-approved-professional' : (statusLower === 'rejected' ? 'status-rejected-professional' : 'status-pending-professional');
            const officeIconClass = getOfficeIconClass(s.office||'');
            const officeIcon = getOfficeIcon(s.office||'');
            const updated = s.updated_at || s.signed_at || '-';
            const reason = s.rejection_reason || '-';
            const signedBy = s.signed_by || '-';
            
            const tr = document.createElement('tr'); 
            tr.innerHTML = `
              <td>
                <div class="office-cell-professional">
                  <div class="office-icon-professional office-icon-${officeIconClass}">
                    <i class="${officeIcon}"></i>
                  </div>
                  <span class="fw-semibold">${s.office}</span>
                </div>
              </td>
              <td>
                <span class="status-badge-professional ${statusClass}">
                  <i class="fa-solid ${statusIcon}"></i>${s.status}
                </span>
              </td>
              <td class="text-muted">${signedBy}</td>
              <td class="text-muted"><small>${updated}</small></td>
              <td class="text-muted">${reason}</td>
            `; 
            tbody.appendChild(tr); 
          }); 
        }
        
        const mEl = document.getElementById('clViewModal'); 
        const bs = new bootstrap.Modal(mEl); 
        bs.show();
      } catch(err){ 
        console.error('view clearance error', err); 
        
        // Handle different types of errors with specific messages
        let errorMessage = 'Unable to load clearance details';
        let errorTitle = 'Error';
        
        if (err.name === 'AbortError') {
          errorTitle = 'Request Timeout';
          errorMessage = 'The request took too long to complete. Please check your internet connection and try again.';
        } else if (err.message.includes('Failed to fetch')) {
          errorTitle = 'Connection Error';
          errorMessage = 'Unable to connect to the server. Please check your internet connection and try again.';
        } else if (err.message.includes('Server error')) {
          errorTitle = 'Server Error';
          errorMessage = 'A server error occurred. Please try again in a few moments.';
        } else if (err.message.includes('not found')) {
          errorTitle = 'Not Found';
          errorMessage = 'The requested clearance could not be found.';
        } else {
          errorMessage = err.message || 'An unexpected error occurred. Please try again.';
        }
        
        Swal.fire({
          icon: 'error', 
          title: errorTitle, 
          text: errorMessage,
          confirmButtonText: 'Try Again',
          showCancelButton: true,
          cancelButtonText: 'Cancel'
        }).then((result) => {
          if (result.isConfirmed) {
            // Retry the request
            openViewClearance(requestId);
          }
        });
      } finally {
        // Hide full-screen loading overlay
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.hideFullScreenLoading();
        }
      }
    }

    // Function to view receipt in Registrar Dashboard - Updated to use modal
    function viewReceiptRegistrar(requestData) {
      console.log(' viewReceiptRegistrar called with data:', requestData);
      
      if (!requestData) {
        Swal.fire({
          icon: 'error',
          title: 'No Receipt Available',
          text: 'Request data not found.',
          confirmButtonText: 'OK'
        });
        return;
      }

      // Check if we have payment information or receipt data
      if (!requestData.payment_method && !requestData.payment_amount && !requestData.payment_details && !requestData.payment_receipt) {
        Swal.fire({
          icon: 'error',
          title: 'No Receipt Available',
          text: 'No payment information or receipt found for this request.',
          confirmButtonText: 'OK'
        });
        return;
      }

      // Use the new modal for receipt viewing
      // Use clearance_request_id for receipt viewing (since receipt API looks in clearance_requests table)
      // Fallback to request_id or id if clearance_request_id is not available
      const requestId = requestData.clearance_request_id || requestData.request_id || requestData.id;
      console.log(' Using request ID:', requestId);
      console.log(' Available fields:', Object.keys(requestData));
      console.log(' clearance_request_id:', requestData.clearance_request_id);
      console.log(' request_id:', requestData.request_id);
      console.log(' id:', requestData.id);
      console.log(' Final requestId for receipt API:', requestId);
      console.log(' requestId type:', typeof requestId);
      console.log(' requestId valid:', requestId && requestId !== 'undefined' && requestId !== 'null');
      console.log(' This should match the clearance_requests.id for receipt viewing');
      
      if (window.showReceiptModal && requestId) {
        console.log(' Using receipt modal for request ID:', requestId);
        try {
          window.showReceiptModal(requestId);
        } catch (error) {
          console.error(' Registrar Dashboard: Error calling receipt modal:', error);
          showReceiptRegistrarFallback(requestData);
        }
      } else {
        // Fallback to old method if modal is not available
        console.warn(' Receipt modal not available, falling back to SweetAlert');
        console.log(' Modal available:', !!window.showReceiptModal);
        console.log(' Request ID:', requestId);
        showReceiptRegistrarFallback(requestData);
      }
    }

    // Fallback function for when modal is not available
    function showReceiptRegistrarFallback(requestData) {
      try {
        // Parse payment details if available
        let paymentDetails = null;
        if (requestData.payment_details) {
          try {
            paymentDetails = typeof requestData.payment_details === 'string' 
              ? JSON.parse(requestData.payment_details) 
              : requestData.payment_details;
          } catch (e) {
            console.warn('Failed to parse payment_details:', e);
            paymentDetails = null;
          }
        }

        let receiptHtml = '<div style="text-align: center; padding: 20px;">';
        
        // Simple receipt format showing amount and reference number (matching student dashboard)
        receiptHtml += '<div style="background: #ffffff; padding: 22px; border-radius: 14px; border: 1px solid #e5e7eb; box-shadow: 0 6px 24px rgba(0,0,0,0.06); text-align:center;">';
        receiptHtml += '<div style="border-bottom: 2px solid #2563eb; padding-bottom: 8px; margin-bottom: 16px;">'
          + '<h5 style="margin:0; color: #111827; font-size: 20px; font-weight: 800;">Payment Receipt</h5>'
        + '</div>';
        
        // Amount paid
        receiptHtml += '<div style="margin-bottom: 14px;">';
        receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Amount Paid</div>';
        receiptHtml += '<div style="font-size: 24px; font-weight: 800; color: #16a34a;">' + (requestData.payment_amount || '50.00') + '</div>';
        receiptHtml += '</div>';
        
        // Reference number
        const referenceNumber = paymentDetails?.reference_number || requestData.reference_number;
        if (referenceNumber && referenceNumber !== 'MANUAL_VERIFY') {
          const rn = referenceNumber;
          receiptHtml += '<div style="margin-bottom: 14px;">';
          receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Reference Number</div>';
          receiptHtml += '<div style="display:flex; align-items:center; justify-content:center; gap:8px;">'
            + '<span style="font-size: 18px; font-weight: 800; color: #2563eb; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", monospace;">' + rn + '</span>'
            + '<button type="button" onclick="navigator.clipboard.writeText(\'' + rn + '\')" class="swal2-styled" style="background:#e5efff; color:#1d4ed8; border:1px solid #bfdbfe; padding:4px 8px; font-size:12px; font-weight:600; border-radius:6px;">Copy</button>'
          + '</div>';
          receiptHtml += '</div>';
        } else if (referenceNumber === 'MANUAL_VERIFY') {
          // Hide registrar note; just show placeholder text until saved
          receiptHtml += '<div style="margin-bottom: 14px;">';
          receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Reference Number</div>';
          receiptHtml += '<span style="font-size: 14px; color: #6b7280;">Not available</span>';
          receiptHtml += '</div>';
        } else {
          receiptHtml += '<div style="margin-bottom: 14px;">';
          receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Reference Number</div>';
          receiptHtml += '<span style="font-size: 14px; color: #6b7280;">Not available</span>';
          receiptHtml += '</div>';
        }
        
        // Payment method
        receiptHtml += '<div style="margin-bottom: 14px;">';
        receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Payment Method</div>';
        receiptHtml += '<span style="font-size: 15px; color: #111827;">' + (requestData.payment_method === 'gcash' ? 'GCash' : 'Cash') + '</span>';
        receiptHtml += '</div>';
        
        // Payment status
        receiptHtml += '<div style="margin-bottom: 14px;">';
        receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Status</div>';
        const awaitingCash = (requestData.payment_method === 'cash' && !requestData.payment_verified);
        const statusColor = awaitingCash ? '#f59e0b' : (requestData.payment_verified ? '#28a745' : '#ffc107');
        const statusText = awaitingCash ? 'Awaiting Onsite Payment' : (requestData.payment_verified ? 'Verified' : 'Pending Verification');
        receiptHtml += '<span style="font-size: 16px; font-weight: bold; color: ' + statusColor + ';">' + statusText + '</span>';
        receiptHtml += '</div>';

        // Receipt image preview (for registrar visibility and student confirmation)
        const receiptS3Url = requestData.payment_receipt_s3_url || (paymentDetails && paymentDetails.receipt_s3_url);
        const receiptB64 = requestData.payment_receipt || (paymentDetails && paymentDetails.receipt_data);
        
        if (receiptS3Url) {
          receiptHtml += '<div style="margin-top: 16px; padding-top: 12px; border-top:1px dashed #e5e7eb;">';
          receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:8px;">Uploaded Receipt</div>';
          receiptHtml += '<img alt="Receipt" src="' + receiptS3Url + '" class="w-full max-w-md mx-auto rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-pointer" onclick="window.open(this.src, \'_blank\')" onerror="console.error(\'Failed to load receipt image from S3\')" />';
          receiptHtml += '</div>';
        } else if (receiptB64) {
          receiptHtml += '<div style="margin-top: 16px; padding-top: 12px; border-top:1px dashed #e5e7eb;">';
          receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:8px;">Uploaded Receipt</div>';
          receiptHtml += '<img alt="Receipt" src="data:image/jpeg;base64,' + receiptB64 + '" class="w-full max-w-md mx-auto rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-pointer" onclick="window.open(this.src, \'_blank\')" />';
          receiptHtml += '</div>';
        }
        
        receiptHtml += '</div></div>';

        Swal.fire({
          title: 'Payment Receipt',
          html: receiptHtml,
          width: 720,
          showConfirmButton: true,
          confirmButtonText: 'Close',
          confirmButtonColor: '#2563eb',
          background: '#ffffff',
          color: '#111827'
        });
      } catch (error) {
        console.error('Error displaying receipt:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to display receipt. Please try again.',
          confirmButtonText: 'OK'
        });
      }
    }
    
    // Helper functions for office icons
    function getOfficeIconClass(office) {
      const officeLower = office.toLowerCase();
      if (officeLower.includes('computer') || officeLower.includes('lab')) return 'computer-lab';
      if (officeLower.includes('guidance')) return 'guidance';
      if (officeLower.includes('student') && officeLower.includes('affairs')) return 'student-affairs';
      if (officeLower.includes('library')) return 'library';
      if (officeLower.includes('dean')) return 'dean';
      if (officeLower.includes('accounting')) return 'accounting';
      if (officeLower.includes('registrar')) return 'registrar';
      return 'computer-lab'; // default
    }
    
    function getOfficeIcon(office) {
      const officeLower = office.toLowerCase();
      if (officeLower.includes('computer') || officeLower.includes('lab')) return 'fa-solid fa-desktop';
      if (officeLower.includes('guidance')) return 'fa-solid fa-heart';
      if (officeLower.includes('student') && officeLower.includes('affairs')) return 'fa-solid fa-users';
      if (officeLower.includes('library')) return 'fa-solid fa-book';
      if (officeLower.includes('dean')) return 'fa-solid fa-user-tie';
      if (officeLower.includes('accounting')) return 'fa-solid fa-calculator';
      if (officeLower.includes('registrar')) return 'fa-solid fa-file-alt';
      return 'fa-solid fa-building'; // default
    }

    // Initialize receipt modal when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log(' Registrar Dashboard: DOM loaded, initializing receipt modal...');
      if (window.receiptModal) {
        console.log(' Registrar Dashboard: Receipt modal already initialized');
      } else {
        console.log(' Registrar Dashboard: Creating new receipt modal instance');
        window.receiptModal = new ReceiptModal();
      }
    });
  </script>
</body>
</html>
