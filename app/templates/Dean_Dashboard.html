<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iRequest</title>
  <link rel="icon" href="/static/assets/iRlogo.png" type="image/x-icon">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Professional SweetAlert Styling -->
  <link rel="stylesheet" href="/static/assets/css/sweetalert-professional.css">
  <!-- SweetAlert Utilities -->
  <script src="/static/assets/js/sweetalert-utils.js"></script>
  <script src="/static/assets/js/loading-utils.js"></script>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    /* Base */
    :root {
      --primary: #0d6efd;
      --bg: #f8f9fa;
    }
    html,body { height:100%; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      margin: 0;
      color: #222;
    }

    /* Layout */
    .container-fluid { padding:0; }
    .row { margin:0; }

    /* Sidebar */
    nav.sidebar {
      min-height:100vh;
      background: var(--primary);
      color: #fff;
      padding: 22px;
    }
    nav.sidebar h4 { margin-bottom:18px; font-weight:600; }
    nav.sidebar .nav-link {
      color: white;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:8px;
    }
    nav.sidebar .nav-link:hover { background: rgba(255,255,255,0.06); text-decoration:none; }
    nav.sidebar .nav-link.active { background: rgba(255,255,255,0.12); font-weight:600; }

    /* Topbar */
    .topbar { background:white; box-shadow:0 2px 8px rgba(0,0,0,0.06); padding:14px 20px; border-radius:6px; }

    /* Counters / cards */
    .card-counter { cursor:pointer; border-radius:12px; transition:.25s; }
    .card-counter:hover { transform: translateY(-6px); box-shadow:0 8px 24px rgba(0,0,0,0.06); }
    .card-counter .card-body h3 { font-weight:700; margin-top:6px; }

    .card-counter.active[data-type="pending"] {
      border:2px solid #facc15; background: rgba(250,204,21,0.06);
    }
    .card-counter.active[data-type="approved"] {
      border:2px solid #198754; background: rgba(25,135,84,0.06);
    }
    .card-counter.active[data-type="rejected"] {
      border:2px solid #dc3545; background: rgba(220,53,69,0.06);
    }

    /* Status classes */
    .status-pending { color:#facc15; font-weight:600; }
    .status-signed  { color:#198754; font-weight:600; }
    .status-rejected{ color:#dc3545; font-weight:600; }

    /* Buttons / selects */
    .btn-sign { background:#198754; color:white; border:none; border-radius:6px; padding:6px 12px; font-weight:600; }
    .btn-sign:hover { background:#157347; }
    .reason-dropdown { border-radius:6px; border:1px solid #ccc; padding:5px; min-width:160px; }

    /* Table */
    table { width:100%; border-collapse:collapse; background:white; border-radius:10px; overflow:hidden; box-shadow:0 6px 20px rgba(0,0,0,0.04); }
    table thead { background:var(--primary); color:white; }
    table thead th { padding:12px; }
    table tbody td { padding:12px; border-bottom:1px solid #f1f1f1; vertical-align:middle; }

    /* Search */
    #searchContainer { margin-bottom:14px; }

    /* Modal canvas */
    .modal-content canvas { border:1px solid #ddd; border-radius:6px; cursor:crosshair; }

    /* small utilities */
    .mt-12 { margin-top:12px; }
    .mb-16 { margin-bottom:16px; }

    @media (max-width: 991px) {
      nav.sidebar { padding:14px; }
      .topbar { margin-left:0; }
    }

    /* ============================================================
       Professional Profile Styles
       ============================================================ */

    /* Profile Header */
    .profile-header {
      background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      color: white;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .profile-header::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(50%, -50%);
    }

    .profile-avatar {
      position: relative;
      flex-shrink: 0;
    }

    .avatar-circle {
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      border: 4px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .profile-status {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: #198754;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }

    .status-indicator.active {
      background: #198754;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .profile-info {
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .profile-name {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .profile-title {
      font-size: 1.125rem;
      margin: 0 0 0.75rem 0;
      opacity: 0.9;
      font-weight: 500;
    }

    .profile-email,
    .profile-joined {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
      font-size: 1rem;
      opacity: 0.9;
    }

    .profile-email i,
    .profile-joined i {
      width: 16px;
      text-align: center;
    }

    /* Profile Cards Grid */
    .profile-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .profile-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid #e9ecef;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .profile-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .profile-card .card-header {
      background: #f8f9fa;
      padding: 1.5rem;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .profile-card .card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
      flex-shrink: 0;
    }

    .profile-card .card-icon.personal {
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
    }

    .profile-card .card-icon.contact {
      background: linear-gradient(135deg, #198754, #157347);
    }

    .profile-card h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: #212529;
      margin: 0;
    }

    .profile-card .card-content {
      padding: 1.5rem;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .info-item.full-width {
      grid-column: 1 / -1;
    }

    .info-item label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }

    .info-item span {
      font-size: 1rem;
      color: #212529;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid #f8f9fa;
    }

    .info-item span i {
      width: 16px;
      text-align: center;
      color: #6c757d;
    }

    .email-link {
      color: #0d6efd !important;
      text-decoration: none;
    }

    .email-link:hover {
      color: #0b5ed7 !important;
      text-decoration: underline;
    }

    .address-text {
      line-height: 1.5;
      padding: 0.75rem 0 !important;
    }

    /* Profile Actions */
    .profile-actions {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid #e9ecef;
      margin-bottom: 1.5rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .action-buttons .btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .action-buttons .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* Profile Notice */
    .profile-notice {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      border-radius: 16px;
      padding: 1.5rem;
    }

    .notice-content {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }

    .notice-content i {
      color: #0d6efd;
      font-size: 1.25rem;
      margin-top: 0.25rem;
      flex-shrink: 0;
    }

    .notice-content strong {
      color: #0a58ca;
      font-weight: 600;
      display: block;
      margin-bottom: 0.5rem;
    }

    .notice-content p {
      color: #0b5ed7;
      margin: 0;
      line-height: 1.6;
    }

    /* Profile Error States */
    .profile-error {
      text-align: center;
      padding: 3rem;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border: 1px solid #e9ecef;
    }

    .error-icon {
      font-size: 4rem;
      color: #dc3545;
      margin-bottom: 1.5rem;
    }

    .profile-error h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #212529;
      margin-bottom: 1rem;
    }

    .profile-error p {
      color: #6c757d;
      font-size: 1.125rem;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    /* Responsive Profile */
    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }
      
      .profile-name {
        font-size: 2rem;
      }
      
      .profile-cards-grid {
        grid-template-columns: 1fr;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-3 col-lg-2 d-md-block sidebar p-3">
        <h4 class="mb-4"><i class="fa-solid fa-user-tie"></i> Dean's Panel</h4>

        <ul class="nav flex-column" id="sidebarMenu">
          <li class="nav-item">
            <a class="nav-link active" onclick="setActive(this); loadContent('dashboard')">
              <i class="fa-solid fa-chart-simple"></i> Dashboard
            </a>
          </li>

          <li class="nav-item mt-12">
            <a class="nav-link d-flex justify-content-between align-items-center"
               data-bs-toggle="collapse" data-bs-target="#settingsMenu"
               aria-expanded="false" aria-controls="settingsMenu" onclick="setActive(this)">
              <span><i class="fa-solid fa-gear"></i> Settings</span>
              <i class="fa-solid fa-caret-down"></i>
            </a>

            <div class="collapse ps-3" id="settingsMenu">
              <ul class="nav flex-column mt-2">
                <li class="nav-item">
                  <a class="nav-link" onclick="loadContent('profile')"><i class="fa-solid fa-id-badge"></i> Profile</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" onclick="loadContent('password')"><i class="fa-solid fa-lock"></i> Change Password</a>
                </li>
              </ul>
            </div>
          </li>

        </ul>

        <button class="btn btn-danger w-100 mt-5"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </nav>

      <!-- Main -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <!-- Topbar -->
        <div class="topbar d-flex justify-content-between align-items-center p-3 mb-4">
          <h5 class="mb-0">Dean's Dashboard</h5>
          <div><i class="fa-solid fa-circle-user"></i> Dean</div>
        </div>

        <!-- Dynamic content mount -->
        <div id="mainContent"></div>
      </main>
    </div>
  </div>

  <!-- Dashboard Template (Pending / Approved / Rejected + search + counters) -->
  <template id="dashboardTemplate">
    <div id="dashboardContent">

      <!-- Cards -->
      <div class="row mb-4">
        <div class="col-md-4 mb-16">
          <div class="card text-center shadow-sm card-counter" data-type="pending" onclick="showTable('pending')">
            <div class="card-body">
              <h5><i class="fa-solid fa-hourglass-half text-warning"></i> Pending Clearances</h5>
              <h3 id="pendingCount">2</h3>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-16">
          <div class="card text-center shadow-sm card-counter" data-type="approved" onclick="showTable('approved')">
            <div class="card-body">
              <h5><i class="fa-solid fa-check text-success"></i> Approved Clearances</h5>
              <h3 id="approvedCount">0</h3>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-16">
          <div class="card text-center shadow-sm card-counter" data-type="rejected" onclick="showTable('rejected')">
            <div class="card-body">
              <h5><i class="fa-solid fa-xmark text-danger"></i> Rejected Clearances</h5>
              <h3 id="rejectedCount">0</h3>
            </div>
          </div>
        </div>
      </div>

      <!-- Search -->
      <div id="searchContainer" class="mb-3 d-none">
        <input id="searchInput" class="form-control" placeholder="Search student...">
      </div>

      <!-- Tables container -->
      <div id="tablesContainer">

        <!-- Pending -->
        <div id="pendingTable" class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white"><i class="fa-solid fa-clipboard-list"></i> Pending Clearances</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-primary">
                <tr>
                  <th>Student Name</th>
                  <th>Course</th>
                  <th>Status</th>
                  <th>Cause / Reason</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="pendingList">
                <tr>
                  <td>Juan Dela Cruz</td>
                  <td>BSCS</td>
                  <td class="status-pending">Pending</td>
                  <td>-</td>
                  <td>
                    <button class="btn-sign" onclick="openSignModal(this)">Sign</button>
                    <select class="reason-dropdown ms-2" onchange="rejectForm(this)">
                      <option value="">Reject Reason</option>
                      <option>Incomplete Requirements</option>
                      <option>Overdue Equipment</option>
                      <option>Violation</option>
                    </select>
                  </td>
                </tr>

                <tr>
                  <td>Maria Santos</td>
                  <td>ACT</td>
                  <td class="status-pending">Pending</td>
                  <td>-</td>
                  <td>
                    <button class="btn-sign" onclick="openSignModal(this)">Sign</button>
                    <select class="reason-dropdown ms-2" onchange="rejectForm(this)">
                      <option value="">Reject Reason</option>
                      <option>Incomplete Requirements</option>
                      <option>Overdue Equipment</option>
                      <option>Violation</option>
                    </select>
                  </td>
                </tr>

              </tbody>
            </table>
          </div>
        </div>

        <!-- Approved -->
        <div id="approvedTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-success text-white"><i class="fa-solid fa-check"></i> Approved Clearances</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-success">
                <tr>
                  <th>Student Name</th>
                  <th>Course</th>
                  <th>Status</th>
                  <th>Signature</th>
                </tr>
              </thead>
              <tbody id="approvedList"></tbody>
            </table>
          </div>
        </div>

        <!-- Rejected -->
        <div id="rejectedTable" class="card shadow-sm mb-4 d-none">
          <div class="card-header bg-danger text-white"><i class="fa-solid fa-xmark"></i> Rejected Clearances</div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-danger">
                <tr>
                  <th>Student Name</th>
                  <th>Course</th>
                  <th>Status</th>
                  <th>Cause / Reason</th>
                </tr>
              </thead>
              <tbody id="rejectedList"></tbody>
            </table>
          </div>
        </div>

      </div> <!-- /tablesContainer -->

    </div> <!-- /dashboardContent -->
  </template>

  <!-- Approval Modal -->
  <div class="modal fade" id="signModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-check-circle text-success"></i> Clearance Approval</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="onModalCloseCleanup()"></button>
        </div>
        <div class="modal-body text-center">
          <div class="alert alert-info mb-4">
            <i class="fa-solid fa-info-circle"></i>
            <strong>Approval Process Information:</strong><br>
            By approving this clearance, you are confirming that the student has met all requirements for your department. This action will:
            <ul class="text-start mt-2 mb-0">
              <li>Mark the clearance as approved in your department</li>
              <li>Update the student's clearance status</li>
              <li>Allow the clearance to proceed to the next stage</li>
            </ul>
          </div>
          <p class="mb-4"><strong>Are you sure you want to approve this student's clearance?</strong></p>
          <div class="mt-3">
            <button class="btn btn-success btn-lg px-4" onclick="approveClearance()">
              <i class="fa-solid fa-check"></i> Approve Clearance
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* ============================================================
       Globals & canvas setup
       ============================================================ */
    let currentRow = null;


    /* ============================================================
       Open modal (also disable reject select for that row while signing)
       ============================================================ */
    function openSignModal(btn) {
      currentRow = btn.closest('tr');

      // disable its reject select (if present) to avoid race
      const sel = currentRow.querySelector('.reason-dropdown');
      if(sel) {
        sel.dataset.disabledBeforeSign = "1";
        sel.disabled = true;
      }

      // show bootstrap modal
      const modalEl = document.getElementById('signModal');
      const bsModal = new bootstrap.Modal(modalEl);
      bsModal.show();

    }

    /* ============================================================
       Save signature: move row to approved (without reject/select)
       and ensure reject option removed (action replaced by signature image)
       ============================================================ */
    function saveSignature() {
      if(!currentRow) return;


      // Build approved row (no reject select)
      const approvedList = document.getElementById('approvedList');
      const newRow = document.createElement('tr');
      newRow.dataset.studentId = currentRow.dataset.studentId || '';
          newRow.setAttribute('role', 'row');
          newRow.innerHTML = `
        <td>${currentRow.cells[0].textContent}</td>
        <td>${currentRow.cells[1].textContent}</td>
        <td class="status-signed">Approved</td>
        <td>Approved</td>
      `;
      approvedList.appendChild(newRow);

      // remove original pending row (so reject dropdown is gone with it)
      currentRow.remove();
      currentRow = null;

      // update counts
      updateCounters();

      // hide modal
      const modalEl = document.getElementById('signModal');
      const bsModal = bootstrap.Modal.getInstance(modalEl);
      if(bsModal) bsModal.hide();
    }

    /* When user clicks Reject inside modal: move current row to Rejected */
    function rejectFromModal() {
      if(!currentRow) return;
      const rejectedList = document.getElementById('rejectedList');
      const newRow = document.createElement('tr');
      newRow.dataset.studentId = currentRow.dataset.studentId || '';
          newRow.setAttribute('role', 'row');
          newRow.innerHTML = `
        <td>${currentRow.cells[0].textContent}</td>
        <td>${currentRow.cells[1].textContent}</td>
        <td class="status-rejected">Rejected</td>
        <td>Rejected via modal</td>
      `;
      rejectedList.appendChild(newRow);

      currentRow.remove();
      currentRow = null;
      updateCounters();

      const modalEl = document.getElementById('signModal');
      const bsModal = bootstrap.Modal.getInstance(modalEl);
      if(bsModal) bsModal.hide();
    }

    /* Cleanup if modal closed without saving: re-enable select if was disabled */
    function onModalCloseCleanup() {
      if(currentRow) {
        const sel = currentRow.querySelector('.reason-dropdown');
        if(sel && sel.dataset.disabledBeforeSign) {
          sel.disabled = false;
          delete sel.dataset.disabledBeforeSign;
        }
        currentRow = null;
      }
    }

    /* Clear canvas */

    /* Reject via dropdown in pending table */
    function rejectForm(select) {
      const reason = select.value;
      if(!reason) return;
      const row = select.closest('tr');
      const rejectedList = document.getElementById('rejectedList');

      const newRow = document.createElement('tr');
      newRow.dataset.studentId = currentRow.dataset.studentId || '';
          newRow.setAttribute('role', 'row');
          newRow.innerHTML = `
        <td>${row.cells[0].textContent}</td>
        <td>${row.cells[1].textContent}</td>
        <td class="status-rejected">Rejected</td>
        <td>${reason}</td>
      `;

      rejectedList.appendChild(newRow);

      // remove pending row (so sign and dropdown gone)
      row.remove();
      updateCounters();
    }

    /* ============================================================
       Counters / showTable / search
       ============================================================ */
    function updateCounters() {
      document.getElementById('pendingCount').textContent = document.querySelectorAll('#pendingList tr').length;
      document.getElementById('approvedCount').textContent = document.querySelectorAll('#approvedList tr').length;
      document.getElementById('rejectedCount').textContent = document.querySelectorAll('#rejectedList tr').length;
    }

    function showTable(type) {
      // hide all
      document.getElementById('pendingTable').classList.add('d-none');
      document.getElementById('approvedTable').classList.add('d-none');
      document.getElementById('rejectedTable').classList.add('d-none');

      // show search
      document.getElementById('searchContainer').classList.remove('d-none');

      // remove active
      document.querySelectorAll('.card-counter').forEach(c => c.classList.remove('active'));

      if(type === 'pending') {
        document.getElementById('pendingTable').classList.remove('d-none');
        document.querySelector(".card-counter[data-type='pending']").classList.add('active');
      } else if(type === 'approved') {
        document.getElementById('approvedTable').classList.remove('d-none');
        document.querySelector(".card-counter[data-type='approved']").classList.add('active');
      } else if(type === 'rejected') {
        document.getElementById('rejectedTable').classList.remove('d-none');
        document.querySelector(".card-counter[data-type='rejected']").classList.add('active');
      }
    }

    // search input behavior (delegated)
    document.addEventListener('keyup', function(e) {
      if(e.target && e.target.id === 'searchInput') {
        const q = e.target.value.toLowerCase();
        const tbody = document.querySelector('#tablesContainer .card:not(.d-none) tbody');
        if(!tbody) return;
        Array.from(tbody.children).forEach(r => {
          r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      }
    });

    /* ============================================================
       Sidebar active & dynamic page loads (profile / password)
       ============================================================ */
    function setActive(elem) {
      document.querySelectorAll('#sidebarMenu .nav-link').forEach(l => l.classList.remove('active'));
      if(elem) elem.classList.add('active');
    }

    function loadContent(type) {
      const container = document.getElementById('mainContent');

      if(type === 'dashboard') {
        const template = document.getElementById('dashboardTemplate').content.cloneNode(true);
        container.innerHTML = '';
        container.appendChild(template);
        showTable('pending');
        updateCounters();
      }

      if(type === 'profile') {
        loadDeanProfile();
      }

      if(type === 'password') {
        container.innerHTML = `
          <div class="card shadow-sm p-4">
            <h5><i class="fa-solid fa-lock"></i> Change Password</h5>
            <form id="passwordForm" class="mt-3">
              <div class="mb-3">
                <label class="form-label">Current Password</label>
                <input id="currentPassword" type="password" class="form-control" required />
              </div>
              <div class="mb-3">
                <label class="form-label">New Password</label>
                <input id="newPassword" type="password" class="form-control" required minlength="6" />
                <div class="form-text">Password must be at least 6 characters long</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Confirm New Password</label>
                <input id="confirmPassword" type="password" class="form-control" required />
              </div>
              <button class="btn btn-primary" type="submit">Update Password</button>
            </form>
          </div>
        `;
        
        // Add form submission handler
        setTimeout(() => {
          const form = document.getElementById('passwordForm');
          if(form) {
            form.addEventListener('submit', handlePasswordChange);
          }
        }, 100);
      }
    }

    // Handle password change
    async function handlePasswordChange(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Client-side validation
      if (!currentPassword || !newPassword || !confirmPassword) {
        Swal.fire('Error', 'All fields are required!', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        Swal.fire('Error', 'New Password and Confirm Password do not match!', 'error');
        return;
      }
      
      if (newPassword.length < 6) {
        Swal.fire('Error', 'New password must be at least 6 characters long!', 'error');
        return;
      }
      
      // Show loading
      Swal.fire({
        title: 'Updating Password...',
        text: 'Please wait while we update your password',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      try {
        const response = await fetch('/api/dean/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Password Updated!',
            text: 'Your password has been successfully updated.',
            confirmButtonText: 'OK'
          }).then(() => {
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Password Update Failed',
            text: data.message || 'An error occurred while updating your password.',
            confirmButtonText: 'Try Again'
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Unable to connect to server. Please check your connection and try again.',
          confirmButtonText: 'OK'
        });
      }
    }

    /* ============================================================
       Helpers: addPending (for testing)
       ============================================================ */
    function addPending(name, course) {
      const tbody = document.getElementById('pendingList');
      if(!tbody) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${name}</td>
        <td>${course}</td>
        <td class="status-pending">Pending</td>
        <td>-</td>
        <td>
          <button class="btn-sign" onclick="openSignModal(this)">Sign</button>
          <select class="reason-dropdown ms-2" onchange="rejectForm(this)">
            <option value="">Reject Reason</option>
            <option>Incomplete Requirements</option>
            <option>Overdue Equipment</option>
            <option>Violation</option>
          </select>
        </td>
      `;
      tbody.appendChild(tr);
      updateCounters();
    }

    // Load Dean information from database
    async function loadDeanInfo() {
      try {
        const response = await fetch('/api/dean/me');
        const data = await response.json();
        
        if (data.ok && data.dean_info) {
          const dean = data.dean_info;
          document.getElementById('deanName').textContent = dean.full_name;
          return dean;
        }
      } catch (error) {
        console.error('Error loading dean info:', error);
      }
      return null;
    }

    // Load Dean profile with real data - Professional Design
    async function loadDeanProfile() {
      const container = document.getElementById('mainContent');
      
      try {
        const dean = await loadDeanInfo();
        
        if (dean) {
          // Format dates
          const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          };

          // Format full name
          const fullName = `${dean.first_name || ''} ${dean.middle_name || ''} ${dean.last_name || ''} ${dean.suffix || ''}`.replace(/\s+/g, ' ').trim();

          container.innerHTML = `
            <!-- Professional Profile Header -->
            <div class="profile-header">
              <div class="profile-avatar">
                <div class="avatar-circle">
                  <i class="fa-solid fa-user"></i>
                </div>
                <div class="profile-status">
                  <span class="status-indicator active"></span>
                  <span class="status-text">Active</span>
                </div>
              </div>
              <div class="profile-info">
                <h2 class="profile-name">${fullName}</h2>
                ${dean.department ? `
                <p class="profile-title">${dean.department}</p>
                ` : ''}
                ${dean.email ? `
                <p class="profile-email">
                  <i class="fa-solid fa-envelope"></i>
                  ${dean.email}
                </p>
                ` : ''}
                ${dean.created_at ? `
                <p class="profile-joined">
                  <i class="fa-solid fa-calendar"></i>
                  Member since ${formatDate(dean.created_at)}
                </p>
                ` : ''}
              </div>
            </div>

            <!-- Professional Profile Cards -->
            <div class="profile-cards-grid">
              <!-- Personal Information Card -->
              <div class="profile-card">
                <div class="card-header">
                  <div class="card-icon personal">
                    <i class="fa-solid fa-user"></i>
                  </div>
                  <h3>Personal Information</h3>
                </div>
                <div class="card-content">
                  <div class="info-grid">
                    ${dean.first_name ? `
                    <div class="info-item">
                      <label>First Name</label>
                      <span>${dean.first_name}</span>
                    </div>
                    ` : ''}
                    ${dean.last_name ? `
                    <div class="info-item">
                      <label>Last Name</label>
                      <span>${dean.last_name}</span>
                    </div>
                    ` : ''}
                    ${dean.middle_name ? `
                    <div class="info-item">
                      <label>Middle Name</label>
                      <span>${dean.middle_name}</span>
                    </div>
                    ` : ''}
                    ${dean.suffix ? `
                    <div class="info-item">
                      <label>Suffix</label>
                      <span>${dean.suffix}</span>
                    </div>
                    ` : ''}
                    ${dean.gender ? `
                    <div class="info-item">
                      <label>Gender</label>
                      <span>${dean.gender}</span>
                    </div>
                    ` : ''}
                    ${dean.date_of_birth ? `
                    <div class="info-item">
                      <label>Date of Birth</label>
                      <span>${formatDate(dean.date_of_birth)}</span>
                    </div>
                    ` : ''}
                    ${dean.department ? `
                    <div class="info-item">
                      <label>Department</label>
                      <span>${dean.department}</span>
                    </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              <!-- Contact Information Card -->
              <div class="profile-card">
                <div class="card-header">
                  <div class="card-icon contact">
                    <i class="fa-solid fa-phone"></i>
                  </div>
                  <h3>Contact Information</h3>
                </div>
                <div class="card-content">
                  <div class="info-grid">
                    ${dean.email ? `
                    <div class="info-item full-width">
                      <label>Email Address</label>
                      <span class="email-link">
                        <i class="fa-solid fa-envelope"></i>
                        ${dean.email}
                      </span>
                    </div>
                    ` : ''}
                    ${dean.contact_no ? `
                    <div class="info-item">
                      <label>Contact Number</label>
                      <span>
                        <i class="fa-solid fa-phone"></i>
                        ${dean.contact_no}
                      </span>
                    </div>
                    ` : ''}
                    ${dean.alternative_contact ? `
                    <div class="info-item">
                      <label>Alternative Contact</label>
                      <span>
                        <i class="fa-solid fa-mobile"></i>
                        ${dean.alternative_contact}
                      </span>
                    </div>
                    ` : ''}
                    ${dean.address ? `
                    <div class="info-item full-width">
                      <label>Address</label>
                      <span class="address-text">
                        <i class="fa-solid fa-map-marker-alt"></i>
                        ${dean.address}
                      </span>
                    </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Actions -->
            <div class="profile-actions">
              <div class="action-buttons">
                <button class="btn btn-primary" onclick="loadContent('password')">
                  <i class="fa-solid fa-key"></i> Change Password
                </button>
              </div>
            </div>

            <!-- Information Notice -->
            <div class="profile-notice">
              <div class="notice-content">
                <i class="fa-solid fa-info-circle"></i>
                <div>
                  <strong>Profile Information Notice:</strong>
                  <p>Your profile information is read-only and managed by the system administrator. To update your information, please contact your HR department or system administrator.</p>
                </div>
              </div>
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="profile-error">
              <div class="error-icon">
                <i class="fa-solid fa-exclamation-triangle"></i>
              </div>
              <h3>Unable to Load Profile</h3>
              <p>We couldn't load your profile information. This might be due to a network issue or server problem.</p>
              <button class="btn btn-primary" onclick="loadDeanProfile()">
                <i class="fa-solid fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        container.innerHTML = `
          <div class="profile-error">
            <div class="error-icon">
              <i class="fa-solid fa-times-circle"></i>
            </div>
            <h3>Error Loading Profile</h3>
            <p>An error occurred while loading your profile information. Please refresh the page and try again.</p>
            <button class="btn btn-primary" onclick="loadDeanProfile()">
              <i class="fa-solid fa-refresh"></i> Retry
            </button>
          </div>
        `;
      }
    }

    // On page load, show dashboard
    window.onload = function() {
        loadContent('dashboard');
        loadDeanInfo(); // Load dean name in topbar
        // Auto-load all data to populate counters
        loadPending();
        loadApproved();
        loadRejected();
      // ensure settings collapsed initially
      const settings = document.getElementById('settingsMenu');
      if(settings) settings.classList.remove('show');

      // listen modal hidden event to cleanup (covers clicking outside or close)
      const modalEl = document.getElementById('signModal');
      modalEl.addEventListener('hidden.bs.modal', function() {
        onModalCloseCleanup();
      });
    };
  </script>
</body>
</html>
  