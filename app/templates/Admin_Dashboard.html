<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iRequest - Admin Dashboard</title>
  <link rel="icon" href="/static/assets/iRlogo.png" type="image/x-icon">
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/static/assets/css/sweetalert-professional.css">
  
  <!-- Utilities -->
  <script src="/static/assets/js/sweetalert-utils.js"></script>
  <script src="/static/assets/js/loading-utils.js"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      font-family: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    /* Sidebar Styles */
    .sidebar {
      width: 72px;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      position: fixed;
      height: 100vh;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      transition: width 250ms cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar.expanded {
      width: 280px;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 1rem 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      min-height: 70px;
    }
    
    .sidebar-hamburger {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.75rem;
      border-radius: 0.75rem;
      transition: all 150ms;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
    }
    
    .sidebar-hamburger:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    .sidebar-title {
      margin-left: 0.75rem;
      font-weight: 700;
      font-size: 1.25rem;
      white-space: nowrap;
      opacity: 0;
      transform: translateX(-10px);
      transition: all 250ms;
    }
    
    .sidebar.expanded .sidebar-title {
      opacity: 1;
      transform: translateX(0);
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 1.5rem 0;
    }
    
    .sidebar-nav-item {
      display: flex;
      align-items: center;
      padding: 0.9375rem 1.875rem;
      cursor: pointer;
      transition: background 0.2s;
      gap: 0.9375rem;
    }
    
    .sidebar-nav-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-nav-item i {
      font-size: 1.125rem;
      width: 20px;
      text-align: center;
    }
    
    .link-text {
      opacity: 0;
      transform: translateX(-10px);
      transition: all 250ms;
      white-space: nowrap;
    }
    
    .sidebar.expanded .link-text {
      opacity: 1;
      transform: translateX(0);
    }
    
    .sidebar-footer {
      padding: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .logout-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.625rem;
      padding: 0.625rem 0;
      border-radius: 0.5rem;
      background: #ef4444;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: 0.2s;
      width: 100%;
    }
    
    .logout-btn:hover {
      background: #dc2626;
    }
    
    /* Topbar */
    .topbar {
      margin-left: 72px;
      height: 70px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.875rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      transition: margin-left 250ms;
    }
    
    .topbar.sidebar-expanded {
      margin-left: 280px;
    }
    
    .topbar-hamburger {
      display: none;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #374151;
      padding: 0.5rem;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    
    .topbar-hamburger:hover {
      background: #f3f4f6;
    }
    
    .main-content {
      margin-left: 72px;
      padding: 1.875rem;
      transition: margin-left 250ms;
    }
    
    .main-content.sidebar-expanded {
      margin-left: 280px;
    }
    
    /* Mobile Menu Overlay */
    .mobile-menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    
    .mobile-menu-overlay.show {
      display: block;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .sidebar.expanded {
        width: 280px;
      }
      
      .topbar {
        margin-left: 0;
      }
      
      .topbar.sidebar-expanded {
        margin-left: 0;
      }
      
      .topbar-hamburger {
        display: block;
      }
      
      .main-content {
        margin-left: 0;
        padding: 1.25rem;
      }
      
      .main-content.sidebar-expanded {
        margin-left: 0;
      }
      
      .sidebar-title,
      .link-text {
        opacity: 1 !important;
        transform: translateX(0) !important;
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  
  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="toggleMobileMenu()"></div>
  
  <!-- Sidebar -->
  <div class="sidebar expanded" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-hamburger" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span class="sidebar-title">Admin Panel</span>
    </div>
    <div class="sidebar-nav">
      <div class="sidebar-nav-item" onclick="loadDashboard()">
        <i class="fas fa-home"></i>
        <span class="link-text">Dashboard</span>
      </div>
      <div class="sidebar-nav-item" onclick="loadContent('password')">
        <i class="fas fa-lock"></i>
        <span class="link-text">Change Password</span>
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="logout-btn" onclick="logout()">
        <i class="fas fa-right-from-bracket"></i>
        <span class="link-text">Logout</span>
      </button>
    </div>
  </div>

  <!-- Topbar -->
  <div class="topbar sidebar-expanded" id="topbar">
    <button class="topbar-hamburger" id="topbarToggle" onclick="toggleMobileMenu()">
      <i class="fas fa-bars"></i>
    </button>
    <h2 class="text-xl font-bold text-gray-800">Dashboard</h2>
    <div class="flex items-center gap-4">
      <span class="text-gray-700 font-medium" id="adminName">Admin</span>
      <i class="fas fa-user-circle text-2xl text-gray-600"></i>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content sidebar-expanded" id="mainContent">
    
    <!-- Status Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow cursor-pointer border-2 border-transparent hover:border-yellow-400" data-type="pending" onclick="showTab('pending')">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-3xl font-bold text-gray-800 mb-1" id="pendingCount">0</h3>
            <p class="text-gray-600 text-sm">Pending Approvals</p>
          </div>
          <i class="fas fa-hourglass-half text-4xl text-yellow-500"></i>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow cursor-pointer border-2 border-transparent hover:border-green-400" data-type="approved" onclick="showTab('approved')">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-3xl font-bold text-gray-800 mb-1" id="approvedCount">0</h3>
            <p class="text-gray-600 text-sm">Approved Staff</p>
          </div>
          <i class="fas fa-check-circle text-4xl text-green-500"></i>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition-shadow cursor-pointer border-2 border-transparent hover:border-red-400" data-type="rejected" onclick="showTab('rejected')">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-3xl font-bold text-gray-800 mb-1" id="rejectedCount">0</h3>
            <p class="text-gray-600 text-sm">Rejected Staff</p>
          </div>
          <i class="fas fa-times-circle text-4xl text-red-500"></i>
        </div>
      </div>
    </div>

    <!-- Staff Management Section -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
      <div class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-6 py-4">
        <h4 class="text-xl font-semibold flex items-center gap-2">
          <i class="fas fa-users"></i>
          Staff Management
        </h4>
      </div>
      
      <!-- Search and Refresh -->
      <div class="p-6 border-b border-gray-200">
        <div class="flex flex-col md:flex-row gap-4">
          <input 
            id="searchInput" 
            type="text" 
            placeholder="Search staff..." 
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition"
          >
          <button 
            onclick="refreshAll()" 
            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-2 justify-center font-medium"
          >
            <i class="fas fa-sync-alt"></i>
            Refresh
          </button>
        </div>
      </div>
      
      <div id="adminAlert" class="hidden mx-6 mt-4 p-4 rounded-lg" role="alert"></div>
      
      <!-- Tables Container -->
      <div id="tablesContainer">
        <!-- Pending Table -->
        <div id="pendingTable" class="overflow-x-auto">
          <div class="bg-indigo-600 text-white px-6 py-3">
            <h5 class="font-semibold flex items-center gap-2">
              <i class="fas fa-hourglass-half"></i>
              Pending Approvals
            </h5>
          </div>
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Staff Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Department</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Position</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody id="approvalsBody" class="bg-white divide-y divide-gray-200">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <!-- Approved Table -->
        <div id="approvedTable" class="hidden overflow-x-auto">
          <div class="bg-green-600 text-white px-6 py-3">
            <h5 class="font-semibold flex items-center gap-2">
              <i class="fas fa-check-circle"></i>
              Approved Staff
            </h5>
          </div>
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Staff Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Department</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Position</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Approved By</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Approval Date</th>
              </tr>
            </thead>
            <tbody id="approvedBody" class="bg-white divide-y divide-gray-200">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>

        <!-- Rejected Table -->
        <div id="rejectedTable" class="hidden overflow-x-auto">
          <div class="bg-red-600 text-white px-6 py-3">
            <h5 class="font-semibold flex items-center gap-2">
              <i class="fas fa-times-circle"></i>
              Rejected Staff
            </h5>
          </div>
          <table class="min-w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Staff Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Department</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Position</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Rejected By</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Rejection Reason</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Rejection Date</th>
              </tr>
            </thead>
            <tbody id="rejectedBody" class="bg-white divide-y divide-gray-200">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    // Sidebar toggle functionality
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const topbarToggle = document.getElementById('topbarToggle');
    const mainContent = document.getElementById('mainContent');
    const topbar = document.getElementById('topbar');
    const overlay = document.getElementById('mobileMenuOverlay');
    const alertBox = document.getElementById('adminAlert');

    function showAlert(msg, type) {
      alertBox.textContent = msg;
      alertBox.className = `mx-6 mt-4 p-4 rounded-lg alert-${type}`;
      if (type === 'success') {
        alertBox.classList.add('bg-green-100', 'text-green-700', 'border', 'border-green-400');
      } else if (type === 'danger') {
        alertBox.classList.add('bg-red-100', 'text-red-700', 'border', 'border-red-400');
      }
      alertBox.classList.remove('hidden');
      setTimeout(() => alertBox.classList.add('hidden'), 5000);
    }

    // Mobile menu toggle
    function toggleMobileMenu() {
      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
        document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : 'auto';
      }
    }

    // Desktop sidebar toggle
    function toggleSidebar() {
      if (window.innerWidth <= 768) {
        toggleMobileMenu();
      } else {
        const isExpanded = sidebar.classList.contains('expanded');
        if (isExpanded) {
          sidebar.classList.remove('expanded');
          mainContent.classList.remove('sidebar-expanded');
          topbar.classList.remove('sidebar-expanded');
        } else {
          sidebar.classList.add('expanded');
          mainContent.classList.add('sidebar-expanded');
          topbar.classList.add('sidebar-expanded');
        }
      }
    }

    // Initialize sidebar
    function initializeSidebar() {
      if (window.innerWidth > 768) {
        sidebar.classList.add('expanded');
        mainContent.classList.add('sidebar-expanded');
        topbar.classList.add('sidebar-expanded');
      }
    }

    sidebarToggle.addEventListener('click', toggleSidebar);
    if (topbarToggle) {
      topbarToggle.addEventListener('click', toggleMobileMenu);
    }
    overlay.addEventListener('click', toggleMobileMenu);

    // Close mobile menu when clicking sidebar links
    document.querySelectorAll('.sidebar-nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          toggleMobileMenu();
        }
      });
    });

    initializeSidebar();

    // SweetAlert functions
    function showSweetAlert(title, text, icon = 'info') {
      Swal.fire({
        title: title,
        text: text,
        icon: icon,
        confirmButtonText: 'OK'
      });
    }

    function logout() {
      Swal.fire({
        title: 'Logout',
        text: 'Are you sure you want to logout?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, Logout',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#ef4444'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '/login.html';
        }
      });
    }

    function showTab(which) {
      const pendingT = document.getElementById('pendingTable');
      const approvedT = document.getElementById('approvedTable');
      const rejectedT = document.getElementById('rejectedTable');
      
      // Hide all tables
      pendingT.classList.add('hidden');
      approvedT.classList.add('hidden');
      rejectedT.classList.add('hidden');
      
      // Remove active border from all cards
      document.querySelectorAll('[data-type]').forEach(card => {
        card.classList.remove('border-yellow-400', 'border-green-400', 'border-red-400');
      });
      
      // Show selected table and highlight card
      if (which === 'approved') {
        approvedT.classList.remove('hidden');
        document.querySelector('[data-type="approved"]').classList.add('border-green-400');
        fetchApproved();
      } else if (which === 'rejected') {
        rejectedT.classList.remove('hidden');
        document.querySelector('[data-type="rejected"]').classList.add('border-red-400');
        fetchRejected();
      } else {
        pendingT.classList.remove('hidden');
        document.querySelector('[data-type="pending"]').classList.add('border-yellow-400');
        fetchApprovals();
      }
    }

    async function safeFetchJson(url, options) {
      const res = await fetch(url, options || {});
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        return { ok: true, json: await res.json(), status: res.status };
      }
      const text = await res.text();
      return { ok: false, text, status: res.status };
    }

    async function fetchApprovals() {
      try {
        const r = await safeFetchJson('/api/admin/staff?status=Pending');
        if (!r.ok || !r.json?.ok) {
          const msg = r.json?.message || r.text || 'Failed to load';
          throw new Error(msg);
        }
        const data = r.json;
        const tbody = document.getElementById('approvalsBody');
        tbody.innerHTML = '';
        
        if (!data.data || data.data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-2 block"></i>
                No pending approvals found
              </td>
            </tr>
          `;
          return;
        }
        
        data.data.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition';
          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${row.first_name} ${row.last_name}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.department || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.position || row.department || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                ${row.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <div class="flex items-center gap-2">
                <button class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium text-sm" data-id="${row.id}">
                  <i class="fas fa-check mr-1"></i> Approve
                </button>
                <select class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium text-sm border-none outline-none cursor-pointer" data-id="${row.id}">
                  <option value="">Reject...</option>
                  <option value="Incomplete Requirements">Incomplete Requirements</option>
                  <option value="Invalid Information">Invalid Information</option>
                  <option value="Duplicate Account">Duplicate Account</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error fetching approvals:', err);
        showAlert(err.message || 'Error loading data', 'danger');
      }
    }

    async function fetchApproved() {
      try {
        const r = await safeFetchJson('/api/admin/staff?status=Approved');
        if (!r.ok || !r.json?.ok) {
          const msg = r.json?.message || r.text || 'Failed to load';
          throw new Error(msg);
        }
        const data = r.json;
        const tbody = document.getElementById('approvedBody');
        tbody.innerHTML = '';
        
        if (!data.data || data.data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-2 block"></i>
                No approved staff found
              </td>
            </tr>
          `;
          return;
        }
        
        data.data.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition';
          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${row.first_name} ${row.last_name}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.department || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.position || row.department || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                ${row.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.approved_by || 'Admin'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.approved_date ? new Date(row.approved_date).toLocaleDateString() : new Date().toLocaleDateString()}</div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error fetching approved:', err);
        showAlert(err.message || 'Error loading data', 'danger');
      }
    }

    async function fetchRejected() {
      try {
        const r = await safeFetchJson('/api/admin/staff?status=Rejected');
        if (!r.ok || !r.json?.ok) {
          const msg = r.json?.message || r.text || 'Failed to load';
          throw new Error(msg);
        }
        const data = r.json;
        const tbody = document.getElementById('rejectedBody');
        tbody.innerHTML = '';
        
        if (!data.data || data.data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-2 block"></i>
                No rejected staff found
              </td>
            </tr>
          `;
          return;
        }
        
        data.data.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition';
          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm font-medium text-gray-900">${row.first_name} ${row.last_name}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.department || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.position || row.department || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                ${row.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.rejected_by || 'Admin'}</div>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm text-gray-500">${row.rejection_reason || '-'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-500">${row.rejected_date ? new Date(row.rejected_date).toLocaleDateString() : new Date().toLocaleDateString()}</div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error fetching rejected:', err);
        showAlert(err.message || 'Error loading data', 'danger');
      }
    }

    async function doApprove(id) {
      try {
        Swal.fire({
          title: 'Approving...',
          text: 'Please wait',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => Swal.showLoading()
        });
        
        const approver = 'Admin';
        const r = await safeFetchJson('/admin/staff/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, approver })
        });
        
        if (!r.ok || !r.json?.ok) {
          const msg = r.json?.message || r.text || 'Approve failed';
          throw new Error(msg);
        }
        
        Swal.fire({
          icon: 'success',
          title: 'Success',
          text: 'Staff member approved successfully!',
          confirmButtonText: 'OK'
        });
        
        await refreshCounts();
        fetchApprovals();
      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Approve error',
          confirmButtonText: 'OK'
        });
      }
    }

    async function doReject(id, providedReason) {
      const reason = (providedReason || '').trim();
      if (!reason) return;
      
      try {
        Swal.fire({
          title: 'Rejecting...',
          text: 'Please wait',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => Swal.showLoading()
        });
        
        const approver = 'Admin';
        const r = await safeFetchJson('/admin/staff/reject', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, reason, approver })
        });
        
        if (!r.ok || !r.json?.ok) {
          const msg = r.json?.message || r.text || 'Reject failed';
          throw new Error(msg);
        }
        
        Swal.fire({
          icon: 'warning',
          title: 'Staff Rejected',
          text: 'Staff member has been rejected.',
          confirmButtonText: 'OK'
        });
        
        await refreshCounts();
        fetchApprovals();
      } catch (err) {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: err.message || 'Reject error',
          confirmButtonText: 'OK'
        });
      }
    }

    // Event listeners
    document.addEventListener('click', function(e) {
      if (e.target.closest('.btn-approve') || (e.target.tagName === 'BUTTON' && e.target.textContent.includes('Approve'))) {
        const btn = e.target.closest('button') || e.target;
        const id = btn.getAttribute('data-id');
        if (id) doApprove(id);
      }
    });

    document.addEventListener('change', function(e) {
      if (e.target.tagName === 'SELECT' && e.target.classList.contains('bg-red-600')) {
        const id = e.target.getAttribute('data-id');
        const reason = e.target.value;
        if (reason) {
          doReject(id, reason);
          e.target.value = '';
        }
      }
    });

    // Search filter
    document.addEventListener('keyup', function(e) {
      if (e.target && e.target.id === 'searchInput') {
        const q = e.target.value.toLowerCase();
        const visibleTable = document.querySelector('#tablesContainer > div:not(.hidden)');
        if (!visibleTable) return;
        const tbody = visibleTable.querySelector('tbody');
        if (!tbody) return;
        Array.from(tbody.children).forEach(tr => {
          const text = tr.textContent.toLowerCase();
          tr.style.display = text.includes(q) ? '' : 'none';
        });
      }
    });

    async function refreshAll() {
      try {
        Swal.fire({
          title: 'Refreshing...',
          text: 'Please wait',
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => Swal.showLoading()
        });
        
        await Promise.all([refreshCounts(), fetchApprovals(), fetchApproved(), fetchRejected()]);
        
        Swal.close();
      } catch (err) {
        Swal.close();
        console.error('Error refreshing:', err);
      }
    }

    // Load admin name
    (async function() {
      try {
        const r = await fetch('/api/admin/me');
        const j = await r.json();
        if (j && j.ok) {
          document.getElementById('adminName').textContent = j.admin_name || 'Admin';
        }
      } catch (err) {
        console.error('Error loading admin name:', err);
      }
    })();

    async function refreshCounts() {
      try {
        const r = await safeFetchJson('/api/admin/staff/counts');
        if (!r.ok || !r.json?.ok) return;
        const c = r.json.data || {};
        document.getElementById('pendingCount').textContent = c.Pending ?? 0;
        document.getElementById('approvedCount').textContent = c.Approved ?? 0;
        document.getElementById('rejectedCount').textContent = c.Rejected ?? 0;
      } catch (e) {
        console.error('Error refreshing counts:', e);
      }
    }

    function loadDashboard() {
      window.location.reload();
    }

    // Load content function for navigation
    function loadContent(type) {
      const mainContent = document.getElementById('mainContent');
      
      if (type === 'password') {
        mainContent.innerHTML = `
          <div class="bg-white rounded-xl shadow-md p-6 max-w-2xl">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-lock text-indigo-600"></i>
                Change Password
              </h2>
            </div>
            <form id="passwordForm">
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                <input 
                  id="currentPassword" 
                  type="password" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" 
                  required 
                />
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                <input 
                  id="newPassword" 
                  type="password" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" 
                  required 
                  minlength="6" 
                />
                <p class="mt-1 text-sm text-gray-500">Password must be at least 6 characters long</p>
              </div>
              <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                <input 
                  id="confirmPassword" 
                  type="password" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition" 
                  required 
                />
              </div>
              <button 
                type="submit" 
                class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium"
              >
                Update Password
              </button>
            </form>
          </div>
        `;
        
        setTimeout(() => {
          const form = document.getElementById('passwordForm');
          if (form) {
            form.addEventListener('submit', handlePasswordChange);
          }
        }, 100);
      }
    }

    // Handle password change
    async function handlePasswordChange(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        Swal.fire('Error', 'All fields are required!', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        Swal.fire('Error', 'New Password and Confirm Password do not match!', 'error');
        return;
      }
      
      if (newPassword.length < 6) {
        Swal.fire('Error', 'New password must be at least 6 characters long!', 'error');
        return;
      }
      
      Swal.fire({
        title: 'Updating Password...',
        text: 'Please wait while we update your password',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => Swal.showLoading()
      });
      
      try {
        const response = await fetch('/api/staff/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword,
            confirm_password: confirmPassword
          })
        });
        
        const data = await response.json();
        
        if (data.ok) {
          Swal.fire({
            icon: 'success',
            title: 'Password Updated!',
            text: 'Your password has been successfully updated.',
            confirmButtonText: 'OK'
          }).then(() => {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            loadDashboard();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Password Update Failed',
            text: data.message || 'An error occurred while updating your password.',
            confirmButtonText: 'Try Again'
          });
        }
      } catch (error) {
        Swal.fire({
          icon: 'error',
          title: 'Network Error',
          text: 'Unable to connect to server. Please check your connection and try again.',
          confirmButtonText: 'OK'
        });
      }
    }

    // Initialize on page load
    async function boot() {
      await refreshCounts();
      showTab('pending');
    }

    boot();
  </script>
</body>
</html>
