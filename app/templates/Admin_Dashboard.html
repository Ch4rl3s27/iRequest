<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iRequest</title>
<link rel="icon" href="/static/assets/iRlogo.png" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Professional SweetAlert Styling -->
<link rel="stylesheet" href="/static/assets/css/sweetalert-professional.css">
<!-- SweetAlert Utilities -->
<script src="/static/assets/js/sweetalert-utils.js"></script>
<script src="/static/assets/js/loading-utils.js"></script>
<!-- Modern Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* Modern Design System Variables */
  :root {
    --sidebar-width: 280px;
    --sidebar-width-sm: 200px;
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #22c55e;
    --success-600: #16a34a;
    --warning-500: #f59e0b;
    --warning-600: #d97706;
    --error-500: #ef4444;
    --error-600: #dc2626;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --surface: #ffffff;
    --font-family-primary: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --space-4: 1rem;
    --space-6: 1.5rem;
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
    font-family: var(--font-family-primary);
  }
  body {
    background: var(--gray-50); 
    color: var(--gray-800);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  a {text-decoration: none; color: inherit;}

  /* Sidebar */
  .sidebar {
    width: var(--sidebar-width);
    height: 100vh;
    background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
    color: white;
    position: fixed;
    top: 0; 
    left: 0;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: var(--space-6) 0;
    box-shadow: var(--shadow-lg);
    z-index: 1000;
  }
  .sidebar .logo {
    text-align: center;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 30px;
  }
  .sidebar ul {list-style: none;}
  .sidebar ul li {
    padding: 15px 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: background 0.2s;
  }
  .sidebar ul li:hover {background: rgba(255,255,255,0.1);}

  /* Logout button */
  .logout-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 0 30px;
    padding: 10px 0;
    border-radius: 8px;
    background: #ef4444;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: 0.2s;
  }
  .logout-btn:hover {background: #dc2626;}

  /* Topbar */
  .topbar {
    margin-left: var(--sidebar-width);
    height: 60px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: sticky;
    top:0;
    z-index: 100;
  }
  .topbar .user-info {display: flex; align-items: center; gap: 15px;}
  .topbar .user-info i {font-size: 1.2rem; cursor: pointer;}

  /* Main content */
  .main-content {margin-left: var(--sidebar-width); padding: 30px;}

  /* Section Heading */
  .main-content h4 {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--gray-800);
    margin: 10px 0 14px 0;
  }

  /* Dashboard cards */
  .cards {display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 20px; margin-bottom: 30px;}
  .card {
    background: white; border-radius: 12px; padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    display: flex; justify-content: space-between; align-items: center;
    transition: 0.3s;
    cursor: pointer;
  }
  .card:hover {transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.1);}
  .card .info {display: flex; flex-direction: column;}
  .card .info h3 {margin:0; font-size: 1.2rem; font-weight: 600;}
  .card .info p {margin-top: 5px; color: #6b7280; font-size: 0.9rem;}
  .card i {font-size: 2rem; color: #4f46e5;}
  
  /* Card highlighting for active states */
  .card-counter.active[data-type="pending"] {
    border: 2px solid #facc15;
    background: rgba(250, 204, 21, 0.1);
    box-shadow: 0 4px 12px rgba(250, 204, 21, 0.4);
  }
  .card-counter.active[data-type="approved"] {
    border: 2px solid #10b981;
    background: rgba(16, 185, 129, 0.1);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
  }
  .card-counter.active[data-type="rejected"] {
    border: 2px solid #ef4444;
    background: rgba(239, 68, 68, 0.1);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
  }

  /* Table Container */
  .table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 20px;
  }
  .table-responsive { width: 100%; overflow-x: auto; }
  
  .table-header {
    background: #4f46e5;
    color: white;
    padding: 15px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  .table-header h5 {
    margin: 0;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Table */
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  table thead {background: #f8f9fa; color: #333;}
  table thead th {padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e9ecef;}
  table tbody td {padding: 12px; border-bottom: 1px solid #f0f0f0;}
  table tbody tr:last-child td {border-bottom: none;}
  table tbody tr:hover {background: #f8f9fa;}
  .btn-approve, .btn-reject {
    padding: 6px 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    color: white;
    margin-right: 5px;
  }
  .btn-approve {background: #10b981; transition: 0.2s;}
  .btn-approve:hover {background: #059669;}
  .btn-reject {background: #ef4444; transition: 0.2s;}
  .btn-reject:hover {background: #dc2626;}

  /* Action group */
  .action-group {display:flex; align-items:center; gap:8px;}
  .reason-select {background:#ef4444; color:#fff; border:none; border-radius:8px; padding:6px 8px;}
  .reason-select option {color:#000;}

  /* Toolbar */
  .toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin: 8px 0 12px 0;
  }
  .search-input {
    flex: 1 1 280px;
    max-width: 420px;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--gray-200);
    background: var(--gray-100);
    outline: none;
    transition: border-color var(--transition-fast), background var(--transition-fast);
  }
  .search-input::placeholder { color: var(--gray-600); }
  .search-input:focus { border-color: var(--primary-500); background: #fff; }

  /* Status Colors */
  .status-pending {color: #facc15; font-weight: 600;}
  .status-approved {color: #10b981; font-weight: 600;}
  .status-rejected {color: #ef4444; font-weight: 600;}

  /* Responsive */
  @media(max-width:768px){
    .sidebar{width: var(--sidebar-width-sm);}
    .topbar{margin-left: var(--sidebar-width-sm);}
    .main-content{margin-left: var(--sidebar-width-sm); padding:20px;}
    .cards{grid-template-columns: 1fr;}
    .toolbar { flex-direction: column; align-items: stretch; }
    .search-input { max-width: 100%; }
  }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div>
    <div class="logo">Admin Panel</div>
    <ul>
      <li><i class="fa-solid fa-house"></i> Dashboard</li>
      <li onclick="loadContent('password')"><i class="fa-solid fa-lock"></i> Change Password</li>
    </ul>
  </div>
  <button class="logout-btn" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
</div>

<!-- Topbar -->
  <div class="topbar">
  <h2>Dashboard</h2>
  <div class="user-info">
    <span id="adminName">Admin</span>
    <i class="fa-solid fa-user-circle"></i>
  </div>
  </div>

<!-- Main Content -->
<div class="main-content">

  <!-- Status Cards -->
  <div class="cards">
    <div class="card card-counter" data-type="pending" onclick="showTab('pending')">
      <div class="info">
        <h3 id="pendingCount">0</h3>
        <p>Pending Approvals</p>
      </div>
      <i class="fa-solid fa-hourglass-half"></i>
    </div>
    <div class="card card-counter" data-type="approved" onclick="showTab('approved')">
      <div class="info">
        <h3 id="approvedCount">0</h3>
        <p>Approved Staff</p>
      </div>
      <i class="fa-solid fa-check"></i>
    </div>
    <div class="card card-counter" data-type="rejected" onclick="showTab('rejected')">
      <div class="info">
        <h3 id="rejectedCount">0</h3>
        <p>Rejected Staff</p>
      </div>
      <i class="fa-solid fa-xmark"></i>
    </div>
  </div>

  <!-- Staff Management Section -->
  <h4>Staff Management</h4>
  
  <!-- Search and Refresh -->
  <div class="toolbar">
    <input id="searchInput" class="search-input" placeholder="Search staff...">
    <button class="btn-approve" style="background:#4f46e5" onclick="refreshAll()">Refresh</button>
  </div>
  
  <div id="adminAlert" class="alert d-none" role="alert" style="margin:10px 0"></div>
  
  <!-- Tables Container -->
  <div id="tablesContainer">
    <!-- Pending Table -->
    <div id="pendingTable" class="table-container">
      <div class="table-header">
        <h5><i class="fa-solid fa-hourglass-half"></i> Pending Approvals</h5>
      </div>
      <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>Department</th>
            <th>Position</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="approvalsBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
      </div>
    </div>

    <!-- Approved Table -->
    <div id="approvedTable" class="table-container" style="display:none;">
      <div class="table-header">
        <h5><i class="fa-solid fa-check"></i> Approved Staff</h5>
      </div>
      <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>Department</th>
            <th>Position</th>
            <th>Status</th>
            <th>Approved By</th>
            <th>Approval Date</th>
          </tr>
        </thead>
        <tbody id="approvedBody"></tbody>
      </table>
      </div>
    </div>

    <!-- Rejected Table -->
    <div id="rejectedTable" class="table-container" style="display:none;">
      <div class="table-header">
        <h5><i class="fa-solid fa-xmark"></i> Rejected Staff</h5>
      </div>
      <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Staff Name</th>
            <th>Department</th>
            <th>Position</th>
            <th>Status</th>
            <th>Rejected By</th>
            <th>Rejection Reason</th>
            <th>Rejection Date</th>
          </tr>
        </thead>
        <tbody id="rejectedBody"></tbody>
      </table>
      </div>
    </div>
  </div>

</div>

<script>
  const alertBox = document.getElementById('adminAlert');
  function showAlert(msg, type){
    alertBox.textContent = msg;
    alertBox.className = 'alert alert-' + type;
  }

  // SweetAlert functions
  function showSweetAlert(title, text, icon = 'info') {
    Swal.fire({
      title: title,
      text: text,
      icon: icon,
      confirmButtonText: 'OK'
    });
  }

  function logout() {
    Swal.fire({
      title: 'Logout',
      text: 'Are you sure you want to logout?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: 'Yes, Logout',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: 'Logged Out',
          text: 'You have been successfully logged out.',
          icon: 'success',
          confirmButtonText: 'OK'
        }).then(() => {
          window.location.href = 'login.html';
        });
      }
    });
  }

  function showTab(which){
    const pendingT = document.getElementById('pendingTable');
    const approvedT = document.getElementById('approvedTable');
    const rejectedT = document.getElementById('rejectedTable');
    
    // Hide all tables
    pendingT.style.display = 'none';
    approvedT.style.display = 'none';
    rejectedT.style.display = 'none';
    
    // Remove active class from all cards
    document.querySelectorAll('.card-counter').forEach(card => card.classList.remove('active'));
    
    // Show selected table and highlight card
    if(which === 'approved'){
      approvedT.style.display = '';
      document.querySelector('.card-counter[data-type="approved"]').classList.add('active');
      fetchApproved();
    } else if(which === 'rejected'){
      rejectedT.style.display = '';
      document.querySelector('.card-counter[data-type="rejected"]').classList.add('active');
      fetchRejected();
    } else {
      pendingT.style.display = '';
      document.querySelector('.card-counter[data-type="pending"]').classList.add('active');
      fetchApprovals();
    }
  }

  async function safeFetchJson(url, options){
    const res = await fetch(url, options || {});
    const ct = res.headers.get('content-type') || '';
    if(ct.includes('application/json')){
      return { ok: true, json: await res.json(), status: res.status };
    }
    const text = await res.text();
    return { ok: false, text, status: res.status };
  }

  async function fetchApprovals(){
    try{
      const r = await safeFetchJson('/api/admin/staff?status=Pending');
      if(!r.ok || !r.json?.ok){
        const msg = r.json?.message || r.text || 'Failed to load';
        throw new Error(msg);
      }
      const data = r.json;
      const tbody = document.getElementById('approvalsBody');
      tbody.innerHTML = '';
      data.data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.first_name} ${row.last_name}</td>
          <td>${row.department}</td>
          <td>${row.position || row.department}</td>
          <td class="status-pending">${row.status}</td>
          <td>
            <div class="action-group">
              <button class="btn-approve" data-id="${row.id}">Approve</button>
              <select class="reason-select" data-id="${row.id}">
              <option value="">Reject reason...</option>
              <option>Incomplete Requirements</option>
              <option>Invalid Information</option>
              <option>Duplicate Account</option>
              <option>Other</option>
              </select>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }catch(err){
      showAlert(err.message || 'Error loading data', 'danger');
    }
  }

  async function fetchApproved(){
    try{
      const r = await safeFetchJson('/api/admin/staff?status=Approved');
      if(!r.ok || !r.json?.ok){
        const msg = r.json?.message || r.text || 'Failed to load';
        throw new Error(msg);
      }
      const data = r.json;
      const tbody = document.getElementById('approvedBody');
      tbody.innerHTML = '';
      data.data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.first_name} ${row.last_name}</td>
          <td>${row.department}</td>
          <td>${row.position || row.department}</td>
          <td class="status-approved">${row.status}</td>
          <td>${row.approved_by || 'Admin'}</td>
          <td>${row.approved_date || new Date().toLocaleDateString()}</td>`;
        tbody.appendChild(tr);
      });
    }catch(err){
      showAlert(err.message || 'Error loading data', 'danger');
    }
  }

  async function fetchRejected(){
    try{
      const r = await safeFetchJson('/api/admin/staff?status=Rejected');
      if(!r.ok || !r.json?.ok){
        const msg = r.json?.message || r.text || 'Failed to load';
        throw new Error(msg);
      }
      const data = r.json;
      const tbody = document.getElementById('rejectedBody');
      tbody.innerHTML = '';
      data.data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.first_name} ${row.last_name}</td>
          <td>${row.department}</td>
          <td>${row.position || row.department}</td>
          <td class="status-rejected">${row.status}</td>
          <td>${row.rejected_by || 'Admin'}</td>
          <td>${row.rejection_reason || '-'}</td>
          <td>${row.rejected_date || new Date().toLocaleDateString()}</td>`;
        tbody.appendChild(tr);
      });
    }catch(err){
      showAlert(err.message || 'Error loading data', 'danger');
    }
  }

  async function doApprove(id){
    try{
      const approver = 'Admin';
      const r = await safeFetchJson('/admin/staff/approve', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, approver})});
      if(!r.ok || !r.json?.ok){
        const msg = r.json?.message || r.text || 'Approve failed';
        throw new Error(msg);
      }
      showSweetAlert('Success', 'Staff member approved successfully!', 'success');
      fetchApprovals();
    }catch(err){
      showSweetAlert('Error', err.message || 'Approve error', 'error');
    }
  }

  async function doReject(id, providedReason){
    const reason = (providedReason || '').trim();
    if(!reason){ return; }
    try{
      const approver = 'Admin';
      const r = await safeFetchJson('/admin/staff/reject', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, reason, approver})});
      if(!r.ok || !r.json?.ok){
        const msg = r.json?.message || r.text || 'Reject failed';
        throw new Error(msg);
      }
      showSweetAlert('Staff Rejected', 'Staff member has been rejected.', 'warning');
      fetchApprovals();
    }catch(err){
      showSweetAlert('Error', err.message || 'Reject error', 'error');
    }
  }

  document.addEventListener('click', function(e){
    if(e.target.classList.contains('btn-approve')){
      doApprove(e.target.getAttribute('data-id'));
    }
  });

  document.addEventListener('change', function(e){
    if(e.target.classList.contains('reason-select')){
      const id = e.target.getAttribute('data-id');
      const reason = e.target.value;
      if(reason){ doReject(id, reason); e.target.value = ''; }
    }
  });

  // search filter
  document.addEventListener('keyup', function(e){
    if(e.target && e.target.id === 'searchInput'){
      const q = e.target.value.toLowerCase();
      const visibleTable = document.querySelector('#tablesContainer .table-container:not([style*="display: none"])');
      if(!visibleTable) return;
      const tbody = visibleTable.querySelector('tbody');
      if(!tbody) return;
      Array.from(tbody.children).forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    }
  });

  async function refreshAll(){ await Promise.all([refreshCounts(), fetchApprovals(), fetchApproved(), fetchRejected()]); }

  // Load admin name from session-backed API
  (async function(){
    try{
      const r = await fetch('/api/admin/me');
      const j = await r.json();
      if(j && j.ok){ document.getElementById('adminName').textContent = j.admin_name || 'Admin'; }
    }catch(err){}
  })();

  async function refreshCounts(){
    try{
      const r = await safeFetchJson('/api/admin/staff/counts');
      if(!r.ok || !r.json?.ok) return;
      const c = r.json.data || {};
      document.getElementById('pendingCount').textContent = c.Pending ?? 0;
      document.getElementById('approvedCount').textContent = c.Approved ?? 0;
      document.getElementById('rejectedCount').textContent = c.Rejected ?? 0;
    }catch(e){ /* ignore for now */ }
  }

  // Load content function for navigation
  function loadContent(type) {
    const mainContent = document.querySelector('.main-content');
    
    if (type === 'password') {
      mainContent.innerHTML = `
        <div class="card shadow-sm p-4">
          <h5><i class="fa-solid fa-lock"></i> Change Password</h5>
          <form id="passwordForm" class="mt-3">
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input id="currentPassword" type="password" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input id="newPassword" type="password" class="form-control" required minlength="6" />
              <div class="form-text">Password must be at least 6 characters long</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input id="confirmPassword" type="password" class="form-control" required />
            </div>
            <button class="btn btn-primary" type="submit">Update Password</button>
          </form>
        </div>
      `;
      
      // Add form submission handler
      setTimeout(() => {
        const form = document.getElementById('passwordForm');
        if(form) {
          form.addEventListener('submit', handlePasswordChange);
        }
      }, 100);
    } else {
      // Default dashboard content
      mainContent.innerHTML = `
        <!-- Status Cards -->
        <div class="cards">
          <div class="card card-counter" data-type="pending" onclick="showTab('pending')">
            <div class="info">
              <h3 id="pendingCount">0</h3>
              <p>Pending</p>
            </div>
            <i class="fa-solid fa-clock"></i>
          </div>
          <div class="card card-counter" data-type="approved" onclick="showTab('approved')">
            <div class="info">
              <h3 id="approvedCount">0</h3>
              <p>Approved</p>
            </div>
            <i class="fa-solid fa-check"></i>
          </div>
          <div class="card card-counter" data-type="rejected" onclick="showTab('rejected')">
            <div class="info">
              <h3 id="rejectedCount">0</h3>
              <p>Rejected</p>
            </div>
            <i class="fa-solid fa-times"></i>
          </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
          <div class="search-container">
            <input type="text" class="search-input" placeholder="Search requests..." id="searchInput">
            <i class="fa-solid fa-search"></i>
          </div>
          <button class="btn-approve" style="background:#4f46e5" onclick="refreshAll()">Refresh</button>
        </div>

        <!-- Tables -->
        <div class="table-container">
          <table id="pendingTable" class="data-table">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Student Number</th>
                <th>Course</th>
                <th>Year Level</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pendingList">
              <!-- Data will be loaded here -->
            </tbody>
          </table>

          <table id="approvedTable" class="data-table" style="display:none;">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Student Number</th>
                <th>Course</th>
                <th>Year Level</th>
                <th>Status</th>
                <th>Date Approved</th>
              </tr>
            </thead>
            <tbody id="approvedList">
              <!-- Data will be loaded here -->
            </tbody>
          </table>

          <table id="rejectedTable" class="data-table" style="display:none;">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Student Number</th>
                <th>Course</th>
                <th>Year Level</th>
                <th>Status</th>
                <th>Date Rejected</th>
              </tr>
            </thead>
            <tbody id="rejectedList">
              <!-- Data will be loaded here -->
            </tbody>
          </table>
        </div>
      `;
    }
  }

  // Handle password change
  async function handlePasswordChange(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Client-side validation
    if (!currentPassword || !newPassword || !confirmPassword) {
      Swal.fire('Error', 'All fields are required!', 'error');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      Swal.fire('Error', 'New Password and Confirm Password do not match!', 'error');
      return;
    }
    
    if (newPassword.length < 6) {
      Swal.fire('Error', 'New password must be at least 6 characters long!', 'error');
      return;
    }
    
    // Show loading
    Swal.fire({
      title: 'Updating Password...',
      text: 'Please wait while we update your password',
      allowOutsideClick: false,
      showConfirmButton: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });
    
    try {
      const response = await fetch('/api/staff/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          current_password: currentPassword,
          new_password: newPassword,
          confirm_password: confirmPassword
        })
      });
      
      const data = await response.json();
      
      if (data.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Password Updated!',
          text: 'Your password has been successfully updated.',
          confirmButtonText: 'OK'
        }).then(() => {
          // Clear form
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Password Update Failed',
          text: data.message || 'An error occurred while updating your password.',
          confirmButtonText: 'Try Again'
        });
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Network Error',
        text: 'Unable to connect to server. Please check your connection and try again.',
        confirmButtonText: 'OK'
      });
    }
  }

  async function boot(){
    await refreshCounts();
    showTab('pending');
  }

  boot();
</script>

</body>
</html>
