<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>iRequest</title>
  <link rel="icon" href="/static/assets/iRlogo.png" type="image/x-icon">
  <!-- Cache busting for receipt fix - 20250125 -->
  <!-- Modern Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Professional SweetAlert Styling -->
  <link rel="stylesheet" href="/static/assets/css/sweetalert-professional.css">
  <!-- Student Dashboard Styles -->
  <link rel="stylesheet" href="/static/assets/css/student-dashboard.css">
  <!-- Receipt Modal Styles -->
  <link rel="stylesheet" href="/static/assets/css/receipt-modal.css">
  <!-- SweetAlert Utilities -->
  <script src="/static/assets/js/sweetalert-utils.js"></script>
  <!-- Loading Utilities -->
  <script src="/static/assets/js/loading-utils.js"></script>
  <!-- Receipt Modal Utilities -->
  <script src="/static/assets/js/receipt-modal.js?v=20250125"></script>
  <style>
    /* Chat styles removed - chat feature disabled */

    /* Chat styles removed - chat feature disabled */
    
    /* Existing Requests Styles */
    .existing-requests-container {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .existing-requests-header h4 {
      color: #1e293b;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .existing-requests-header h4::before {
      content: "⚠️";
      font-size: 1.2em;
    }
    
    .existing-requests-header p {
      color: #64748b;
      font-size: 0.9em;
      margin-bottom: 16px;
    }
    
    .existing-request-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }
    
    .existing-request-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }
    
    .request-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .request-id {
      font-weight: 600;
      color: #1e293b;
      background: #f1f5f9;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
    }
    
    .request-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .status-pending {
      background: #fef3c7;
      color: #d97706;
    }
    
    .status-approved {
      background: #d1fae5;
      color: #059669;
    }
    
    .status-rejected {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .request-date {
      color: #64748b;
      font-size: 0.85em;
    }
    
    .request-details {
      color: #475569;
      font-size: 0.9em;
      line-height: 1.5;
    }
    
    .request-details strong {
      color: #1e293b;
    }
  </style>

  <style>
    /* Import Modern Design System */
    /* ===== ROOT VARIABLES ===== */
    :root {
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-200: #bfdbfe;
      --primary-300: #93c5fd;
      --primary-400: #60a5fa;
      --primary-500: #3b82f6;
      --primary-600: #2563eb;
      --primary-700: #1d4ed8;
      --primary-800: #1e40af;
      --primary-900: #1e3a8a;

      --secondary-50: #f8fafc;
      --secondary-100: #f1f5f9;
      --secondary-200: #e2e8f0;
      --secondary-300: #cbd5e1;
      --secondary-400: #94a3b8;
      --secondary-500: #64748b;
      --secondary-600: #475569;
      --secondary-700: #334155;
      --secondary-800: #1e293b;
      --secondary-900: #0f172a;

      --success-50: #f0fdf4;
      --success-100: #dcfce7;
      --success-200: #bbf7d0;
      --success-500: #22c55e;
      --success-600: #16a34a;
      --success-700: #15803d;

      --warning-50: #fffbeb;
      --warning-100: #fef3c7;
      --warning-200: #fde68a;
      --warning-500: #f59e0b;
      --warning-600: #d97706;
      --warning-700: #b45309;

      --error-50: #fef2f2;
      --error-100: #fee2e2;
      --error-200: #fecaca;
      --error-500: #ef4444;
      --error-600: #dc2626;
      --error-700: #b91c1c;

      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;

      --bg-primary: #ffffff;
      --bg-secondary: var(--gray-50);
      --surface: var(--bg-primary);

      --font-family-primary: 'Inter', 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

      --text-xs: 0.75rem;
      --text-sm: 0.875rem;
      --text-base: 1rem;
      --text-lg: 1.125rem;
      --text-xl: 1.25rem;
      --text-2xl: 1.5rem;
      --text-3xl: 1.875rem;

      --font-normal: 400;
      --font-medium: 500;
      --font-semibold: 600;
      --font-bold: 700;

      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;

      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --radius-full: 9999px;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ===== RESET & BASE ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family-primary);
      font-size: var(--text-base);
      font-weight: var(--font-normal);
      line-height: 1.6;
      color: var(--gray-800);
      background-color: var(--bg-secondary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      min-height: 100vh;
    }

    /* ===== LAYOUT ===== */
    .sidebar {
      width: 72px;
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      color: white;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      transition: width var(--transition-normal);
      overflow: hidden;
      flex-shrink: 0;
    }

    /* Expanded sidebar */
    .sidebar.expanded {
      width: 280px;
    }

    /* Hamburger button inside sidebar */
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: var(--space-4) var(--space-3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      min-height: 70px;
      width: 100%;
      position: relative;
    }

    .sidebar-hamburger {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      font-size: var(--text-xl);
      cursor: pointer;
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 10;
    }

    .sidebar-hamburger:hover {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.8);
      transform: scale(1.1);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
    }

    .sidebar-hamburger:active {
      transform: scale(0.95);
    }

    .sidebar-title {
      margin-left: var(--space-3);
      font-weight: var(--font-bold);
      font-size: var(--text-xl);
      opacity: 1;
      transform: translateX(0);
      transition: all var(--transition-normal);
      white-space: nowrap;
    }

    .sidebar.expanded .sidebar-title {
      opacity: 1;
      transform: translateX(0);
    }

    /* Hide title cleanly when collapsed to prevent layout shift */
    .sidebar:not(.expanded) .sidebar-title {
      display: none;
    }

    /* Mobile view - always show sidebar title */
    @media (max-width: 768px) {
      .sidebar-title {
        opacity: 1 !important;
        transform: translateX(0) !important;
      }
    }

    /* Navigation items */
    .sidebar-nav {
      flex: 1;
      padding: var(--space-6) 0;
    }

    .sidebar .link-text { 
      opacity: 0;
      transform: translateX(-10px);
      transition: all var(--transition-normal);
      white-space: nowrap;
    }
    
    .sidebar.expanded .link-text { 
      opacity: 1;
      transform: translateX(0);
    }

    /* Mobile view - always show text */
    @media (max-width: 768px) {
      .sidebar .link-text {
        opacity: 1 !important;
        transform: translateX(0) !important;
      }
      
      /* Ensure all button text is visible in mobile */
      .btn, button {
        font-size: var(--text-sm) !important;
        padding: var(--space-2) var(--space-3) !important;
        white-space: nowrap;
        min-height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      .btn i {
        margin-right: var(--space-1);
      }
      
      /* Specific styles for small buttons in mobile */
      .btn-sm {
        font-size: var(--text-xs) !important;
        padding: var(--space-1) var(--space-2) !important;
        min-height: 32px;
      }
      
      .btn-sm i {
        margin-right: var(--space-1);
        font-size: var(--text-sm);
      }
    }
    
    .sidebar a { 
      justify-content: flex-start;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      margin: 0 var(--space-2) var(--space-1);
    }

    /* Center icons and remove side padding when collapsed */
    .sidebar:not(.expanded) a {
      justify-content: center;
      padding: var(--space-3) 0;
    }

    /* Ensure text is hidden only when collapsed */
    .sidebar:not(.expanded) .link-text { display: none; }

    .sidebar.expanded a {
      justify-content: flex-start;
    }

    /* Remove old h2 styles since we're using sidebar-title now */

    .sidebar a {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      font-weight: var(--font-medium);
      transition: all var(--transition-fast);
      cursor: pointer;
      border-radius: 12px;
      margin: 0 var(--space-3) var(--space-2);
      position: relative;
      min-height: 48px;
      font-size: var(--text-sm);
    }

    .sidebar a i {
      width: 20px;
      text-align: center;
      font-size: var(--text-lg);
      flex-shrink: 0;
    }

    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      transform: translateX(2px);
    }

    .sidebar a.active {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
      font-weight: var(--font-semibold);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .sidebar a.active::before {
      display: none;
    }

    .logout {
      margin-top: auto;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      padding: var(--space-4) 0;
    }

    /* Dark Mode Toggle Styles */
    .dark-mode-toggle {
      margin: var(--space-6) 0;
      padding: 0;
    }

    .dark-mode-btn {
      width: 100%;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      padding: var(--space-3) var(--space-4);
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--space-3);
      transition: all var(--transition-normal);
      font-size: var(--text-sm);
      font-weight: 500;
      position: relative;
      min-height: 48px;
      margin: 0 var(--space-3);
    }

    .dark-mode-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
      transform: translateX(2px);
    }

    .dark-mode-btn:active {
      transform: translateX(0);
    }

    .dark-mode-btn i {
      font-size: var(--text-lg);
      width: 20px;
      text-align: center;
      transition: transform var(--transition-normal);
      flex-shrink: 0;
    }

    .dark-mode-btn.active i {
      transform: rotate(180deg);
    }

    /* Dark Mode Styles */
    .dark-mode {
      --primary-50: #1a1a1a;
      --primary-100: #2d2d2d;
      --primary-200: #404040;
      --primary-300: #525252;
      --primary-400: #666666;
      --primary-500: #7a7a7a;
      --primary-600: #8e8e8e;
      --primary-700: #a1a1a1;
      --primary-800: #b5b5b5;
      --primary-900: #c9c9c9;
      
      --gray-50: #1a1a1a;
      --gray-100: #2d2d2d;
      --gray-200: #404040;
      --gray-300: #525252;
      --gray-400: #666666;
      --gray-500: #7a7a7a;
      --gray-600: #8e8e8e;
      --gray-700: #a1a1a1;
      --gray-800: #b5b5b5;
      --gray-900: #c9c9c9;
      
      --text-primary: #ffffff;
      --text-secondary: #b5b5b5;
      --text-muted: #8e8e8e;
      
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #404040;
    }

    /* Global dark mode styles */
    .dark-mode {
      background: #1a1a1a !important;
      color: #ffffff !important;
    }



    .dark-mode input,
    .dark-mode textarea,
    .dark-mode select {
      background: #2d2d2d !important;
      color: #ffffff !important;
      border: 1px solid #404040 !important;
    }

    .dark-mode input::placeholder,
    .dark-mode textarea::placeholder {
      color: #8e8e8e !important;
    }

    .dark-mode .sidebar {
      background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
      border-right: 1px solid #404040;
    }

    .dark-mode .main-content {
      background: #1a1a1a !important;
      color: #ffffff !important;
    }

    .dark-mode .content {
      background: #1a1a1a !important;
      color: #ffffff !important;
    }

    .dark-mode .content h1,
    .dark-mode .content h2,
    .dark-mode .content h3,
    .dark-mode .content h4,
    .dark-mode .content h5,
    .dark-mode .content h6 {
      color: #ffffff !important;
    }

    .dark-mode .topbar {
      background: #2d2d2d !important;
      border-bottom: 1px solid #404040;
      color: #ffffff !important;
    }

    .dark-mode .topbar h1,
    .dark-mode .topbar h2,
    .dark-mode .topbar h3,
    .dark-mode .topbar h4,
    .dark-mode .topbar h5,
    .dark-mode .topbar h6 {
      color: #ffffff !important;
    }

    .dark-mode .card {
      background: #2d2d2d !important;
      border: 1px solid #404040 !important;
      color: #ffffff !important;
    }

    .dark-mode .card-header {
      background: #404040 !important;
      border-bottom: 1px solid #525252 !important;
      color: #ffffff !important;
    }

    .dark-mode .card-body {
      background: #2d2d2d !important;
      color: #ffffff !important;
    }

    .dark-mode .form-control,
    .dark-mode input[type="text"],
    .dark-mode input[type="email"],
    .dark-mode input[type="password"],
    .dark-mode input[type="number"],
    .dark-mode textarea,
    .dark-mode select {
      background: #2d2d2d !important;
      border: 1px solid #404040 !important;
      color: #ffffff !important;
    }

    .dark-mode .form-control:focus,
    .dark-mode input:focus,
    .dark-mode textarea:focus,
    .dark-mode select:focus {
      background: #2d2d2d !important;
      border-color: #8b5cf6 !important;
      color: #ffffff !important;
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2) !important;
    }

    .dark-mode .form-control::placeholder,
    .dark-mode input::placeholder,
    .dark-mode textarea::placeholder {
      color: #8e8e8e !important;
    }

    .dark-mode .btn-primary {
      background: var(--accent-600) !important;
      border-color: var(--accent-600) !important;
      color: #ffffff !important;
    }

    .dark-mode .btn-primary:hover {
      background: var(--accent-700) !important;
      border-color: var(--accent-700) !important;
    }

    .dark-mode .btn-secondary {
      background: #404040 !important;
      border-color: #525252 !important;
      color: #ffffff !important;
    }

    .dark-mode .btn-secondary:hover {
      background: #525252 !important;
      border-color: #666666 !important;
    }

    .dark-mode .table {
      color: #ffffff !important;
      background: #2d2d2d !important;
    }

    .dark-mode .table th {
      background: #404040 !important;
      border-color: #525252 !important;
      color: #ffffff !important;
    }

    .dark-mode .table td {
      border-color: #525252 !important;
      background: #2d2d2d !important;
      color: #ffffff !important;
    }

    .dark-mode .table-striped tbody tr:nth-of-type(odd) {
      background: rgba(255, 255, 255, 0.05) !important;
    }

    .dark-mode .table-striped tbody tr:nth-of-type(even) {
      background: #2d2d2d !important;
    }

    .dark-mode .table-hover tbody tr:hover {
      background: rgba(255, 255, 255, 0.1) !important;
    }

    /* Badge styles */
    .dark-mode .badge {
      color: #ffffff !important;
    }

    .dark-mode .badge-warning {
      background: #f59e0b !important;
      color: #000000 !important;
    }

    .dark-mode .badge-success {
      background: #10b981 !important;
      color: #ffffff !important;
    }

    .dark-mode .badge-danger {
      background: #ef4444 !important;
      color: #ffffff !important;
    }

    .dark-mode .badge-info {
      background: #3b82f6 !important;
      color: #ffffff !important;
    }

    /* Pagination */
    .dark-mode .pagination {
      background: #2d2d2d !important;
      color: #ffffff !important;
    }

    .dark-mode .page-link {
      background: #404040 !important;
      border-color: #525252 !important;
      color: #ffffff !important;
    }

    .dark-mode .page-link:hover {
      background: #525252 !important;
      border-color: #666666 !important;
      color: #ffffff !important;
    }

    .dark-mode .page-item.active .page-link {
      background: var(--accent-600) !important;
      border-color: var(--accent-600) !important;
      color: #ffffff !important;
    }

    /* Section headers */
    .dark-mode .section-header {
      background: #404040 !important;
      color: #ffffff !important;
    }

    .dark-mode .section-title {
      color: #ffffff !important;
    }

    /* Status cards */
    .dark-mode .status-card {
      background: #2d2d2d !important;
      border: 1px solid #404040 !important;
      color: #ffffff !important;
    }

    .dark-mode .status-card .card-body {
      background: #2d2d2d !important;
      color: #ffffff !important;
    }

    /* Profile section */
    .dark-mode .profile-section {
      background: #2d2d2d !important;
      color: #ffffff !important;
    }

    .dark-mode .profile-header {
      background: #404040 !important;
      color: #ffffff !important;
    }

    /* All text elements */
    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3,
    .dark-mode h4,
    .dark-mode h5,
    .dark-mode h6,
    .dark-mode p,
    .dark-mode span,
    .dark-mode div,
    .dark-mode label,
    .dark-mode strong,
    .dark-mode em,
    .dark-mode small,
    .dark-mode .text-muted,
    .dark-mode .form-label,
    .dark-mode .section-title,
    .dark-mode .card-title {
      color: #ffffff !important;
    }

    /* Profile and form sections */
    .dark-mode .profile-container,
    .dark-mode .profile-card,
    .dark-mode .profile-header,
    .dark-mode .profile-body,
    .dark-mode .profile-field,
    .dark-mode .profile-label,
    .dark-mode .profile-input {
      background: #2d2d2d !important;
      color: #ffffff !important;
      border-color: #404040 !important;
    }

    .dark-mode .profile-input {
      background: #1a1a1a !important;
      color: #ffffff !important;
      border: 1px solid #404040 !important;
    }

    .dark-mode p,
    .dark-mode span,
    .dark-mode div {
      color: #ffffff !important;
    }


    /* Specific overrides for better visibility */
    .dark-mode .username,
    .dark-mode .notification,
    .dark-mode .link-text,
    .dark-mode .sidebar-title {
      color: #ffffff !important;
    }

    /* Simple dark mode text visibility */
    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3,
    .dark-mode h4,
    .dark-mode h5,
    .dark-mode h6,
    .dark-mode p,
    .dark-mode span,
    .dark-mode div,
    .dark-mode label {
      color: #ffffff !important;
    }

    .dark-mode label {
      color: #ffffff !important;
    }

    /* Input groups */
    .dark-mode .input-group-text {
      background: #404040 !important;
      border-color: #525252 !important;
      color: #ffffff !important;
    }

    /* Dropdowns */
    .dark-mode .dropdown-menu {
      background: #2d2d2d !important;
      border: 1px solid #404040 !important;
    }

    .dark-mode .dropdown-item {
      color: #ffffff !important;
    }

    .dark-mode .dropdown-item:hover {
      background: #404040 !important;
      color: #ffffff !important;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 72px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: margin-left var(--transition-normal);
      width: calc(100% - 72px);
      overflow-x: hidden;
    }

    /* When sidebar is expanded */
    .main-content.sidebar-expanded { 
      margin-left: 280px; 
      width: calc(100% - 280px);
    }

    /* Topbar */
    .topbar {
      background: var(--surface);
      padding: 0 var(--space-6);
      min-height: 68px; /* consistent top height */
      box-shadow: var(--shadow-sm);
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center; /* vertical centering */
      justify-content: space-between;
      gap: var(--space-4);
      position: sticky;
      top: 0;
      z-index: 100;
      margin-bottom: 0;
    }

    /* Mobile hamburger button in topbar */
    .topbar-hamburger {
      display: none;
      background: var(--primary-500);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      cursor: pointer;
      align-items: center;
      justify-content: center;
      font-size: var(--text-lg);
      transition: all var(--transition-fast);
      margin-right: var(--space-3);
    }

    .topbar-hamburger:hover {
      background: var(--primary-600);
      transform: scale(1.05);
    }

    .topbar-hamburger:active {
      transform: scale(0.95);
    }

    .topbar .username {
      font-weight: var(--font-semibold);
      font-size: var(--text-lg);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }



    /* Content area */
    .content {
      flex: 1;
      padding: var(--space-6) var(--space-6) var(--space-6) var(--space-6);
      overflow-y: auto;
      margin-top: 0;
    }

    .content h1 {
      font-size: var(--text-3xl);
      margin: 0 0 var(--space-6) 0;
      font-weight: var(--font-bold);
      color: var(--gray-800);
    }

    /* Status Cards */
    .status-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-6);
      margin-bottom: var(--space-8);
      position: relative;
      width: 100%;
      max-width: 100%;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      cursor: pointer;
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      min-height: 120px;
      width: 100%;
      box-sizing: border-box;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
      transition: height var(--transition-normal);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .card:hover::before {
      height: 6px;
    }

    .card i {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-2xl);
      color: white;
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    }

    .card div {
      flex: 1;
    }

    .card h3 {
      font-size: var(--text-xl);
      margin: 0 0 var(--space-1);
      font-weight: var(--font-bold);
      color: var(--gray-800);
    }

    .card p {
      font-size: var(--text-sm);
      margin: 0;
      color: var(--gray-600);
      font-weight: var(--font-medium);
    }

    /* Icon Colors */
    .pending i {
      background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
    }
    .processing i {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    }
    .completed i {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
    }
    .rejected i {
      background: linear-gradient(135deg, var(--error-500), var(--error-600));
    }
    .unclaimed i {
      background: linear-gradient(135deg, var(--gray-500), var(--gray-600));
    }
    .claimed i {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
    }

    /* Status Badge */
    .status-badge {
      position: absolute;
      top: var(--space-3);
      right: var(--space-3);
      background: var(--error-500);
      color: white;
      font-size: var(--text-xs);
      font-weight: var(--font-bold);
      border-radius: var(--radius-full);
      min-width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      z-index: 2;
      border: 2px solid white;
    }

    /* Request Form */
    .request-form {
      margin-top: 0;
      background: var(--surface);
      padding: var(--space-8);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      max-width: 100%;
      overflow-x: auto;
    }

    .request-form h2 {
      margin-bottom: var(--space-8);
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      border-bottom: 3px solid var(--primary-500);
      padding-bottom: var(--space-3);
    }

    .request-form h3 {
      margin-bottom: var(--space-5);
      margin-top: var(--space-6);
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--gray-700);
      background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-lg);
      border-left: 4px solid var(--primary-500);
    }

    .request-form input[type="text"],
    .request-form textarea,
    .request-form input[type="file"] {
      padding: var(--space-4) var(--space-5);
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      width: 100%;
      font-size: var(--text-base);
      transition: all var(--transition-fast);
      background: white;
      box-sizing: border-box;
    }

    .request-form input[type="text"]:focus,
    .request-form textarea:focus,
    .request-form input[type="file"]:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }

    .request-form form {
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
    }

    /* Enhanced Reference Number Styling */
    .reference-number-section {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }

    .reference-number-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
    }

    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .section-icon i {
      color: white;
      font-size: 20px;
    }

    .section-title h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #1e293b;
    }

    .section-subtitle {
      margin: 4px 0 0 0;
      color: #64748b;
      font-size: 14px;
    }

    .reference-input-wrapper {
      position: relative;
    }

    .input-group {
      position: relative;
      display: flex;
      align-items: center;
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .input-group:focus-within {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .input-icon {
      padding: 16px;
      color: #64748b;
      background: #f8fafc;
      border-right: 1px solid #e2e8f0;
    }

    .reference-input {
      flex: 1;
      border: none;
      outline: none;
      padding: 16px;
      font-size: 16px;
      font-weight: 500;
      color: #1e293b;
      background: transparent;
    }

    .reference-input::placeholder {
      color: #94a3b8;
      font-weight: 400;
    }

    .input-actions {
      padding: 8px;
    }

    .clear-btn {
      background: #f1f5f9;
      border: none;
      border-radius: 8px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .clear-btn:hover {
      background: #e2e8f0;
      color: #475569;
    }

    .reference-validation {
      margin-top: 16px;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .validation-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .validation-icon {
      flex-shrink: 0;
    }

    .validation-icon i {
      font-size: 20px;
    }

    .validation-message {
      flex: 1;
      font-weight: 500;
    }

    .reference-validation.valid {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border-color: #22c55e;
      color: #166534;
    }

    .reference-validation.valid .validation-icon i {
      color: #22c55e;
    }

    .reference-validation.invalid {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      border-color: #ef4444;
      color: #dc2626;
    }

    .reference-validation.invalid .validation-icon i {
      color: #ef4444;
    }

    .reference-validation.verifying {
      background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%);
      border-color: #f59e0b;
      color: #d97706;
    }

    .reference-validation.verifying .validation-icon i {
      color: #f59e0b;
    }

    .reference-info {
      display: flex;
      gap: 24px;
      margin-top: 16px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(226, 232, 240, 0.5);
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #64748b;
      font-size: 14px;
      font-weight: 500;
    }

    .info-item i {
      color: #3b82f6;
      font-size: 16px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .reference-info {
        flex-direction: column;
        gap: 12px;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .section-icon {
        margin-right: 0;
      }
    }

    .validation-message {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .request-form .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-5);
      width: 100%;
    }

    /* Enhanced responsive grid improvements */
    .responsive-grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-5);
      margin-bottom: var(--space-4);
    }

    .responsive-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-5);
      margin-bottom: var(--space-4);
    }

    .responsive-grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-5);
      margin-bottom: var(--space-4);
    }

    /* Form section containers */
    .form-section {
      background: var(--gray-50);
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      border: 1px solid var(--gray-200);
      margin-bottom: var(--space-6);
    }

    /* Remove white backgrounds in dark mode */
    .dark-mode .form-section {
      background: transparent !important;
      border: 1px solid #404040 !important;
    }

    /* Checkbox and radio styling */
    .request-form label {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      margin-bottom: var(--space-2);
    }

    .request-form label:hover {
      background: var(--primary-50);
      border-color: var(--primary-300);
    }

    .request-form input[type="checkbox"],
    .request-form input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-500);
    }

    /* Payment Section Styles */
    .payment-section {
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin: var(--space-6) 0;
      box-shadow: var(--shadow-md);
      border: 2px solid;
    }

    .gcash-section {
      border-color: #28a745;
      background: linear-gradient(135deg, #f8fff9, #e8f5e8);
    }

    .cash-section {
      border-color: #007bff;
      background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
    }

    .payment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-4);
      border-bottom: 2px solid rgba(0,0,0,0.1);
    }

    .payment-header h4 {
      margin: 0;
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .gcash-section .payment-header h4 {
      color: #28a745;
    }

    .cash-section .payment-header h4 {
      color: #007bff;
    }

    .receipt-number-input {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: rgba(0, 123, 255, 0.05);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(0, 123, 255, 0.2);
    }

    .receipt-number-input label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 600;
      color: #007bff;
      margin-bottom: var(--space-2);
    }

    .receipt-number-input input {
      width: 100%;
      padding: var(--space-3);
      border: 2px solid #e1e5e9;
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      transition: all 0.2s ease;
    }

    .receipt-number-input input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .receipt-upload {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: rgba(0, 123, 255, 0.05);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(0, 123, 255, 0.2);
    }

    .receipt-upload label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 600;
      color: #007bff;
      margin-bottom: var(--space-2);
    }

    .receipt-upload input[type="file"] {
      width: 100%;
      padding: var(--space-3);
      border: 2px dashed #007bff;
      border-radius: var(--radius-md);
      background: rgba(0, 123, 255, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .receipt-upload input[type="file"]:hover {
      border-color: #0056b3;
      background: rgba(0, 123, 255, 0.1);
    }

    .pricing-breakdown {
      margin-top: var(--space-4);
      padding: var(--space-4);
      background: rgba(0, 123, 255, 0.05);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(0, 123, 255, 0.2);
    }

    .pricing-breakdown h5 {
      color: #007bff;
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .pricing-breakdown #pricingDetails {
      margin-bottom: var(--space-3);
    }

    .pricing-item {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
      border-bottom: 1px solid rgba(0, 123, 255, 0.1);
    }

    .pricing-item:last-child {
      border-bottom: none;
    }

    .pricing-item .document-name {
      color: #374151;
      font-weight: 500;
    }

    .pricing-item .document-price {
      color: #007bff;
      font-weight: 600;
    }

    .total-amount {
      padding: var(--space-3);
      background: rgba(0, 123, 255, 0.1);
      border-radius: var(--radius-md);
      text-align: center;
      color: #007bff;
      font-size: var(--text-lg);
    }

    .payment-amount {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      background: white;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .receipt-upload-container {
      margin-top: var(--space-3);
    }

    .receipt-upload-container input[type="file"] {
      width: 100%;
      padding: var(--space-3);
      border: 2px dashed #007bff;
      border-radius: var(--radius-md);
      background: rgba(0, 123, 255, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .receipt-upload-container input[type="file"]:hover {
      border-color: #0056b3;
      background: rgba(0, 123, 255, 0.1);
    }

    .receipt-preview-container {
      text-align: center;
      margin-top: var(--space-3);
    }

    .qr-code-container {
      text-align: center;
      margin-bottom: var(--space-6);
    }

    .qr-instructions {
      margin-bottom: var(--space-5);
    }

    .qr-title {
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      margin-bottom: var(--space-2);
    }

    .qr-subtitle {
      font-size: var(--text-sm);
      color: var(--gray-600);
      font-style: italic;
    }

    .qr-code-wrapper {
      display: inline-block;
      padding: var(--space-6);
      background: white;
      border: 3px solid #28a745;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      margin: var(--space-4) 0;
    }

    .qr-code-image {
      width: 300px;
      height: 300px;
      border-radius: var(--radius-lg);
      display: block;
    }

    .payment-instructions {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-5);
    }

    .payment-instructions h5 {
      color: #856404;
      margin-bottom: var(--space-4);
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
    }

    .payment-instructions ol {
      color: #856404;
      margin: 0;
      padding-left: var(--space-6);
    }

    .payment-instructions li {
      margin-bottom: var(--space-2);
      line-height: 1.5;
    }

    .receipt-upload {
      background: white;
      padding: var(--space-5);
      border-radius: var(--radius-lg);
      border: 2px dashed var(--gray-300);
    }

    .receipt-upload label {
      display: block;
      margin-bottom: var(--space-3);
      font-weight: var(--font-semibold);
      color: var(--gray-700);
    }

    .receipt-upload input[type="file"] {
      margin-bottom: var(--space-4);
    }

    .receipt-preview {
      margin-top: var(--space-4);
    }

    .cash-instructions {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: var(--radius-lg);
      padding: var(--space-5);
    }

    .cash-instructions h5 {
      color: #0c5460;
      margin-bottom: var(--space-4);
      font-size: var(--text-base);
      font-weight: var(--font-semibold);
    }

    .cash-info {
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
      color: #0c5460;
    }

    .cash-info i {
      color: #f39c12;
      font-size: var(--text-lg);
      margin-top: 2px;
    }

    .cash-info p {
      margin: 0;
      line-height: 1.5;
    }

    /* Enhanced Form Section Styles */
    .documents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-3);
    }

    .document-name {
      font-weight: var(--font-medium);
      color: var(--gray-700);
    }

    /* Remove white backgrounds from document checkboxes in dark mode */
    .dark-mode .documents-grid label {
      background: transparent !important;
      border: none !important;
      padding: var(--space-2) 0 !important;
    }

    .dark-mode .document-name {
      color: #ffffff !important;
    }

    .payment-method-options {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .payment-option {
      font-weight: var(--font-semibold);
      color: var(--gray-700);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    /* Remove white backgrounds from payment options in dark mode */
    .dark-mode .payment-method-options label {
      background: transparent !important;
      border: none !important;
      padding: var(--space-2) 0 !important;
    }

    .dark-mode .payment-option {
      color: #ffffff !important;
    }

    .purpose-options {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .purpose-option {
      font-weight: var(--font-medium);
      color: var(--gray-700);
    }

    /* Remove white backgrounds from purpose options in dark mode */
    .dark-mode .purpose-options label {
      background: transparent !important;
      border: none !important;
      padding: var(--space-2) 0 !important;
    }

    .dark-mode .purpose-option {
      color: #ffffff !important;
    }

    .other-purpose {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .other-input {
      flex: 1;
      min-width: 200px;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--gray-300);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }

    .id-upload-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .id-preview-container {
      text-align: center;
      padding: var(--space-4);
      border: 2px dashed var(--gray-300);
      border-radius: var(--radius-lg);
      background: var(--gray-50);
    }

    .id-preview {
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      display: none;
    }

    .id-preview.show {
      display: block;
    }

    .submit-section {
      text-align: center;
      background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
      border: 2px solid var(--primary-200);
    }

    .submit-btn {
      padding: var(--space-4) var(--space-8);
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      transition: all var(--transition-fast);
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    /* Clearance Modal Styles */
    .clearance-modal-popup {
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--gray-200);
    }

    .clearance-modal-content {
      padding: 0;
    }

    .clearance-modal {
      font-family: var(--font-family);
    }

    .request-header {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      color: white;
      padding: var(--space-6);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      margin: calc(-1 * var(--space-6)) calc(-1 * var(--space-6)) var(--space-6) calc(-1 * var(--space-6));
    }

    .request-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-4);
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      background: rgba(255, 255, 255, 0.1);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      backdrop-filter: blur(10px);
    }

    .info-item i {
      font-size: var(--text-lg);
      color: rgba(255, 255, 255, 0.9);
      width: 20px;
      text-align: center;
    }

    .info-label {
      font-weight: var(--font-semibold);
      color: rgba(255, 255, 255, 0.9);
      font-size: var(--text-sm);
    }

    .info-value {
      font-weight: var(--font-bold);
      color: white;
      font-size: var(--text-sm);
    }

    .payment-paid {
      color: #10b981;
      font-weight: var(--font-bold);
    }

    .payment-pending {
      color: #f59e0b;
      font-weight: var(--font-bold);
    }

    .clearance-table-container {
      background: white;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--gray-200);
    }

    .table-header {
      background: var(--gray-50);
      padding: var(--space-4) var(--space-6);
      border-bottom: 2px solid var(--gray-200);
    }

    .table-header h4 {
      margin: 0;
      font-size: var(--text-lg);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .table-header i {
      color: var(--primary-500);
    }

    .table-wrapper {
      max-height: 400px;
      overflow-y: auto;
      overflow-x: auto;
    }

    .clearance-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    .clearance-table thead {
      background: var(--gray-100);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .clearance-table th {
      padding: var(--space-4) var(--space-3);
      text-align: left;
      font-weight: var(--font-bold);
      font-size: var(--text-sm);
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--gray-300);
    }

    .clearance-table td {
      padding: var(--space-4) var(--space-3);
      border-bottom: 1px solid var(--gray-200);
      vertical-align: middle;
    }

    .office-row:hover {
      background: var(--primary-50);
    }

    .office-info {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .office-icon {
      color: var(--primary-500);
      font-size: var(--text-sm);
      width: 16px;
      text-align: center;
    }

    .office-name {
      font-weight: var(--font-semibold);
      color: var(--gray-800);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-approved {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .status-rejected {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .status-badge i {
      font-size: var(--text-xs);
    }

    .signed-by,
    .date-cell,
    .reason-cell {
      font-size: var(--text-sm);
      color: var(--gray-600);
    }

    .reason-cell {
      max-width: 200px;
      word-wrap: break-word;
    }

    /* Professional Receipt Button */
    .view-receipt-btn {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      cursor: pointer;
      transition: var(--transition-normal);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }
    
    .view-receipt-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: var(--transition-slow);
    }
    
    .view-receipt-btn:hover {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      color: white;
      text-decoration: none;
    }
    
    .view-receipt-btn:hover::before {
      left: 100%;
    }
    
    .view-receipt-btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .view-receipt-btn i {
      font-size: 0.875rem;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
    }
    
    /* Mobile receipt button */
    .view-receipt-mobile {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      cursor: pointer;
      transition: var(--transition-normal);
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      position: relative;
      overflow: hidden;
      text-decoration: none;
    }
    
    .view-receipt-mobile:hover {
      background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      color: white;
      text-decoration: none;
    }
    
    /* No receipt text styling */
    .no-receipt-text {
      color: var(--gray-500);
      font-size: var(--text-sm);
      font-style: italic;
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      background: var(--gray-100);
      border-radius: var(--radius-md);
      border: 1px solid var(--gray-200);
    }
    
    .no-receipt-text i {
      font-size: var(--text-xs);
      opacity: 0.7;
    }

    /* Responsive modal styles */
    @media (max-width: 768px) {
      .request-info {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }
      
      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
        text-align: left;
      }
      
      .clearance-table {
        min-width: 600px;
      }
      
      .clearance-table th,
      .clearance-table td {
        padding: var(--space-3) var(--space-2);
        font-size: var(--text-xs);
      }
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-5);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      line-height: 1;
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      text-decoration: none;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, var(--success-600), var(--success-700));
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .request-form button {
      padding: var(--space-4) var(--space-6);
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      color: white;
      border: none;
      border-radius: var(--radius-lg);
      cursor: pointer;
      font-weight: var(--font-semibold);
      transition: all var(--transition-fast);
      font-size: var(--text-base);
    }

    .request-form button:hover {
      background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Tables */
    .table-wrapper {
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      margin-top: var(--space-6);
      width: 100%;
    }

    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      min-width: 1000px; /* Prevent table from being too compressed */
    }

    th, td {
      padding: var(--space-4) var(--space-5);
      border-bottom: 1px solid var(--gray-200);
      text-align: left;
      font-size: var(--text-sm);
      vertical-align: middle;
      white-space: nowrap; /* Prevent text wrapping */
    }

    th {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      color: white;
      font-weight: var(--font-semibold);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    /* Specific column widths for requests table */
    table th:nth-child(1), 
    table td:nth-child(1) {
      width: 15%; /* Student Name */
      min-width: 120px;
    }

    table th:nth-child(2), 
    table td:nth-child(2) {
      width: 20%; /* Documents */
      min-width: 150px;
    }

    table th:nth-child(3), 
    table td:nth-child(3) {
      width: 15%; /* Purpose */
      min-width: 120px;
    }

    table th:nth-child(4), 
    table td:nth-child(4) {
      width: 12%; /* Status */
      min-width: 90px;
    }

    table th:nth-child(5), 
    table td:nth-child(5) {
      width: 15%; /* Payment Status */
      min-width: 110px;
    }

    table th:nth-child(6), 
    table td:nth-child(6) {
      width: 15%; /* Clearance Status */
      min-width: 110px;
    }

    table th:nth-child(7), 
    table td:nth-child(7) {
      width: 8%; /* Files */
      min-width: 80px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr {
      transition: background-color var(--transition-fast);
    }

    tbody tr:hover {
      background: var(--gray-50);
    }

    /* ===== My Requests (responsive) ===== */
    /* Shared chips and card lines for request items */
    .request-card-line { display: flex; align-items: center; gap: 10px; margin: 6px 0; }
    .request-card-line .label { font-weight: var(--font-semibold); color: var(--gray-700); }
    .request-card-line .value { color: var(--gray-800); }
    .status-badge-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-weight: 600; font-size: 12px; border: 1px solid transparent; }
    .chip-pending { background: var(--warning-100); color: var(--warning-700); border-color: var(--warning-200); }
    .chip-approved { background: var(--success-100); color: var(--success-700); border-color: var(--success-200); }
    .chip-rejected { background: var(--error-100); color: var(--error-700); border-color: var(--error-200); }

    /* Pending Requests panel */
    .pending-requests-header { display: flex; align-items: center; justify-content: space-between; gap: var(--space-4); margin-top: var(--space-6); }
    
    .pending-requests-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .pending-requests-card { background: var(--surface); border-radius: var(--radius-xl); box-shadow: var(--shadow-md); border: 1px solid var(--gray-200); padding: var(--space-5); }
    .pending-table { display: block; }
    .pending-cards { display: none; }
    .pending-card-item { background: var(--surface); border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); border: 1px solid var(--gray-200); padding: var(--space-4); margin-top: var(--space-4); transition: transform var(--transition-fast), box-shadow var(--transition-fast); cursor: pointer; }
    .pending-card-item:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .pending-pagination { display: flex; align-items: center; justify-content: flex-end; gap: 8px; padding: 12px 0; }
    .pending-pagination button { padding: 6px 10px; border-radius: var(--radius-lg); border: 1px solid var(--gray-300); background: var(--surface); cursor: pointer; }
    .pending-pagination button[disabled] { opacity: 0.5; cursor: not-allowed; }
    .pending-pagination .page-info { color: var(--gray-600); font-weight: 600; }

    /* Status Classes */
    .status-pending {
      color: var(--warning-600);
      font-weight: var(--font-semibold);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }

    .status-pending::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: var(--radius-full);
      background: var(--warning-500);
    }

    .status-signed {
      color: var(--success-600);
      font-weight: var(--font-semibold);
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }

    .status-signed::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: var(--radius-full);
      background: var(--success-500);
    }

    /* Signer Info */
    .signer-info {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: var(--font-medium);
      color: var(--success-600);
    }

    .signer-info i {
      color: var(--success-500);
    }

    /* Preview ng Valid ID */
    #idPreview {
      margin-top: var(--space-3);
      max-width: 300px;
      border: 2px solid var(--gray-300);
      border-radius: var(--radius-lg);
      display: none;
      box-shadow: var(--shadow-sm);
    }

    /* Remove mobile menu toggle styles since hamburger is now in sidebar */

    /* Mobile Menu Overlay */
    .mobile-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1040;
      display: none;
    }

    /* Profile Card Styles */
    .profile-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .profile-card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      overflow: hidden;
      margin-top: var(--space-6);
    }

    .profile-header {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      color: white;
      padding: var(--space-6);
      position: relative;
    }

    .profile-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
    }

    .profile-header-content {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      position: relative;
      z-index: 1;
    }

    .profile-header-content i {
      font-size: 2.5rem;
      opacity: 0.9;
    }

    .profile-header-content h2 {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      margin: 0;
    }

    .profile-body {
      padding: var(--space-8);
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-6);
      margin-bottom: var(--space-8);
      width: 100%;
    }

    /* Allow specific fields to span the full grid width when needed */
    .profile-field.full-width {
      grid-column: 1 / -1;
    }

    .profile-field {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .profile-label {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      color: var(--gray-700);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-1);
    }

    .profile-input {
      padding: var(--space-4);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      font-size: var(--text-base);
      font-weight: var(--font-medium);
      color: var(--gray-800);
      background: var(--gray-50);
      transition: all var(--transition-fast);
      cursor: not-allowed;
    }

    .profile-input:focus {
      outline: none;
      border-color: var(--primary-300);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .profile-notice {
      background: linear-gradient(135deg, var(--primary-50) 0%, var(--primary-100) 100%);
      border: 1px solid var(--primary-200);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      color: var(--primary-700);
      font-weight: var(--font-medium);
    }

    .profile-notice i {
      font-size: var(--text-lg);
      color: var(--primary-500);
    }

    /* Clearance Status Section */
    .clearance-status-section {
      margin-top: var(--space-8);
    }

    .clearance-status-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
      margin-bottom: var(--space-6);
    }

    .clearance-status-title i {
      color: var(--primary-500);
      font-size: var(--text-xl);
    }

    .no-clearance-message {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-5);
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      color: var(--gray-600);
      font-weight: var(--font-medium);
      margin: var(--space-4) 0;
    }

    .no-clearance-message i {
      color: var(--gray-500);
      font-size: var(--text-lg);
    }

    /* ===== Request Tracking Card ===== */
    .request-card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--gray-200);
      padding: var(--space-6);
      margin-top: var(--space-6);
    }

    .request-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-5);
    }

    .request-card-title {
      font-size: var(--text-xl);
      font-weight: var(--font-bold);
      color: var(--gray-800);
    }

    .badge-status {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: 0.35rem 0.6rem;
      border-radius: var(--radius-full);
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      line-height: 1;
      white-space: nowrap;
    }

    .badge-pending { background: var(--warning-100); color: var(--warning-700); border: 1px solid var(--warning-200); }
    .badge-approved { background: var(--success-100); color: var(--success-700); border: 1px solid var(--success-200); }
    .badge-rejected { background: var(--error-100); color: var(--error-700); border: 1px solid var(--error-200); }

    .request-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--space-4) var(--space-8);
      width: 100%;
    }

    .request-detail {
      display: grid;
      grid-template-columns: 180px 1fr;
      align-items: start;
      gap: var(--space-3);
      min-width: 0;
    }

    .detail-label {
      font-weight: var(--font-semibold);
      color: var(--gray-700);
      white-space: nowrap;
    }

    .detail-value {
      font-weight: var(--font-normal);
      color: var(--gray-800);
      overflow-wrap: anywhere;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    
    /* Mobile-first approach - ensure hamburger is always visible */
    .sidebar-hamburger {
      display: flex !important; /* Always visible */
      position: relative;
      z-index: 1001;
      min-width: 40px;
      min-height: 40px;
    }

    /* Responsive utility classes */
    .mobile-only {
      display: none;
    }
    
    .desktop-only {
      display: block;
    }
    
    .tablet-only {
      display: none;
    }

    /* Responsive text sizing */
    .responsive-text {
      font-size: clamp(var(--text-sm), 2.5vw, var(--text-lg));
    }

    /* Responsive spacing */
    .responsive-padding {
      padding: clamp(var(--space-2), 3vw, var(--space-6));
    }

    /* Responsive margins */
    .responsive-margin {
      margin: clamp(var(--space-2), 3vw, var(--space-6));
    }

    /* Tablet and Desktop - Sidebar behavior */
    @media (min-width: 769px) {
      .sidebar {
        width: 72px;
        position: fixed;
        height: 100vh;
        transform: translateX(0);
        transition: width var(--transition-normal);
      }
      
      .sidebar.expanded {
        width: 280px;
      }
      
      .main-content {
        margin-left: 72px;
        transition: margin-left var(--transition-normal);
      }
      
      .main-content.sidebar-expanded {
        margin-left: 280px;
      }
      
      .mobile-menu-overlay {
        display: none !important;
      }
      
      /* Desktop utility classes */
      .desktop-only {
        display: block;
      }
      
      .mobile-only {
        display: none;
      }
      
      .tablet-only {
        display: none;
      }
    }

    /* Tablet specific adjustments */
    @media (min-width: 769px) and (max-width: 1024px) {
      .sidebar.expanded {
        width: 260px;
      }
      
      .main-content.sidebar-expanded {
        margin-left: 260px;
      }
      
      .status-cards {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--space-4);
      }
      
      .request-form .grid {
        grid-template-columns: 1fr 1fr;
      }

      /* Tablet responsive grids */
      .responsive-grid-2 {
        grid-template-columns: 1fr 1fr;
      }
      
      .responsive-grid-3 {
        grid-template-columns: 1fr 1fr;
      }
      
      .responsive-grid-4 {
        grid-template-columns: 1fr 1fr;
      }
      
      /* Tablet utility classes */
      .tablet-only {
        display: block;
      }
      
      .mobile-only {
        display: none;
      }
      
      .desktop-only {
        display: none;
      }
    }

    /* Mobile - Full overlay sidebar */
    @media (max-width: 768px) {
      .sidebar {
        width: 280px;
        position: fixed;
        height: 100vh;
        transform: translateX(-100%);
        transition: transform var(--transition-normal);
        z-index: 1050;
        box-shadow: var(--shadow-xl);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
        width: 100%;
      }
      
      .topbar {
        padding: var(--space-3) var(--space-4);
        position: relative;
        justify-content: flex-start;
      }
      
      /* Show mobile hamburger button in topbar */
      .topbar-hamburger {
        display: flex !important;
        min-width: 40px;
        min-height: 40px;
        font-size: var(--text-lg);
      }
      
      .topbar .username {
        margin-left: var(--space-2);
        flex: 1;
      }
      
      .content {
        padding: var(--space-4);
      }
      
      .status-cards {
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }
      
      .card {
        padding: var(--space-4);
        flex-direction: row;
        text-align: left;
      }
      
      .request-form .grid {
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }

      /* Responsive grid adjustments for mobile */
      .responsive-grid-2,
      .responsive-grid-3,
      .responsive-grid-4 {
        grid-template-columns: 1fr;
        gap: var(--space-3);
      }
      
      /* Form section improvements for mobile */
      .form-section {
        padding: var(--space-4);
        margin-bottom: var(--space-4);
      }
      
      /* Better spacing for form elements on mobile */
      .request-form input[type="text"],
      .request-form textarea,
      .request-form input[type="file"] {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
      }
      
      /* Mobile responsive for new form sections */
      .documents-grid {
        grid-template-columns: 1fr;
        gap: var(--space-2);
      }
      
      .other-purpose {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
      }
      
      .other-input {
        min-width: 100%;
      }
      
      .payment-method-options {
        gap: var(--space-2);
      }
      
      .purpose-options {
        gap: var(--space-2);
      }

      /* Profile responsive */
      .profile-grid {
        grid-template-columns: 1fr;
        gap: var(--space-4);
      }

      .profile-body {
        padding: var(--space-6);
      }

      /* Table responsive - switch to cards */
      .table-wrapper {
        margin: var(--space-4) -var(--space-4);
        border-radius: 0;
        border-left: none;
        border-right: none;
      }

      /* Switch Pending Requests to cards on mobile */
      .pending-table { 
        display: none; 
      }
      .pending-cards { 
        display: block; 
      }
      
      /* Form improvements for mobile */
      .request-form {
        padding: var(--space-4);
      }
      
      .request-form h2 {
        font-size: var(--text-xl);
      }
      
      .request-form h3 {
        font-size: var(--text-base);
      }
      
      /* Payment sections mobile optimization */
      .payment-section {
        padding: var(--space-4);
        margin: var(--space-4) 0;
      }
      
      .payment-header {
        flex-direction: column;
        gap: var(--space-3);
        text-align: center;
      }
      
      .qr-code-image {
        width: 250px;
        height: 250px;
      }
      
      .qr-code-wrapper {
        padding: var(--space-4);
      }
      
      #gcashPaymentSection img {
        width: 100%;
        max-width: 300px;
        height: auto;
      }
      
      /* Mobile utility classes */
      .mobile-only {
        display: block;
      }
      
      .desktop-only {
        display: none;
      }
      
      .tablet-only {
        display: none;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      .topbar {
        padding: var(--space-3);
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      
      .topbar .username {
        font-size: var(--text-base);
        margin-left: 40px; /* Space for hamburger */
      }
      
      .content {
        padding: var(--space-3);
      }
      
      .content h1 {
        font-size: var(--text-2xl);
        margin-bottom: var(--space-4);
      }
      
      .card {
        flex-direction: column;
        text-align: center;
        gap: var(--space-3);
        padding: var(--space-3);
      }
      
      .card i {
        width: 48px;
        height: 48px;
        font-size: var(--text-xl);
      }

      /* Profile responsive for small screens */
      .profile-header {
        padding: var(--space-4);
      }

      .profile-header-content {
        flex-direction: column;
        text-align: center;
        gap: var(--space-2);
      }

      .profile-body {
        padding: var(--space-4);
      }

      .profile-grid {
        gap: var(--space-3);
      }

      .clearance-status-title {
        font-size: var(--text-xl);
        flex-direction: column;
        text-align: center;
        gap: var(--space-2);
      }

      /* Request card responsive */
      .request-details-grid { 
        grid-template-columns: 1fr; 
        gap: var(--space-3);
      }
      .request-detail { 
        grid-template-columns: 1fr; 
        gap: var(--space-2);
      }
      
      /* Form improvements for small screens */
      .request-form {
        padding: var(--space-3);
      }
      
      .request-form input[type="text"],
      .request-form textarea,
      .request-form input[type="file"] {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-sm);
      }
      
      /* Payment sections small screen optimization */
      .payment-section {
        padding: var(--space-3);
        margin: var(--space-3) 0;
      }
      
      .qr-code-image {
        width: 200px;
        height: 200px;
      }
      
      .qr-code-wrapper {
        padding: var(--space-3);
      }
      
      .payment-header h4 {
        font-size: var(--text-lg);
      }
      
      .payment-amount {
        font-size: var(--text-xl);
        padding: var(--space-2) var(--space-3);
      }
      
      /* Button improvements for small screens */
      .btn {
        padding: var(--space-2) var(--space-4);
        font-size: var(--text-sm);
      }
      
      .request-form button {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
      }
    }

    /* Extra small devices */
    @media (max-width: 360px) {
      .content {
        padding: var(--space-2);
      }
      
      .card {
        padding: var(--space-2);
      }
      
      .request-form {
        padding: var(--space-2);
      }
      
      .profile-body {
        padding: var(--space-3);
      }
      
      .topbar {
        padding: var(--space-2);
      }
      
      .topbar .username {
        font-size: var(--text-sm);
      }
    }

    /* Print Styles */
    @media print {
      body * {
        visibility: hidden;
      }
      
      .printable-clearance,
      .printable-clearance * {
        visibility: visible;
      }
      
      .printable-clearance {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      
      .sidebar,
      .topbar,
      .btn,
      button {
        display: none !important;
      }
      
      .request-form {
        box-shadow: none;
        border: 1px solid var(--gray-800);
      }
      
      table {
        border-collapse: collapse;
      }
      
      th, td {
        border: 1px solid var(--gray-800);
        padding: var(--space-2);
      }
    }
  </style>
  <!-- Bootstrap JS (for consistency with dean pages that use Bootstrap UI) -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-hamburger" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      <span class="sidebar-title">iRequest</span>
    </div>
    <div class="sidebar-nav">
      <a id="documentLink"><i class="fas fa-file-alt"></i> <span class="link-text">Document Request</span></a>
      <a id="dashboardLink" class="active"><i class="fas fa-home"></i> <span class="link-text">Request Status</span></a>
     
      
      <a id="profileLink"><i class="fas fa-user"></i> <span class="link-text">Profile</span></a>
    </div>
    
    <!-- Dark Mode Toggle -->
    <div class="dark-mode-toggle">
      <button id="darkModeToggle" class="dark-mode-btn">
        <i class="fas fa-moon" id="darkModeIcon"></i>
        <span class="link-text">Dark Mode</span>
      </button>
    </div>
    
    <div class="logout">
      <a id="logoutLink"><i class="fas fa-sign-out-alt"></i> <span class="link-text">Logout</span></a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Topbar -->
    <div class="topbar">
      <button class="topbar-hamburger" id="topbarToggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
      </button>
      <div style="display: flex; align-items: center; gap: var(--space-4); flex: 1;">
        <div class="username">Welcome, <strong id="userFullName"></strong></div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <h1 id="pageTitle">Request Status</h1>

      <!-- Dashboard Section -->
      <div id="dashboardSection">
        <div class="status-cards">
          <button type="button" class="card pending btn" id="pendingBtn">
            <span class="status-badge" id="pendingBadge">0</span>
            <i class="fas fa-hourglass-half"></i>
            <div>
              <h3>Pending</h3>
              <p>Your document request is waiting to be reviewed.</p>
            </div>
          </button>
          <button type="button" class="card processing btn" id="processingBtn">
            <span class="status-badge" id="processingBadge">0</span>
            <i class="fas fa-spinner"></i>
            <div>
              <h3>Processing</h3>
              <p>Your document request is currently being processed.</p>
            </div>
          </button>
          <button type="button" class="card completed btn" id="completedBtn">
            <span class="status-badge" id="completedBadge">0</span>
            <i class="fas fa-check-circle"></i>
            <div>
              <h3>Completed</h3>
              <p>Download files from your completed document requests.</p>
            </div>
          </button>
          <button type="button" class="card rejected btn" id="rejectedBtn">
            <span class="status-badge" id="rejectedBadge">0</span>
            <i class="fas fa-times-circle"></i>
            <div>
              <h3>Rejected</h3>
              <p>View your rejected document requests and reasons.</p>
            </div>
          </button>
          <button type="button" class="card unclaimed btn" id="unclaimedBtn">
            <span class="status-badge" id="unclaimedBadge">0</span>
            <i class="fas fa-box-archive"></i>
            <div>
              <h3>Unclaimed</h3>
              <p>View your unclaimed document requests.</p>
            </div>
          </button>
          <button type="button" class="card claimed btn" id="claimedBtn">
            <span class="status-badge" id="claimedBadge">0</span>
            <i class="fas fa-check-square"></i>
            <div>
              <h3>Claimed</h3>
              <p>View your claimed document requests.</p>
            </div>
          </button>
        </div>


        <!-- Pending Requests Panel (shows inside dashboard when Pending is clicked) -->
        <div id="pendingRequestsPanel" style="display:none;">
          <div class="pending-requests-header">
            <div class="request-card-title" id="requestsHeaderTitle"><i class="fas fa-folder-open"></i> Pending Requests</div>
            <div class="pending-requests-actions">
              <button id="refreshRequestsBtn" class="btn btn-outline-primary btn-sm" onclick="refreshAllRequests()" title="Refresh Data">
                <i class="fas fa-sync-alt"></i> Refresh
              </button>
            </div>
          </div>
          <div class="pending-requests-card">
            <!-- Table (desktop) -->
            <div class="table-wrapper pending-table">
              <div class="table-scroll">
                <table>
                  <thead>
                    <tr>
                      <th>Student Name</th>
                      <th>Documents</th>
                      <th>Purpose</th>
                      <th>Status</th>
                      <th>Payment Status</th>
                      <th>Clearance Status</th>
                      <th>Pickup Date</th>
                      <th>Files</th>
                    </tr>
                  </thead>
                  <tbody id="pendingTableBody"></tbody>
                </table>
              </div>
            </div>
            <!-- Cards (mobile) -->
            <div id="pendingCardsContainer" class="pending-cards"></div>
            <!-- Pagination -->
            <div class="pending-pagination">
              <button id="prevPendingBtn">Prev</button>
              <span class="page-info" id="pendingPageInfo">Page 1</span>
              <button id="nextPendingBtn">Next</button>
            </div>
          </div>
        </div>

      </div>

      <!-- Profile Section (moved here, hidden by default) -->
      <div id="profileSection" style="display:none;">
        <div class="profile-container">
          <div class="profile-card">
            <div class="profile-header">
              <div class="profile-header-content">
                <i class="fas fa-user-circle"></i>
                <h2>Student Profile</h2>
              </div>
            </div>
            <div class="profile-body">
              <form id="profileForm" autocomplete="off">
                <div class="profile-grid">
                  <div class="profile-field">
                    <label class="profile-label">First Name</label>
                    <input id="profileFirstName" type="text" class="profile-input" readonly>
                  </div>
                  <div class="profile-field">
                    <label class="profile-label">Last Name</label>
                    <input id="profileLastName" type="text" class="profile-input" readonly>
                  </div>
                  <div class="profile-field">
                    <label class="profile-label">Middle Name</label>
                    <input id="profileMiddleName" type="text" class="profile-input" readonly>
                  </div>
                  <div class="profile-field">
                    <label class="profile-label">Student ID</label>
                    <input id="profileStudentId" type="text" class="profile-input" readonly>
                  </div>
                  <div class="profile-field">
                    <label class="profile-label">Address</label>
                    <input id="profileAddress" type="text" class="profile-input" readonly>
                  </div>
                  <div class="profile-field full-width">
                    <label class="profile-label">Course</label>
                    <input id="profileCourse" type="text" class="profile-input" readonly>
                  </div>
                  <div class="profile-field">
                    <label class="profile-label">Year Level</label>
                    <input id="profileYearLevel" type="text" class="profile-input" readonly>
                  </div>
                </div>
                <div class="profile-notice">
                  <i class="fas fa-info-circle"></i>
                  <span>Profile information is read-only. Contact the administrator to update your information.</span>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Document Section -->
      <div id="documentSection" style="display:none;">
        
        <!-- Individual Document Request Form -->
       

        <!-- Moved Clearance Section under Documents -->
        <div id="clearanceSection" class="printable-clearance" style="margin-top:30px;">
        
          <!-- Enhanced Document Information Section -->
          <div class="document-info-container">
            <div class="document-info-header">
              <div class="header-icon">
                <i class="fas fa-file-alt"></i>
              </div>
              <div class="header-content">
                <h2>Document Information</h2>
                <p>Your personal and academic details for document processing</p>
              </div>
            </div>
            
            <div class="document-info-grid">
              <!-- Personal Information Card -->
              <div class="info-card personal-info">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-user"></i>
                  </div>
                  <h3>Personal Information</h3>
                </div>
                <div class="card-content">
                  <div class="input-group">
                    <label>First Name</label>
                    <input type="text" id="docFirstName" placeholder="First Name" readonly>
                  </div>
                  <div class="input-group">
                    <label>Last Name</label>
                    <input type="text" id="docLastName" placeholder="Last Name" readonly>
                  </div>
                  <div class="input-group">
                    <label>Middle Name</label>
                    <input type="text" id="docMiddleName" placeholder="Middle Name" readonly>
                  </div>
                  <div class="input-group">
                    <label>Student ID</label>
                    <input type="text" id="docStudentId" placeholder="Student ID" readonly>
                  </div>
                </div>
              </div>

              <!-- Contact Information Card -->
              <div class="info-card contact-info">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-map-marker-alt"></i>
                  </div>
                  <h3>Contact Information</h3>
                </div>
                <div class="card-content">
                  <div class="input-group">
                    <label>Address</label>
                    <input type="text" id="docAddress" placeholder="Address" readonly>
                  </div>
                  <div class="input-group">
                    <label>Nationality</label>
                    <input type="text" id="docNationality" placeholder="Nationality" readonly>
                  </div>
                </div>
              </div>

              <!-- Academic Information Card -->
              <div class="info-card academic-info">
                <div class="card-header">
                  <div class="card-icon">
                    <i class="fas fa-graduation-cap"></i>
                  </div>
                  <h3>Academic Information</h3>
                </div>
                <div class="card-content">
                  <div class="input-group">
                    <label>Course</label>
                    <input type="text" id="docCourse" placeholder="Course" readonly>
                  </div>
                  <div class="input-group">
                    <label>Year Level</label>
                    <input type="text" id="docYearLevel" placeholder="Year Level" readonly>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Existing Requests Container -->
          <div id="existingRequestsContainer" class="existing-requests-container" style="display: none;">
            <!-- Content will be loaded by JavaScript -->
          </div>

          <div class="request-form-container">
            <div class="request-form-header">
              <h2><i class="fas fa-clipboard-list"></i> Request Form</h2>
              <p>Select the documents you need and provide additional information</p>
            </div>
            <form id="clearanceForm">

              <!-- Documents To Request Section -->
              <div class="form-section">
                <h3><i class="fas fa-file-alt"></i> Documents to Request</h3>
                <div class="documents-grid">
                  <label><input type="checkbox" name="requestedDocument" value="Transcript of Record"> <span class="document-name">Transcript of Record</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="Diploma"> <span class="document-name">Diploma</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="Transfer Credential"> <span class="document-name">Transfer Credential</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="Certificate - Enrollment"> <span class="document-name">Certificate - Enrollment</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="Certificate - Cross Enroll"> <span class="document-name">Certificate - Cross Enroll</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="Certificate - Candidacy / Completion of Academic Requirements"> <span class="document-name">Certificate - Candidacy / Completion of Academic Requirements</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="Certificate - Graduation"> <span class="document-name">Certificate - Graduation</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="Certificate - Weighted Average"> <span class="document-name">Certificate - Weighted Average</span></label>
                  <label><input type="checkbox" name="requestedDocument" value="CAV"> <span class="document-name">CAV</span></label>
                </div>
              </div>

              <!-- Pricing Breakdown Section -->
              <div class="form-section">
                <h3><i class="fas fa-calculator"></i> Pricing Breakdown</h3>
                <div class="pricing-breakdown">
                  <h5><i class="fas fa-receipt"></i> Document Pricing</h5>
                  <div id="pricingDetails">
                    <p style="color: #6b7280; font-style: italic;">Select documents above to see pricing details</p>
                  </div>
                  <div class="total-amount">
                    <strong>Total Amount: ₱<span id="totalAmount">0.00</span></strong>
                  </div>
                </div>
              </div>

              <!-- Receipt Upload Section -->
              <div class="form-section">
                <h3><i class="fas fa-receipt"></i> Upload Payment Receipt</h3>
                <div class="receipt-upload-container">
                  <input type="file" name="payment_receipt" id="paymentReceipt" accept="image/*">
                  <div class="receipt-preview-container">
                    <img id="receiptPreview" style="display: none; max-width: 200px; max-height: 200px; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  </div>
                  <p style="color: #6b7280; font-size: 14px; margin-top: 8px;">
                    <i class="fas fa-info-circle"></i> Please upload a clear photo of your payment receipt
                  </p>
                </div>
              </div>

              <!-- Reference Number Section -->
              <div class="form-section reference-number-section">
                <div class="section-header">
                  <div class="section-icon">
                    <i class="fas fa-hashtag"></i>
                  </div>
                  <div class="section-title">
                    <h3>Reference Number</h3>
                    <p class="section-subtitle">Enter the reference number from your payment receipt</p>
                  </div>
                </div>
                
                <div class="reference-input-wrapper">
                  <div class="input-group">
                    <div class="input-icon">
                      <i class="fas fa-receipt"></i>
                    </div>
                    <input 
                      type="text" 
                      name="reference_number" 
                      id="referenceNumber" 
                      class="reference-input"
                      placeholder="e.g., 6219902" 
                      required
                      autocomplete="off"
                    >
                    <div class="input-actions">
                      <button type="button" class="clear-btn" id="clearReferenceBtn" style="display: none;">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="reference-validation" id="referenceValidation" style="display: none;">
                    <div class="validation-content">
                      <div class="validation-icon">
                        <i class="fas fa-spinner fa-spin" id="validationSpinner" style="display: none;"></i>
                        <i class="fas fa-check-circle" id="validationSuccess" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle" id="validationError" style="display: none;"></i>
                      </div>
                    <div class="validation-message" id="validationMessage"></div>
                  </div>
                  </div>
                  
                  <div class="reference-info">
                    <div class="info-item">
                      <i class="fas fa-robot"></i>
                      <span>AI-powered verification</span>
                    </div>
                    <div class="info-item">
                      <i class="fas fa-shield-alt"></i>
                      <span>Secure validation</span>
                    </div>
                    <div class="info-item">
                      <i class="fas fa-clock"></i>
                      <span>Instant verification</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Clearance Purpose Section -->
              <div class="form-section">
                <h3><i class="fas fa-bullseye"></i> Purpose</h3>
                <div class="purpose-options">
                  <label><input type="checkbox" name="clearancePurpose" value="Graduation"> <span class="purpose-option">Graduation</span></label>
                  <label><input type="checkbox" name="clearancePurpose" value="Transfer"> <span class="purpose-option">Transfer to Another School</span></label>
                  <label><input type="checkbox" name="clearancePurpose" value="Employment"> <span class="purpose-option">Employment Requirements</span></label>
                  <label><input type="checkbox" name="clearancePurpose" value="Scholarship"> <span class="purpose-option">Scholarship Application</span></label>
                  <label class="other-purpose">
                    <input type="checkbox" name="clearancePurpose" value="Other"> 
                    <span class="purpose-option">Other: </span>
                    <input type="text" placeholder="specify" class="other-input">
                  </label>
                </div>
              </div>

              <!-- ID Upload Section -->
              <div class="form-section">
                <h3><i class="fas fa-camera"></i> Upload Valid ID Photo</h3>
                <div class="id-upload-container">
                  <input type="file" name="validID" id="validID" accept="image/*" required>
                  <div class="id-preview-container">
                    <img id="idPreview" alt="Valid ID Preview" class="id-preview">
                  </div>
                </div>
                <input type="hidden" id="clearanceReason" value="">
              </div>

              <!-- Submit Section -->
              <div class="form-section submit-section">
                <button type="submit" class="btn btn-primary submit-btn">
                  <i class="fas fa-paper-plane"></i> Submit Request
                </button>
              </div>
            </form>
          </div>

          <!-- Signatories table removed from document panel as requested -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let allRequestsCache = [];
    let lastRequestsLoadOk = false; // track whether the last API load succeeded
    
    // Make allRequestsCache globally accessible
    window.allRequestsCache = allRequestsCache;
    
    document.addEventListener("DOMContentLoaded", function () {
      // Profile Section logic (not modal)
      const profileLink = document.getElementById("profileLink");
      const profileSection = document.getElementById("profileSection");
      function showProfileSection(student) {
        document.getElementById("profileFirstName").value = student.first_name || "";
        document.getElementById("profileLastName").value = student.last_name || "";
        document.getElementById("profileMiddleName").value = student.middle_name || "";
        document.getElementById("profileStudentId").value = student.student_no || "";
        document.getElementById("profileAddress").value = student.address || "";
        document.getElementById("profileCourse").value = student.course_name || student.course || "";
        document.getElementById("profileYearLevel").value = student.year_level_name || (student.year_level ? `Year ${student.year_level}` : "");
        profileSection.style.display = "block";
      }
      profileLink.addEventListener("click", async function () {
        setActive(profileLink);
        pageTitle.textContent = "Profile";
        hideAllSections();
        profileSection.style.display = "block";
        
        // Show full-screen loading
        if (window.showFullScreenLoading) {
          window.showFullScreenLoading('Loading profile...');
        }
        
        // Fetch student info (reuse API)
        try {
          const response = await fetch('/api/student/me');
          const data = await response.json();
          if (data.ok && data.student_info) {
            showProfileSection(data.student_info);
          } else {
            SweetAlertUtils.error('Error', 'Failed to load profile info.');
          }
        } catch (e) {
          console.error('Error loading profile:', e);
          if (e.message && e.message.includes('401')) {
            showSessionError();
          } else {
            SweetAlertUtils.error('Error', 'Failed to load profile info.');
          }
        } finally {
          // Hide full-screen loading
          if (window.hideFullScreenLoading) {
            window.hideFullScreenLoading();
          }
        }
      });
      // Update notification badges for status buttons
      async function updateStatusBadges() {
        // Show skeleton loading on badges
        const pendingBadge = document.getElementById('pendingBadge');
        const processingBadge = document.getElementById('processingBadge');
        const completedBadge = document.getElementById('completedBadge');
        const rejectedBadge = document.getElementById('rejectedBadge');
        const unclaimedBadge = document.getElementById('unclaimedBadge');
        const claimedBadge = document.getElementById('claimedBadge');
        
        // Add skeleton loading to badges
        if (pendingBadge) {
          pendingBadge.innerHTML = '<div class="skeleton-badge"><div class="skeleton-text-small"></div></div>';
          pendingBadge.style.display = 'flex';
        }
        if (processingBadge) {
          processingBadge.innerHTML = '<div class="skeleton-badge"><div class="skeleton-text-small"></div></div>';
          processingBadge.style.display = 'flex';
        }
        if (completedBadge) {
          completedBadge.innerHTML = '<div class="skeleton-badge"><div class="skeleton-text-small"></div></div>';
          completedBadge.style.display = 'flex';
        }
        if (rejectedBadge) {
          rejectedBadge.innerHTML = '<div class="skeleton-badge"><div class="skeleton-text-small"></div></div>';
          rejectedBadge.style.display = 'flex';
        }
        if (unclaimedBadge) {
          unclaimedBadge.innerHTML = '<div class="skeleton-badge"><div class="skeleton-text-small"></div></div>';
          unclaimedBadge.style.display = 'flex';
        }
        if (claimedBadge) {
          claimedBadge.innerHTML = '<div class="skeleton-badge"><div class="skeleton-text-small"></div></div>';
          claimedBadge.style.display = 'flex';
        }
        
        let pending = 0, processing = 0, completed = 0, rejected = 0, unclaimed = 0, claimed = 0;
        try {
          // Use cached data if available, otherwise fetch fresh data
          await loadAllRequests();
          allRequestsCache.forEach(r => {
            const eff = getEffectiveStatus(r);
            if (eff === 'pending') pending++;
            else if (eff === 'processing') processing++;
            else if (eff === 'released' || eff === 'completed') completed++;
            else if (eff === 'rejected') rejected++;
            else if (eff === 'unclaimed') unclaimed++;
            else if (eff === 'claimed') claimed++;
          });
        } catch (_) {}
        
        // Update badge display with actual numbers
        if (pendingBadge) {
          pendingBadge.textContent = pending;
          pendingBadge.style.display = 'flex';
        }
        
        if (processingBadge) {
          processingBadge.textContent = processing;
          processingBadge.style.display = 'flex';
        }
        
        if (completedBadge) {
          completedBadge.textContent = completed;
          completedBadge.style.display = 'flex';
        }
        
        if (rejectedBadge) {
          rejectedBadge.textContent = rejected;
          rejectedBadge.style.display = 'flex';
        }
        
        if (unclaimedBadge) {
          unclaimedBadge.textContent = unclaimed;
          unclaimedBadge.style.display = 'flex';
        }
        
        if (claimedBadge) {
          claimedBadge.textContent = claimed;
          claimedBadge.style.display = 'flex';
        }
      }
      // Initial badge update
      updateStatusBadges();
      // Optionally, refresh badges every 30s
      setInterval(updateStatusBadges, 30000);
      // Removed old modal-on-card-click behavior. Pending/Processing/Completed
      // cards are now handled by the new dashboard interactions below.
      const dashboardLink = document.getElementById("dashboardLink");
      const documentLink = document.getElementById("documentLink");
      const sidebarLinks = document.querySelectorAll(".sidebar a");
      const dashboardSection = document.getElementById("dashboardSection");
      const documentSection = document.getElementById("documentSection");
      const clearanceSection = document.getElementById("clearanceSection");
      const pendingRequestsPanel = document.getElementById("pendingRequestsPanel");
      const pageTitle = document.getElementById("pageTitle");
      const logoutLink = document.getElementById("logoutLink");
      const signatoryContainer = document.getElementById("signatoryContainer");
      const noClearanceMsg = document.getElementById("noClearanceMsg");
      // Removed latest request card variables

      function setActive(link) {
        sidebarLinks.forEach(a => a.classList.remove("active"));
        link.classList.add("active");
      }

      function hideAllSections() {
  dashboardSection.style.display = "none";
  documentSection.style.display = "none";
  if (pendingRequestsPanel) pendingRequestsPanel.style.display = "none";
  if (profileSection) profileSection.style.display = "none";
      }

      dashboardLink.addEventListener("click", async function () {
        setActive(dashboardLink);
        pageTitle.textContent = "Dashboard";
        hideAllSections();
        dashboardSection.style.display = "block";
        
        // Show full-screen loading
        if (window.showFullScreenLoading) {
          window.showFullScreenLoading('Loading your requests...');
        }
        
        // Load all requests and update dashboard
        try {
          await loadAllRequests();
          updateStatusBadges();
          updatePendingPagination();
          
          // Show success message if there are requests
          if (allRequestsCache.length > 0) {
            console.log(`Dashboard loaded with ${allRequestsCache.length} requests`);
          }
        } catch (error) {
          console.error('Error loading dashboard:', error);
          // Show error message
          const dashboardContent = document.getElementById('dashboardContent');
          if (dashboardContent) {
            dashboardContent.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Failed to load dashboard content. Please try refreshing the page.
              </div>
            `;
          }
        } finally {
          // Hide full-screen loading
          if (window.hideFullScreenLoading) {
            window.hideFullScreenLoading();
          }
        }
      });

      // Logout with confirmation (SweetAlert2)
      logoutLink.addEventListener("click", async function (e) {
        e.preventDefault();
        const result = await Swal.fire({ title: 'Logout?', text: 'Are you sure you want to logout?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, logout', cancelButtonText: 'Cancel' });

        if (result.isConfirmed) {
          try {
            // Attempt API logout if available
            await fetch('/api/logout', { method: 'POST' }).catch(() => {});
          } catch (_) {}

          try {
            // Clear any local/session storage tokens
            localStorage.clear();
            sessionStorage.clear();
          } catch (_) {}

          await SweetAlertUtils.success(
            'Logged out',
            'You have been logged out successfully.',
            {
              timer: 1200,
              showConfirmButton: false
            }
          );

          // Redirect to login page (adjust path if needed)
          window.location.href = 'login.html';
        }
      });

      // Load user data when page loads
      populateClearanceForm();
      
      // Auto-load dashboard content on page load
      async function initializeDashboard() {
        try {
          // Show full-screen loading
          if (window.showFullScreenLoading) {
            window.showFullScreenLoading('Loading your requests...');
          }
          
          // Use the consolidated API that includes both clearance and document requests
          await loadAllRequests();
          updateStatusBadges();
          updatePendingPagination();
          console.log('Dashboard initialized with consolidated request data');
        } catch (error) {
          console.error('Error initializing dashboard:', error);
        } finally {
          // Hide full-screen loading
          if (window.hideFullScreenLoading) {
            window.hideFullScreenLoading();
          }
        }
      }
      
      // Initialize dashboard after a short delay to ensure DOM is ready
      setTimeout(initializeDashboard, 100);


      // Initially show empty state for signatories
      function showNoRequestState(){
        if(noClearanceMsg) noClearanceMsg.style.display = "block";
        if(signatoryContainer) signatoryContainer.style.display = "none";
      }
      function showPendingState(){
        if(noClearanceMsg) noClearanceMsg.style.display = "none";
        if(signatoryContainer) signatoryContainer.style.display = "block";
      }
      showNoRequestState();

      documentLink.addEventListener("click", async function () {
        setActive(documentLink);
        pageTitle.textContent = "Request Document";
        hideAllSections();
        documentSection.style.display = "block";
        
        // Show full-screen loading
        if (window.showFullScreenLoading) {
          window.showFullScreenLoading('Loading document form...');
        }
        
        try {
          // Populate student information in document request form
          await populateDocumentRequestForm();
        } catch (error) {
          console.error('Error loading document form:', error);
        } finally {
          // Hide full-screen loading
          if (window.hideFullScreenLoading) {
            window.hideFullScreenLoading();
          }
        }
      });

      // Handle individual document request form submission (guard if form exists)
      const documentRequestFormEl = document.getElementById('documentRequestForm');
      if (documentRequestFormEl) documentRequestFormEl.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const documentType = document.getElementById('documentTypeSelect').value;
        const purpose = document.getElementById('documentPurpose').value;
        
        if (!documentType) {
          SweetAlertUtils.warning(
            'Select Document Type',
            'Please select a document type.'
          );
          return;
        }
        
        // Show full-screen loading
        if (window.showFullScreenLoading) {
          window.showFullScreenLoading('Submitting document request...');
        }
        
        try {
          const response = await fetch('/api/document/request', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              document_type: documentType,
              purpose: purpose
            })
          });
          
          const data = await response.json();
          
          if (data.ok) {
            Swal.fire({
              icon: 'success',
              title: 'Request Submitted',
              text: 'Your document request has been submitted successfully. It will appear in the Registrar\'s pending documents once all required clearances are approved.',
              confirmButtonText: 'OK'
            }).then(() => {
              // Automatically switch to dashboard and refresh content
              dashboardLink.click();
            });
            
            // Reset form
            document.getElementById('documentRequestForm').reset();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message || 'Failed to submit document request.'
            });
          }
        } catch (error) {
          console.error('Error submitting document request:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to submit document request. Please try again.'
          });
        } finally {
          // Hide full-screen loading
          if (window.hideFullScreenLoading) {
            window.hideFullScreenLoading();
          }
        }
      });

      // Function to populate student information in document request form
      async function populateDocumentRequestForm() {
        try {
          const response = await fetch('/api/student/me');
          const data = await response.json();
          if (data.ok && data.student_info) {
            const student = data.student_info;
            
            // Personal Information
            const f = document.getElementById('docFirstName');
            const l = document.getElementById('docLastName');
            const m = document.getElementById('docMiddleName');
            const sid = document.getElementById('docStudentId');
            
            // Contact Information
            const addr = document.getElementById('docAddress');
            const nat = document.getElementById('docNationality');
            
            // Academic Information
            const c = document.getElementById('docCourse');
            const yl = document.getElementById('docYearLevel');
            
            // Populate all fields
            if (f) f.value = student.first_name || '';
            if (l) l.value = student.last_name || '';
            if (m) m.value = student.middle_name || '';
            if (sid) sid.value = student.student_no || '';
            if (addr) addr.value = student.address || '';
            if (nat) nat.value = student.nationality || 'Filipino';
            if (c) c.value = student.course_name || student.course || '';
            if (yl) yl.value = student.year_level_name || (student.year_level ? `Year ${student.year_level}` : '');
          }
        } catch (error) {
          console.error('Error loading student info:', error);
          if (error.message && error.message.includes('401')) {
            showSessionError();
          }
        }
      }

      // Show Pending Requests inside dashboard when clicking Pending card
      document.getElementById("pendingBtn").addEventListener("click", async function(){
        console.log("Pending button clicked");
        
        try {
          // Show full-screen loading
          if (window.showFullScreenLoading) {
            window.showFullScreenLoading('Loading Pending Requests...');
          }
          
          setActive(dashboardLink);
          pageTitle.textContent = "Dashboard";
          hideAllSections();
          dashboardSection.style.display = "block";
          if (pendingRequestsPanel) {
            pendingRequestsPanel.style.display = "block";
            console.log("Pending requests panel displayed");
          }
          const titleEl = document.getElementById('requestsHeaderTitle');
          if (titleEl) titleEl.innerHTML = '<i class="fas fa-folder-open"></i> Pending Requests';
          // Always reload latest requests to avoid stale/empty cache
          try { await loadAllRequests(); } catch(_) {}
          renderPendingPage(1);
        } finally {
          // Hide full-screen loading
          if (window.hideFullScreenLoading) {
            window.hideFullScreenLoading();
          }
        }
      });
      

      // Function to populate clearance form with user data from database
      async function populateClearanceForm() {
        try {
          const response = await fetch('/api/student/me');
          const data = await response.json();
          if (data.ok && data.student_info) {
            const student = data.student_info;
            // Populate form fields with real user data (using correct element IDs)
            const docFirstName = document.getElementById("docFirstName");
            const docLastName = document.getElementById("docLastName");
            const docMiddleName = document.getElementById("docMiddleName");
            const docStudentId = document.getElementById("docStudentId");
            const docAddress = document.getElementById("docAddress");
            const docNationality = document.getElementById("docNationality");
            const docCourse = document.getElementById("docCourse");
            const docYearLevel = document.getElementById("docYearLevel");
            
            // Only populate if elements exist
            if (docFirstName) docFirstName.value = student.first_name || "";
            if (docLastName) docLastName.value = student.last_name || "";
            if (docMiddleName) docMiddleName.value = student.middle_name || "";
            if (docStudentId) docStudentId.value = student.student_no || "";
            if (docAddress) docAddress.value = student.address || "";
            if (docNationality) docNationality.value = student.nationality || "Filipino";
            if (docCourse) docCourse.value = student.course_name || student.course || "Computer Science";
            if (docYearLevel) docYearLevel.value = student.year_level_name || (student.year_level ? `Year ${student.year_level}` : "");

            // Update the topbar with real user name
            document.getElementById("userFullName").textContent = student.full_name || "Student";

            // Also populate document form fields
            console.log("Populating document form fields with student data:", student);
            document.getElementById("docFirstName").value = student.first_name || "";
            document.getElementById("docLastName").value = student.last_name || "";
            document.getElementById("docMiddleName").value = student.middle_name || "";
            document.getElementById("docStudentId").value = student.student_no || "";
            document.getElementById("docAddress").value = student.address || "";
            document.getElementById("docNationality").value = student.nationality || "Filipino";
            document.getElementById("docCourse").value = student.course_name || student.course || "";
            document.getElementById("docYearLevel").value = student.year_level_name || (student.year_level ? `Year ${student.year_level}` : "");
            
            console.log("Document form fields populated successfully");

            // Apply signatory visibility rules based on course
            const courseName = (student.course_name || student.course || "").toString();
            applyCourseSignatoryRules(courseName);
          } else {
            console.error("Failed to fetch student data:", data.message);
            // Check if it's a session error
            if (data.message && data.message.includes('No student session found')) {
              showSessionError();
              return;
            }
            // Fallback to sample data if API fails
            populateWithSampleData();
          }

          // Also load clearance status and signatories
          try{
            const cRes = await fetch('/api/student/clearance');
            const cData = await cRes.json();
            if(cData.ok && cData.data){
              if(!cData.data.has_request){
                showNoRequestState();
              } else {
                renderSignatories(cData.data.signatories || []);
                showPendingState();
              }
            }
          }catch(e){
            console.error('Error loading clearance status:', e);
            if (e.message && e.message.includes('401')) {
              showSessionError();
            }
          }
        } catch (error) {
          console.error("Error fetching student data:", error);
          // Check if it's a session error
          if (error.message && error.message.includes('401')) {
            showSessionError();
            return;
          }
          // Fallback to sample data if API fails
          populateWithSampleData();
        }
      }
      
      // Function to handle session errors
      function showSessionError() {
        Swal.fire({
          icon: 'warning',
          title: 'Session Expired',
          html: 'Your session has expired. Please log in again to continue.',
          confirmButtonText: 'Go to Login',
          allowOutsideClick: false,
          allowEscapeKey: false
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/login.html';
          }
        });
      }

      // Fallback function with sample data
      function populateWithSampleData() {
        // Document form (with null checks)
        const docFirstName = document.getElementById("docFirstName");
        const docLastName = document.getElementById("docLastName");
        const docStudentId = document.getElementById("docStudentId");
        const docAddress = document.getElementById("docAddress");
        const docNationality = document.getElementById("docNationality");
        
        if (docFirstName) docFirstName.value = "Juan";
        if (docLastName) docLastName.value = "Dela Cruz";
        if (docStudentId) docStudentId.value = "2025-0001";
        if (docAddress) docAddress.value = "Sample Address, City";
        if (docNationality) docNationality.value = "Filipino";
        // Apply signatory rules using current course field value
        const docCourse = document.getElementById("docCourse");
        const sampleCourseName = docCourse ? docCourse.value : "Computer Science";
        applyCourseSignatoryRules(sampleCourseName);
      }

      // Determine if the course is Computer Science/CS
      function isComputerScienceCourse(courseName) {
        if (!courseName) return false;
        const normalized = String(courseName).trim().toLowerCase();
        if (normalized.includes('computer science')) return true;
        return /(^|\b)cs(\b|$)/i.test(courseName);
      }

      // Hide/show Computer Laboratory signatory rows based on course
      function applyCourseSignatoryRules(courseName) {
        const showComputerLab = isComputerScienceCourse(courseName);
        const rows = [];
        document.querySelectorAll('#clearanceSignatoryList tr, #signatoryList tr').forEach(tr => {
          const firstCell = tr.querySelector('td');
          if (firstCell && /computer\s+laboratory/i.test(firstCell.textContent)) {
            rows.push(tr);
          }
        });
        rows.forEach(tr => { tr.style.display = showComputerLab ? '' : 'none'; });
      }

      // Render signatories table from API
      function renderSignatories(signatories){
        const tbody = document.getElementById('clearanceSignatoryList');
        if(!tbody) return;
        const mapStatus = function(s){
          if(!s) return 'Pending';
          if(s === 'Approved') return 'Approved';
          if(s === 'Rejected') return 'Rejected';
          return 'Pending';
        };
        tbody.innerHTML = signatories.map(function(s){
          const statusText = mapStatus(s.status);
          const statusClass = s.status === 'Approved' ? 'status-signed' : (s.status === 'Rejected' ? 'status-rejected' : 'status-pending');
          const dateSigned = s.signed_at ? new Date(s.signed_at).toLocaleString() : '-';
          const remarks = s.rejection_reason || (s.signed_by ? ('<span class="signer-info"><i class="fas fa-pen-to-square"></i>Signed by ' + s.signed_by + '</span>') : (statusText === 'Pending' ? 'Awaiting signature' : '-'));
          return '<tr>'+
            '<td>'+s.office+'</td>'+
            '<td><span class="'+statusClass+'">'+statusText+'</span></td>'+
            '<td>'+dateSigned+'</td>'+
            '<td>'+remarks+'</td>'+
          '</tr>';
        }).join('');
      }

      // Preview ng Valid ID
      const validIDInput = document.getElementById("validID");
      const idPreview = document.getElementById("idPreview");

      validIDInput.addEventListener("change", function() {
        const file = this.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function(e) {
            idPreview.src = e.target.result;
            idPreview.style.display = "block";
          }
          reader.readAsDataURL(file);
        } else {
          idPreview.style.display = "none"; // hide kung hindi image (like pdf)
        }
      });


      // Document pricing configuration
      const documentPricing = {
        'Transcript of Record': 300,
        'Diploma': 200,
        'Transfer Credential': 150,
        'Certificate - Enrollment': 50,
        'Certificate - Cross Enroll': 50,
        'Certificate - Candidacy / Completion of Academic Requirements': 50,
        'Certificate - Graduation': 50,
        'Certificate - Weighted Average': 50,
        'CAV': 50
      };

      // Define which documents require clearance
      const CLEARANCE_REQUIRED_DOCS = ['Diploma', 'Transcript of Record'];
      
      // Function to calculate total price (includes all documents - both clearance and certificates)
      function calculateTotalPrice() {
        const selectedDocuments = [];
        const documentCheckboxes = document.querySelectorAll('input[name="requestedDocument"]:checked');
        documentCheckboxes.forEach(cb => selectedDocuments.push(cb.value));
        
        // Split documents into clearance-required and non-clearance
        const clearanceDocs = selectedDocuments.filter(doc => 
          CLEARANCE_REQUIRED_DOCS.includes(doc)
        );
        const nonClearanceDocs = selectedDocuments.filter(doc => 
          !CLEARANCE_REQUIRED_DOCS.includes(doc)
        );
        
        let total = 0;
        const pricingDetails = [];
        
        // Calculate price for clearance-required documents
        clearanceDocs.forEach(doc => {
          const price = documentPricing[doc] || 0;
          total += price;
          pricingDetails.push({
            name: doc,
            price: price,
            requiresClearance: true
          });
        });
        
        // Calculate price for non-clearance docs (certificates) - they also need payment
        nonClearanceDocs.forEach(doc => {
          const price = documentPricing[doc] || 0;
          total += price; // Add to total since certificates also need payment
          pricingDetails.push({
            name: doc,
            price: price,
            requiresClearance: false
          });
        });
        
        return { total, pricingDetails, clearanceDocs, nonClearanceDocs };
      }

      // Function to update pricing display
      function updatePricingDisplay() {
        const { total, pricingDetails, clearanceDocs, nonClearanceDocs } = calculateTotalPrice();
        
        const pricingDetailsElement = document.getElementById('pricingDetails');
        const totalAmountElement = document.getElementById('totalAmount');
        
        // Debug logging
        console.log('Selected documents:', document.querySelectorAll('input[name="requestedDocument"]:checked'));
        console.log('Pricing details:', pricingDetails);
        console.log('Total:', total);
        
        if (pricingDetails.length === 0) {
          pricingDetailsElement.innerHTML = '<p style="color: #6b7280; font-style: italic;">Select documents above to see pricing details</p>';
        } else {
          let pricingHTML = '';
          
          // Show clearance-required documents first
          if (clearanceDocs.length > 0) {
            pricingHTML += '<div style="margin-bottom: 10px;"><strong style="color: #3b82f6;">📋 Requires Clearance:</strong></div>';
            pricingDetails.filter(item => item.requiresClearance).forEach(item => {
              pricingHTML += `
                <div class="pricing-item">
                  <span class="document-name">${item.name} <span style="color: #3b82f6; font-size: 0.85em;">(Clearance)</span></span>
                  <span class="document-price">₱${item.price.toFixed(2)}</span>
                </div>
              `;
            });
          }
          
          // Show non-clearance documents (direct processing)
          if (nonClearanceDocs.length > 0) {
            if (clearanceDocs.length > 0) {
              pricingHTML += '<div style="margin-top: 15px; margin-bottom: 10px;"><strong style="color: #10b981;">⚡ Direct Processing:</strong></div>';
            }
            pricingDetails.filter(item => !item.requiresClearance).forEach(item => {
              pricingHTML += `
                <div class="pricing-item">
                  <span class="document-name">${item.name} <span style="color: #10b981; font-size: 0.85em;">(Direct)</span></span>
                  <span class="document-price">₱${item.price.toFixed(2)}</span>
                </div>
              `;
            });
          }
          
          pricingDetailsElement.innerHTML = pricingHTML;
        }
        
        if (totalAmountElement) {
          // Show total for all documents (clearance + certificates)
          totalAmountElement.textContent = total.toFixed(2);
        }
      }

      // Function to setup pricing event listeners
      function setupPricingEventListeners() {
        const documentCheckboxes = document.querySelectorAll('input[name="requestedDocument"]');
        documentCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', updatePricingDisplay);
        });
        
        // Initial pricing display
        updatePricingDisplay();
      }

      // Setup event listeners immediately and also on DOMContentLoaded as fallback
      setupPricingEventListeners();
      document.addEventListener('DOMContentLoaded', setupPricingEventListeners);
      
      // Manual trigger for testing - remove this after testing
      setTimeout(() => {
        console.log('Manual pricing update triggered');
        console.log('Document checkboxes found:', document.querySelectorAll('input[name="requestedDocument"]').length);
        console.log('Checked checkboxes:', document.querySelectorAll('input[name="requestedDocument"]:checked').length);
        updatePricingDisplay();
      }, 1000);
      
      // Add a test button for manual pricing calculation
      window.testPricing = function() {
        console.log('Testing pricing manually...');
        updatePricingDisplay();
      };

      // Receipt upload preview functionality
      document.getElementById('paymentReceipt').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('receiptPreview');
        
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        } else {
          preview.style.display = 'none';
        }
      });



      // Helper function to convert file to base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => {
            const base64 = reader.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
            resolve(base64);
          };
          reader.onerror = error => reject(error);
        });
      }

      // Helper function to show reference validation status
      function showReferenceValidation(type, message) {
        const validationDiv = document.getElementById('referenceValidation');
        const messageDiv = document.getElementById('validationMessage');
        const spinner = document.getElementById('validationSpinner');
        const successIcon = document.getElementById('validationSuccess');
        const errorIcon = document.getElementById('validationError');
        
        validationDiv.className = `reference-validation ${type}`;
        validationDiv.style.display = 'block';
        messageDiv.innerHTML = message;
        
        // Hide all icons first
        if (spinner) spinner.style.display = 'none';
        if (successIcon) successIcon.style.display = 'none';
        if (errorIcon) errorIcon.style.display = 'none';
        
        // Show appropriate icon
        if (type === 'verifying' && spinner) {
          spinner.style.display = 'block';
        } else if (type === 'valid' && successIcon) {
          successIcon.style.display = 'block';
        } else if (type === 'invalid' && errorIcon) {
          errorIcon.style.display = 'block';
        }
      }

      // Helper function to clear reference number form
      function clearReferenceNumberForm() {
        // Clear reference number input
        const referenceNumberInput = document.getElementById('referenceNumber');
        if (referenceNumberInput) {
          referenceNumberInput.value = '';
        }
        
        // DON'T clear payment receipt file input - let user keep the file
        // (This was causing the bug where receipt gets cleared when reference number validation fails)
        
        // Hide validation message
        const validationDiv = document.getElementById('referenceValidation');
        if (validationDiv) {
          validationDiv.style.display = 'none';
          validationDiv.className = 'reference-validation';
        }
        
        // Reset file preview if exists
        const filePreview = document.querySelector('.file-preview');
        if (filePreview) {
          filePreview.remove();
        }
        
        // Hide clear button
        const clearBtn = document.getElementById('clearReferenceBtn');
        if (clearBtn) {
          clearBtn.style.display = 'none';
        }
        
        // Focus on reference number input for better UX
        if (referenceNumberInput) {
          referenceNumberInput.focus();
        }
      }

      // Add event listeners for enhanced UX
      document.addEventListener('DOMContentLoaded', function() {
        const referenceInput = document.getElementById('referenceNumber');
        const clearBtn = document.getElementById('clearReferenceBtn');
        
        if (referenceInput) {
          // Show/hide clear button based on input
          referenceInput.addEventListener('input', function() {
            if (clearBtn) {
              clearBtn.style.display = this.value.trim() ? 'flex' : 'none';
            }
          });
          
          // Clear input when clear button is clicked
          if (clearBtn) {
            clearBtn.addEventListener('click', function() {
              referenceInput.value = '';
              clearBtn.style.display = 'none';
              referenceInput.focus();
            });
          }
          
          // Add focus effects
          referenceInput.addEventListener('focus', function() {
            this.parentElement.style.borderColor = '#3b82f6';
            this.parentElement.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.1)';
          });
          
          referenceInput.addEventListener('blur', function() {
            this.parentElement.style.borderColor = '#e2e8f0';
            this.parentElement.style.boxShadow = 'none';
          });
        }
      });

      // Clearance Form Submission with SweetAlert2
      const clearanceForm = document.getElementById("clearanceForm");
      // Function to test AI service connectivity
      async function testConnectivity() {
        try {
          const response = await fetch('/api/test-ai-connectivity');
          const result = await response.json();
          console.log('Connectivity test result:', result);
          return result.ok;
        } catch (error) {
          console.error('Connectivity test failed:', error);
          return false;
        }
      }

      // Function to test connection and retry AI validation
      async function testConnectionAndRetry() {
        const testBtn = document.getElementById('testConnectionBtn');
        if (testBtn) {
          testBtn.disabled = true;
          testBtn.innerHTML = '🔄 Testing...';
        }

        try {
          const isConnected = await testConnectivity();
          if (isConnected) {
            Swal.fire({
              icon: 'success',
              title: 'Connection Restored!',
              text: 'AI service is now reachable. Retrying receipt validation...',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
              // Close the current dialog and retry
              Swal.close();
              // Trigger the form submission again
              const form = document.getElementById('clearanceForm');
              if (form) {
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                form.dispatchEvent(submitEvent);
              }
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Still Cannot Connect',
              text: 'AI service is still unreachable. Please try the troubleshooting steps or proceed without AI validation.',
              confirmButtonText: 'OK'
            });
          }
        } catch (error) {
          console.error('Connection test failed:', error);
          Swal.fire({
            icon: 'error',
            title: 'Test Failed',
            text: 'Unable to test connection. Please try the troubleshooting steps.',
            confirmButtonText: 'OK'
          });
        } finally {
          if (testBtn) {
            testBtn.disabled = false;
            testBtn.innerHTML = '🔄 Test Connection & Retry';
          }
        }
      }

      // Function to continue with submission when AI validation is bypassed
      function continueSubmission() {
        console.log('Continuing with submission without AI validation...');
        // Hide full-screen loading
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.hideFullScreenLoading();
        }
        // Re-enable submit button
        const submitButton = document.querySelector('.submit-btn');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.style.opacity = '1';
        }
        
        // Continue with the normal submission process
        // This will trigger the form submission logic
        const form = document.getElementById('clearanceForm');
        if (form) {
          // Create a synthetic submit event
          const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
          form.dispatchEvent(submitEvent);
        }
      }

      // Add duplicate check function
      async function checkForDuplicateRequest(selectedDocuments, selectedPurposes) {
        try {
          const response = await fetch('/api/clearance/check-duplicate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              documents: selectedDocuments,
              purposes: selectedPurposes,
              document_type: 'Clearance Documents'
            })
          });
          
          const result = await response.json();
          return result;
        } catch (error) {
          console.error('Error checking for duplicates:', error);
          return {ok: false, is_duplicate: false, message: 'Error checking duplicates'};
        }
      }

      clearanceForm.addEventListener("submit", async function(e) {
        e.preventDefault();
        // Get selected documents
        const selectedDocuments = [];
        const documentCheckboxes = document.querySelectorAll('input[name="requestedDocument"]:checked');
        documentCheckboxes.forEach(cb => selectedDocuments.push(cb.value));
        // Get selected purposes
        const selectedPurposes = [];
        const purposeCheckboxes = document.querySelectorAll('input[name="clearancePurpose"]:checked');
        purposeCheckboxes.forEach(checkbox => {
          if (checkbox.value === "Other") {
            const otherInput = checkbox.nextElementSibling;
            if (otherInput && otherInput.value.trim()) {
              selectedPurposes.push(otherInput.value.trim());
            }
          } else {
            selectedPurposes.push(checkbox.value);
          }
        });

        if (selectedDocuments.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Select document(s)',
            text: 'Please select at least one document to request.'
          });
          return;
        }

        // Split documents into clearance-required and non-clearance
        const CLEARANCE_REQUIRED_DOCS = ['Diploma', 'Transcript of Record'];
        const clearanceDocs = selectedDocuments.filter(doc => 
          CLEARANCE_REQUIRED_DOCS.includes(doc)
        );
        const nonClearanceDocs = selectedDocuments.filter(doc => 
          !CLEARANCE_REQUIRED_DOCS.includes(doc)
        );

        // Only require purposes if clearance documents are selected
        if (clearanceDocs.length > 0 && selectedPurposes.length === 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Select purpose',
            text: 'Please select at least one purpose for clearance documents (Diploma/Transcript of Record).'
          });
          return;
        }

        // Check for duplicates BEFORE submission (only for clearance documents)
        if (clearanceDocs.length > 0) {
          try {
            if (window.buttonLoadingManager) {
              window.buttonLoadingManager.showFullScreenLoading('Checking for existing requests...');
            }
            
            const duplicateCheck = await checkForDuplicateRequest(clearanceDocs, selectedPurposes);
            
            if (duplicateCheck.is_duplicate) {
              // Hide loading first
              if (window.buttonLoadingManager) {
                window.buttonLoadingManager.hideFullScreenLoading();
              }
              
              // Show duplicate warning
              await Swal.fire({
                icon: 'warning',
                title: 'Duplicate Request Detected',
                html: `
                  <div class="text-start">
                    <p><strong>You already have a pending/approved request for the same clearance documents.</strong></p>
                    <p><strong>Request Details:</strong></p>
                    <ul>
                      <li>Request ID: #${duplicateCheck.existing_request.id}</li>
                      <li>Status: ${duplicateCheck.existing_request.status}</li>
                      <li>Submitted: ${new Date(duplicateCheck.existing_request.created_at).toLocaleDateString()}</li>
                    </ul>
                    <p class="text-muted">Please wait for your current request to be processed before submitting a new one.</p>
                  </div>
                `,
                confirmButtonText: 'Understood',
                confirmButtonColor: '#3b82f6',
                allowOutsideClick: false
              });
              
              return; // Stop submission
            }
            
            if (window.buttonLoadingManager) {
              window.buttonLoadingManager.hideFullScreenLoading();
            }
          } catch (error) {
            console.error('Duplicate check error:', error);
            if (window.buttonLoadingManager) {
              window.buttonLoadingManager.hideFullScreenLoading();
            }
          }
        }

        // Validate reference number if both receipt and reference number are provided
        // Required for both clearance documents AND certificates (they all need payment)
        const referenceNumber = document.getElementById('referenceNumber').value.trim();
        const paymentReceiptFile = document.getElementById('paymentReceipt').files[0];
        
        // Validate reference number if any documents are selected (both clearance and certificates need payment)
        if (selectedDocuments.length > 0 && referenceNumber && paymentReceiptFile) {
          // Show full-screen loading and disable submit button
          if (window.buttonLoadingManager) {
            window.buttonLoadingManager.showFullScreenLoading('Verifying reference number with receipt...');
          }
          
          // Disable submit button
          const submitButton = document.querySelector('button[type="submit"]');
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.style.opacity = '0.5';
          }
          
          // Show validation status
          showReferenceValidation('verifying', 'Verifying reference number with receipt...');
          
          try {
            // Convert receipt to base64 for AI processing
            const receiptBase64 = await fileToBase64(paymentReceiptFile);
            
            // Call AI validation endpoint
            const validationResponse = await fetch('/api/validate-receipt-reference', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                receipt_image: receiptBase64,
                reference_number: referenceNumber
              })
            });
            
            const validationResult = await validationResponse.json();
            
            // Check if AI processing failed due to service issues
            if (!validationResult.ok) {
              // Hide full-screen loading
              if (window.buttonLoadingManager) {
                window.buttonLoadingManager.hideFullScreenLoading();
              }
              // Re-enable submit button
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.style.opacity = '1';
              }
              
              // Check if it's a network/connection error
              const isNetworkError = validationResult.message && (
                validationResult.message.includes('connection') ||
                validationResult.message.includes('timeout') ||
                validationResult.message.includes('network') ||
                validationResult.message.includes('resolve') ||
                validationResult.message.includes('ConnectionError') ||
                validationResult.message.includes('NameResolutionError')
              );
              
              if (isNetworkError) {
                // Test connectivity first
                testConnectivity().then((connectivityResult) => {
                  // Show option to proceed without AI validation for network errors
                  Swal.fire({
                    icon: 'warning',
                    title: 'AI Service Connection Issue',
                    html: `
                      <div style="text-align: center;">
                        <p style="margin-bottom: 15px;">${validationResult.message}</p>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0;">
                          <strong>⚠️ Network Issue Detected</strong><br>
                          The AI service cannot be reached due to network connectivity problems.
                        </div>
                        <div style="background: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; border-radius: 5px; margin: 10px 0;">
                          <strong>🔧 Troubleshooting Tips:</strong><br>
                          • Check your internet connection<br>
                          • Try switching to mobile data or different WiFi<br>
                          • Restart your router if possible<br>
                          • Clear DNS cache: Run "ipconfig /flushdns" in Command Prompt<br>
                          • Wait a few minutes and try again
                        </div>
                        <div style="margin-top: 10px;">
                          <button id="testConnectionBtn" class="btn btn-sm btn-outline-primary" onclick="testConnectionAndRetry()">
                            🔄 Test Connection & Retry
                          </button>
                        </div>
                        <p style="color: #6c757d; font-size: 14px;">
                          You can either try again later or proceed without AI validation (manual verification will be required).
                        </p>
                      </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Proceed Without AI',
                    cancelButtonText: 'Try Again Later',
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                  }).then((result) => {
                    if (result.isConfirmed) {
                      // Proceed without AI validation
                      console.log('User chose to proceed without AI validation');
                      showReferenceValidation('warning', '⚠️ Proceeding without AI validation - manual verification required');
                      // Continue with submission process
                      continueSubmission();
                    } else {
                      // Clear the form and reset reference number validation
                      clearReferenceNumberForm();
                    }
                  });
                });
              } else {
                // Show regular error for other AI issues
                Swal.fire({
                  icon: 'warning',
                  title: 'AI Service Temporarily Unavailable',
                  html: `
                    <div style="text-align: center;">
                      <p style="margin-bottom: 15px;">${validationResult.message || 'Unable to process receipt at this time.'}</p>
                      <p style="color: #6c757d; font-size: 14px;">
                        Please try again in a few minutes. The AI service may be experiencing high traffic.
                      </p>
                    </div>
                  `,
                  confirmButtonText: 'Try Again Later',
                  confirmButtonColor: '#ffc107',
                  allowOutsideClick: false,
                  allowEscapeKey: false
                }).then(() => {
                  // Clear the form and reset reference number validation
                  clearReferenceNumberForm();
                });
              }
              return; // Stop submission if AI service is down
            }
            
            // DEBUG: Log the validation result to understand what's happening
            console.log('DEBUG: Validation result:', validationResult);
            console.log('DEBUG: validationResult.ok:', validationResult.ok);
            console.log('DEBUG: validationResult.matches:', validationResult.matches);
            console.log('DEBUG: extracted_reference:', validationResult.extracted_reference);
            console.log('DEBUG: provided_reference:', validationResult.provided_reference);
            
            // SECURITY: Only accept matches that pass AI validation
            // No manual fallback to prevent security bypass
            if (validationResult.ok && validationResult.matches) {
              // STEP 2: CHECK FOR DUPLICATE REFERENCE NUMBER (only if match is successful)
              console.log('Reference numbers match (AI or manual), checking for duplicates...');
              try {
                const duplicateCheckResponse = await fetch('/api/check-reference-duplicate', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    reference_number: referenceNumber
                  })
                });
                
                const duplicateResult = await duplicateCheckResponse.json();
                if (!duplicateResult.ok && duplicateResult.is_duplicate) {
                  // Hide full-screen loading
                  if (window.buttonLoadingManager) {
                    window.buttonLoadingManager.hideFullScreenLoading();
                  }
                  // Re-enable submit button
                  if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                  }
                  
                  // Show SweetAlert for duplicate reference number
                  Swal.fire({
                    icon: 'warning',
                    title: 'Reference Number Already Used',
                    html: `
                      <div style="text-align: center;">
                        <p style="margin-bottom: 15px;">The reference number <strong>'${referenceNumber}'</strong> has already been used in a previous request.</p>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0;">
                          <strong>⚠️ Duplicate Reference Number</strong><br>
                          This reference number was already submitted for clearance processing.
                        </div>
                        <p style="color: #6c757d; font-size: 14px;">
                          Please use a different reference number from your receipt or contact the office if you believe this is an error.
                        </p>
                      </div>
                    `,
                    confirmButtonText: 'Clear Form & Try Again',
                    confirmButtonColor: '#ffc107',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                  }).then(() => {
                    // Clear the form and reset reference number validation
                    clearReferenceNumberForm();
                  });
                  return; // STOP SUBMISSION - Reference number already used
                }
                
                // STEP 3: ALL CHECKS PASSED - Show success and continue
                showReferenceValidation('valid', '✓ Reference number verified and available');
                // Hide full-screen loading
                if (window.buttonLoadingManager) {
                  window.buttonLoadingManager.hideFullScreenLoading();
                }
                // Re-enable submit button
                if (submitButton) {
                  submitButton.disabled = false;
                  submitButton.style.opacity = '1';
                }
                
              } catch (duplicateError) {
                console.error('Duplicate check error:', duplicateError);
                // Continue with submission if duplicate check fails
                showReferenceValidation('valid', '✓ Reference number matches the receipt');
                // Hide full-screen loading
                if (window.buttonLoadingManager) {
                  window.buttonLoadingManager.hideFullScreenLoading();
                }
                // Re-enable submit button
                if (submitButton) {
                  submitButton.disabled = false;
                  submitButton.style.opacity = '1';
                }
              }
            } else {
              // Hide full-screen loading
              if (window.buttonLoadingManager) {
                window.buttonLoadingManager.hideFullScreenLoading();
              }
              // Re-enable submit button
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.style.opacity = '1';
              }
              
              // Show SweetAlert for reference number mismatch
              console.log('DEBUG: Showing mismatch error - validationResult:', validationResult);
              Swal.fire({
                icon: 'error',
                title: 'Reference Number Mismatch',
                html: `
                  <div style="text-align: center;">
                    <p style="margin-bottom: 15px;">The reference number you entered does not match the receipt.</p>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0;">
                      <strong>Entered:</strong> ${referenceNumber}<br>
                      <strong>Extracted from receipt:</strong> ${validationResult.extracted_reference || 'Not found'}
                    </div>
                    ${!validationResult.ai_success ? `
                      <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>⚠️ AI Processing Issue:</strong> The system could not read the reference number from your receipt image. 
                        This might be due to:
                        <ul style="text-align: left; margin: 5px 0; padding-left: 20px;">
                          <li>Blurry or unclear receipt image</li>
                          <li>Poor lighting or image quality</li>
                          <li>Receipt format not recognized by AI</li>
                        </ul>
                      </div>
                    ` : ''}
                    <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">
                      Please check your receipt and enter the correct reference number. 
                      ${!validationResult.ai_success ? 'Try taking a clearer photo of your receipt or wait a few minutes and try again.' : ''}
                    </p>
                    ${validationResult.message ? `
                      <div style="background: #e3f2fd; border: 1px solid #2196f3; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>💡 Tip:</strong> ${validationResult.message}
                      </div>
                    ` : ''}
                  </div>
                `,
                confirmButtonText: 'Clear Form & Try Again',
                confirmButtonColor: '#dc3545',
                allowOutsideClick: false,
                allowEscapeKey: false
              }).then(() => {
                // Clear the form and reset reference number validation
                clearReferenceNumberForm();
              });
              return; // Stop submission if validation fails
            }
          } catch (error) {
            console.error('Reference validation error:', error);
            // Hide full-screen loading
            if (window.buttonLoadingManager) {
              window.buttonLoadingManager.hideFullScreenLoading();
            }
            // Re-enable submit button
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.style.opacity = '1';
            }
            
            // Show SweetAlert for validation error
            Swal.fire({
              icon: 'error',
              title: 'Verification Error',
              html: `
                <div style="text-align: center;">
                  <p style="margin-bottom: 15px;">Unable to verify reference number. Please try again.</p>
                  <p style="color: #6c757d; font-size: 14px;">
                    Make sure your receipt image is clear and readable.
                  </p>
                </div>
              `,
              confirmButtonText: 'Clear Form & Try Again',
              confirmButtonColor: '#dc3545',
              allowOutsideClick: false,
              allowEscapeKey: false
            }).then(() => {
              // Clear the form and reset reference number validation
              clearReferenceNumberForm();
            });
            return;
          }
        }

        // Submit to backend
        (async function(){
          try{
            // Show full-screen loading overlay
            if (window.buttonLoadingManager) {
              window.buttonLoadingManager.showFullScreenLoading('Submitting Request...');
            }
            
            const results = [];
            const errors = [];
            
            // 1. Submit certificates/non-clearance docs directly to document request endpoint (with payment)
            if (nonClearanceDocs.length > 0) {
              const purposeText = selectedPurposes.length > 0 ? selectedPurposes.join(', ') : 'General Request';
              
              // Calculate total price for certificates
              const certPricing = {
                'Transfer Credential': 150,
                'Certificate - Enrollment': 50,
                'Certificate - Cross Enroll': 50,
                'Certificate - Candidacy / Completion of Academic Requirements': 50,
                'Certificate - Graduation': 50,
                'Certificate - Weighted Average': 50,
                'CAV': 50
              };
              
              // Get payment receipt and reference number
              const paymentReceiptFile = document.getElementById('paymentReceipt').files[0];
              const referenceNumber = document.getElementById('referenceNumber').value.trim();
              
              for (const certDoc of nonClearanceDocs) {
                try {
                  // Create FormData for certificate requests with payment
                  const certFormData = new FormData();
                  certFormData.append('document_type', certDoc);
                  certFormData.append('purpose', purposeText);
                  
                  // Calculate price for this certificate
                  const certPrice = certPricing[certDoc] || 50;
                  certFormData.append('payment_amount', certPrice.toString());
                  certFormData.append('payment_method', 'cash');
                  
                  // Add payment receipt if available
                  if (paymentReceiptFile) {
                    certFormData.append('payment_receipt', paymentReceiptFile);
                  }
                  
                  // Add reference number if available
                  if (referenceNumber) {
                    certFormData.append('reference_number', referenceNumber);
                  }
                  
                  const certResponse = await fetch('/api/document/request', {
                    method: 'POST',
                    body: certFormData
                  });
                  const certResult = await certResponse.json();
                  if (certResult.ok) {
                    results.push({ type: 'certificate', doc: certDoc, success: true });
                  } else {
                    errors.push({ type: 'certificate', doc: certDoc, error: certResult.message || 'Unknown error' });
                  }
                } catch (error) {
                  errors.push({ type: 'certificate', doc: certDoc, error: error.message || 'Network error' });
                }
              }
            }
            
            // 2. Submit Diploma/Transcript to clearance endpoint (if any)
            if (clearanceDocs.length > 0) {
              // Calculate total price only for clearance docs
              const clearancePricing = {
                'Transcript of Record': 300,
                'Diploma': 200
              };
              let total = 0;
              clearanceDocs.forEach(doc => {
                total += clearancePricing[doc] || 0;
              });
              
              // Prepare form data for clearance submission
              const formData = new FormData();
              formData.append('document_type', 'Clearance Documents');
              formData.append('documents', JSON.stringify(clearanceDocs)); // Only clearance docs
              formData.append('purposes', JSON.stringify(selectedPurposes));
              formData.append('reason', (document.getElementById('clearanceReason') || {}).value || '');
              formData.append('payment_amount', total.toString());
              formData.append('payment_method', 'cash');
              formData.append('reference_number', referenceNumber || '');

              // Add valid ID file
              const validIDFile = document.getElementById('validID').files[0];
              if (validIDFile) {
                formData.append('valid_id', validIDFile);
              }

              // Add payment receipt file
              const paymentReceiptFile = document.getElementById('paymentReceipt').files[0];
              if (paymentReceiptFile) {
                formData.append('payment_receipt', paymentReceiptFile);
              }

              try {
                const resp = await fetch('/api/clearance/request', { 
                  method: 'POST', 
                  body: formData
                });
                const resj = await resp.json();
                
                if (resj && resj.ok) {
                  results.push({ type: 'clearance', docs: clearanceDocs, success: true });
                  
                  // Reload signatories and status badges
                  try{
                    const cRes = await fetch('/api/student/clearance');
                    const cData = await cRes.json();
                    if(cData.ok && cData.data && cData.data.has_request){
                      renderSignatories(cData.data.signatories || []);
                      showPendingState();
                    }
                  }catch(_){ }
                } else {
                  errors.push({ type: 'clearance', docs: clearanceDocs, error: resj.message || 'Unknown error' });
                }
              } catch (error) {
                errors.push({ type: 'clearance', docs: clearanceDocs, error: error.message || 'Network error' });
              }
            }
            
            // Show results
            if (errors.length === 0) {
              // All successful
              let successMessage = '';
              
              // Calculate totals
              const clearanceTotal = clearanceDocs.reduce((sum, doc) => {
                const clearancePricing = { 'Transcript of Record': 300, 'Diploma': 200 };
                return sum + (clearancePricing[doc] || 0);
              }, 0);
              
              const certTotal = nonClearanceDocs.reduce((sum, doc) => {
                const certPricing = {
                  'Transfer Credential': 150,
                  'Certificate - Enrollment': 50,
                  'Certificate - Cross Enroll': 50,
                  'Certificate - Candidacy / Completion of Academic Requirements': 50,
                  'Certificate - Graduation': 50,
                  'Certificate - Weighted Average': 50,
                  'CAV': 50
                };
                return sum + (certPricing[doc] || 50);
              }, 0);
              
              const grandTotal = clearanceTotal + certTotal;
              
              if (clearanceDocs.length > 0) {
                successMessage += `<b>Clearance Documents:</b> ${clearanceDocs.join(', ')}<br/>`;
                if (clearanceTotal > 0) {
                  successMessage += `<b>Clearance Amount:</b> ₱${clearanceTotal.toFixed(2)}<br/>`;
                }
              }
              if (nonClearanceDocs.length > 0) {
                successMessage += `<b>Certificates (Direct Processing):</b> ${nonClearanceDocs.join(', ')}<br/>`;
                if (certTotal > 0) {
                  successMessage += `<b>Certificates Amount:</b> ₱${certTotal.toFixed(2)}<br/>`;
                }
              }
              if (selectedPurposes.length > 0) {
                successMessage += `<b>Purpose:</b> ${selectedPurposes.join(', ')}<br/>`;
              }
              if (grandTotal > 0) {
                successMessage += `<b>Total Amount:</b> ₱${grandTotal.toFixed(2)}<br/>`;
              }
              
              Swal.fire({
                icon: 'success',
                title: 'Request Submitted',
                html: successMessage + '<br/>' + 
                      (clearanceDocs.length > 0 ? 'Your clearance request has been forwarded to signatories.<br/>' : '') +
                      (nonClearanceDocs.length > 0 ? 'Your certificate requests have been submitted and will be processed directly.<br/>' : '')
              });
              
              // Refresh status badges immediately
              updateStatusBadges();
              
              // Reload dashboard to show new requests
              try {
                await loadAllRequests();
              } catch(_) {}
            } else {
              // Some failed
              let errorMessage = '<strong>Some requests failed:</strong><br/>';
              errors.forEach(e => {
                const docName = e.doc || (e.docs ? e.docs.join(', ') : 'Unknown');
                errorMessage += `• ${docName}: ${e.error}<br/>`;
              });
              
              // Show successful ones too
              if (results.length > 0) {
                errorMessage += '<br/><strong>Successfully submitted:</strong><br/>';
                results.forEach(r => {
                  const docName = r.doc || (r.docs ? r.docs.join(', ') : 'Unknown');
                  errorMessage += `• ${docName}<br/>`;
                });
              }
              
              Swal.fire({
                icon: 'warning',
                title: 'Partial Success',
                html: errorMessage
              });
              
              // Still refresh status badges
              updateStatusBadges();
              try {
                await loadAllRequests();
              } catch(_) {}
            }
          }catch(err){
            Swal.fire({ icon:'error', title:'Error', text: String(err) });
          } finally {
            // Hide full-screen loading overlay
            if (window.buttonLoadingManager) {
              window.buttonLoadingManager.hideFullScreenLoading();
            }
          }
        })();
        // Reset form
        clearanceForm.reset();
      });

      // Print Clearance Functionality (guard in case button is not present)
      const printClearanceBtn = document.getElementById("printClearanceBtn");
      if (printClearanceBtn) printClearanceBtn.addEventListener("click", function() {
        // Ensure the Documents section (which contains Clearance) is visible
        setActive(documentLink);
        pageTitle.textContent = "Request Document";
        hideAllSections();
        documentSection.style.display = "block";
        // Populate form, then print the clearance content
        populateClearanceForm();
        // If there is no request yet, do not auto-switch to Pending when printing
        // Keep current visibility states
        setTimeout(() => { window.print(); }, 100);
      });

      // Sidebar toggle functionality
      const sidebar = document.getElementById('sidebar');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const topbarToggle = document.getElementById('topbarToggle');
      const mainContent = document.querySelector('.main-content');
      const overlay = document.querySelector('.mobile-menu-overlay');

      // Mobile menu toggle functionality
      window.toggleMobileMenu = function() {
        if (sidebar.classList.contains('open')) {
          sidebar.classList.remove('open');
          overlay.style.display = 'none';
          document.body.style.overflow = 'auto';
        } else {
          sidebar.classList.add('open');
          overlay.style.display = 'block';
          document.body.style.overflow = 'hidden';
        }
      };

      // Desktop expand/collapse sidebar
      function toggleSidebar() {
        console.log('Toggle sidebar clicked');
        if (window.innerWidth <= 768) {
          toggleMobileMenu();
        } else {
          const isExpanded = sidebar.classList.contains('expanded');
          console.log('Current expanded state:', isExpanded);
          if (isExpanded) {
            sidebar.classList.remove('expanded');
            mainContent.classList.remove('sidebar-expanded');
            localStorage.setItem('sidebar_expanded', '0');
            console.log('Sidebar collapsed');
          } else {
            sidebar.classList.add('expanded');
            mainContent.classList.add('sidebar-expanded');
            localStorage.setItem('sidebar_expanded', '1');
            console.log('Sidebar expanded');
          }
        }
      }

      // Initialize sidebar state
      function initializeSidebar() {
        console.log('Initializing sidebar, window width:', window.innerWidth);
        if (window.innerWidth > 768) {
          // Always start expanded by default for better UX
          sidebar.classList.add('expanded');
          mainContent.classList.add('sidebar-expanded');
          console.log('Sidebar initialized as expanded');
        }
      }

      // Event listeners
      sidebarToggle.addEventListener('click', toggleSidebar);
      if (topbarToggle) {
        topbarToggle.addEventListener('click', toggleMobileMenu);
      }
      overlay.addEventListener('click', toggleMobileMenu);
      
      // Add mobile hamburger button in topbar (for mobile devices)
      const topbar = document.querySelector('.topbar');
      if (topbar) {
        topbar.addEventListener('click', function(e) {
          // Check if click is on the hamburger area (left side of topbar)
          if (e.clientX <= 60 && window.innerWidth <= 768) {
            toggleMobileMenu();
          }
        });
      }

      // Initialize sidebar state
      initializeSidebar();

      // Close mobile menu when clicking on sidebar links
      document.querySelectorAll('.sidebar a').forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            toggleMobileMenu();
          }
        });
      });

      // Handle window resize
      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          // Close mobile menu if open
          sidebar.classList.remove('open');
          overlay.style.display = 'none';
          document.body.style.overflow = 'auto';
          
          // Reinitialize sidebar state for desktop
          initializeSidebar();
        } else {
          // Remove desktop expanded state on mobile
          sidebar.classList.remove('expanded');
          mainContent.classList.remove('sidebar-expanded');
        }
      });

      // Removed latest request card rendering function

      // ===== Pending Requests Rendering with pagination =====
      let pendingCache = [];
      let pendingCurrentPage = 1;
      const pageSize = 10;
      const pendingTableBody = document.getElementById('pendingTableBody');
      const pendingCardsContainer = document.getElementById('pendingCardsContainer');
      const prevPendingBtn = document.getElementById('prevPendingBtn');
      const nextPendingBtn = document.getElementById('nextPendingBtn');
      const pendingPageInfo = document.getElementById('pendingPageInfo');
      const refreshPendingBtn = document.getElementById('refreshPendingBtn');

      function getEffectiveStatus(req){
        const raw = (req.status || '').toString().trim().toLowerCase(); // registrar fulfillment_status when available
        const signatories = Array.isArray(req.signatories) ? req.signatories : [];
        const requestType = req.request_type || 'clearance'; // Default to clearance for backward compatibility
        
        // Debug logging
        console.log(`🔍 getEffectiveStatus for request ${req.id}:`, {
          raw: raw,
          signatories_count: signatories.length,
          request_type: requestType,
          fulfillment_status: req.fulfillment_status
        });
        
        // Handle consolidated requests (clearance + document combined)
        if (requestType === 'consolidated') {
          // For consolidated requests, use the document status as the primary status
          // This ensures we show the actual registrar processing status
          if (raw === 'completed') {
            console.log(`🔍 getEffectiveStatus returning: 'completed' (consolidated)`);
            return 'completed';
          }
          if (raw === 'processing') {
            console.log(`🔍 getEffectiveStatus returning: 'processing' (consolidated)`);
            return 'processing';
          }
          if (raw === 'rejected') {
            console.log(`🔍 getEffectiveStatus returning: 'rejected' (consolidated)`);
            return 'rejected';
          }
          if (raw === 'released') {
            console.log(`🔍 getEffectiveStatus returning: 'released' (consolidated)`);
            return 'released';
          }
          if (raw === 'unclaimed') {
            console.log(`🔍 getEffectiveStatus returning: 'unclaimed' (consolidated)`);
            return 'unclaimed';
          }
          if (raw === 'claimed') {
            console.log(`🔍 getEffectiveStatus returning: 'claimed' (consolidated)`);
            return 'claimed';
          }
          console.log(`🔍 getEffectiveStatus returning: 'pending' (consolidated default)`);
          return 'pending';
        }
        
        // Handle document requests (post-auto-transfer)
          if (requestType === 'document') {
          // For document requests, keep a distinct Completed state before Released
          if (raw === 'completed') return 'completed';
          if (raw === 'released') return 'released';
          if (raw === 'processing') return 'processing';
          if (raw === 'rejected') return 'rejected';
          if (raw === 'unclaimed') return 'unclaimed';
          if (raw === 'claimed') return 'claimed';
          return 'pending';
        }
        
        // Handle clearance requests (pre-auto-transfer)
        // Handle standalone document requests (no signatories) - legacy support
        if (signatories.length === 0) {
          // For legacy document requests
          if (raw === 'completed') return 'completed';
          if (raw === 'released') return 'released';
          if (raw === 'processing') return 'processing';
          if (raw === 'rejected') return 'rejected';
          if (raw === 'unclaimed') return 'unclaimed';
          if (raw === 'claimed') return 'claimed';
          return 'pending';
        }
        
        // Handle clearance requests (with signatories)
        const hasAnyRejected = signatories.some(function(s){ return (s.status || '').toString().toLowerCase() === 'rejected'; });
        const allApproved = signatories.length > 0 && signatories.every(function(s){ return (s.status || '').toString().toLowerCase() === 'approved'; });

        // If any office rejected, whole request is Rejected
        if (hasAnyRejected) {
          console.log(`🔍 getEffectiveStatus returning: 'rejected' (signatory rejected)`);
          return 'rejected';
        }

        // If not all signatories have approved yet, remain Pending
        if (!allApproved) {
          console.log(`🔍 getEffectiveStatus returning: 'pending' (not all signatories approved)`);
          return 'pending';
        }

        // All signatories approved → rely on Registrar fulfillment status
        // Show the actual registrar status for better synchronization
        if (raw === 'processing') {
          console.log(`🔍 getEffectiveStatus returning: 'processing' (clearance)`);
          return 'processing';
        }
        if (raw === 'approved') {
          console.log(`🔍 getEffectiveStatus returning: 'processing' (approved, ready for processing)`);
          return 'processing';
        }
        if (raw === 'rejected') {
          console.log(`🔍 getEffectiveStatus returning: 'rejected' (clearance)`);
          return 'rejected';
        }
        if (raw === 'completed') {
          console.log(`🔍 getEffectiveStatus returning: 'completed' (clearance)`);
          return 'completed';
        }
        if (raw === 'released') {
          console.log(`🔍 getEffectiveStatus returning: 'released' (clearance)`);
          return 'released';
        }
        if (raw === 'unclaimed') {
          console.log(`🔍 getEffectiveStatus returning: 'unclaimed' (clearance)`);
          return 'unclaimed';
        }
        if (raw === 'claimed') {
          console.log(`🔍 getEffectiveStatus returning: 'claimed' (clearance)`);
          return 'claimed';
        }

        // Default when Registrar has not started (e.g., fulfillment_status Pending or unknown)
        console.log(`🔍 getEffectiveStatus returning: 'pending' (default)`);
        return 'pending';
      }

      function statusToChip(status){
        const s = (status || '').toString().trim().toLowerCase();
        if (s === 'released') return { cls: 'chip-approved', text: 'Released' };
        if (s === 'completed') return { cls: 'chip-approved', text: 'Completed' };
        if (s === 'approved') return { cls: 'chip-approved', text: 'Approved' };
        if (s === 'processing') return { cls: 'chip-pending', text: 'Processing' };
        if (s === 'rejected') return { cls: 'chip-rejected', text: 'Rejected' };
        if (s === 'unclaimed') return { cls: 'chip-pending', text: 'Unclaimed' };
        if (s === 'claimed') return { cls: 'chip-approved', text: 'Claimed' };
        return { cls: 'chip-pending', text: 'Pending' };
      }

      function formatPurpose(p){
        try {
          // Handle both array (clearance_requests) and string (document_requests)
          if (Array.isArray(p)) {
            return p.join(', ') || '—';
          } else if (typeof p === 'string' && p.trim()) {
            return p.trim();
          } else {
            return '—';
          }
        } catch(e) {
          console.error('❌ Error in formatPurpose:', e);
          return '—';
        }
      }

      function formatDate(d){
        try { 
          if (!d) return '-';
          const date = new Date(d);
          if (isNaN(date.getTime())) return '-';
          return date.toLocaleString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        } catch(_) { return '-'; }
      }

      function formatPickupDate(pickupDate) {
        if (!pickupDate) return '<span class="text-muted">Not yet available</span>';
        try {
          const date = new Date(pickupDate);
          // Check if date is valid
          if (isNaN(date.getTime())) {
            return '<span class="text-muted">Not yet available</span>';
          }
          return date.toLocaleString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
        } catch(e) {
          return '<span class="text-muted">Not yet available</span>';
        }
      }

      // Match Registrar helpers for office icon styling
      function getOfficeIconClass(office){
        try{
          const o = (office||'').toLowerCase();
          if (o.includes('computer') || o.includes('lab')) return 'computer-lab';
          if (o.includes('guidance')) return 'guidance';
          if (o.includes('student') && o.includes('affairs')) return 'student-affairs';
          if (o.includes('library')) return 'library';
          if (o.includes('dean')) return 'dean';
          if (o.includes('accounting')) return 'accounting';
          if (o.includes('registrar')) return 'registrar';
          return 'computer-lab';
        } catch(_){ return 'computer-lab'; }
      }

      function getOfficeIcon(office){
        try{
          const o = (office||'').toLowerCase();
          if (o.includes('computer') || o.includes('lab')) return 'fa-solid fa-desktop';
          if (o.includes('guidance')) return 'fa-solid fa-heart';
          if (o.includes('student') && o.includes('affairs')) return 'fa-solid fa-users';
          if (o.includes('library')) return 'fa-solid fa-book';
          if (o.includes('dean')) return 'fa-solid fa-user-tie';
          if (o.includes('accounting')) return 'fa-solid fa-calculator';
          if (o.includes('registrar')) return 'fa-solid fa-file-alt';
          return 'fa-solid fa-building';
        } catch(_){ return 'fa-solid fa-building'; }
      }


      // Function to open receipt modal
      function openReceiptModal(req) {
        console.log('🔍 Student Dashboard openReceiptModal called with req:', req);
        console.log('🔍 Student Dashboard req.id:', req?.id);
        console.log('🔍 Student Dashboard req.request_type:', req?.request_type);
        console.log('🔍 Student Dashboard req.clearance_request_id:', req?.clearance_request_id);
        console.log('🔍 Student Dashboard req.clearance_id:', req?.clearance_id);
        console.log('🔍 Student Dashboard req.payment_receipt exists:', !!req?.payment_receipt);
        console.log('🔍 Student Dashboard req.receipt_status:', req?.receipt_status);
        
        // Show loading state on the receipt button
        const receiptButton = event?.target?.closest('button');
        if (receiptButton && window.showButtonLoading) {
          window.showButtonLoading(receiptButton, 'Loading Receipt...', true);
        }
        
        try {
          // Use the receipt modal for better image viewing experience
          // Use clearance_request_id for receipt viewing (since receipt API looks in clearance_requests table)
          // Fallback to request_id or id if clearance_request_id is not available
          const requestId = req.clearance_request_id || req.request_id || req.id;
          console.log('🎯 Student Dashboard: Using request ID for receipt modal:', requestId);
          
          if (window.showReceiptModal && requestId) {
            console.log('✅ Student Dashboard: Using receipt modal for request ID:', requestId);
            window.showReceiptModal(requestId);
          } else {
            console.warn('❌ Student Dashboard: Receipt modal not available, falling back to SweetAlert');
            viewReceipt(req);
          }
        } finally {
          // Hide loading state
          if (receiptButton && window.hideButtonLoading) {
            window.hideButtonLoading(receiptButton);
          }
        }
      }

      // Helper functions for clearance view (same as registrar dashboard)
      function getOfficeIconClass(office) {
        try {
          const o = (office || '').toLowerCase();
          if (o.includes('library')) return 'library';
          if (o.includes('accounting')) return 'accounting';
          if (o.includes('registrar')) return 'registrar';
          if (o.includes('guidance')) return 'guidance';
          if (o.includes('dean')) return 'dean';
          if (o.includes('student affairs')) return 'student-affairs';
          if (o.includes('computer lab')) return 'computer-lab';
          return 'default';
        } catch(_){ return 'default'; }
      }

      function getOfficeIcon(office) {
        try {
          const o = (office || '').toLowerCase();
          if (o.includes('library')) return 'fa-solid fa-book';
          if (o.includes('accounting')) return 'fa-solid fa-calculator';
          if (o.includes('registrar')) return 'fa-solid fa-file-alt';
          if (o.includes('guidance')) return 'fa-solid fa-heart';
          if (o.includes('dean')) return 'fa-solid fa-user-tie';
          if (o.includes('student affairs')) return 'fa-solid fa-users';
          if (o.includes('computer lab')) return 'fa-solid fa-desktop';
          return 'fa-solid fa-building';
        } catch(_){ return 'fa-solid fa-building'; }
      }

      // Function to open clearance view (same as registrar dashboard)
      window.openViewClearance = async function openViewClearance(requestId){ 
        console.log('🔍 openViewClearance called with requestId:', requestId);
        if(!requestId) {
          console.error('❌ No requestId provided');
          return; 
        }
        
        // Show full-screen loading overlay
        if (window.buttonLoadingManager) {
          window.buttonLoadingManager.showFullScreenLoading('Loading Clearance Details...');
        } 
        
        // Always fetch fresh data from API to ensure we have complete signatories data
        let req = null;
        let sigs = [];
        
        try { 
          console.log('🌐 Fetching from API:', `/api/clearance/request/${Number(requestId)}`);
          const res = await fetch(`/api/clearance/request/${Number(requestId)}`); 
          console.log('📡 API Response status:', res.status);
          const data = await res.json(); 
          console.log('📄 API Response data:', data);
          if(!data.ok){ throw new Error(data.message||'Failed'); } 
          req = data.request || {}; 
          sigs = data.signatories || [];
          console.log('📋 Request data:', req);
          console.log('📋 Signatories data:', sigs);
        } catch (apiError) {
          console.error('❌ API Error:', apiError);
          // Hide loading before showing error
          if (window.buttonLoadingManager) {
            window.buttonLoadingManager.hideFullScreenLoading();
          }
          // Show a more helpful error message
          Swal.fire({
            icon: 'error',
            title: 'Clearance Not Available',
            text: 'This request does not have clearance details available. This might be a document request that was not created from a clearance request.',
            confirmButtonText: 'OK'
          });
          return;
        }
        
        try {
          const studentInfoEl = document.getElementById('clViewStudentInfo');
          const infoEl = document.getElementById('clViewInfo'); 
          const progressEl = document.getElementById('clViewProgress');
          const tbody = document.getElementById('clViewSignatories'); 
          
          // Populate Student Information
          if(studentInfoEl) {
            const studentName = req.student_name || `${req.first_name || ''} ${req.last_name || ''}`.trim() || '—';
            const course = req.course || '—';
            const yearLevel = req.year_level || '—';
            const studentNo = req.student_no || '—';
            
            studentInfoEl.innerHTML = `
              <div class="info-item-professional">
                <div class="info-label-professional">
                  <i class="fa-solid fa-user"></i>
                  Student Name
                </div>
                <div class="info-value-professional">${studentName}</div>
              </div>
              <div class="info-item-professional">
                <div class="info-label-professional">
                  <i class="fa-solid fa-id-card"></i>
                  Student Number
                </div>
                <div class="info-value-professional">${studentNo}</div>
              </div>
              <div class="info-item-professional">
                <div class="info-label-professional">
                  <i class="fa-solid fa-graduation-cap"></i>
                  Course
                </div>
                <div class="info-value-professional">${course}</div>
              </div>
              <div class="info-item-professional">
                <div class="info-label-professional">
                  <i class="fa-solid fa-layer-group"></i>
                  Year Level
                </div>
                <div class="info-value-professional">${yearLevel}</div>
              </div>
            `;
          }
          
          // Populate Document Information
          if(infoEl) { 
            const documents = (req.documents||[]).join(', ') || (req.document_type||'—');
            const purposes = (req.purpose||[]).join(', ') || '—';
            const dateRequested = req.created_at ? new Date(req.created_at).toLocaleString() : '—';
            
            // Get overall status
            const overallStatus = req.clearance_status || 'Pending';
            const statusClass = overallStatus.toLowerCase() === 'completed' ? 'status-approved-professional' : 
                              overallStatus.toLowerCase() === 'approved' ? 'status-approved-professional' : 'status-pending-professional';
            
            infoEl.innerHTML = `
              <div class="info-item-professional">
                <div class="info-label-professional">
                  <i class="fa-solid fa-file-lines"></i>
                  Document Type
                </div>
                <div class="info-value-professional">${documents}</div>
              </div>
              <div class="info-item-professional">
                <div class="info-label-professional">
                  <i class="fa-solid fa-bullseye"></i>
                  Purpose
                </div>
                <div class="info-value-professional">${purposes}</div>
              </div>
              <div class="info-item-professional">
                <div class="info-label-professional">
                  <i class="fa-solid fa-chart-line"></i>
                  Overall Status
                </div>
                <div class="info-value-professional">
                  <span class="status-badge-professional ${statusClass}">
                    <i class="fa-solid fa-check-circle"></i>${overallStatus}
                  </span>
                </div>
              </div>
            `; 
          }
          
          // Populate Progress Overview
          if(progressEl && Array.isArray(sigs)) {
            const totalOffices = sigs.length;
            const approvedCount = sigs.filter(s => s.status === 'approved').length;
            const pendingCount = sigs.filter(s => s.status === 'pending').length;
            const rejectedCount = sigs.filter(s => s.status === 'rejected').length;
            const completionPercentage = totalOffices > 0 ? Math.round((approvedCount / totalOffices) * 100) : 0;
            
            progressEl.innerHTML = `
              <div class="progress-item">
                <div class="progress-icon completed">
                  <i class="fa-solid fa-check"></i>
                </div>
                <div class="progress-label">Approved</div>
                <div class="progress-value">${approvedCount}</div>
              </div>
              <div class="progress-item">
                <div class="progress-icon pending">
                  <i class="fa-solid fa-clock"></i>
                </div>
                <div class="progress-label">Pending</div>
                <div class="progress-value">${pendingCount}</div>
              </div>
              <div class="progress-item">
                <div class="progress-icon rejected">
                  <i class="fa-solid fa-times"></i>
                </div>
                <div class="progress-label">Rejected</div>
                <div class="progress-value">${rejectedCount}</div>
              </div>
              <div class="progress-item">
                <div class="progress-icon completed">
                  <i class="fa-solid fa-percentage"></i>
                </div>
                <div class="progress-label">Completion</div>
                <div class="progress-value">${completionPercentage}%</div>
              </div>
            `;
          } 
          
          if(tbody){ 
            console.log('🔍 Populating signatories table with:', sigs);
            let signatoriesTableHtml = '';
            if (Array.isArray(sigs) && sigs.length){
              console.log('📋 Found', sigs.length, 'signatories to display');
              signatoriesTableHtml = sigs.map(function(s){
                const statusLower = (s.status||'').toLowerCase();
                const statusIcon = statusLower === 'approved' ? 'fa-check-circle' : (statusLower === 'pending' ? 'fa-clock' : 'fa-times-circle');
                const statusClass = statusLower === 'approved' ? 'status-approved-professional' : (statusLower === 'rejected' ? 'status-rejected-professional' : 'status-pending-professional');
                const officeIconClass = getOfficeIconClass(s.office||'');
                const officeIcon = getOfficeIcon(s.office||'');
                const updated = s.updated_at || s.signed_at || '-';
                const reason = s.rejection_reason || '-';
                const signedBy = s.signed_by || '-';
                
                return '<tr>'+
                  '<td>'+
                    '<div class="office-cell-professional">'+
                      '<div class="office-icon-professional office-icon-'+officeIconClass+'"><i class="'+officeIcon+'"></i></div>'+
                      '<span class="fw-semibold">'+(s.office||'-')+'</span>'+
                    '</div>'+
                  '</td>'+
                  '<td>'+
                    '<span class="status-badge-professional '+statusClass+'">'+
                      '<i class="fa-solid '+statusIcon+'"></i>'+
                      (s.status||'-')+
                    '</span>'+
                  '</td>'+
                  '<td class="text-muted">'+signedBy+'</td>'+
                  '<td class="text-muted"><small>'+updated+'</small></td>'+
                  '<td class="text-muted">'+reason+'</td>'+
                '</tr>';
              }).join('');
            } else {
              console.log('⚠️ No signatories found or empty array');
            }
            console.log('📄 Final signatories HTML:', signatoriesTableHtml);
            tbody.innerHTML = signatoriesTableHtml;
          }
          
          // Show the Bootstrap modal
          const modal = new bootstrap.Modal(document.getElementById('clViewModal'));
          modal.show();
        } catch(err){ 
          console.error('Error opening clearance view:', err);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load clearance details.',
            confirmButtonText: 'OK'
          });
        } finally {
          // Hide full-screen loading overlay
          if (window.buttonLoadingManager) {
            window.buttonLoadingManager.hideFullScreenLoading();
          }
        }
      };



      // Print helper for clearance details
      function printClearanceDetails(innerHtml){
        try{
          const iframe = document.createElement('iframe');
          iframe.style.position = 'fixed';
          iframe.style.right = '0';
          iframe.style.bottom = '0';
          iframe.style.width = '0';
          iframe.style.height = '0';
          iframe.style.border = '0';
          document.body.appendChild(iframe);

          const doc = iframe.contentWindow ? iframe.contentWindow.document : iframe.contentDocument;
          if (!doc) { document.body.removeChild(iframe); return; }

          const styles = `
            <style>
              body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: #111827; }
              .label { font-weight: 600; color: #374151; }
              .value { color: #111827; }
              .request-card-line { margin: 8px 0; font-size: 14px; }
              .status-badge-chip { padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 600; }
              .chip-approved { background: #d1fae5; color: #065f46; }
              .chip-pending { background: #fef3c7; color: #92400e; }
              .chip-rejected { background: #fee2e2; color: #991b1b; }
              table { width: 100%; border-collapse: collapse; margin-top: 8px; }
              th, td { border: 1px solid #e5e7eb; padding: 8px 12px; font-size: 13px; }
              thead th { background: #2563eb; color: #fff; }
              h2 { text-align:center; margin: 0 0 12px; }
              @media print { @page { margin: 16mm; } }
            </style>`;

          doc.open();
          doc.write('<html><head><title>Clearance Details</title>'+styles+'</head><body>');
          doc.write('<h2>Clearance Details</h2>');
          doc.write(innerHtml);
          doc.write('</body></html>');
          doc.close();

          const win = iframe.contentWindow || iframe;
          win.focus();
          // Ensure resources are ready before printing
          setTimeout(function(){
            try { win.print(); } catch(_) {}
            setTimeout(function(){ document.body.removeChild(iframe); }, 300);
          }, 150);
        } catch(e){ console.error('Print failed:', e); }
      }

      function renderPending(list){
        console.log("Rendering pending list:", list);
        if (pendingTableBody) pendingTableBody.innerHTML = '';
        if (pendingCardsContainer) pendingCardsContainer.innerHTML = '';
        if ((!list || list.length === 0) && lastRequestsLoadOk){
          // only show empty state when the API succeeded but returned no data
          if (pendingTableBody){
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="8" class="text-center py-4 text-muted">'+
                           '<i class="fas fa-inbox fa-2x mb-2 d-block"></i>'+
                           'No requests found'+
                           '</td>';
            pendingTableBody.appendChild(tr);
          }
          if (pendingCardsContainer){
            const emptyCard = document.createElement('div');
            emptyCard.className = 'pending-card-item empty';
            emptyCard.innerHTML = '<div class="text-center text-muted" style="width:100%">'+
                                  '<i class="fas fa-inbox fa-2x mb-2 d-block"></i>'+
                                  'No requests found'+
                                  '</div>';
            pendingCardsContainer.appendChild(emptyCard);
          }
          return;
        }
        // Helper to display requested documents nicely
        function formatDocuments(r){
          try{
            // Use the same logic as Registrar dashboard modal
            const documents = Array.isArray(r.documents) ? r.documents : [];
            return documents.join(', ') || (r.document_type||'—');
          } catch(e){
            console.error('❌ Error in formatDocuments:', e);
            return '—';
          }
        }
        list.forEach(function(r){
          const chip = statusToChip(getEffectiveStatus(r));
          
          // Add clearance requirement indicator
          
          // table row
          if (pendingTableBody){
            const tr = document.createElement('tr');
            tr.dataset.requestId = r.id; // Add request ID for file loading
            const clearanceStatus = (r.clearance_status || 'Pending');
            tr.innerHTML = '<td>'+ (r.student_name||'-') +'</td>'+
                           '<td>'+ formatDocuments(r) +'</td>'+
                           '<td>'+ formatPurpose(r.purpose) +'</td>'+
                           '<td><span class="status-badge-chip '+chip.cls+'">'+chip.text+'</span></td>'+
                           '<td><button class="btn btn-info btn-sm view-receipt-btn" type="button"><i class="fas fa-receipt"></i> View Receipt</button></td>'+
                           '<td class="clearance-status-cell">'+
                             (r.request_type === 'clearance' || !r.request_type ? 
                               '<button class="btn btn-outline-primary btn-sm" onclick="openViewClearance('+r.id+')">View Clearance</button>' :
                               r.request_type === 'consolidated' && r.clearance_id ?
                               '<button class="btn btn-outline-primary btn-sm" onclick="openViewClearance('+r.clearance_id+')">View Clearance</button>' :
                               r.request_type === 'document' && r.clearance_request_id ?
                               '<button class="btn btn-outline-primary btn-sm" onclick="openViewClearance('+r.clearance_request_id+')">View Clearance</button>' :
                               '<span class="text-muted">—</span>'
                             )+
                           '</td>'+
                           '<td class="pickup-date-cell">'+ formatPickupDate(r.pickup_date) +'</td>'+
                           '<td class="files-cell"><span class="text-muted">—</span></td>'; 
            pendingTableBody.appendChild(tr);
            const receiptBtn = tr.querySelector('.view-receipt-btn');
            if (receiptBtn){ receiptBtn.addEventListener('click', function(e){ e.stopPropagation(); openReceiptModal(r); }); }
          }
          // card item (mobile)
          if (pendingCardsContainer){
            const card = document.createElement('div');
            card.className = 'pending-card-item';
            const clearanceStatusMobile = (r.clearance_status || '—');
            card.innerHTML =
              '<div class="request-card-line"><span class="label">👤 Student Name:</span> <span class="value">'+(r.student_name||'-')+'</span></div>'+
              '<div class="request-card-line"><span class="label">📄 Documents:</span> <span class="value">'+formatDocuments(r)+'</span></div>'+
              '<div class="request-card-line"><span class="label">🎯 Purpose:</span> <span class="value">'+formatPurpose(r.purpose)+'</span></div>'+
              '<div class="request-card-line"><span class="label">⏳ Status:</span> <span class="value"><span class="status-badge-chip '+chip.cls+'">'+chip.text+'</span></span></div>'+
              '<div class="request-card-line"><span class="label">📝 Clearance:</span> <span class="value">'+
                (r.request_type === 'clearance' || !r.request_type ? 
                  '<button class="btn btn-outline-primary btn-sm view-clearance-mobile" onclick="openViewClearance('+r.id+')">View Clearance</button>' :
                  '<span class="text-muted">—</span>'
                )+
              '</span></div>'+
              '<div class="request-card-line"><span class="label">📅 Pickup Date:</span> <span class="value">'+formatPickupDate(r.pickup_date)+'</span></div>'+
              '<div class="request-card-line"><span class="label">💰 Payment:</span> <span class="value"><button class="btn btn-info btn-sm view-receipt-mobile" type="button"><i class="fas fa-receipt"></i> View Receipt</button></span></div>';
            pendingCardsContainer.appendChild(card);
            const mobileReceiptBtn = card.querySelector('.view-receipt-mobile');
            if (mobileReceiptBtn){ mobileReceiptBtn.addEventListener('click', function(e){ e.stopPropagation(); openReceiptModal(r); }); }
          }
        });
      }

      
      // Load clearance data using registrar dashboard approach
      async function loadStudentClearances(){
        try{
          console.log("Loading student clearances...");
          
          // Load pending clearances
          await loadStudentPendingClearances();
          
          // Load approved clearances  
          await loadStudentApprovedClearances();
          
          // Load rejected clearances
          await loadStudentRejectedClearances();
          
          lastRequestsLoadOk = true;
          console.log("Student clearances loaded successfully");
          
        } catch(error) {
          console.error("Error loading student clearances:", error);
          lastRequestsLoadOk = false;
          throw error;
        }
      }

      // Load pending clearances for student
      async function loadStudentPendingClearances(){
        try {
          const res = await fetch('/api/student/clearance?status=pending');
          const data = await res.json();
          const tbody = document.getElementById('pendingTableBody');
          if (!tbody) { 
            console.warn('pendingTableBody element not found'); 
            return; 
          }
          tbody.innerHTML = '';
          
          if(data.ok && data.data && Array.isArray(data.data)){
            data.data.forEach(item => {
              // Build payment status HTML
              let paymentStatusHtml = '<span class="no-receipt-text"><i class="fas fa-receipt"></i> No receipt</span>';
              
              const tr = document.createElement('tr'); 
              tr.dataset.studentId = item.student_id || item.id || ''; 
              tr.dataset.requestId = item.request_id || ''; 
              tr.innerHTML = `
              <td>${(item.first_name||'') + ' ' + (item.last_name||'')}</td>
              <td>${formatDocuments(item)}</td>
              <td>${formatPurpose(item.purpose)}</td>
              <td><span class="status-badge-chip chip-pending">Pending</span></td>
              <td><button class="btn btn-info btn-sm view-receipt-btn" type="button"><i class="fas fa-receipt"></i> View Receipt</button></td>
              <td class="clearance-status-cell">
                <button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${item.request_id})">View Clearance</button>
              </td>
              <td class="files-cell"><span class="text-muted">—</span></td>
            `; 
              tbody.appendChild(tr);
              
              // Add receipt button event listener
              const receiptBtn = tr.querySelector('.view-receipt-btn');
              if (receiptBtn){ 
                receiptBtn.addEventListener('click', function(e){ 
                  e.stopPropagation(); 
                  openReceiptModal(item); 
                }); 
              }
            }); 
          }
        } catch(err){ 
          console.error('Error loading student pending clearances:', err); 
        }
      }

      // Load approved clearances for student
      async function loadStudentApprovedClearances(){
        try {
          const res = await fetch('/api/student/clearance?status=processing');
          const data = await res.json();
          const tbody = document.getElementById('approvedTableBody');
          if (!tbody) { 
            console.warn('approvedTableBody element not found'); 
            return; 
          }
          tbody.innerHTML = '';
          
          if(data.ok && data.data && Array.isArray(data.data)){
            data.data.forEach(item => {
              // Build payment status HTML
              let paymentStatusHtml = '<span class="no-receipt-text"><i class="fas fa-receipt"></i> No receipt</span>';
              
              const tr = document.createElement('tr'); 
              tr.dataset.requestId = item.request_id || ''; 
              tr.dataset.studentId = item.student_id || item.id || ''; 
              tr.innerHTML = `
              <td>${(item.first_name||'') + ' ' + (item.last_name||'')}</td>
              <td>${formatDocuments(item)}</td>
              <td>${formatPurpose(item.purpose)}</td>
              <td><span class="status-badge-chip chip-approved">Approved</span></td>
              <td><button class="btn btn-info btn-sm view-receipt-btn" type="button"><i class="fas fa-receipt"></i> View Receipt</button></td>
              <td class="clearance-status-cell">
                <button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${item.request_id})">View Clearance</button>
              </td>
              <td class="files-cell"><span class="text-muted">—</span></td>
            `; 
              tbody.appendChild(tr);
              
              // Add receipt button event listener
              const receiptBtn = tr.querySelector('.view-receipt-btn');
              if (receiptBtn){ 
                receiptBtn.addEventListener('click', function(e){ 
                  e.stopPropagation(); 
                  openReceiptModal(item); 
                }); 
              }
            }); 
            
            // Load files for approved clearances
            setTimeout(async function(){
              try{
                const tbody = document.getElementById('approvedTableBody');
                if (!tbody) return;
                Array.from(tbody.querySelectorAll('tr')).forEach(async function(row){
                  const reqId = row.dataset && (row.dataset.requestId || row.getAttribute('data-request-id'));
                  if(!reqId) return;
                  
                  try{
                    // Load files from both document_files and clearance_files
                    const [docRes, clrRes] = await Promise.all([
                      fetch('/api/student/document-files/'+Number(reqId)),
                      fetch('/api/student/clearance-files/'+Number(reqId))
                    ]);
                    
                    const [docData, clrData] = await Promise.all([
                      docRes.json(),
                      clrRes.json()
                    ]);
                    
                    const allFiles = [];
                    
                    // Add document files
                    if (docData.ok && docData.files && docData.files.length) {
                      allFiles.push(...docData.files);
                    }
                    
                    // Add clearance files
                    if (clrData.ok && clrData.files && clrData.files.length) {
                      allFiles.push(...clrData.files);
                    }
                    
                    const filesCell = row.cells[7]; // Files column (8th column, index 7)
                    if (filesCell) {
                      if (allFiles.length > 0) {
                        const links = allFiles.map(function(f){ 
                          return '<a class="btn btn-outline-primary btn-sm me-2" href="'+f.url+'" download title="Download '+f.name+'"><i class="fas fa-download"></i> '+ (f.name||'File') +'</a>'; 
                        }).join('');
                        filesCell.innerHTML = links;
                      } else {
                        filesCell.innerHTML = '<span class="text-muted"><i class="fas fa-times-circle"></i> No files</span>';
                      }
                    }
                  }catch(e){ 
                    console.error('Error loading files:', e);
                    const filesCell = row.cells[7]; // Files column (8th column, index 7)
                    if (filesCell) {
                      filesCell.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error</span>';
                    }
                  }
                });
              }catch(_){ }
            }, 50);
          }
        } catch(err){ 
          console.error('Error loading student approved clearances:', err); 
        }
      }

      // Load rejected clearances for student
      async function loadStudentRejectedClearances(){
        try {
          const res = await fetch('/api/student/clearance?status=rejected');
          const data = await res.json();
          const tbody = document.getElementById('rejectedTableBody');
          if (!tbody) { 
            console.warn('rejectedTableBody element not found'); 
            return; 
          }
          tbody.innerHTML = '';
          
          if(data.ok && data.data && Array.isArray(data.data)){
            data.data.forEach(item => {
              // Build payment status HTML
              let paymentStatusHtml = '<span class="no-receipt-text"><i class="fas fa-receipt"></i> No receipt</span>';
              
              const tr = document.createElement('tr'); 
              tr.dataset.requestId = item.request_id || ''; 
              tr.dataset.studentId = item.student_id || item.id || ''; 
              tr.innerHTML = `
              <td>${(item.first_name||'') + ' ' + (item.last_name||'')}</td>
              <td>${formatDocuments(item)}</td>
              <td>${formatPurpose(item.purpose)}</td>
              <td><span class="status-badge-chip chip-rejected">Rejected</span></td>
              <td><button class="btn btn-info btn-sm view-receipt-btn" type="button"><i class="fas fa-receipt"></i> View Receipt</button></td>
              <td class="clearance-status-cell">
                <button class="btn btn-outline-primary btn-sm" onclick="openViewClearance(${item.request_id})">View Clearance</button>
              </td>
              <td class="files-cell"><span class="text-muted">—</span></td>
            `; 
              tbody.appendChild(tr);
              
              // Add receipt button event listener
              const receiptBtn = tr.querySelector('.view-receipt-btn');
              if (receiptBtn){ 
                receiptBtn.addEventListener('click', function(e){ 
                  e.stopPropagation(); 
                  openReceiptModal(item); 
                }); 
              }
            }); 
            
            // Load files for rejected clearances
            setTimeout(async function(){
              try{
                const tbody = document.getElementById('rejectedTableBody');
                if (!tbody) return;
                Array.from(tbody.querySelectorAll('tr')).forEach(async function(row){
                  const reqId = row.dataset && (row.dataset.requestId || row.getAttribute('data-request-id'));
                  if(!reqId) return;
                  
                  try{
                    // Load files from both document_files and clearance_files
                    const [docRes, clrRes] = await Promise.all([
                      fetch('/api/student/document-files/'+Number(reqId)),
                      fetch('/api/student/clearance-files/'+Number(reqId))
                    ]);
                    
                    const [docData, clrData] = await Promise.all([
                      docRes.json(),
                      clrRes.json()
                    ]);
                    
                    const allFiles = [];
                    
                    // Add document files
                    if (docData.ok && docData.files && docData.files.length) {
                      allFiles.push(...docData.files);
                    }
                    
                    // Add clearance files
                    if (clrData.ok && clrData.files && clrData.files.length) {
                      allFiles.push(...clrData.files);
                    }
                    
                    const filesCell = row.cells[7]; // Files column (8th column, index 7)
                    if (filesCell) {
                      if (allFiles.length > 0) {
                        const links = allFiles.map(function(f){ 
                          return '<a class="btn btn-outline-primary btn-sm me-2" href="'+f.url+'" download title="Download '+f.name+'"><i class="fas fa-download"></i> '+ (f.name||'File') +'</a>'; 
                        }).join('');
                        filesCell.innerHTML = links;
                      } else {
                        filesCell.innerHTML = '<span class="text-muted"><i class="fas fa-times-circle"></i> No files</span>';
                      }
                    }
                  }catch(e){ 
                    console.error('Error loading files:', e);
                    const filesCell = row.cells[7]; // Files column (8th column, index 7)
                    if (filesCell) {
                      filesCell.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error</span>';
                    }
                  }
                });
              }catch(_){ }
            }, 50);
          }
        } catch(err){ 
          console.error('Error loading student rejected clearances:', err); 
        }
      }

      // Legacy function for backward compatibility
      async function loadAllRequests(){
        try{
          console.log("Loading all requests...");
          // Add cache-busting parameter to force fresh data
          const timestamp = new Date().getTime();
          const resp = await fetch(`/api/student/requests?t=${timestamp}`);
          if (!resp.ok){
            let message = 'Server error ('+resp.status+') while loading requests';
            try {
              const errJson = await resp.json();
              if (errJson && (errJson.error || errJson.message)){
                message = (errJson.error || errJson.message) + ' (HTTP '+resp.status+')';
              }
            } catch(_){ }
            lastRequestsLoadOk = false;
            throw new Error(message);
          }
          const data = await resp.json();
          console.log("API response:", data);
          if (data.ok && Array.isArray(data.requests)){
            allRequestsCache = data.requests.slice().sort(function(a,b){
              const da = a.date_requested ? new Date(a.date_requested).getTime() : 0;
              const db = b.date_requested ? new Date(b.date_requested).getTime() : 0;
              return db - da;
            });
            // Update global reference
            window.allRequestsCache = allRequestsCache;
            // Use effective status (considers signatories + registrar state) so Pending view matches dashboard
            pendingCache = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'pending'; });
            lastRequestsLoadOk = true;
            console.log("All requests loaded:", allRequestsCache.length);
            console.log("Pending requests:", pendingCache.length);
            
            // Debug: Log all requests to see what we have
            console.log("=== DEBUG: All Requests Details ===");
            allRequestsCache.forEach((req, index) => {
              const effectiveStatus = getEffectiveStatus(req);
              console.log(`Request ${index + 1}:`, {
                id: req.id,
                status: req.status,
                fulfillment_status: req.fulfillment_status,
                request_type: req.request_type,
                document_type: req.document_type,
                purpose: req.purpose,
                documents: req.documents,
                purposes: req.purposes,
                signatories: req.signatories?.length || 0,
                effective_status: effectiveStatus,
                clearance_status: req.clearance_status,
                student_name: req.student_name,
                clearance_request_id: req.clearance_request_id,
                pickup_date: req.pickup_date,
                payment_receipt: req.payment_receipt ? 'HAS_RECEIPT' : 'NO_RECEIPT',
                payment_method: req.payment_method,
                payment_amount: req.payment_amount,
                receipt_status: req.receipt_status
              });
              console.log(`  → Raw status: "${req.status}"`);
              console.log(`  → Fulfillment status: "${req.fulfillment_status}"`);
              console.log(`  → Effective status: "${effectiveStatus}"`);
              console.log(`  → Payment receipt: ${req.payment_receipt ? 'EXISTS' : 'MISSING'}`);
            });
            
            console.log("=== DEBUG: Pending Requests ===");
            pendingCache.forEach((req, index) => {
              console.log(`Pending ${index + 1}:`, {
                id: req.id,
                status: req.status,
                document_type: req.document_type,
                effective_status: getEffectiveStatus(req)
              });
            });
          } else if (data.ok && Array.isArray(data.requests) && data.requests.length === 0){
            // Explicit empty state
            allRequestsCache = [];
            pendingCache = [];
            lastRequestsLoadOk = true;
            console.log("No requests found");
            // Update pending clearance button visibility
          } else {
            // Malformed response
            lastRequestsLoadOk = false;
            throw new Error('Malformed response from API');
          }
        } catch(err){ 
          console.error("Error loading requests:", err);
          // Check if it's a session error
          if (err.message && (err.message.includes('401') || err.message.includes('No student session found'))) {
            showSessionError();
            return;
          }
          // Show error message to user
          const errorMsg = document.getElementById('errorMessage');
          if (errorMsg) {
            errorMsg.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${err.message}</div>`;
            errorMsg.style.display = 'block';
          }
          try {
            let banner = document.getElementById('requestsErrorBanner');
            if (!banner){
              banner = document.createElement('div');
              banner.id = 'requestsErrorBanner';
              banner.className = 'alert alert-danger';
              banner.style.margin = '10px 0';
              const container = document.getElementById('pendingRequestsPanel') || document.body;
              container.insertBefore(banner, container.firstChild);
            }
            banner.textContent = (err && err.message) ? err.message : 'Failed to load requests.';
          } catch(_){ }
          // Keep caches as-is to avoid showing empty-state due to transient errors
        }
      }
      
      // Keep the old function name for compatibility
      async function loadPending(){
        await loadAllRequests();
      }

      // Function to refresh all requests and update the display
      async function refreshAllRequests(){
        try {
          console.log("🔄 Refreshing all requests...");
          
          // Show loading state on refresh button
          const refreshBtn = document.getElementById('refreshRequestsBtn');
          if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
          }
          
          // Clear ALL caches to force fresh data
          allRequestsCache = [];
          pendingCache = [];
          lastRequestsLoadOk = false;
          
          // Force reload all requests with fresh cache-busting
          await loadAllRequests();
          
          // Update status badges
          updateStatusBadges();
          
          // Update pagination
          updatePendingPagination();
          
          // Force re-render the current view
          const titleEl = document.getElementById('requestsHeaderTitle');
          if (titleEl) {
            const currentTitle = titleEl.textContent;
            if (currentTitle.includes('Processing')) {
              // Re-render processing view
              const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'processing'; });
              renderPending(list);
            } else if (currentTitle.includes('Completed')) {
              // Re-render completed view
              const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'completed'; });
              renderPending(list);
            } else if (currentTitle.includes('Rejected')) {
              // Re-render rejected view
              const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'rejected'; });
              renderPending(list);
            } else if (currentTitle.includes('Unclaimed')) {
              // Re-render unclaimed view
              const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'unclaimed'; });
              renderPending(list);
            } else if (currentTitle.includes('Claimed')) {
              // Re-render claimed view
              const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'claimed'; });
              renderPending(list);
            } else {
              // Re-render pending view
              renderPendingPage(1);
            }
          }
          
          // Show success message
          if (window.Swal) {
            Swal.fire({
              icon: 'success',
              title: 'Data Refreshed!',
              text: 'Request data has been updated.',
              timer: 2000,
              showConfirmButton: false
            });
          }
          
        } catch (error) {
          console.error('Error refreshing requests:', error);
          if (window.Swal) {
            Swal.fire({
              icon: 'error',
              title: 'Refresh Failed',
              text: 'Failed to refresh data. Please try again.',
              confirmButtonText: 'OK'
            });
          }
        } finally {
          // Reset refresh button
          const refreshBtn = document.getElementById('refreshRequestsBtn');
          if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
          }
        }
      }

      function updatePendingPagination(){
        const total = pendingCache.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        pendingCurrentPage = Math.min(pendingCurrentPage, totalPages);
        const start = (pendingCurrentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageItems = pendingCache.slice(start, end);
        renderPending(pageItems);
        if (pendingPageInfo) pendingPageInfo.textContent = 'Page '+pendingCurrentPage+' of '+totalPages;
        if (prevPendingBtn) prevPendingBtn.disabled = pendingCurrentPage <= 1;
        if (nextPendingBtn) nextPendingBtn.disabled = pendingCurrentPage >= totalPages;
      }

      async function renderPendingPage(page){
        if (!pendingCache.length){ await loadPending(); }
        pendingCurrentPage = page || 1;
        updatePendingPagination();
      }

      if (prevPendingBtn){ prevPendingBtn.addEventListener('click', function(){ if (pendingCurrentPage > 1){ pendingCurrentPage--; updatePendingPagination(); } }); }
      if (nextPendingBtn){ nextPendingBtn.addEventListener('click', function(){ pendingCurrentPage++; updatePendingPagination(); }); }

      // Buttons for Processing and Completed to mirror Pending list with filters
      const processingBtn = document.getElementById('processingBtn');
      const completedBtn = document.getElementById('completedBtn');
      if (processingBtn){
        processingBtn.addEventListener('click', async function(){
          try {
            // Show full-screen loading
            if (window.showFullScreenLoading) {
              window.showFullScreenLoading('Loading Processing Requests...');
            }
            
            setActive(dashboardLink);
            pageTitle.textContent = 'Dashboard';
            hideAllSections();
            dashboardSection.style.display = 'block';
            if (pendingRequestsPanel) pendingRequestsPanel.style.display = 'block';
            const titleEl = document.getElementById('requestsHeaderTitle');
            if (titleEl) titleEl.innerHTML = '<i class="fas fa-spinner"></i> Processing Requests';
            // Load and render only processing
            await loadAllRequests();
            const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'processing'; });
            renderPending(list);
            if (pendingPageInfo) pendingPageInfo.textContent = 'Page 1 of 1';
            if (prevPendingBtn) prevPendingBtn.disabled = true;
            if (nextPendingBtn) nextPendingBtn.disabled = true;
          } finally {
            // Hide full-screen loading
            if (window.hideFullScreenLoading) {
              window.hideFullScreenLoading();
            }
          }
        });
      }
      if (completedBtn){
        completedBtn.addEventListener('click', async function(){
          try {
            // Show full-screen loading
            if (window.showFullScreenLoading) {
              window.showFullScreenLoading('Loading Completed Documents...');
            }
            setActive(dashboardLink);
            pageTitle.textContent = 'Dashboard';
            hideAllSections();
            dashboardSection.style.display = 'block';
            if (pendingRequestsPanel) pendingRequestsPanel.style.display = 'block';
            const titleEl = document.getElementById('requestsHeaderTitle');
            if (titleEl) titleEl.innerHTML = '<i class="fas fa-check-circle"></i> Completed Documents - Download Files';
            // Load and render only completed
            await loadAllRequests();
            const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'completed'; });
            // After rendering, enhance rows with download links for released files
            renderPending(list);
          setTimeout(async function(){
            try{
              const tbody = document.getElementById('pendingTableBody');
              if (!tbody) return;
              Array.from(tbody.querySelectorAll('tr')).forEach(async function(row){
                const reqId = row.dataset && (row.dataset.requestId || row.getAttribute('data-request-id'));
                if(!reqId) return;
                
                try{
                  // Load files from both document_files and clearance_files
                  const [docRes, clrRes] = await Promise.all([
                    fetch('/api/student/document-files/'+Number(reqId)),
                    fetch('/api/student/clearance-files/'+Number(reqId))
                  ]);
                  
                  const [docData, clrData] = await Promise.all([
                    docRes.json(),
                    clrRes.json()
                  ]);
                  
                  const allFiles = [];
                  
                  // Add document files
                  if (docData.ok && docData.files && docData.files.length) {
                    allFiles.push(...docData.files);
                  }
                  
                  // Add clearance files
                  if (clrData.ok && clrData.files && clrData.files.length) {
                    allFiles.push(...clrData.files);
                  }
                  
                  const filesCell = row.cells[7]; // Files column (8th column, index 7)
                  if (filesCell) {
                    if (allFiles.length > 0) {
                      const links = allFiles.map(function(f){ 
                        return '<a class="btn btn-outline-primary btn-sm me-2" href="'+f.url+'" download title="Download '+f.name+'"><i class="fas fa-download"></i> '+ (f.name||'File') +'</a>'; 
                      }).join('');
                      filesCell.innerHTML = links;
                    } else {
                      filesCell.innerHTML = '<span class="text-muted"><i class="fas fa-times-circle"></i> No files</span>';
                    }
                  }
                }catch(e){ 
                  console.error('Error loading files:', e);
                  const filesCell = row.cells[7]; // Files column (8th column, index 7)
                  if (filesCell) {
                    filesCell.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error</span>';
                  }
                }
              });
            }catch(_){ }
          }, 50);
          if (pendingPageInfo) pendingPageInfo.textContent = 'Page 1 of 1';
          if (prevPendingBtn) prevPendingBtn.disabled = true;
          if (nextPendingBtn) nextPendingBtn.disabled = true;
          } finally {
            // Hide full-screen loading
            if (window.hideFullScreenLoading) {
              window.hideFullScreenLoading();
            }
          }
        });
      }
      const rejectedBtn = document.getElementById('rejectedBtn');
      if (rejectedBtn){
        rejectedBtn.addEventListener('click', async function(){
          try {
            // Show full-screen loading
            if (window.showFullScreenLoading) {
              window.showFullScreenLoading('Loading Rejected Requests...');
            }
            
            setActive(dashboardLink);
            pageTitle.textContent = 'Dashboard';
            hideAllSections();
            dashboardSection.style.display = 'block';
            if (pendingRequestsPanel) pendingRequestsPanel.style.display = 'block';
            const titleEl = document.getElementById('requestsHeaderTitle');
            if (titleEl) titleEl.innerHTML = '<i class="fas fa-times-circle"></i> Rejected Requests';
            // Load and render only rejected
            await loadAllRequests();
            const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'rejected'; });
            renderPending(list);
            if (pendingPageInfo) pendingPageInfo.textContent = 'Page 1 of 1';
            if (prevPendingBtn) prevPendingBtn.disabled = true;
            if (nextPendingBtn) nextPendingBtn.disabled = true;
          } finally {
            // Hide full-screen loading
            if (window.hideFullScreenLoading) {
              window.hideFullScreenLoading();
            }
          }
        });
      }
      const unclaimedBtn = document.getElementById('unclaimedBtn');
      if (unclaimedBtn){
        unclaimedBtn.addEventListener('click', async function(){
          try {
            // Show full-screen loading
            if (window.showFullScreenLoading) {
              window.showFullScreenLoading('Loading Unclaimed Requests...');
            }
            
            setActive(dashboardLink);
            pageTitle.textContent = 'Dashboard';
            hideAllSections();
            dashboardSection.style.display = 'block';
            if (pendingRequestsPanel) pendingRequestsPanel.style.display = 'block';
            const titleEl = document.getElementById('requestsHeaderTitle');
            if (titleEl) titleEl.innerHTML = '<i class="fas fa-box-archive"></i> Unclaimed Requests';
            // Load and render only unclaimed
            await loadAllRequests();
            const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'unclaimed'; });
            renderPending(list);
            if (pendingPageInfo) pendingPageInfo.textContent = 'Page 1 of 1';
            if (prevPendingBtn) prevPendingBtn.disabled = true;
            if (nextPendingBtn) nextPendingBtn.disabled = true;
          } finally {
            // Hide full-screen loading
            if (window.hideFullScreenLoading) {
              window.hideFullScreenLoading();
            }
          }
        });
      }
      const claimedBtn = document.getElementById('claimedBtn');
      if (claimedBtn){
        claimedBtn.addEventListener('click', async function(){
          try {
            // Show full-screen loading
            if (window.showFullScreenLoading) {
              window.showFullScreenLoading('Loading Claimed Requests...');
            }
            
            setActive(dashboardLink);
            pageTitle.textContent = 'Dashboard';
            hideAllSections();
            dashboardSection.style.display = 'block';
            if (pendingRequestsPanel) pendingRequestsPanel.style.display = 'block';
            const titleEl = document.getElementById('requestsHeaderTitle');
            if (titleEl) titleEl.innerHTML = '<i class="fas fa-check-square"></i> Claimed Requests';
            // Load and render only claimed
            await loadAllRequests();
            const list = allRequestsCache.filter(function(r){ return getEffectiveStatus(r) === 'claimed'; });
            renderPending(list);
            if (pendingPageInfo) pendingPageInfo.textContent = 'Page 1 of 1';
            if (prevPendingBtn) prevPendingBtn.disabled = true;
            if (nextPendingBtn) nextPendingBtn.disabled = true;
          } finally {
            // Hide full-screen loading
            if (window.hideFullScreenLoading) {
              window.hideFullScreenLoading();
            }
          }
        });
      }


      // Function to show clearance section
      function showClearanceSection() {
        const clearanceBtn = document.getElementById('clearanceBtn');
        if (clearanceBtn) {
          clearanceBtn.click();
        }
      }


      // Fix status inconsistencies function
      window.fixStatusInconsistencies = async function() {
        try {
          const response = await fetch('/api/fix-status-inconsistencies', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          
          if (result.ok) {
            Swal.fire({
              title: 'Status Fix Complete',
              text: result.message,
              icon: 'success',
              confirmButtonText: 'OK'
            }).then(() => {
              // Reload the requests to show updated status
              loadAllRequests();
            });
          } else {
            Swal.fire({
              title: 'Error',
              text: result.message || 'Failed to fix status inconsistencies',
              icon: 'error',
              confirmButtonText: 'OK'
            });
          }
        } catch (error) {
          Swal.fire({
            title: 'Error',
            text: 'Failed to fix status inconsistencies: ' + error.message,
            icon: 'error',
            confirmButtonText: 'OK'
          });
        }
      };

      // Debug function for pending requests
      window.debugPendingRequests = function() {
        console.log("=== DEBUG PENDING REQUESTS ===");
        console.log("All requests cache:", allRequestsCache);
        console.log("Pending cache:", pendingCache);
        console.log("Last load OK:", lastRequestsLoadOk);
        
        // Show detailed info in alert
        const info = `
Total Requests: ${allRequestsCache.length}
Pending Requests: ${pendingCache.length}
Last Load OK: ${lastRequestsLoadOk}

All Requests Details:
${allRequestsCache.map((req, i) => 
  `${i+1}. ID: ${req.id}, Status: ${req.status}, Type: ${req.document_type}
     Documents: ${JSON.stringify(req.documents)}
     Purpose: ${JSON.stringify(req.purpose)}
     Purposes: ${JSON.stringify(req.purposes)}
     Signatories: ${req.signatories?.length || 0}`
).join('\n')}

Pending Requests Details:
${pendingCache.map((req, i) => 
  `${i+1}. ID: ${req.id}, Status: ${req.status}, Type: ${req.document_type}
     Documents: ${JSON.stringify(req.documents)}
     Purpose: ${JSON.stringify(req.purpose)}
     Purposes: ${JSON.stringify(req.purposes)}`
).join('\n')}
        `;
        
        Swal.fire({
          title: 'Debug Information',
          html: `<pre style="text-align: left; font-size: 12px;">${info}</pre>`,
          width: '80%',
          confirmButtonText: 'OK'
        });
      }

      // Function to view receipt for document requests (by ID)
      function viewReceiptById(requestId) {
        // Find the request in the cache
        const request = allRequestsCache.find(req => req.id === requestId);
        if (!request) {
          Swal.fire({
            icon: 'error',
            title: 'Request Not Found',
            text: 'Could not find the requested document.',
            confirmButtonText: 'OK'
          });
          return;
        }

        // Call the main viewReceipt function with the found request
        viewReceipt(request);
      }

      // Function to view receipt for student dashboard - Updated to use modal
      function viewReceipt(requestData) {
        console.log('🔍 Student Dashboard viewReceipt called with data:', requestData);
        console.log('🔍 Student Dashboard requestData.id:', requestData?.id);
        console.log('🔍 Student Dashboard available fields:', Object.keys(requestData || {}));
        console.log('🔍 Student Dashboard payment_receipt length:', requestData?.payment_receipt?.length || 0);
        console.log('🔍 Student Dashboard payment_receipt preview:', requestData?.payment_receipt?.substring(0, 50) || 'NONE');
        
        if (!requestData) {
          Swal.fire({
            icon: 'error',
            title: 'No Receipt Available',
            text: 'Request data not found.',
            confirmButtonText: 'OK'
          });
          return;
        }

        // Check if we have payment information or receipt status
        if (!requestData.payment_method && !requestData.payment_amount && !requestData.receipt_status) {
          Swal.fire({
            icon: 'error',
            title: 'No Receipt Available',
            text: 'No payment information or receipt found for this request.',
            confirmButtonText: 'OK'
          });
          return;
        }

        // Use the same logic as completed requests - display receipt directly from request data
        // This ensures receipt images are properly aligned with their requests
        console.log('🔍 Student Dashboard: Using direct receipt display (same as completed requests)');
        console.log('🔍 Student Dashboard: requestData.payment_receipt exists:', !!requestData.payment_receipt);
        console.log('🔍 Student Dashboard: requestData.receipt_status:', requestData.receipt_status);
        
        showReceiptFallback(requestData);
      }

      // Fallback function for when modal is not available
      function showReceiptFallback(requestData) {
        try {
          let receiptHtml = '<div style="text-align: center; padding: 20px;">';
          
          // Simple receipt format showing amount and payment info
          receiptHtml += '<div style="background: #ffffff; padding: 22px; border-radius: 14px; border: 1px solid #e5e7eb; box-shadow: 0 6px 24px rgba(0,0,0,0.06); text-align:center;">';
          receiptHtml += '<div style="border-bottom: 2px solid #2563eb; padding-bottom: 8px; margin-bottom: 16px;">'
            + '<h5 style="margin:0; color: #111827; font-size: 20px; font-weight: 800;">Payment Receipt</h5>'
          + '</div>';
          
          // Amount paid
          receiptHtml += '<div style="margin-bottom: 14px;">';
          receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Amount Paid</div>';
          receiptHtml += '<div style="font-size: 24px; font-weight: 800; color: #16a34a;">₱' + (requestData.payment_amount || '50.00') + '</div>';
          receiptHtml += '</div>';
          
          // Payment method
          if (requestData.payment_method) {
            receiptHtml += '<div style="margin-bottom: 14px;">';
            receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:4px;">Payment Method</div>';
            receiptHtml += '<div style="font-size: 16px; font-weight: 600; color: #374151;">' + requestData.payment_method.toUpperCase() + '</div>';
            receiptHtml += '</div>';
          }
          
          // Show uploaded receipt image if available (S3 or database)
          if (requestData.payment_receipt_s3_url) {
            console.log('Payment receipt S3 URL found:', requestData.payment_receipt_s3_url);
            receiptHtml += '<div style="margin-top: 16px; padding-top: 12px; border-top:1px dashed #e5e7eb;">';
            receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:8px;">Uploaded Receipt</div>';
            receiptHtml += '<img alt="Receipt" src="' + requestData.payment_receipt_s3_url + '" class="w-full max-w-md mx-auto rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-pointer" onclick="window.open(this.src, \'_blank\')" onerror="console.error(\'Failed to load receipt image from S3\')" />';
            receiptHtml += '</div>';
          } else if (requestData.payment_receipt) {
            console.log('Payment receipt data found:', requestData.payment_receipt.substring(0, 50) + '...');
            receiptHtml += '<div style="margin-top: 16px; padding-top: 12px; border-top:1px dashed #e5e7eb;">';
            receiptHtml += '<div style="color:#374151; font-size: 13px; font-weight:600; margin-bottom:8px;">Uploaded Receipt</div>';
            // Use generic image format that works for both JPEG and PNG
            receiptHtml += '<img alt="Receipt" src="data:image/jpeg;base64,' + requestData.payment_receipt + '" class="w-full max-w-md mx-auto rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200 cursor-pointer" onclick="window.open(this.src, \'_blank\')" onerror="console.error(\'Failed to load receipt image\')" />';
            receiptHtml += '</div>';
          } else if (requestData.receipt_status === 'has_receipt') {
            console.log('Receipt exists but not loaded in this view');
            receiptHtml += '<div style="margin-top: 16px; padding: 16px; background: #dbeafe; border-radius: 8px; border-left: 4px solid #2563eb;">';
            receiptHtml += '<div style="color: #1e40af; font-size: 14px;">';
            receiptHtml += '<i class="fas fa-receipt" style="margin-right: 6px;"></i>';
            receiptHtml += 'Receipt image is available. Click "View Receipt" button to see the full receipt image.';
            receiptHtml += '</div>';
            receiptHtml += '</div>';
          } else {
            console.log('No payment receipt data found');
            // Show message when no receipt image is available
            if (requestData.payment_method || requestData.payment_amount) {
              receiptHtml += '<div style="margin-top: 16px; padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">';
              receiptHtml += '<div style="color: #92400e; font-size: 14px;">';
              receiptHtml += '<i class="fas fa-info-circle" style="margin-right: 6px;"></i>';
              receiptHtml += 'No receipt image was uploaded for this request. Contact the registrar if you need to upload a receipt.';
              receiptHtml += '</div>';
              receiptHtml += '</div>';
            }
          }
          
          receiptHtml += '</div></div>';

          Swal.fire({
            title: 'Payment Receipt',
            html: receiptHtml,
            width: 720,
            showConfirmButton: true,
            confirmButtonText: 'Close',
            confirmButtonColor: '#2563eb',
            background: '#ffffff',
            color: '#111827'
          });
        } catch (error) {
          console.error('Error displaying receipt:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to display receipt. Please try again.',
            confirmButtonText: 'OK'
          });
        }
      }


      // Initial load
      loadAllRequests();

      // Dark Mode Toggle Functionality
      const darkModeToggle = document.getElementById('darkModeToggle');
      const darkModeIcon = document.getElementById('darkModeIcon');
      const body = document.body;

      // Check for saved dark mode preference or default to dark mode
      const isDarkMode = localStorage.getItem('darkMode') !== 'false';
      
      // Initialize dark mode
      function initializeDarkMode() {
        if (isDarkMode) {
          body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          darkModeToggle.classList.add('active');
          darkModeIcon.className = 'fas fa-sun';
        } else {
          body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          darkModeToggle.classList.remove('active');
          darkModeIcon.className = 'fas fa-moon';
        }
      }

      // Force dark mode on page load for better text visibility
      body.classList.add('dark-mode');
      document.documentElement.classList.add('dark-mode');
      darkModeToggle.classList.add('active');
      darkModeIcon.className = 'fas fa-sun';
      

      // Toggle dark mode
      function toggleDarkMode() {
        const isCurrentlyDark = body.classList.contains('dark-mode');
        
        if (isCurrentlyDark) {
          // Switch to light mode
          body.classList.remove('dark-mode');
          document.documentElement.classList.remove('dark-mode');
          darkModeToggle.classList.remove('active');
          darkModeIcon.className = 'fas fa-moon';
          localStorage.setItem('darkMode', 'false');
        } else {
          // Switch to dark mode
          body.classList.add('dark-mode');
          document.documentElement.classList.add('dark-mode');
          darkModeToggle.classList.add('active');
          darkModeIcon.className = 'fas fa-sun';
          localStorage.setItem('darkMode', 'true');
        }
      }

      // Add event listener to dark mode toggle
      darkModeToggle.addEventListener('click', toggleDarkMode);

      // Initialize dark mode on page load
      initializeDarkMode();

    });

    // Initialize receipt modal when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🔍 Student Dashboard: DOM loaded, initializing receipt modal...');
      if (window.receiptModal) {
        console.log('✅ Student Dashboard: Receipt modal already initialized');
      } else {
        console.log('🔍 Student Dashboard: Creating new receipt modal instance');
        window.receiptModal = new ReceiptModal();
      }
    });
  </script>

  <!-- Professional Clearance Modal -->
  <div class="modal fade" id="clViewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content professional-modal">
        <div class="modal-header professional-header">
          <div class="d-flex align-items-center">
            <div class="header-icon-container">
              <div class="header-icon-bg">
                <i class="fa-solid fa-file-shield"></i>
              </div>
              <div class="header-content">
                <h4 class="modal-title">Clearance Details</h4>
                <p class="modal-subtitle">Student Clearance Information & Status</p>
              </div>
            </div>
          </div>
          <button type="button" class="btn-close professional-close" data-bs-dismiss="modal" aria-label="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="modal-body professional-body">
          <!-- Student Information Card -->
          <div class="info-card professional-card">
            <div class="card-header-professional">
              <div class="header-accent-line"></div>
              <div class="d-flex align-items-center">
                <div class="card-icon-container">
                  <i class="fa-solid fa-user-graduate"></i>
                </div>
                <h6 class="card-title-professional">Student Information</h6>
              </div>
            </div>
            <div class="card-body-professional">
              <div id="clViewStudentInfo" class="student-info-grid">
                <!-- Student info will be populated here -->
              </div>
            </div>
          </div>

          <!-- Document Information Card -->
          <div class="info-card professional-card">
            <div class="card-header-professional">
              <div class="header-accent-line"></div>
              <div class="d-flex align-items-center">
                <div class="card-icon-container">
                  <i class="fa-solid fa-file-lines"></i>
                </div>
                <h6 class="card-title-professional">Document Information</h6>
              </div>
            </div>
            <div class="card-body-professional">
              <div id="clViewInfo" class="info-grid-professional">
                <!-- Content will be populated here -->
              </div>
            </div>
          </div>


          <!-- Office Clearance Status Card -->
          <div class="info-card professional-card">
            <div class="card-header-professional">
              <div class="header-accent-line"></div>
              <div class="d-flex align-items-center">
                <div class="card-icon-container">
                  <i class="fa-solid fa-clipboard-check"></i>
                </div>
                <h6 class="card-title-professional">Office Clearance Status</h6>
              </div>
            </div>
            <div class="card-body-professional">
              <div class="table-container-professional">
                <table class="professional-table">
                  <thead>
                    <tr>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-building"></i>
                          <span>Office</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-check-circle"></i>
                          <span>Status</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-signature"></i>
                          <span>Approved By</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-clock"></i>
                          <span>Updated</span>
                        </div>
                      </th>
                      <th>
                        <div class="th-content">
                          <i class="fa-solid fa-comment"></i>
                          <span>Reason</span>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody id="clViewSignatories">
                    <!-- Content will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer professional-footer">
          <button type="button" class="btn-professional btn-secondary-professional" data-bs-dismiss="modal">
            <i class="fa-solid fa-times"></i>
            <span>Close</span>
          </button>
          <button type="button" class="btn-professional btn-primary-professional" onclick="printClearanceDetails(document.getElementById('clViewInfo').innerHTML)">
            <i class="fa-solid fa-print"></i>
            <span>Print</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Professional Modal Styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    .professional-modal {
      border: none;
      border-radius: 20px;
      box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.05);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      overflow: hidden;
    }

    /* Professional Header Styles */
    .professional-header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border: none;
      border-radius: 20px 20px 0 0;
      padding: 32px;
      color: white;
      position: relative;
      overflow: hidden;
    }

    .professional-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
      pointer-events: none;
    }

    .header-icon-container {
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
      z-index: 1;
    }

    .header-icon-bg {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
      position: relative;
    }

    .header-icon-bg::before {
      content: '';
      position: absolute;
      inset: 2px;
      background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
      border-radius: 16px;
      pointer-events: none;
    }

    .header-icon-bg i {
      font-size: 28px;
      color: white;
      position: relative;
      z-index: 1;
    }

    .header-content h4 {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin: 0;
      line-height: 1.2;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .modal-subtitle {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.8);
      margin: 8px 0 0 0;
      font-weight: 400;
    }

    .professional-close {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      color: white;
      position: relative;
      z-index: 1;
    }

    .professional-close:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .professional-close i {
      font-size: 16px;
    }

    /* Professional Body Styles */
    .professional-body {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      padding: 40px;
      border-radius: 0;
    }

    /* Professional Card Styles */
    .professional-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      margin-bottom: 32px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(226, 232, 240, 0.5);
    }

    .professional-card:hover {
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
      transform: translateY(-4px);
    }

    .card-header-professional {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      padding: 24px 32px;
      border-bottom: 1px solid #e2e8f0;
      position: relative;
    }

    .header-accent-line {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4);
    }

    .card-icon-container {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .card-icon-container i {
      font-size: 18px;
      color: white;
    }

    .card-title-professional {
      font-size: 22px;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
      display: flex;
      align-items: center;
    }

    .card-body-professional {
      padding: 32px;
    }

    /* Professional Grid Styles */
    .info-grid-professional {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 32px;
    }

    .student-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }

    .info-item-professional {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .info-item-professional:hover {
      background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
      border-color: #3b82f6;
      transform: translateY(-2px);
    }

    .info-label-professional {
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-label-professional i {
      font-size: 16px;
      color: #3b82f6;
    }

    .info-value-professional {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
      line-height: 1.4;
    }

    /* Progress Overview Styles */
    .progress-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 24px;
    }

    .progress-item {
      text-align: center;
      padding: 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .progress-item:hover {
      background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
      border-color: #3b82f6;
      transform: translateY(-4px);
    }

    .progress-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 20px;
      color: white;
    }

    .progress-icon.completed {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .progress-icon.pending {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .progress-icon.rejected {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .progress-label {
      font-size: 14px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 8px;
    }

    .progress-value {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
    }

    /* Professional Table Styles */
    .table-container-professional {
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .professional-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      table-layout: fixed;
    }

    .professional-table thead {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .professional-table th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      color: white;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: none;
      white-space: nowrap;
    }

    .professional-table th:nth-child(1) { width: 25%; } /* Office */
    .professional-table th:nth-child(2) { width: 15%; } /* Status */
    .professional-table th:nth-child(3) { width: 20%; } /* Approved By */
    .professional-table th:nth-child(4) { width: 20%; } /* Updated */
    .professional-table th:nth-child(5) { width: 20%; } /* Reason */

    .th-content {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .th-content i {
      font-size: 14px;
      color: #60a5fa;
    }

    .professional-table td {
      padding: 12px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
      font-size: 13px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.4;
    }

    .professional-table td.text-muted {
      font-size: 12px;
      color: #64748b;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .professional-table td small {
      font-size: 11px;
      color: #64748b;
    }

    .professional-table tbody tr {
      transition: all 0.2s ease;
    }

    .professional-table tbody tr:hover {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    /* Ensure all content is visible */
    .professional-table td:nth-child(1) { 
      min-width: 120px; 
      max-width: 200px;
    }
    .professional-table td:nth-child(2) { 
      min-width: 80px; 
      max-width: 120px;
    }
    .professional-table td:nth-child(3) { 
      min-width: 100px; 
      max-width: 150px;
    }
    .professional-table td:nth-child(4) { 
      min-width: 100px; 
      max-width: 150px;
    }
    .professional-table td:nth-child(5) { 
      min-width: 100px; 
      max-width: 200px;
    }

    .office-cell-professional {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .office-icon-professional {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .office-cell-professional span {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .office-icon-computer { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1d4ed8; }
    .office-icon-guidance { background: linear-gradient(135deg, #fce7f3, #fbcfe8); color: #be185d; }
    .office-icon-student { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
    .office-icon-library { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }
    .office-icon-dean { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #3730a3; }
    .office-icon-accounting { background: linear-gradient(135deg, #f3e8ff, #e9d5ff); color: #7c3aed; }
    .office-icon-registrar { background: linear-gradient(135deg, #f0fdf4, #dcfce7); color: #15803d; }

    .status-badge-professional {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      gap: 4px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      white-space: nowrap;
      max-width: 100%;
    }

    .status-approved-professional {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      color: #166534;
    }

    .status-pending-professional {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }

    .status-rejected-professional {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
    }

    /* Professional Footer Styles */
    .professional-footer {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: none;
      border-radius: 0 0 20px 20px;
      padding: 24px 32px;
      gap: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .btn-professional {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      border: none;
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary-professional {
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      color: #64748b;
      border: 1px solid #cbd5e1;
    }

    .btn-secondary-professional:hover {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      color: #475569;
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    .btn-primary-professional {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary-professional:hover {
      background: linear-gradient(135deg, #1d4ed8, #1e40af);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .professional-modal {
        margin: 16px;
        border-radius: 16px;
      }
      
      .professional-header {
        padding: 24px;
      }
      
      .header-icon-bg {
        width: 56px;
        height: 56px;
      }
      
      .header-content h4 {
        font-size: 28px;
      }
      
      .professional-body {
        padding: 24px;
      }
      
      .card-body-professional {
        padding: 24px;
      }
      
      .info-grid-professional {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .professional-table th,
      .professional-table td {
        padding: 16px;
      }
    }

  /* Request Form Container Styles */
  .request-form-container {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin-top: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
  }

  .request-form-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #f1f5f9;
  }

  .request-form-header h2 {
    color: #1e293b;
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
  }

  .request-form-header h2 i {
    color: #667eea;
    font-size: 1.5rem;
  }

  .request-form-header p {
    color: #64748b;
    font-size: 1rem;
    margin: 0;
  }

  .modern-form .form-section {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e2e8f0;
  }

  .modern-form .form-section h3 {
    color: #1e293b;
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .modern-form .form-section h3 i {
    color: #667eea;
    font-size: 1rem;
  }

  .documents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
  }

  .documents-grid label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .documents-grid label:hover {
    border-color: #667eea;
    background: #f8fafc;
  }

  .documents-grid input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #667eea;
  }

  .documents-grid input[type="checkbox"]:checked + .document-name {
    color: #667eea;
    font-weight: 600;
  }

  .documents-grid label:has(input:checked) {
    border-color: #667eea;
    background: #f0f4ff;
  }

  .purpose-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
  }

  .purpose-options label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .purpose-options label:hover {
    border-color: #667eea;
    background: #f8fafc;
  }

  .purpose-options input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #667eea;
  }

  .purpose-options input[type="checkbox"]:checked + .purpose-option {
    color: #667eea;
    font-weight: 600;
  }

  .purpose-options label:has(input:checked) {
    border-color: #667eea;
    background: #f0f4ff;
  }

  .other-purpose {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .other-purpose:hover {
    border-color: #667eea;
    background: #f8fafc;
  }

  .other-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
  }

  .other-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .id-upload-container {
    background: white;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.2s ease;
  }

  .id-upload-container:hover {
    border-color: #667eea;
    background: #f8fafc;
  }

  .id-upload-container input[type="file"] {
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    cursor: pointer;
  }

  .id-preview-container {
    margin-top: 1rem;
  }

  .id-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    display: none;
  }

  .submit-section {
    text-align: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
  }

  .submit-btn {
    background: white;
    color: #667eea;
    border: none;
    padding: 1rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1.125rem;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    background: #f8fafc;
  }

  .submit-btn i {
    margin-right: 0.5rem;
  }

  @media (max-width: 768px) {
    .request-form-container {
      padding: 1.5rem;
      margin: 1rem 0;
    }

    .request-form-header h2 {
      font-size: 1.5rem;
    }

    .documents-grid,
    .purpose-options {
      grid-template-columns: 1fr;
    }

    .modern-form .form-section {
      padding: 1rem;
    }
  }
  </style>

</body>
</html>
